/*
 * Copyright (c) 2020 MarkLogic Corporation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.marklogic.hub.impl;

import com.marklogic.hub.AbstractHubCoreTest;
import com.marklogic.hub.DatabaseKind;
import com.marklogic.mgmt.resource.appservers.ServerManager;
import com.marklogic.rest.util.Fragment;
import com.marklogic.rest.util.ResourcesFragment;
import org.easymock.EasyMock;
import org.jdom2.Namespace;
import org.junit.jupiter.api.Assumptions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.util.ArrayList;
import java.util.List;

import static org.easymock.EasyMock.expect;
import static org.easymock.EasyMock.replay;
import static org.junit.jupiter.api.Assertions.*;

public class DataHubImplTest extends AbstractHubCoreTest {

    private ServerManager serverManager;

    private DataHubImpl dh;

    private Versions versions;

    @BeforeEach
    public void beforeTests() {
        serverManager = EasyMock.mock(ServerManager.class);

        dh = EasyMock.createMockBuilder(DataHubImpl.class)
            .withConstructor()
            .createMock();
        dh.setHubConfig(getHubConfig());

        versions = EasyMock.createMockBuilder(Versions.class)
            .withConstructor()
            .addMockedMethod("getMarkLogicVersion")
            .createMock();
        dh.setVersions(versions);
    }

    @Test
    public void testValidateServerPriorTo8withDot() {
        assertFalse(dh.isServerVersionValid("7.0-6.6"));
    }

    @Test
    public void testValidateServerPriorTo8sansDot() {
        assertFalse(dh.isServerVersionValid("7.0"));
    }

    @Test
    public void testValidateServerPriorTo804() {
        assertFalse(dh.isServerVersionValid("8.0-3.4"));
    }

    @Test
    public void testValidateServer804() {
        assertFalse(dh.isServerVersionValid("8.0-4"));
    }

    @Test
    public void testValidateServerBeyond804() {
        assertFalse(dh.isServerVersionValid("8.0-5"));
    }

    @Test
    public void testValidateServer807() {
        assertFalse(dh.isServerVersionValid("8.0-7"));
    }

    @Test
    public void testValidateServer809() {
        assertFalse(dh.isServerVersionValid("8.0-9"));
    }

    @Test
    public void testValidateServerBeyond804WithDot() {
        assertFalse(dh.isServerVersionValid("8.0-5.2"));
    }

    @Test
    public void testValidateServer8nightly() {
        assertFalse(dh.isServerVersionValid("8.0-20160719"));
    }

    @Test
    public void testValidateServer9nightly() {
        assertTrue(dh.isServerVersionValid("9.0-20191112"));
        assertFalse(dh.isServerVersionValid("9.0-20191110"));
    }

    @Test
    public void testValidateServer8nightlyValid() {
        assertFalse(dh.isServerVersionValid("8.0-20170702"));
    }

    @Test
    public void testValidateServer8nightlyValidEdge() {
        assertFalse(dh.isServerVersionValid("8.0-20170701"));
    }

    @Test
    public void testValidateServer8nightlyInValid() {
        assertFalse(dh.isServerVersionValid("8.0-20170630"));
    }

    @Test
    public void testInvalidServer9nightly() {
        assertFalse(dh.isServerVersionValid("9.0-20180719"));
    }

    @Test
    public void testInvalidServer9nightly1() {
        assertFalse(dh.isServerVersionValid("9.0-20180504"));
    }

    @Test
    public void testValidateServer9() {
        assertFalse(dh.isServerVersionValid("9.0"));
    }

    @Test
    public void testValidateServer9041() {
        assertFalse(dh.isServerVersionValid("9.0-4.1"));
    }

    @Test
    public void testValidateServer905() {
        assertFalse(dh.isServerVersionValid("9.0-5"));
    }

    @Test
    public void testValidateServer906() {
        assertFalse(dh.isServerVersionValid("9.0-6.2"));
        assertFalse(dh.isServerVersionValid("9.0-6.99"));
    }

    @Test
    public void testValidateServerBeyond907() {
        assertFalse(dh.isServerVersionValid("9.0-7"));
        assertFalse(dh.isServerVersionValid("9.0-7.10"));
    }

    @Test
    public void testValidateServerBeyond909() {
        assertTrue(dh.isServerVersionValid("9.0-11.1"));
        assertTrue(dh.isServerVersionValid("9.0-11"));
        assertFalse(dh.isServerVersionValid("9.0-10.10"));
    }


    @Test
    public void testValidateServerBeyond10() {
        assertFalse(dh.isServerVersionValid("10.0-1.34"));
        assertTrue(dh.isServerVersionValid("10.0-2"));
        assertTrue(dh.isServerVersionValid("10.0-5.10"));
    }

    @Test
    public void testValidateServer10Nightly() {
        assertFalse(dh.isServerVersionValid("10.0-20170801"));
    }

    @Test
    public void testValidateServer10NightlyValid() {
        assertFalse(dh.isServerVersionValid("10.0-20180505"));
    }

    @Test
    public void testPreFlightCheckNoHubInstalled() {
        List<Namespace> list = new ArrayList<>();
        expect(serverManager.getAsXml()).andReturn(new ResourcesFragment(new Fragment("<server-default-list xmlns=\"http://marklogic.com/manage/servers\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://marklogic.com/manage/servers manage-servers.xsd\"> <meta> <uri>/manage/v2/servers</uri> <current-time>2017-10-01T19:15:38.140598-04:00</current-time> <elapsed-time units=\"sec\">0.030447</elapsed-time> </meta> <relations> <relation-group array=\"true\"> <typeref>groups</typeref> <relation-count units=\"quantity\">1</relation-count> <relation array=\"true\"> <uriref>/manage/v2/groups/Default</uriref> <idref>3341249095562999141</idref> <nameref>Default</nameref> </relation> </relation-group> </relations> <list-items> <list-count units=\"quantity\">8</list-count> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/Admin?group-id=Default</uriref> <kindref>http</kindref> <content-db>Security</content-db> <idref>7776582106827683360</idref> <nameref>Admin</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/App-Services?group-id=Default</uriref> <kindref>http</kindref> <content-db>Documents</content-db> <modules-db>Modules</modules-db> <idref>4626187627163603518</idref> <nameref>App-Services</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/HealthCheck?group-id=Default</uriref> <kindref>http</kindref> <content-db>App-Services</content-db> <idref>16530884482127520539</idref> <nameref>HealthCheck</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/Manage?group-id=Default</uriref> <kindref>http</kindref> <content-db>App-Services</content-db> <idref>15392081774558336614</idref> <nameref>Manage</nameref> </list-item> </list-items> <related-views> <related-view array=\"true\"> <view-type>root</view-type> <view-name>default</view-name> <view-uri>/manage/v2</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>metrics</view-name> <view-uri>/manage/v2/servers?view=metrics</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>package</view-name> <view-uri>/manage/v2/servers?view=package</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>schema</view-name> <view-uri>/manage/v2/servers?view=schema</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>status</view-name> <view-uri>/manage/v2/servers?view=status</view-uri> </related-view> </related-views> </server-default-list>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("Admin")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>Admin</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>Admin/</root> <authentication>digest</authentication> <port>8001</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>10800</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>false</debug-allow> <profile-allow>false</profile-allow> <default-xquery-version>0.9-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>/error-switch.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>rewriter.xqy</url-rewriter> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>Security</content-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("App-Services")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>App-Services</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>/</root> <authentication>digest</authentication> <port>8000</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>/MarkLogic/rest-api/8000-error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>/MarkLogic/rest-api/8000-rewriter.xml</url-rewriter> <rewrite-resolves-globally>true</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>Documents</content-database> <modules-database>Modules</modules-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("HealthCheck")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>HealthCheck</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>HealthCheck/</root> <authentication>application-level</authentication> <port>7997</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>2</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler/> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter/> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>App-Services</content-database> <default-user>healthcheck</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("Manage")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>Manage</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>Apps/</root> <authentication>digest</authentication> <port>8002</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>manage/error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>manage/rewriter.xqy</url-rewriter> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>App-Services</content-database> <default-user>nobody</default-user> <privilege>http://marklogic.com/xdmp/privileges/manage</privilege> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(versions.getMarkLogicVersion()).andReturn("9.0-19.1");
        replay(dh, serverManager, versions);

        dh.runPreInstallCheck(serverManager);
        assertTrue(dh.isServerVersionOk());
        assertFalse(dh.isPortInUse(DatabaseKind.STAGING));
        assertFalse(dh.isPortInUse(DatabaseKind.FINAL));
        assertFalse(dh.isPortInUse(DatabaseKind.JOB));
        assertTrue(dh.isSafeToInstall());
    }

    @Test
    public void testPreFlightCheckHubAlreadyInstalled() {
        List<Namespace> list = new ArrayList<>();
        expect(serverManager.getAsXml()).andReturn(new ResourcesFragment(new Fragment("<server-default-list xsi:schemaLocation=\"http://marklogic.com/manage/servers manage-servers.xsd\" xmlns=\"http://marklogic.com/manage/servers\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"> <meta> <uri>/manage/v2/servers</uri> <current-time>2017-10-01T19:15:38.140598-04:00</current-time> <elapsed-time units=\"sec\">0.030447</elapsed-time> </meta> <relations> <relation-group array=\"true\"> <typeref>groups</typeref> <relation-count units=\"quantity\">1</relation-count> <relation array=\"true\"> <uriref>/manage/v2/groups/Default</uriref> <idref>3341249095562999141</idref> <nameref>Default</nameref> </relation> </relation-group> </relations> <list-items> <list-count units=\"quantity\">8</list-count> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/Admin?group-id=Default</uriref> <kindref>http</kindref> <content-db>Security</content-db> <idref>7776582106827683360</idref> <nameref>Admin</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/App-Services?group-id=Default</uriref> <kindref>http</kindref> <content-db>Documents</content-db> <modules-db>Modules</modules-db> <idref>4626187627163603518</idref> <nameref>App-Services</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/data-hub-FINAL?group-id=Default</uriref> <kindref>http</kindref> <content-db>data-hub-FINAL</content-db> <modules-db>data-hub-MODULES</modules-db> <idref>15427288426559314135</idref> <nameref>data-hub-FINAL</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/data-hub-JOBS?group-id=Default</uriref> <kindref>http</kindref> <content-db>data-hub-JOBS</content-db> <modules-db>data-hub-MODULES</modules-db> <idref>5586643511435004736</idref> <nameref>data-hub-JOBS</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/data-hub-STAGING?group-id=Default</uriref> <kindref>http</kindref> <content-db>data-hub-STAGING</content-db> <modules-db>data-hub-MODULES</modules-db> <idref>10842453788764821876</idref> <nameref>data-hub-STAGING</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/data-hub-TRACING?group-id=Default</uriref> <kindref>http</kindref> <content-db>data-hub-TRACING</content-db> <modules-db>data-hub-MODULES</modules-db> <idref>16866661289646622013</idref> <nameref>data-hub-TRACING</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/HealthCheck?group-id=Default</uriref> <kindref>http</kindref> <content-db>App-Services</content-db> <idref>16530884482127520539</idref> <nameref>HealthCheck</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/Manage?group-id=Default</uriref> <kindref>http</kindref> <content-db>App-Services</content-db> <idref>15392081774558336614</idref> <nameref>Manage</nameref> </list-item> </list-items> <related-views> <related-view array=\"true\"> <view-type>root</view-type> <view-name>default</view-name> <view-uri>/manage/v2</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>metrics</view-name> <view-uri>/manage/v2/servers?view=metrics</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>package</view-name> <view-uri>/manage/v2/servers?view=package</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>schema</view-name> <view-uri>/manage/v2/servers?view=schema</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>status</view-name> <view-uri>/manage/v2/servers?view=status</view-uri> </related-view> </related-views> </server-default-list>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("Admin")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>Admin</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>Admin/</root> <authentication>digest</authentication> <port>8001</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>10800</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>false</debug-allow> <profile-allow>false</profile-allow> <default-xquery-version>0.9-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>/error-switch.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>rewriter.xqy</url-rewriter> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>Security</content-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("App-Services")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>App-Services</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>/</root> <authentication>digest</authentication> <port>8000</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>/MarkLogic/rest-api/8000-error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>/MarkLogic/rest-api/8000-rewriter.xml</url-rewriter> <rewrite-resolves-globally>true</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>Documents</content-database> <modules-database>Modules</modules-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("data-hub-FINAL")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>data-hub-FINAL</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>/</root> <port>8011</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <authentication>digest</authentication> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>true</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>json</default-error-format> <error-handler>/MarkLogic/rest-api/error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>/MarkLogic/rest-api/rewriter.xml</url-rewriter> <rewrite-resolves-globally>true</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>data-hub-FINAL</content-database> <modules-database>data-hub-MODULES</modules-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("data-hub-JOBS")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>data-hub-JOBS</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>/</root> <port>8013</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <authentication>digest</authentication> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>true</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>json</default-error-format> <error-handler>/MarkLogic/rest-api/error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>/MarkLogic/rest-api/rewriter.xml</url-rewriter> <rewrite-resolves-globally>true</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>data-hub-JOBS</content-database> <modules-database>data-hub-MODULES</modules-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("data-hub-STAGING")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>data-hub-STAGING</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>/</root> <port>8010</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <authentication>digest</authentication> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>true</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>json</default-error-format> <error-handler>/MarkLogic/rest-api/error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>/dhf-hub/5/rest-api/rewriter.xml</url-rewriter> <rewrite-resolves-globally>true</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>data-hub-STAGING</content-database> <modules-database>data-hub-MODULES</modules-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("data-hub-TRACING")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>data-hub-TRACING</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>/</root> <port>8012</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <authentication>digest</authentication> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>true</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>json</default-error-format> <error-handler>/MarkLogic/rest-api/error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>/data-hub/5/tracing/tracing-rewriter.xml</url-rewriter> <rewrite-resolves-globally>true</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>data-hub-TRACING</content-database> <modules-database>data-hub-MODULES</modules-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("HealthCheck")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>HealthCheck</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>HealthCheck/</root> <authentication>application-level</authentication> <port>7997</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>2</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler/> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter/> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>App-Services</content-database> <default-user>healthcheck</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("Manage")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>Manage</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>Apps/</root> <authentication>digest</authentication> <port>8002</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>manage/error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>manage/rewriter.xqy</url-rewriter> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>App-Services</content-database> <default-user>nobody</default-user> <privilege>http://marklogic.com/xdmp/privileges/manage</privilege> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(versions.getMarkLogicVersion()).andReturn("9.0-11");
        replay(dh, serverManager, versions);

        dh.runPreInstallCheck(serverManager);
        assertTrue(dh.isServerVersionOk());
        assertFalse(dh.isPortInUse(DatabaseKind.STAGING));
        assertFalse(dh.isPortInUse(DatabaseKind.FINAL));
        assertFalse(dh.isPortInUse(DatabaseKind.JOB));
        assertTrue(dh.isSafeToInstall());
    }

    @Test
    public void testPreFlightCheckStagingPortTaken() {
        Assumptions.assumeTrue(!getHubConfig().getIsProvisionedEnvironment());
        List<Namespace> list = new ArrayList<>();
        expect(serverManager.getAsXml()).andReturn(new ResourcesFragment(new Fragment("<server-default-list xmlns=\"http://marklogic.com/manage/servers\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://marklogic.com/manage/servers manage-servers.xsd\"> <meta> <uri>/manage/v2/servers</uri> <current-time>2017-10-01T19:15:38.140598-04:00</current-time> <elapsed-time units=\"sec\">0.030447</elapsed-time> </meta> <relations> <relation-group array=\"true\"> <typeref>groups</typeref> <relation-count units=\"quantity\">1</relation-count> <relation array=\"true\"> <uriref>/manage/v2/groups/Default</uriref> <idref>3341249095562999141</idref> <nameref>Default</nameref> </relation> </relation-group> </relations> <list-items> <list-count units=\"quantity\">8</list-count> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/Admin?group-id=Default</uriref> <kindref>http</kindref> <content-db>Security</content-db> <idref>7776582106827683360</idref> <nameref>Admin</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/App-Services?group-id=Default</uriref> <kindref>http</kindref> <content-db>Documents</content-db> <modules-db>Modules</modules-db> <idref>4626187627163603518</idref> <nameref>App-Services</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/port-stealer?group-id=Default</uriref> <kindref>http</kindref> <content-db>data-hub-STAGING</content-db> <modules-db>data-hub-MODULES</modules-db> <idref>10842453788764821876</idref> <nameref>port-stealer</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/HealthCheck?group-id=Default</uriref> <kindref>http</kindref> <content-db>App-Services</content-db> <idref>16530884482127520539</idref> <nameref>HealthCheck</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/Manage?group-id=Default</uriref> <kindref>http</kindref> <content-db>App-Services</content-db> <idref>15392081774558336614</idref> <nameref>Manage</nameref> </list-item> </list-items> <related-views> <related-view array=\"true\"> <view-type>root</view-type> <view-name>default</view-name> <view-uri>/manage/v2</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>metrics</view-name> <view-uri>/manage/v2/servers?view=metrics</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>package</view-name> <view-uri>/manage/v2/servers?view=package</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>schema</view-name> <view-uri>/manage/v2/servers?view=schema</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>status</view-name> <view-uri>/manage/v2/servers?view=status</view-uri> </related-view> </related-views> </server-default-list>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("Admin")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>Admin</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>Admin/</root> <authentication>digest</authentication> <port>8001</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>10800</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>false</debug-allow> <profile-allow>false</profile-allow> <default-xquery-version>0.9-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>/error-switch.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>rewriter.xqy</url-rewriter> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>Security</content-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("App-Services")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>App-Services</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>/</root> <authentication>digest</authentication> <port>8000</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>/MarkLogic/rest-api/8000-error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>/MarkLogic/rest-api/8000-rewriter.xml</url-rewriter> <rewrite-resolves-globally>true</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>Documents</content-database> <modules-database>Modules</modules-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("port-stealer")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>port-stealer</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>/</root> <port>8010</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <authentication>digest</authentication> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>true</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>json</default-error-format> <error-handler>/MarkLogic/rest-api/error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>/MarkLogic/rest-api/rewriter.xml</url-rewriter> <rewrite-resolves-globally>true</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>data-hub-FINAL</content-database> <modules-database>data-hub-MODULES</modules-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("HealthCheck")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>HealthCheck</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>HealthCheck/</root> <authentication>application-level</authentication> <port>7997</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>2</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler/> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter/> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>App-Services</content-database> <default-user>healthcheck</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("Manage")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>Manage</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>Apps/</root> <authentication>digest</authentication> <port>8002</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>manage/error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>manage/rewriter.xqy</url-rewriter> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>App-Services</content-database> <default-user>nobody</default-user> <privilege>http://marklogic.com/xdmp/privileges/manage</privilege> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(versions.getMarkLogicVersion()).andReturn("10.0-9");
        replay(serverManager, dh, versions);

        dh.runPreInstallCheck(serverManager);
        assertTrue(dh.isServerVersionOk());
        assertTrue(dh.isPortInUse(DatabaseKind.STAGING));
        assertEquals("port-stealer", dh.getPortInUseBy(DatabaseKind.STAGING));
        assertFalse(dh.isPortInUse(DatabaseKind.FINAL));
        assertFalse(dh.isPortInUse(DatabaseKind.JOB));
        assertFalse(dh.isSafeToInstall());
    }

    @Test
    public void testPreFlightCheckStagingPortTakenAndBadVersion() {
        Assumptions.assumeTrue(!getHubConfig().getIsProvisionedEnvironment());
        List<Namespace> list = new ArrayList<>();
        expect(serverManager.getAsXml()).andReturn(new ResourcesFragment(new Fragment("<server-default-list xmlns=\"http://marklogic.com/manage/servers\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://marklogic.com/manage/servers manage-servers.xsd\"> <meta> <uri>/manage/v2/servers</uri> <current-time>2017-10-01T19:15:38.140598-04:00</current-time> <elapsed-time units=\"sec\">0.030447</elapsed-time> </meta> <relations> <relation-group array=\"true\"> <typeref>groups</typeref> <relation-count units=\"quantity\">1</relation-count> <relation array=\"true\"> <uriref>/manage/v2/groups/Default</uriref> <idref>3341249095562999141</idref> <nameref>Default</nameref> </relation> </relation-group> </relations> <list-items> <list-count units=\"quantity\">8</list-count> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/Admin?group-id=Default</uriref> <kindref>http</kindref> <content-db>Security</content-db> <idref>7776582106827683360</idref> <nameref>Admin</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/App-Services?group-id=Default</uriref> <kindref>http</kindref> <content-db>Documents</content-db> <modules-db>Modules</modules-db> <idref>4626187627163603518</idref> <nameref>App-Services</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/port-stealer?group-id=Default</uriref> <kindref>http</kindref> <content-db>data-hub-STAGING</content-db> <modules-db>data-hub-MODULES</modules-db> <idref>10842453788764821876</idref> <nameref>port-stealer</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/HealthCheck?group-id=Default</uriref> <kindref>http</kindref> <content-db>App-Services</content-db> <idref>16530884482127520539</idref> <nameref>HealthCheck</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/Manage?group-id=Default</uriref> <kindref>http</kindref> <content-db>App-Services</content-db> <idref>15392081774558336614</idref> <nameref>Manage</nameref> </list-item> </list-items> <related-views> <related-view array=\"true\"> <view-type>root</view-type> <view-name>default</view-name> <view-uri>/manage/v2</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>metrics</view-name> <view-uri>/manage/v2/servers?view=metrics</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>package</view-name> <view-uri>/manage/v2/servers?view=package</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>schema</view-name> <view-uri>/manage/v2/servers?view=schema</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>status</view-name> <view-uri>/manage/v2/servers?view=status</view-uri> </related-view> </related-views> </server-default-list>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("Admin")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>Admin</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>Admin/</root> <authentication>digest</authentication> <port>8001</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>10800</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>false</debug-allow> <profile-allow>false</profile-allow> <default-xquery-version>0.9-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>/error-switch.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>rewriter.xqy</url-rewriter> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>Security</content-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("App-Services")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>App-Services</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>/</root> <authentication>digest</authentication> <port>8000</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>/MarkLogic/rest-api/8000-error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>/MarkLogic/rest-api/8000-rewriter.xml</url-rewriter> <rewrite-resolves-globally>true</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>Documents</content-database> <modules-database>Modules</modules-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("port-stealer")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>port-stealer</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>/</root> <port>8010</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <authentication>digest</authentication> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>true</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>json</default-error-format> <error-handler>/MarkLogic/rest-api/error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>/MarkLogic/rest-api/rewriter.xml</url-rewriter> <rewrite-resolves-globally>true</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>data-hub-FINAL</content-database> <modules-database>data-hub-MODULES</modules-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("HealthCheck")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>HealthCheck</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>HealthCheck/</root> <authentication>application-level</authentication> <port>7997</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>2</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler/> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter/> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>App-Services</content-database> <default-user>healthcheck</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("Manage")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>Manage</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>Apps/</root> <authentication>digest</authentication> <port>8002</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>manage/error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>manage/rewriter.xqy</url-rewriter> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>App-Services</content-database> <default-user>nobody</default-user> <privilege>http://marklogic.com/xdmp/privileges/manage</privilege> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(versions.getMarkLogicVersion()).andReturn("9.0-1");
        replay(dh, versions, serverManager);

        dh.runPreInstallCheck(serverManager);
        assertFalse(dh.isServerVersionOk());
        assertTrue(dh.isPortInUse(DatabaseKind.STAGING));
        assertEquals("port-stealer", dh.getPortInUseBy(DatabaseKind.STAGING));
        assertFalse(dh.isPortInUse(DatabaseKind.FINAL));
        assertFalse(dh.isPortInUse(DatabaseKind.JOB));
        assertFalse(dh.isSafeToInstall());
    }

    @Test
    public void testPreFlightCheckFinalPortTaken() {
        Assumptions.assumeTrue(!getHubConfig().getIsProvisionedEnvironment());
        List<Namespace> list = new ArrayList<>();
        expect(serverManager.getAsXml()).andReturn(new ResourcesFragment(new Fragment("<server-default-list xmlns=\"http://marklogic.com/manage/servers\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://marklogic.com/manage/servers manage-servers.xsd\"> <meta> <uri>/manage/v2/servers</uri> <current-time>2017-10-01T19:15:38.140598-04:00</current-time> <elapsed-time units=\"sec\">0.030447</elapsed-time> </meta> <relations> <relation-group array=\"true\"> <typeref>groups</typeref> <relation-count units=\"quantity\">1</relation-count> <relation array=\"true\"> <uriref>/manage/v2/groups/Default</uriref> <idref>3341249095562999141</idref> <nameref>Default</nameref> </relation> </relation-group> </relations> <list-items> <list-count units=\"quantity\">8</list-count> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/Admin?group-id=Default</uriref> <kindref>http</kindref> <content-db>Security</content-db> <idref>7776582106827683360</idref> <nameref>Admin</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/App-Services?group-id=Default</uriref> <kindref>http</kindref> <content-db>Documents</content-db> <modules-db>Modules</modules-db> <idref>4626187627163603518</idref> <nameref>App-Services</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/port-stealer?group-id=Default</uriref> <kindref>http</kindref> <content-db>data-hub-STAGING</content-db> <modules-db>data-hub-MODULES</modules-db> <idref>10842453788764821876</idref> <nameref>port-stealer</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/HealthCheck?group-id=Default</uriref> <kindref>http</kindref> <content-db>App-Services</content-db> <idref>16530884482127520539</idref> <nameref>HealthCheck</nameref> </list-item> <list-item array=\"true\"> <relation-id>3341249095562999141</relation-id> <groupnameref>Default</groupnameref> <uriref>/manage/v2/servers/Manage?group-id=Default</uriref> <kindref>http</kindref> <content-db>App-Services</content-db> <idref>15392081774558336614</idref> <nameref>Manage</nameref> </list-item> </list-items> <related-views> <related-view array=\"true\"> <view-type>root</view-type> <view-name>default</view-name> <view-uri>/manage/v2</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>metrics</view-name> <view-uri>/manage/v2/servers?view=metrics</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>package</view-name> <view-uri>/manage/v2/servers?view=package</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>schema</view-name> <view-uri>/manage/v2/servers?view=schema</view-uri> </related-view> <related-view array=\"true\"> <view-type>list</view-type> <view-name>status</view-name> <view-uri>/manage/v2/servers?view=status</view-uri> </related-view> </related-views> </server-default-list>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("Admin")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>Admin</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>Admin/</root> <authentication>digest</authentication> <port>8001</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>10800</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>false</debug-allow> <profile-allow>false</profile-allow> <default-xquery-version>0.9-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>/error-switch.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>rewriter.xqy</url-rewriter> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>Security</content-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("App-Services")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>App-Services</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>/</root> <authentication>digest</authentication> <port>8000</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>/MarkLogic/rest-api/8000-error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>/MarkLogic/rest-api/8000-rewriter.xml</url-rewriter> <rewrite-resolves-globally>true</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>Documents</content-database> <modules-database>Modules</modules-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("port-stealer")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>port-stealer</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>/</root> <port>8011</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <authentication>digest</authentication> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>true</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>json</default-error-format> <error-handler>/MarkLogic/rest-api/error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>/MarkLogic/rest-api/rewriter.xml</url-rewriter> <rewrite-resolves-globally>true</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>data-hub-FINAL</content-database> <modules-database>data-hub-MODULES</modules-database> <default-user>nobody</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("HealthCheck")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>HealthCheck</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>HealthCheck/</root> <authentication>application-level</authentication> <port>7997</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>2</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler/> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter/> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>App-Services</content-database> <default-user>healthcheck</default-user> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(serverManager.getPropertiesAsXml("Manage")).andReturn(new ResourcesFragment(new Fragment("<http-server-properties xmlns=\"http://marklogic.com/manage\"> <server-name>Manage</server-name> <group-name>Default</group-name> <server-type>http</server-type> <enabled>true</enabled> <root>Apps/</root> <authentication>digest</authentication> <port>8002</port> <webDAV>false</webDAV> <execute>true</execute> <display-last-login>false</display-last-login> <address>0.0.0.0</address> <backlog>512</backlog> <threads>32</threads> <request-timeout>30</request-timeout> <keep-alive-timeout>5</keep-alive-timeout> <session-timeout>3600</session-timeout> <max-time-limit>3600</max-time-limit> <default-time-limit>600</default-time-limit> <max-inference-size>500</max-inference-size> <default-inference-size>100</default-inference-size> <static-expires>3600</static-expires> <pre-commit-trigger-depth>1000</pre-commit-trigger-depth> <pre-commit-trigger-limit>10000</pre-commit-trigger-limit> <collation>http://marklogic.com/collation/</collation> <internal-security>true</internal-security> <concurrent-request-limit>0</concurrent-request-limit> <compute-content-length>true</compute-content-length> <log-errors>false</log-errors> <debug-allow>true</debug-allow> <profile-allow>true</profile-allow> <default-xquery-version>1.0-ml</default-xquery-version> <multi-version-concurrency-control>contemporaneous</multi-version-concurrency-control> <distribute-timestamps>fast</distribute-timestamps> <output-sgml-character-entities>none</output-sgml-character-entities> <output-encoding>UTF-8</output-encoding> <output-method>default</output-method> <output-byte-order-mark>default</output-byte-order-mark> <output-cdata-section-namespace-uri/> <output-cdata-section-localname/> <output-doctype-public/> <output-doctype-system/> <output-escape-uri-attributes>default</output-escape-uri-attributes> <output-include-content-type>default</output-include-content-type> <output-indent>default</output-indent> <output-indent-untyped>default</output-indent-untyped> <output-indent-tabs>default</output-indent-tabs> <output-media-type/> <output-normalization-form>none</output-normalization-form> <output-omit-xml-declaration>default</output-omit-xml-declaration> <output-standalone>omit</output-standalone> <output-undeclare-prefixes>default</output-undeclare-prefixes> <output-version/> <output-include-default-attributes>default</output-include-default-attributes> <default-error-format>compatible</default-error-format> <error-handler>manage/error-handler.xqy</error-handler> <schemas/> <namespaces/> <module-locations/> <request-blackouts/> <url-rewriter>manage/rewriter.xqy</url-rewriter> <rewrite-resolves-globally>false</rewrite-resolves-globally> <ssl-allow-sslv3>true</ssl-allow-sslv3> <ssl-allow-tls>true</ssl-allow-tls> <ssl-disable-sslv3>false</ssl-disable-sslv3> <ssl-disable-tlsv1>false</ssl-disable-tlsv1> <ssl-disable-tlsv1-1>false</ssl-disable-tlsv1-1> <ssl-disable-tlsv1-2>false</ssl-disable-tlsv1-2> <ssl-hostname/> <ssl-ciphers>ALL:!LOW:@STRENGTH</ssl-ciphers> <ssl-require-client-certificate>true</ssl-require-client-certificate> <content-database>App-Services</content-database> <default-user>nobody</default-user> <privilege>http://marklogic.com/xdmp/privileges/manage</privilege> </http-server-properties>", list.toArray(new Namespace[]{}))));
        expect(versions.getMarkLogicVersion()).andReturn("9.0-11.1");
        replay(dh, versions, serverManager);

        dh.runPreInstallCheck(serverManager);
        assertTrue(dh.isServerVersionOk());
        assertFalse(dh.isPortInUse(DatabaseKind.STAGING));
        assertTrue(dh.isPortInUse(DatabaseKind.FINAL));
        assertEquals("port-stealer", dh.getPortInUseBy(DatabaseKind.FINAL));
        assertFalse(dh.isPortInUse(DatabaseKind.JOB));
        assertFalse(dh.isSafeToInstall());
    }
}
