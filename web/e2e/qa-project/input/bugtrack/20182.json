{"id":20182, "kind":"Task", "createdAt":"2012-12-03T15:13:07.282613-08:00", "status":"Closed", "title":"interaction between external auth and alerting", "category":"xdmp", "severity":"Major", "priority":{"level":"5", "title":""}, "days":null, "period":{"startDate":null, "endDate":null}, "submittedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"alert:make-rule() takes a user id, and stores it in the database.\r\n\r\nThe alerting API needs to be able to do an xdmp:login() as that user for the purpose of testing if the user's rule should trigger (i.e. document permissions) as well as needs to run the action as that user. We don't have a good way to map that user id to a particular external user.\r\n\r\nWe need to solve this for ML7.", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea3", "fixedin":"7.0-ea3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, {"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}], "attachments":[], "includeInTaskList":false, "proceduralTasks":{"Requirements Task":[], "Functional Specification Task":[], "Test Specification Task":[], "Test Automation Task":[], "Documentation Task":[]}, "subTasks":[], "tags":["xdmp", "wfeick"], "changeHistory":[{"time":"2012-12-03T15:13:07.282613-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-05-06T14:18:23.380508-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"7.0-1", "to":"7.0-ea3"}}, "files":[], "show":true}, {"time":"2013-05-20T15:07:58.267976-07:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"141951", "paths":["xdmp/trunk/src/Modules/MarkLogic/alert.xqy", "xdmp/trunk/src/Config/alert.xsd"], "affectedBugs":[]}, "comment":"bug:20182 alerting for external user"}, {"time":"2013-05-20T15:08:39.504336-07:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-05-20T15:08:39.504336-07:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{"assignTo":{"from":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-05-21T11:11:43.915139-07:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"142018", "paths":["xdmp/trunk/src/Config/alert.xsd"], "affectedBugs":[]}, "comment":"bug:20182 change external user element to optional"}, {"time":"2013-06-10T17:59:55.336591-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}}}, "files":[], "show":true, "comment":"Hi Arthur,\r\n\r\nAs I just showed it to you, I am not able to create a rule as external user by passing external userid to alert:make-rule() API\r\n\r\nSteps:\r\n1. create external security profile with ldap for authN and authZ - ldap10-a\r\n2. setup alerting config: \r\n      xquery version \"1.0-ml\";\r\n          import module namespace alert = \"http://marklogic.com/xdmp/alert\" \r\n                  at \"/MarkLogic/alert.xqy\";\r\n\r\n          let $config := alert:make-config(\r\n                         \"alerting-uri-for-external-security\",\r\n                         \"Test Alerting App for external security\",\r\n                         \"Alerting config for test app\",\r\n                          <alert:options/> )\r\n           return\r\n           alert:config-insert($config)\r\n\r\n3. create action for alerting:\r\n xquery version \"1.0-ml\";\r\n          import module namespace alert = \"http://marklogic.com/xdmp/alert\" \r\n                  at \"/MarkLogic/alert.xqy\";\r\n\r\n           let $action := alert:make-action(\r\n                          \"insert-document\", \r\n                          \"Write to documents database\",\r\n                          xdmp:modules-database(),\r\n                          xdmp:modules-root(), \r\n                         \"/extsec-modules/extsec10-alert-action.xqy\",\r\n                         <alert:options>nothing to specify here</alert:options> )\r\n                         return\r\n                        alert:action-insert(\"alerting-uri-for-external-security\", $action)\r\n\r\n4. try to create a rule:\r\n xquery version \"1.0-ml\";\r\n           import module namespace alert = \"http://marklogic.com/xdmp/alert\" \r\n                  at \"/MarkLogic/alert.xqy\";\r\n          let $user := \"user4\"\r\n          let $ext-sec-prof-name := \"ldap10-a\"\r\n          let $ext-sec-prof := xdmp:external-security($ext-sec-prof-name)\r\n          let $logit := xdmp:log(concat(\"External Security Profile ID for \", $ext-sec-prof-name, \" is : \",$ext-sec-prof))\r\n          let $ext-userid := xdmp:user($user,$ext-sec-prof, fn:false())\r\n          let $logit := xdmp:log(fn:concat(\"Userid of external user \", $user, \" is : \", $ext-userid))\r\n          let $rule := alert:make-rule(\r\n                         \"rule1\", \r\n                         \"hello world rule 1\",\r\n                          $ext-userid,\r\n                         cts:word-query(\"hello world\"),\r\n                        \"insert-document\",\r\n                        <alert:options/> )\r\n          return\r\n          alert:rule-insert(\"alerting-uri-for-external-security\", $rule)\r\n\r\n ==>\r\n[1.0-ml] SEC-USERDNE: (err:FOER0000) User does not exist: sec:user-id = 1489802874050732804\r\n\r\nStack Trace\r\nIn /MarkLogic/security.xqy on line 5244\r\nIn sec:get-user-names(xs:unsignedLong(\"1489802874050732804\"))\r\n\r\n$user-ids := xs:unsignedLong(\"1489802874050732804\")\r\n$assert := ()\r\n$col := \"http://marklogic.com/xdmp/security\"\r\n$u-id := xs:unsignedLong(\"1489802874050732804\")\r\n$user := ()\r\nAt line 5 column 7:\r\n\r\nIn xdmp:eval(\"import module 'http://marklogic.com/xdmp/security' at '/MarkLogi...\", (fn:QName(\"\", \"user-id\"), xs:unsignedLong(\"1489802874050732804\")), <options xmlns=\"xdmp:eval\"><database>8919867232453363200</database></options>)\r\n\r\n3. at \"/MarkLogic/alert.xqy\";\r\n4. let $user := \"user4\"\r\n5. let $ext-sec-prof-name := \"ldap10-a\"\r\n6. let $ext-sec-prof := xdmp:external-security($ext-sec-prof-name)\r\n7. let $logit := xdmp:log(concat(\"External Security Profile ID for \", $ext-sec-prof-name, \" is : \",$ext-sec-prof))\r\nIn /MarkLogic/alert.xqy on line 1449\r\nIn alert:rule-insert(\"alerting-uri-for-external-security\", <alert:rule id=\"3400166841451783087\" xmlns:alert=\"http://marklogic.com/xdmp/alert\"><alert:name>rule1</alert:name><alert:description>hello world rul...</alert:rule>)\r\n\r\n$collection-uri := \"alerting-uri-for-external-security\"\r\n$rule := <alert:rule id=\"3400166841451783087\" xmlns:alert=\"http://marklogic.com/xdmp/alert\"><alert:name>rule1</alert:name><alert:description>hello world rul...</alert:rule>\r\n$tmp := ()\r\n$tmp := ()\r\n$validate-query := cts:word-query(\"hello world\", (\"lang=en\"), 1)\r\n$user-id := xs:unsignedLong(\"1489802874050732804\")\r\n$config := fn:doc(\"alerting-uri-for-external-security/config.xml\")/alert:config\r\n$rule-id := xs:unsignedLong(\"3400166841451783087\")\r\n$rule-url := \"alerting-uri-for-external-security/rules/3400166841451783087.xml\"\r\n$existing-rule := ()\r\n$tmp := ()\r\nAt line 18 column 10:\r\n\r\nIn xdmp:eval(\"xquery version &quot;1.0-ml&quot;;&#10; import module ...\", (), <options xmlns=\"xdmp:eval\"><database>8919867232453363200</database><default-xquery-version>...</options>)\r\n\r\n$user := \"alerting-uri-for-external-security\"\r\n$ext-sec-prof-name := <alert:rule id=\"3400166841451783087\" xmlns:alert=\"http://marklogic.com/xdmp/alert\"><alert:name>rule1</alert:name><alert:description>hello world rul...</alert:rule>\r\n\r\n16. <alert:options/> )\r\n17. return\r\n18. alert:rule-insert(\"alerting-uri-for-external-security\", $rule)\r\n19.\r\nIn /MarkLogic/appservices/qconsole/qconsole-amped.xqy on line 180\r\nIn amped-qconsole:qconsole-eval(\"xquery version &quot;1.0-ml&quot;;&#10; import module ...\", (), <options xmlns=\"xdmp:eval\"><database>8919867232453363200</database><default-xquery-version>...</options>)\r\n\r\n$xquery := \"xquery version &quot;1.0-ml&quot;;&#10; import module ...\"\r\n$vars := ()\r\n$options := <options xmlns=\"xdmp:eval\"><database>8919867232453363200</database><default-xquery-version>...</options>"}, {"time":"2013-06-10T17:59:55.336591-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-06-10T18:39:30.404141-07:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"143866", "paths":["xdmp/trunk/src/Modules/MarkLogic/alert.xqy"], "affectedBugs":[]}, "comment":"bug:20182 external auth and alerting"}, {"time":"2013-06-10T18:39:52.416466-07:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-06-10T18:39:52.416466-07:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{"assignTo":{"from":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-06-12T12:23:41.110624-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"status":{"from":null, "to":"Ship"}, "assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified with MarkLogic-7.0-20130612\r\n\r\nTest in regression: extsec-ldap-10-alerting.xml\r\nTestsuite: extsec\r\n\r\nAdditional issue is tracked via following bug:\r\nBug 22571 -  SEC-USERDNE error when running alert:make-rule as external user"}], "updatedAt":"2013-06-12T12:23:41.110624-07:00", "fixedAt":"2013-06-10T18:39:52.416466-07:00", "fixedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "shippedAt":"2013-06-12T12:23:41.110624-07:00", "shippedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}