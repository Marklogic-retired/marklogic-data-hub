{"id":20688, "kind":"Bug", "createdAt":"2013-02-04T03:57:48.491532-08:00", "status":"Closed", "title":"element-query containing multiple anded element-word-queries yields incorrect search results", "category":"search", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"element-query containing multiple anded element-word-queries yields incorrect search results\r\n\r\nSteps to reproduce:\r\n\r\n1. create a DB with forest\r\n2. set dir create to manual, disable maintain-last-modified, maintain-directory-last-modified, inherit-permissions, inherit-collections, inherit-quality.\r\n3. enable word searches, word positions and element word positions on this DB.\r\n4. load test data\r\n\r\n                xquery version \"1.0-ml\";\r\n                (xdmp:document-insert(\"test1\", <d:Doc id=\"test1\" xmlns:d=\"urn:ns1\">\r\n                  <d:Group>\r\n                                <d:Outer>\r\n                                  <d:FirstNode>blah</d:FirstNode>\r\n                                  <d:SecondNode>bar baz</d:SecondNode>\r\n                                </d:Outer>\r\n                  </d:Group>\r\n                  <d:Group>\r\n                                <d:Outer>\r\n                                  <d:FirstNode>foo</d:FirstNode>\r\n                                  <d:SecondNode>bar baz</d:SecondNode>\r\n                                </d:Outer>\r\n                  </d:Group>\r\n                </d:Doc>, (), (\"testColl\")),\r\n                xdmp:document-insert(\"test2\", <d:Doc id=\"test2\" xmlns:d=\"urn:ns1\">\r\n                  <d:Group>\r\n                                <d:Outer>\r\n                                  <d:FirstNode>foo</d:FirstNode>\r\n                                  <d:SecondNode>bar baz</d:SecondNode>\r\n                                </d:Outer>\r\n                  </d:Group>\r\n                </d:Doc>, (), (\"testColl\")))\r\n5. Run following query:\r\n\r\n                xquery version \"1.0-ml\";\r\n                declare namespace ns1=\"urn:ns1\";\r\n                declare namespace ns2=\"urn:ns2\";\r\n\r\n                let $outer-qnames := (xs:QName(\"ns1:Outer\"))\r\n                let $first-qnames := (xs:QName(\"ns1:FirstNode\"), xs:QName(\"ns2:FirstNode\"))\r\n                let $second-qnames := (xs:QName(\"ns1:SecondNode\"), xs:QName(\"ns2:SecondNode\"))\r\n\r\n                let $q :=\r\n                cts:and-query((\r\n                  cts:collection-query(\"testColl\"),\r\n                  cts:element-query($outer-qnames,\r\n                                cts:and-query((\r\n                                  cts:element-word-query($first-qnames, \"foo\"),\r\n                                  cts:element-word-query($second-qnames, \"bar baz\")\r\n                                ))\r\n                  )\r\n                ))\r\n                let $srch := cts:search(fn:doc(), $q)\r\n                for $doc in $srch\r\n                return\r\n                ( fn:base-uri($doc), \" \")\r\n\r\nActual Result: test2\r\nExpected result: test1 test2", "samplequery":"", "sampledata":"", "version":"5.0-nightly", "tofixin":"5.0-5", "fixedin":"5.0-5", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, {"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, {"username":"smazer", "name":"Sara  Mazer", "email":"Sara.Mazer@marklogic.com"}, {"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"nightly", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["search", "iagrawal"], "changeHistory":[{"time":"2013-02-04T03:57:48.491532-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-04T04:07:29.731178-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2013-02-04T08:23:00.777937-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"130555", "paths":["xdmp/branches/b5_0/src/SearchBuiltins.cpp"], "affectedBugs":[]}, "comment":"Bug:20688 more element-word-query cases"}, {"time":"2013-02-04T08:24:12.331152-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}}}, "files":[], "show":true, "comment":"Fixed 5.0-20120205"}, {"time":"2013-02-04T08:24:12.331152-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-04T08:42:40.227327-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-06T00:59:28.977013-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on ML 20130205. The test bug12625.xml is passing now,Hence shipping the bug."}, {"time":"2013-02-06T00:59:28.977013-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-25T17:04:35.440093-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-02-25T17:04:35.440093-08:00", "fixedAt":"2013-02-04T08:24:12.331152-08:00", "fixedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "shippedAt":"2013-02-06T00:59:28.977013-08:00", "shippedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "closedAt":"2013-02-25T17:04:35.440093-08:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}