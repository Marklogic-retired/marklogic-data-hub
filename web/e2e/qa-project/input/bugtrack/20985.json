{"id":20985, "kind":"Bug", "createdAt":"2013-03-01T11:09:09.987525-08:00", "status":"Closed", "title":"Deleting App-Services database prevents future upgrades from completing", "category":"Upgrade", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"fsalonga", "name":"Frank Salonga", "email":"franklin.salonga@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"from this case: https://help.marklogic.com/staff/Tickets/Ticket/View/12558\r\n\r\nIf a user deletes their App-Services database, the upgrade script never completes, which means the user is now locked out of the Admin UI with an error.\r\n\r\nEither the upgrade script should be smarter about what to do if the App-Services database (or app servers) are missing, or we should not allow users to delete databases or app servers without which their instance is broken.", "samplequery":"", "sampledata":"", "version":"6.0-2.2", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"linux(64-bit)", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"fsalonga", "name":"Frank Salonga", "email":"franklin.salonga@marklogic.com"}, {"username":"mbhatnag", "name":"Mayank Bhatnagar", "email":"Mayank.Bhatnagar@marklogic.com"}, {"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, {"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"Upgrade to MarkLogic 6 fails if App-Services database does not exist", "supportDescription":"If a user has manually removed the App-Services database, the upgrade to MarkLogic 6 fails with the error ADMIN-NOSUCHDATABASE.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"Medium", "title":"Requires significant or unnatural effort to work around issue or to prevent significant business impact"}, "workaround":"Creating a new database named App-Services will prevent the error at upgrade time. The database can be optionally deleted immediately after upgrade completes."}, "tags":["Upgrade", "fsalonga"], "changeHistory":[{"time":"2013-03-01T17:29:27.145038-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-01T17:29:27.145038-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-01T17:29:27.145038-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-03-04T11:50:24.367112-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"From the support case, here's the stack: This occurs in upgrade.xqy immediately after the comment (: begin putative ticket api change :)\r\n\r\n500: Internal Server Error\r\n\r\nADMIN-NOSUCHDATABASE: (err:FOER0000) No such database App-Services\r\n\r\nIn /MarkLogic/admin.xqy on line 11726\r\n\r\nIn database-get-value-by-name(<configuration/>, \"App-Services\",\r\n\r\n\"db:database-id\")\r\n\r\n\r\n\r\n$config = <configuration/>\r\n\r\n$database-name = \"App-Services\"\r\n\r\n$name = \"db:database-id\"\r\n\r\n$db-config = <databases\r\n\r\nxsi:schemaLocation=\"http://marklogic.com/xdmp/database database.xsd\"\r\n\r\ntimestamp=\"13619974440535800\"\r\n\r\nxmlns=\"http://marklogic.com/xdmp/database\"\r\n\r\nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"><database><database-id>3689828479196801716</database-id><databas...</databases>\r\n\r\n\r\n\r\nIn /MarkLogic/admin.xqy on line 4067\r\n\r\nIn admin:database-get-id(<configuration/>, \"App-Services\")\r\n\r\n\r\n\r\n$config = <configuration/>\r\n\r\n$database-name = \"App-Services\"\r\n\r\n\r\n\r\nIn /lib/upgrade.xqy on line 1211\r\n\r\nIn databases-51(<configuration/>)\r\n\r\n\r\n\r\n$config = <configuration/>\r\n\r\n$config = <configuration/>\r\n\r\n\r\n\r\nIn /lib/upgrade.xqy on line 1254\r\n\r\nIn upgrade-51()\r\n\r\n\r\n\r\n$_ = ()\r\n\r\n$upg = ()\r\n\r\n$config = <configuration/>\r\n\r\n$config = <configuration/>\r\n\r\n$restart = ()\r\n\r\n\r\n\r\nIn /lib/upgrade.xqy on line 1305\r\n\r\nIn config-upgrade()\r\n\r\n\r\n\r\n$s-output = ()\r\n\r\n$cl-output = ()\r\n\r\n$db-schemaroot = <xs:schema\r\n\r\ntargetNamespace=\"http://marklogic.com/xdmp/database\"\r\n\r\nxsi:schemaLocation=\"http://www.w3.org/2001/XMLSchema XMLSchema.xsd\r\n\r\nhttp://marklogic....\" attributeFormDefault=\"unqualified\"\r\n\r\nelementFormDefault=\"unqualified\"\r\n\r\nxmlns:xhtml=\"http://www.w3.org/1999/xhtml\"\r\n\r\nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n\r\nxmlns:xs=\"http://www.w3.org/2001/XMLSchema\"\r\n\r\nxmlns:sec=\"http://marklogic.com/xdmp/security\"\r\n\r\nxmlns:admin=\"http://marklogic.com/xdmp/admin\"\r\n\r\nxmlns=\"http://marklogic.com/xdmp/database\"><xs:annotation><xs:documentation>&#10;\r\n\r\nDatabase configurati...</xs:schema>\r\n\r\n$db-datanode = <databases\r\n\r\nxsi:schemaLocation=\"http://marklogic.com/xdmp/database database.xsd\"\r\n\r\ntimestamp=\"13619973629349720\"\r\n\r\nxmlns=\"http://marklogic.com/xdmp/database\"\r\n\r\nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"><database><database-id>3689828479196801716</database-id><databas...</databases>\r\n\r\n$db-output = ()\r\n\r\n$gr-schemaroot = <xs:schema\r\n\r\ntargetNamespace=\"http://marklogic.com/xdmp/group\"\r\n\r\nxsi:schemaLocation=\"http://www.w3.org/2001/XMLSchema XMLSchema.xsd\r\n\r\nhttp://marklogic....\" attributeFormDefault=\"unqualified\"\r\n\r\nelementFormDefault=\"unqualified\"\r\n\r\nxmlns:xhtml=\"http://www.w3.org/1999/xhtml\"\r\n\r\nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n\r\nxmlns:xs=\"http://www.w3.org/2001/XMLSchema\"\r\n\r\nxmlns:admin=\"http://marklogic.com/xdmp/admin\"\r\n\r\nxmlns=\"http://marklogic.com/xdmp/group\"><xs:annotation><xs:documentation>&#10;\r\n\r\nServer configuration...</xs:schema>\r\n\r\n$gr-datanode = <groups\r\n\r\nxsi:schemaLocation=\"http://marklogic.com/xdmp/group group.xsd\"\r\n\r\ntimestamp=\"13619973602673800\"\r\n\r\nxmlns=\"http://marklogic.com/xdmp/group\"\r\n\r\nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"><group><group-name>Default</group-name><group-id>170879140590886...</groups>\r\n\r\n$gr-output = ()\r\n\r\n$as-schemaroot = <xs:schema\r\n\r\ntargetNamespace=\"http://marklogic.com/xdmp/assignments\"\r\n\r\nxsi:schemaLocation=\"http://www.w3.org/2001/XMLSchema XMLSchema.xsd\r\n\r\nhttp://marklogic....\" attributeFormDefault=\"unqualified\"\r\n\r\nelementFormDefault=\"unqualified\"\r\n\r\nxmlns:xhtml=\"http://www.w3.org/1999/xhtml\"\r\n\r\nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n\r\nxmlns:xs=\"http://www.w3.org/2001/XMLSchema\"\r\n\r\nxmlns:admin=\"http://marklogic.com/xdmp/admin\"\r\n\r\nxmlns=\"http://marklogic.com/xdmp/assignments\"><xs:annotation><xs:documentation>&#10;\r\n\r\nAssignments configur...</xs:schema>\r\n\r\n$as-datanode = <assignments\r\n\r\nxsi:schemaLocation=\"http://marklogic.com/xdmp/assignments\r\n\r\nassignments.xsd\" timestamp=\"13619973629248540\"\r\n\r\nxmlns=\"http://marklogic.com/xdmp/assignments\"\r\n\r\nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"><assignment><forest-name>Documents</forest-name><enabled>true</e...</assignments>\r\n\r\n$as-output = ()\r\n\r\n$ho-schemaroot = <xs:schema\r\n\r\ntargetNamespace=\"http://marklogic.com/xdmp/hosts\"\r\n\r\nxsi:schemaLocation=\"http://www.w3.org/2001/XMLSchema XMLSchema.xsd\r\n\r\nhttp://marklogic....\" attributeFormDefault=\"unqualified\"\r\n\r\nelementFormDefault=\"unqualified\"\r\n\r\nxmlns:xhtml=\"http://www.w3.org/1999/xhtml\"\r\n\r\nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n\r\nxmlns:xs=\"http://www.w3.org/2001/XMLSchema\"\r\n\r\nxmlns:admin=\"http://marklogic.com/xdmp/admin\"\r\n\r\nxmlns=\"http://marklogic.com/xdmp/hosts\"><xs:annotation><xs:documentation>&#10;\r\n\r\nHosts configuration ...</xs:schema>\r\n\r\n$ho-datanode = <hosts\r\n\r\nxsi:schemaLocation=\"http://marklogic.com/xdmp/hosts hosts.xsd\"\r\n\r\ntimestamp=\"13619973603192450\"\r\n\r\nxmlns=\"http://marklogic.com/xdmp/hosts\"\r\n\r\nxmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"><host><host-id>1109736108870853251</host-id><host-name>saltine.c...</hosts>\r\n\r\n$ho-output = ()\r\n\r\n$mi-hash = xs:unsignedLong(\"5361201424756024050\")\r\n\r\n$mi-tmp = ()\r\n\r\n\r\n\r\nIn /lib/security-upgrade-funcs.xqy on line 161\r\n\r\nIn server-upgrade()\r\n\r\n\r\n\r\n$force = fn:false()\r\n\r\n$ver = xs:double(\"50001\")\r\n\r\n\r\n\r\nIn /security-upgrade-go.xqy on line 20\r\n\r\n\r\n\r\n$confirm = \"31\"\r\n\r\n$cancel = \"\"\r\n\r\n"}, {"time":"2013-03-07T11:52:08.587504-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"135503", "paths":["xdmp/branches/b6_0/src/Admin/lib/upgrade.xqy"], "affectedBugs":[]}, "comment":"bug:20985 upgrade needs to check for existence of App-Services db\n"}, {"time":"2013-03-07T11:52:41.848552-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"135504", "paths":["xdmp/trunk/src/Admin/lib/upgrade.xqy"], "affectedBugs":[]}, "comment":"bug:20985 upgrade needs\tto check for existence of App-Services db\n"}, {"time":"2013-03-07T11:54:00.665636-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "to":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}}}, "files":[], "show":true, "comment":"Fixed on b6_0 and trunk. (Not on EA1 branch, as upgrades are not supported in EA).\r\nFranklin pre-verified the fix."}, {"time":"2013-03-07T11:54:00.665636-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{"assignTo":{"from":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "to":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-12T10:39:22.380694-07:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "to":{"username":"mbhatnag", "name":"Mayank Bhatnagar", "email":"Mayank.Bhatnagar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-25T00:06:38.084399-07:00", "updatedBy":{"username":"mbhatnag", "name":"Mayank Bhatnagar", "email":"Mayank.Bhatnagar@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"mbhatnag", "name":"Mayank Bhatnagar", "email":"Mayank.Bhatnagar@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"This bug is no more producible as Upgrade from 6.0-2.1 to Nightly build 20130319 was successful after deleting App-Services Database, hence shipping it.\r\ni.e Verified on Build : 20130319"}, {"time":"2013-03-25T00:06:38.084399-07:00", "updatedBy":{"username":"mbhatnag", "name":"Mayank Bhatnagar", "email":"Mayank.Bhatnagar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"mbhatnag", "name":"Mayank Bhatnagar", "email":"Mayank.Bhatnagar@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-22T16:23:33.716563-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-04-22T16:23:33.716563-07:00", "fixedAt":"2013-03-07T11:54:00.665636-08:00", "fixedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "shippedAt":"2013-03-25T00:06:38.084399-07:00", "shippedBy":{"username":"mbhatnag", "name":"Mayank Bhatnagar", "email":"Mayank.Bhatnagar@marklogic.com"}, "closedAt":"2013-04-22T16:23:33.716563-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}