{"id":20031, "kind":"Bug", "createdAt":"2012-11-08T10:52:33.081873-08:00", "status":"Closed", "title":"InfoStudio collecting causes excessive memory usage when configured with 64 task server threads", "category":"xdmp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"dfeldman", "name":"Damon Feldman", "email":"dfeldman@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"This may be a memory leak. MarkLogic memory use as reported in windows task manager reports 800MB use. After starting load of 3,000 Flickr XML files, at about 100 or 300 loaded, memory spikes to 6GB, and does not come back down after the job is cancelled. CPU is also pegged at 100%, although loading these moderate sized docs should not be that taxing.\r\n\r\nThe database (\"Documents\") has some unusual settings, such as 10,000=max in memory stand fragments, but nothing I can see that will cause it to use 6GB RAM.\r\n\r\nThe information studio load process is configured with all defaults, except that the format is set to be XML rather than auto. I will attach a zip of the Fickr data after submitting this bug.", "samplequery":"", "sampledata":"", "version":"6.0-1", "tofixin":"N/A", "fixedin":"N/A", "platform":"windows(64-bit)", "memory":"8GB", "processors":"", "note":"Windows 7 Professional ", "subscribers":[{"username":"dfeldman", "name":"Damon Feldman", "email":"dfeldman@marklogic.com"}, {"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, {"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, {"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}], "attachments":[{"name":"Config manager export of Documents DB and App Services app server", "uri":"root/support/bugtracking/attachments/20031/MemoryIssue.xml"}, {"name":"support dump", "uri":"root/support/bugtracking/attachments/20031/SupportDump.txt"}, {"name":"Zip file of directory info studio was pointed at", "uri":"root/support/bugtracking/attachments/20031/Flickr.zip"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "dfeldman"], "changeHistory":[{"time":"2012-11-09T17:43:12.338921-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-09T17:43:12.338921-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-2"}}, "files":[], "show":true}, {"time":"2012-11-09T20:14:33.771472-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Micah, how do we deal with such memory leak defects. Do we do the analysis before passing on to server team? What tools do we use? For now I have marked for 6.0-2 under your name. Please advice."}, {"time":"2012-11-11T20:50:41.399795-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I tried this with a 6.0-2 build from last week. Here are the steps I followed - \r\n\r\n1. Imported the package attached.. Looks like this package works against Documents DB \r\n2. Loaded the documents from the zip attached to Documents DB via InfoStudio. I did see the memory fluctuate between 1.7 GB and 2.1 GB, but at the end of the run, I did see the memory come back to 1.7GB  \r\n\r\nI did some errors XDMP-DOCENTITYREF errors and only 2414 of 2514 documents got loaded. \r\n\r\nDamon, \r\n\r\nPlease ping me when you some time tomorrow. We can go over your environment and compare against mine (I was running on Windows 7) and chat to see how we can gather more information.\r\n\r\nThanks,\r\n\r\nGanesh"}, {"time":"2012-11-12T12:51:06.352523-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Damon: how much memory overall in the system? How much swapping?\r\n\r\nIn general, it's very difficult to use Task Manager to diagnose a memory leak. By design, MarkLogic grabs hold of memory for caches and doesn't let go.\r\n\r\nIf (without restarting or doing anything else) re-load the same documents, does memory consumption jump to 12Gb, or does it level out around 6?\r\n"}, {"time":"2012-11-12T13:07:36.410655-08:00", "updatedBy":{"username":"dgorbet", "name":"David Gorbet", "email":"David.Gorbet@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Leaving open for now. Continuing investigation but not enough evidence that there is a leak yet."}, {"time":"2012-11-12T13:07:36.410655-08:00", "updatedBy":{"username":"dgorbet", "name":"David Gorbet", "email":"David.Gorbet@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dgorbet", "name":"David Gorbet", "email":"David.Gorbet@marklogic.com"}, "to":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-12T20:34:05.172056-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-13T05:15:25.10154-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"The memory use seen in our internal test looks normal.\r\nSince we cannot duplicate the severe memory use reported, I think we should move this out of 6.0-2.\r\nThis may already be fixed with some other fix."}, {"time":"2012-11-13T13:46:24.889902-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Moving to 6.0-3 as per Chris's guidance. I do have a meeting with Damon on 11/15 to understand his environment and look at his issue"}, {"time":"2012-11-13T13:46:24.889902-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"tofixin":{"from":"6.0-2", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2012-11-16T05:37:44.271681-08:00", "updatedBy":{"username":"dfeldman", "name":"Damon Feldman", "email":"dfeldman@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This appears to be memory use due to many threads in the task server. I had the task server threads cranked up to 64 to test sending parallel HTTP requests, and this setting causes the memory spike. Dropping threads down to 16 or 4 reduces peak memory to 2.7 to 3.8 GB and also reduces the CPU spike, rather than maxing out the machine at 6GB plus right away.\r\n\r\nSince a lot of our sizing discussions are about working memory, I do think the issue is important, despite the workaround, as 64 CPF transactions should not intuitively use 4+GB of working RAM. My task server status showed mostly state/status transitions, rather than real InfoStudio work when the CPU was maxed out, so I suspect it may be inherent to CPF rather than InfoStudio.\r\n"}, {"time":"2012-11-16T07:55:10.512371-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{"tofixin":{"from":"6.0-3", "to":"6.1-1"}}, "files":[], "show":true}, {"time":"2013-01-29T22:12:14.506992-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Ron,\r\n\r\nBased on the description by Damon this seems to be CPF issue. Assigning this to you for disposition. Please pass this back on if I misunderstood things"}, {"time":"2013-01-29T22:12:14.506992-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-19T11:55:31.393694-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2013-05-20T08:38:57.962641-07:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"(1) Not a CPF issue per se. \r\n(2) I have yet to see an actionable bug description. It seems to amount to a complaint that throwing a lot of work at a lot of threads they consume a lot of memory.\r\n\r\nRecommend we close this."}, {"time":"2013-05-20T15:04:35.23698-07:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I agree with Mary."}, {"time":"2013-05-20T15:20:28.181718-07:00", "updatedBy":{"username":"dfeldman", "name":"Damon Feldman", "email":"dfeldman@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This now works on my laptop using version 6.0-2.2. I suspect Chris is correct that it was fixed by another change (perhaps the Windows performance fix for 20461). For the archive, the observed behavior was not normal multi-threaded behavior. It was \"reboot the machine in front of the training class\" bad."}, {"time":"2013-05-20T15:33:48.364604-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Closing based on recommendation from Mary and Damon"}, {"time":"2013-05-20T15:33:48.364604-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-05-20T15:33:48.364604-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-05-20T15:33:48.364604-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"tofixin":{"from":"7.0-1", "to":"N/A"}}, "files":[], "show":true}], "updatedAt":"2013-05-20T15:33:48.364604-07:00", "closedAt":"2013-05-20T15:33:48.364604-07:00", "closedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "renderDescriptionAs":"normal"}