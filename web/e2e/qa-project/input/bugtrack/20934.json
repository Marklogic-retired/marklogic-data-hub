{"id":20934, "kind":"Bug", "createdAt":"2013-02-26T02:27:35.928845-08:00", "status":"Closed", "title":"REGR:less count is returned by cts:search on cts:element-word-query", "category":"search", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"REGR:less count is returned by cts:search with cts:element-word-query\r\n\r\nTest failing: bug17944.xml\r\nML version: 20130225\r\nLink to diff: https://regression-status.marklogic.com/new-app/space2/diff-archive/b7_0-ea1/2013-02-25/linux-64-rh5-cluster/diffs/bug17944.xml\r\n\r\nSteps to reproduce:\r\n\r\n1. Create Db and forest:\r\n2. Set database word query include document root to false.\r\n3. add db word query include\r\nxquery version \"1.0-ml\";\r\n   import module namespace admin=\"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n   let $name := \"bug17944\"\r\n   let $dbid := xdmp:database($name)\r\n   let $config := admin:get-configuration()\r\n   let $wqspec :=   admin:database-included-element(\"\", \"TEXTO\", 1.0, \"\", \"\", \"\")\r\n   let $config := admin:database-add-word-query-included-element($config, $dbid, $wqspec)\r\n   return admin:save-configuration($config)\r\n4. Insert documents into db:\r\nxdmp:document-load(\"QA_HOME/testdata/bug17944/doc-1.xml\",\r\n<options xmlns=\"xdmp:document-load\">\r\n        <uri>doc-1.xml</uri>\r\n</options>);\r\nxdmp:document-load(\"QA_HOME/testdata/bug17944/doc-2.xml\",\r\n<options xmlns=\"xdmp:document-load\">\r\n        <uri>doc-2.xml</uri>\r\n</options>);\r\nxdmp:document-load(\"QA_HOME/testdata/bug17944/doc-3.xml\",\r\n<options xmlns=\"xdmp:document-load\">\r\n        <uri>doc-3.xml</uri>\r\n</options>);\r\nxdmp:document-load(\"QA_HOME/testdata/bug17944/doc-4.xml\",\r\n<options xmlns=\"xdmp:document-load\">\r\n        <uri>doc-4.xml</uri>\r\n</options>)\r\n5. Run following queries:\r\n\r\nQuery1:\r\nfn:count(cts:search(/DOC, cts:element-word-query(xs:QName(\"PUBLICACION\"), \"FIESTAS DE BENAHADUX\")))\r\n\r\nActual result:1\r\nExpected count:4\r\n\r\nQuery2:\r\nfn:count(cts:search(/DOC, cts:element-word-query(xs:QName(\"PUBLICACION\"), \"fiestas de benahadux\")))\r\n\r\nActual count:3\r\nExpected count:4\r\n\r\nNote: This test started failing since 2013-02-21", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea1", "fixedin":"N/A", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, {"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["search", "iagrawal"], "changeHistory":[{"time":"2013-02-26T02:27:35.928845-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-26T12:05:42.275882-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-05T20:27:06.092743-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"It doesn't look like this test is failing from 02/21/2013. Since we created b7_0-ea1 branch on 02/20/2013, we may have noticed the first failure on this branch on 02/21/2013. In reality it must be failing on HEAD quite some time before that.\r\n\r\nI tried to back out changes related to the inheritance of database flags by fields and the test still did not pass. That just indicates that some check-in has broken this test in HEAD before 02/21.\r\n\r\nOther things I noticed is that if I include the field root on the word query field this test passes. But that also seems to be irrelevant- see the following two examples.\r\n\r\n1. Do not include document root on word-query field.\r\n2. Include element \"t\".\r\n3. Insert document:\r\nxdmp:document-insert(\"doc-1.xml\",\r\n<a><b>DE FIESTAS</b>\r\n<t></t>\r\n</a>)\r\n4. Run the query:\r\ncts:search(fn:doc(\"doc-1.xml\"),\r\n    cts:element-word-query(xs:QName(\"b\"),\r\n      \"DE FIESTAS\"),\"unfiltered\")\r\n=> returns the document.\r\n5. Now add one more word to the document and query.\r\nxdmp:document-insert(\"doc-1.xml\",\r\n<a><b>DE FIESTAS BENAHADUX</b>\r\n<t></t>\r\n</a>)\r\n6.\r\ncts:search(fn:doc(\"doc-1.xml\"),\r\n    cts:element-word-query(xs:QName(\"b\"),\r\n      \"DE FIESTAS BENAHADUX\"),\"unfiltered\")\r\n=> doesn't return the document.\r\n\r\nSo the problem seems to be related to three word phrases."}, {"time":"2013-03-05T21:28:06.336967-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Finally found that this is not a regression. We seem to have ported the test from b5_0 to HEAD (now it has also made into b7_0-ea1) but we didn't port the underlying bug fix (17762/) to HEAD.\r\n\r\nAlso for completeness, all these bugs are built on top of the fix for bug 16105."}, {"time":"2013-03-05T21:29:37.135511-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Duplicate bug 21053."}, {"time":"2013-03-05T21:42:33.989009-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Fei fixed this in b6_0 as bug 19331."}, {"time":"2013-03-06T08:50:58.025128-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Duplicate of 21503."}], "updatedAt":"2013-03-06T08:50:58.025128-08:00", "closedAt":"2013-03-06T08:50:58.025128-08:00", "closedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "renderDescriptionAs":"normal"}