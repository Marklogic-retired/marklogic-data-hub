{"id":20628, "kind":"Task", "createdAt":"2013-01-29T11:59:15.285727-08:00", "status":"Closed", "title":"Distribute prefix/suffix computation to the D nodes", "category":"search", "severity":"Performance", "priority":{"level":"5", "title":""}, "days":null, "period":{"startDate":null, "endDate":null}, "submittedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Turning a list of word matches into a series of 3-character prefixes and postfixes is currently done on the E-node\r\nMuch less data would need to be shipped around and other optimizations may be possible if this were distributed to the D-node and performed directly on the range indexes. To take full advantage of this operation, we'd probably want to put harder limits on the initial expansion call.", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea3", "fixedin":"7.0-ea3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, {"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}], "attachments":[], "parent":{"type":"Sub-task", "parentId":"20625", "taskOrRfe":"task"}, "includeInTaskList":false, "proceduralTasks":{"Requirements Task":[], "Functional Specification Task":[], "Test Specification Task":[], "Test Automation Task":[], "Documentation Task":[]}, "subTasks":[], "tags":["search", "mary"], "changeHistory":[{"time":"2013-01-29T11:59:15.285727-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2013-03-01T16:44:29.625354-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{"assignTo":{"from":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "to":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-15T15:01:58.386587-07:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Design: \r\nLeverage what we already have with wordMatch.\r\n1.pass an additional parameter minlen for the length of pre and postfix.\r\n2.Construct a HashTable of {string, bool(isPrefix), bool(isPostfix)} after wordmatch is done.\r\n  done with a new future that extends StringIteratorFuture.\r\nThis will have minimal data movement. As \"abc\" will appear only once even if it both occurred as pre and postfix.\r\n3.Need additional operations to merge such items.\r\n\r\n"}, {"time":"2013-03-19T14:05:37.832054-07:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137190", "paths":["xdmp/trunk/src/Item.h", "xdmp/trunk/src/QueryPath.h", "xdmp/trunk/src/XQuery.h", "xdmp/trunk/src/QueryVal.h", "xdmp/trunk/src/ForestQuery.h", "xdmp/trunk/src/DatabaseQuery.cpp", "xdmp/trunk/src/OnDiskRangeIndexes.cpp", "xdmp/trunk/src/SearchBuiltins.cpp", "xdmp/trunk/src/DatabaseQuery.h", "xdmp/trunk/src/ForestQuery.cpp", "xdmp/trunk/src/XDQPServer.cpp", "xdmp/trunk/src/SearchBuiltins.h", "xdmp/trunk/src/QueryPath.cpp", "xdmp/trunk/src/XDQPClient.h", "xdmp/trunk/src/Item.cpp", "xdmp/trunk/src/search.y", "xdmp/trunk/src/XDQPClient.cpp", "xdmp/trunk/src/XDQPServer.h"], "affectedBugs":["21073"]}, "comment":"Bug:21073 add expand-lexicon and expand-lexicon-off to query options to force behavior of wildcard expansion, Bug:20628 pre- and postfix now on stand level, new PrePostfixIterator and related composite ones for combination operation"}, {"time":"2013-03-19T14:15:01.520895-07:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The above change is preliminary tested on a local database with 4 forests.\r\nneed to observe if behaves correctly when more than 1 host is involved to test encoding, decoding and data transfer on XDQP."}, {"time":"2013-04-25T18:02:35.615919-07:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Performance characteristics:\r\n\r\n1.Ingested ~2m cpox doc on a one node in a db with 3 forests\r\n2.xdmp:plan(cts:search(doc(),cts:word-query(\"ab*\",(\"case-sensitive\",\"wildcarded\",\"lexicon-expand=prefix-postfix\"))))\r\n\r\n<qry:expansion-trace type=\"prefix-postfix\" elapsed-time=\"PT0.241053S\" text=\"ab*\" prefix-counts=\"44\" postfix-counts=\"845\">\r\n<qry:info-trace elapsed-time=\"PT10.908096S\">Selected 309587 fragments to filter</qry:info-trace>\r\n<qry:result elapsed-time=\"PT10.908182S\" estimate=\"309587\">\r\n\r\n3.xdmp:plan(cts:search(doc(),cts:word-query(\"ab*\",(\"case-sensitive\",\"wildcarded\",\"lexicon-expand=full\"))))\r\n\r\n<qry:expansion-trace type=\"full\" elapsed-time=\"PT0.443527S\" text=\"ab*\" counts=\"1982\">\r\n <qry:info-trace elapsed-time=\"PT1.318587S\">Selected 701414 fragments to filter</qry:info-trace> <qry:result elapsed-time=\"PT1.318666S\" estimate=\"701414\"/> </qry:query-plan>\r\n\r\n\r\n4. Build before 20628 & 21073, modify the code to force full expand and then do prefix postfix\r\n\r\nxdmp:plan(cts:search(doc(),cts:word-query(\"ab*\",(\"case-sensitive\",\"wildcarded\"))))\r\n\r\n<qry:info-trace elapsed-time=\"PT0.815425S\">Raw lexicon expansion too large: 1982</qry:info-trace>\r\n<qry:expansion-trace elapsed-time=\"PT0.837695S   \" text=\"ab*\" counts=\"1982 513\">\r\n\r\nSummary\r\n\r\nBefore:                                                  time                              num\r\nfull expand                                           0.815425S                  1982\r\nfull expand + get prefix/postfix          0.837695S                  44+845\r\n\r\nAfter:\r\nfull expand                                           0.443527S                  1982\r\nprefix/postfix expand                          0.241053S                  44+845\r\n\r\nNote:\r\n1. Distributing prefix-postfix operation to D-node is shown to be beneficial since less data are shipped between D and E\r\n2. Time actually taken to get prefix and postfix is trivial compared to that of full expansion\r\n3. It is unclear why full expansion should be twice as fast as before \r\n4. Further tests need to be done on a multiple nod cluster"}, {"time":"2013-05-15T17:19:47.965519-07:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"141658", "paths":["xdmp/trunk/src/Item.h", "xdmp/trunk/src/OnDiskRangeIndexes.cpp", "xdmp/trunk/src/SearchBuiltins.cpp", "xdmp/trunk/src/Item.cpp", "xdmp/trunk/src/XDQPClient.cpp", "xdmp/trunk/src/Messages/TS-en.xml"], "affectedBugs":[]}, "comment":"bug:20628 fix XDQP prefix postfix transfer"}, {"time":"2013-06-10T14:48:43.609129-07:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-06-10T14:48:43.609129-07:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{"assignTo":{"from":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-10-10T16:10:18.19005-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":null, "to":"Ship"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"The wildcarded lexicon expansion tests have been running in regression on a single node and cluster for quite some time and all the tests have been passing. Hence moving this bug to 'ship' as of builg 7.0-20131009"}], "updatedAt":"2013-10-10T16:10:18.19005-07:00", "fixedAt":"2013-06-10T14:48:43.609129-07:00", "fixedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "shippedAt":"2013-10-10T16:10:18.19005-07:00", "shippedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}