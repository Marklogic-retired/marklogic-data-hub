{"id":20558, "kind":"Bug", "createdAt":"2013-01-22T17:00:29.151567-08:00", "status":"Closed", "title":"SVC-FILREN: File rename error while doing a point in time recovery", "category":"Backup/Restore", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"\r\nI see the following error when I ran hdfs-point-in-time-recovery-test-3.xml \r\n\r\n2013-01-22 16:18:05.994 Info: Starting 2-forest database restore from hdfs://rh5-intel64-42-test-4.marklogic.com:54310/skottam.marklogic.com/backup/backupdb/20130122-1614490938970, jobid=10912000069152332807\r\n2013-01-22 16:18:06.023 Info: Starting restore of forest backup_3F1 from hdfs://rh5-intel64-42-test-4.marklogic.com:54310/skottam.marklogic.com/backup/backupdb/20130122-1614490938970, jobid=10912000069152332807\r\n2013-01-22 16:18:06.043 Info: Starting restore of forest backup_3F2 from hdfs://rh5-intel64-42-test-4.marklogic.com:54310/skottam.marklogic.com/backup/backupdb/20130122-1614490938970, jobid=10912000069152332807\r\n2013-01-22 16:18:06.874 Info: Saving hdfs://rh5-intel64-42-test-4.marklogic.com:54310/skottam.marklogic.com/Data/RestoredForests/backup_3F1/00000000\r\n2013-01-22 16:18:09.565 Info: Saving hdfs://rh5-intel64-42-test-4.marklogic.com:54310/skottam.marklogic.com/Data/RestoredForests/backup_3F2/00000000\r\n2013-01-22 16:18:12.763 Info: Saved 8 MB in 6 sec at 1 MB/sec to hdfs://rh5-intel64-42-test-4.marklogic.com:54310/skottam.marklogic.com/Data/RestoredForests/backup_3F1/00000000\r\n\r\n\r\n2013-01-22 16:18:15.805 Alert: XDMP-FORESTERR: Error in startup of forest backup_3F1: XDMP-RECOVERY: Recovery error on forest backup_3F1 after 37 redo records -- {{fsn=38, chksum=0x45981b20, words=23}, op=forestClear, time=1358900132, mfor=5260782932508496052, mtim=13589000859151240, mfsn=38, fmcl=17422821449002904914, fmf=5260782932508496052, fmfsn=38, sk=14452099322253257467} SVC-FILREN: File rename error: rename 'hdfs://rh5-intel64-42-test-4.marklogic.com:54310/skottam.marklogic.com/Data/TmpForests/backup_3F1/Journals': failed\r\n\r\n\r\n2013-01-22 16:18:16.439 Info: Finished copying to forest backup_3F1 from hdfs://rh5-intel64-42-test-4.marklogic.com:54310/skottam.marklogic.com/backup/backupdb/20130122-1614490938970, jobid=10912000069152332807\r\n2013-01-22 16:18:16.722 Info: Saved 8 MB in 7 sec at 1 MB/sec to hdfs://rh5-intel64-42-test-4.marklogic.com:54310/skottam.marklogic.com/Data/RestoredForests/backup_3F2/00000000\r\n2013-01-22 16:18:16.873 Info: Finished copying to forest backup_3F2 from hdfs://rh5-intel64-42-test-4.marklogic.com:54310/skottam.marklogic.com/backup/backupdb/20130122-1614490938970, jobid=10912000069152332807\r\n2013-01-22 16:18:17.422 Info: Finishing restore of forest backup_3F1 from hdfs://rh5-intel64-42-test-4.marklogic.com:54310/skottam.marklogic.com/backup/backupdb/20130122-1614490938970/Forests/backup_3F1 assertMaster=true, jobid=10912000069152332807\r\n2013-01-22 16:18:17.422 Info: Finishing restore of forest backup_3F2 from hdfs://rh5-intel64-42-test-4.marklogic.com:54310/skottam.marklogic.com/backup/backupdb/20130122-1614490938970/Forests/backup_3F2 assertMaster=true, jobid=10912000069152332807\r\n2013-01-22 16:18:17.466 Info: Restored forest backup_3F2 asserting itself as master with new precise time 13589002974661290\r\n2013-01-22 16:18:17.522 Info: Restored forest backup_3F1 asserting itself as master with new precise time 13589002975229350\r\n\r\nTo narrow it down here are the steps that I have followed\r\n\r\n1. Create a database with Forests on HDFS\r\n2. Take a backup with journal archiving \r\n3. Load some documents\r\n4. Do a database clear\r\n5.  Now do a point in time recovery to a point just after the clear.\r\n\r\n", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea1", "fixedin":"7.0-ea1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, {"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["Backup/Restore", "skottam"], "changeHistory":[{"time":"2013-01-22T17:00:29.151567-08:00", "updatedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "change":{"assignTo":{"from":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "to":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-24T10:01:57.183505-08:00", "updatedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Looks like this error is not specific to hdfs, I see this happening in local filesystem on 7.0"}, {"time":"2013-02-19T14:38:53.448862-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Here's the stack:\r\n\r\n21 svc::File::rename() /space/projects/head/xdmp/src/services/File.cpp:841 0x000000000324052d\t\r\n20 xdmp::Forest::_clear() /space/projects/head/xdmp/src/Forest.cpp:10304 0x00000000024e1b2f\t\r\n19 xdmp::Forest::redoClear() /space/projects/head/xdmp/src/Forest.cpp:7008 0x00000000024ca7cb\t\r\n18 xdmp::ForestClearRecoveryOp::redo() /space/projects/head/xdmp/src/Recovery.cpp:1102 0x0000000002a729f1\t\r\n17 xdmp::Forest::recoverRedo() /space/projects/head/xdmp/src/Forest.cpp:4171 0x00000000024b698c\t\r\n16 xdmp::Forest::recover() /space/projects/head/xdmp/src/Forest.cpp:3936 0x00000000024b5606\t\r\n15 xdmp::Forest::init() /space/projects/head/xdmp/src/Forest.cpp:3896 0x00000000024b5304\t\r\n14 xdmp::Forest::open() /space/projects/head/xdmp/src/Forest.cpp:5125 0x00000000024be54d\t\r\n13 xdmp::Forest::_startup() /space/projects/head/xdmp/src/Forest.cpp:5585 0x00000000024c197b\t\r\n12 xdmp::Forest::startup() /space/projects/head/xdmp/src/Forest.cpp:5604 0x00000000024c1ce6\t\r\n11 xdmp::Forest::_restore() /space/projects/head/xdmp/src/Forest.cpp:14653 0x000000000250310a\t\r\n10 xdmp::ForestRestoreTask::run() /space/projects/head/xdmp/src/Forest.cpp:2622 0x00000000024a7137\t\r\n9 svc::TaskManager::runTask() /space/projects/head/xdmp/src/services/Task.cpp:246 0x00000000032ac6bf\t\r\n8 svc::TaskManager::scheduler() /space/projects/head/xdmp/src/services/Task.cpp:339 0x00000000032acfee\t\r\n7 svc::TaskManagerTask::run() /space/projects/head/xdmp/src/services/Task.cpp:387 0x00000000032ad302\t\r\n6 svc::PooledThread::run() /space/projects/head/xdmp/src/services/ThreadPool.cpp:146 0x00000000032b3d13\t\r\n5 svc::Thread::top() /space/projects/head/xdmp/src/services/Thread.cpp:284 0x00000000032b1f5a\t\r\n4 svc::runThread() /space/projects/head/xdmp/src/services/Thread.cpp:320 0x00000000032b247d\t\r\n3 start_thread()  0x0000003429006a3a\t\r\n2 clone()  0x0000003428cde62d\t\r\n1 <symbol is not available> 0x0000000000000000\t\r\n\r\nWe are trying to open the restored forest at \"/space/projects/head/xdmp/src/Data3/RestoredForests/Documents\".  \r\n\r\nNot related to HDFS.  Regression started with change 126554."}, {"time":"2013-02-19T14:46:33.572588-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"132479", "paths":["xdmp/trunk/src/Forest.cpp"], "affectedBugs":[]}, "comment":"Bug:20558 - Attempt to rename only if Journals directory exists.\n"}, {"time":"2013-02-19T14:47:02.952682-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "to":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-19T14:47:02.952682-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"assignTo":{"from":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "to":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-19T14:49:28.879346-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"132480", "paths":["xdmp/trunk/src/Forest.cpp"], "affectedBugs":[]}, "comment":"Bug:20558 - Fix a typo.\n"}, {"time":"2013-03-04T17:26:51.2471-08:00", "updatedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on the build 7.0-20130304 and verified the test point-in-time-recovery-test-3.xml is passing in my local machine."}], "updatedAt":"2013-03-04T17:26:51.2471-08:00", "fixedAt":"2013-02-19T14:47:02.952682-08:00", "fixedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "shippedAt":"2013-03-04T17:26:51.2471-08:00", "shippedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "renderDescriptionAs":"normal"}