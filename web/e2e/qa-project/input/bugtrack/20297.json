{"id":20297, "kind":"Bug", "createdAt":"2012-12-17T09:52:07.614091-08:00", "status":"Will not fix", "title":"Module database cache out of sync with amped module(s) stored on the filesystem", "category":"security", "severity":"Minor", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"This is being filed on behalf\r\n\r\nhttps://help.marklogic.com/staff/Tickets/Ticket/View/12165\r\n\r\nMy feeling is that this is a low priority case which may not be worth fixing.  \r\n\r\nThe issue occurs when data is split between the modules database and a call is issued to a Module which is stored on the filesystem (for example, a module stored on the filesystem which would reside at: /opt/MarkLogic/Modules).  \r\n\r\nFor the example given in the above case, they've split the files in this way because they want to amp permissions to call a \"restricted\" function in the module on the filesystem.  They were inspired by the documentation here for this design - although the documentation does also state that it is best practice to keep all modules in the same place (the modules database):\r\nhttp://docs.marklogic.com/guide/security/execute#id_12043\r\n\r\nIn this case, if a Module is stored in the database, which issues a call to a Module stored on the filesystem and if the Module is placed in the database before the second module gets written to the filesystem, this will trigger an XDMP-MODNOTFOUND even though the filesystem has been updated.  This is due to the Module in the Modules database getting cached at the point where the file on the filesystem is absent; adding it does not trigger a re-caching of the original module.\r\n\r\nI've attached notes to script the whole process which should make reproducing the issue easy.   Reproduced in 4.2-7 and confirmed the same behaviour in 5.0-4.1.  I'll clone this bug to the 6.0-x branch if anyone believes the case is worth fixing.", "samplequery":"Case Repro notes:\r\n- Test with ML 4.2-7 and follow the steps below to repro the original issue (this has been also confirmed with 5.0-4.1 and is likely to be reproducible in 6.0-2 also).\r\n\r\n(:::::::::::::::: 1. Set up a load of trace events :::::::::::::)\r\nxquery version \"1.0-ml\";\r\n\r\nimport module namespace admin = \"http://marklogic.com/xdmp/admin\"\r\n\tat \"/MarkLogic/admin.xqy\";\r\n\r\nlet $config := admin:get-configuration()\r\nlet $config := (\r\n\tadmin:group-add-trace-event($config,\r\n\tadmin:group-get-id($config, \"Default\"),\r\n\t(admin:group-trace-event(\"Module Library DBCache\"),\r\n\tadmin:group-trace-event(\"Module Library FSCache\"),\r\n\tadmin:group-trace-event(\"Module Program FSCache\"),\r\n\tadmin:group-trace-event(\"Module Program DBCache\"),\r\n\tadmin:group-trace-event(\"Module Library DNE DBCache\"),\r\n\tadmin:group-trace-event(\"Module Library DNE FSCache\"),\r\n\tadmin:group-trace-event(\"Module Main DNE DBCache\"),\r\n\tadmin:group-trace-event(\"Module Main DNE FSCache\")))\r\n)\r\nreturn admin:save-configuration($config)\r\n\r\n(: Note this won't enable them :)\r\n\r\n\r\n(:::::::::::::::: 2. Create the driver module for the trusted solution ::::::::::::::::::)\r\n(: Execute this against your Modules db to install \"/test.xqy\" :)\r\n\r\nxquery version \"1.0-ml\";\r\n\r\ndeclare variable $mod as xs:string := \r\n'xquery version \"1.0-ml\";\r\n\r\nimport module namespace ml = \"http://help.marklogic.com\"\r\n  at \"/trusted.xqy\";\r\n\r\n(: Simple driver module :)\r\nml:set-timestamp()';\r\n\r\n\r\nxdmp:document-insert(\"/test.xqy\", document {$mod} )\r\n\r\n\r\n(:::::::::::::::: 3. Create the http server (port 9998) to test the Module ::::::::::::::::::)\r\nxquery version \"1.0-ml\";\r\n\r\nimport module namespace admin = \"http://marklogic.com/xdmp/admin\"\r\nat \"/MarkLogic/admin.xqy\";\r\n\r\ndeclare variable $port as xs:string := \"9998\";\r\ndeclare variable $config := admin:get-configuration();\r\n\r\n(: create the initial application server :)\r\nlet $config := admin:http-server-create(\r\n$config,\r\nadmin:group-get-id($config, \"Default\"),\r\nfn:concat(\"http-\",$port),\r\n\"/\",\r\nxs:unsignedLong($port),\r\nxdmp:database(\"Modules\"),\r\nxdmp:database(\"Documents\"))\r\n\r\nreturn admin:save-configuration($config)\r\n\r\n(::::::::::::::::: 4. Make sure it's broken ::::::::::::::)\r\n\r\nVisit:\r\nhttp://localhost:9998/test.xqy\r\n\r\nYou want to see this:\r\n500 Internal Server Error\r\n\r\n[1.0-ml]\r\n    XDMP-MODNOTFOUND: (err:XQST0059) Module /trusted.xqy not found\r\nin /test.xqy, on line 7 [1.0-ml]\r\n    XDMP-UNDFUN: (err:XPST0017) Undefined function ml:set-timestamp()\r\n\r\n\r\n(:::::::::::::: 5. Create the trusted solution on the filesystem ::::::::::::::)\r\n\r\n$ sudo vim /opt/MarkLogic/Modules/trusted.xqy\r\n[i] - paste the below [esc][:wq]\r\n\r\nxquery version \"1.0-ml\";\r\n\r\nmodule namespace ml =\"http://help.marklogic.com\";\r\n\r\nimport module namespace admin = \"http://marklogic.com/xdmp/admin\"\r\n\tat \"/MarkLogic/admin.xqy\";\r\n\r\ndeclare function ml:set-timestamp() {\r\n\tlet $_ := xdmp:log(\"Trusted module :: setting the merge timestamp\")\r\n\tlet $config := admin:get-configuration()\r\n\treturn\r\n\tadmin:save-configuration(admin:database-set-merge-timestamp($config,xdmp:database(\"Documents\"), 10))\r\n};\r\n\r\n$ sudo chmod o+x /opt/MarkLogic/Modules/trusted.xqy\r\n\r\n(:::::::::::::::::: 6. Ensure you still see the *same* error message ::::::::::::::)\r\nPerform step 4 again\r\n(:::::::::::::::::: 7. Reinstall the module and retest ::::::::::::::)\r\nPerform steps 2 and 4 again", "sampledata":"", "version":"5.0-4.1", "tofixin":"5.0-5", "fixedin":"N/A", "platform":"linux(64-bit)", "memory":"", "processors":"", "note":"Tested with Linux, but I suspect the same behaviour will be observed in all environments", "subscribers":[{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, {"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, {"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}], "attachments":[{"name":"My notes for scripting the reproduction of the issue for reference", "uri":"root/support/bugtracking/attachments/20297/repro-notes.txt"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"Module database cache out of sync with amped modules stored on the filesystem", "supportDescription":"This happens when data is split between the modules database and a call is issued to a Module which is stored on the filesystem (for example, a module stored on the filesystem which would reside at: /opt/MarkLogic/Modules).  \r\n\r\nIn this case, if a Module is stored in the database, which issues a call to a Module stored on the filesystem and if the Module is placed in the database before the second module gets written to the filesystem, this will trigger an XDMP-MODNOTFOUND even though the filesystem has been updated.  This is due to the Module in the Modules database getting cached at the point where the file on the filesystem is absent; adding it does not trigger a re-caching of the original module.", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"Low", "title":"Minimal business impact or reasonable workaround is available"}, "workaround":"Reinstall all calling modules in the Modules databases to update the Module cache and everything should be fine."}, "tags":["security", "ableasdale"], "changeHistory":[{"time":"2012-12-17T10:47:03.970734-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true, "comment":"Alex, if they restart the server after adding the module with the amp to the filesystem, does that make the problem go away?  If so, then I think this is not a bug."}, {"time":"2012-12-17T10:47:03.970734-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-17T10:47:03.970734-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-5"}}, "files":[], "show":true}, {"time":"2012-12-18T02:18:15.465119-08:00", "updatedBy":{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi Danny,\r\n\r\nI've just re-tested this and I can confirm that a restart does cure the problem - thanks for the suggestion.\r\n\r\nBest,\r\nA"}, {"time":"2012-12-18T09:49:31.594179-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"In that case, I recommend we close this as not-a-bug.  THe filesystem is not desigened to notice when new modules are added, as this should only happen on installation.  The best practice for amps is to put them in a Modules db.\r\n\r\nAlex, if that makes sense to you, can you please close this and communicate it with the customer?"}, {"time":"2012-12-20T00:27:06.870126-08:00", "updatedBy":{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"As discussed, closing the case."}, {"time":"2012-12-20T00:28:15.719803-08:00", "updatedBy":{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, "change":{"status":{"from":"", "to":"Will not fix"}, "assignTo":{"from":{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2012-12-20T00:28:15.719803-08:00", "renderDescriptionAs":"normal", "renderSampleQueryAs":"normal"}