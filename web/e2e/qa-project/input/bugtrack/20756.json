{"id":20756, "kind":"Bug", "createdAt":"2013-01-21T10:33:03.759206-08:00", "status":"Closed", "title":"After bulk replicating 48,055,082 documents it was found that the replica was missing 2 documents ", "category":"Replication", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Using build 5.0-20130108 the following was observed: \r\n\r\nAfter bulk replicating 48,055,082 documents it was found that the replica was missing 2 documents \r\n\r\nFrom the db status page (note f1-on4 has replica f1r-on5  f1-on4 has 48,055,082 documents where f1r-on5 has 48,055,080 ):\r\n \r\nForest  \tHost  \tState  \tDocuments  \tFragments  \tDeleted Fragments  \tStands  \tSize  \tFree Space  \tLarge Free Space  \tFast Free Space\r\nDocuments \trh6-intel64-51-test-4.marklogic.com \topen \t47,001,931 \t47,003,596 \t1,687 \t5 \t330,084 MB \t773,039 MB \tn/a \tn/a\r\nf1-on4 \trh6-intel64-51-test-4.marklogic.com \topen \t48,055,082 \t48,056,824 \t1,072 \t5 \t336,690 MB \t773,039 MB \tn/a \tn/a\r\nf1-on5 \trh6-intel64-51-test-5.marklogic.com \topen \t47,006,443 \t47,008,090 \t3,232 \t5 \t330,118 MB \t939,523 MB \tn/a \tn/a\r\nf1r-on5 \trh6-intel64-51-test-5.marklogic.com \tsync replicating \t48,055,080 \t48,056,822 \t1 \t6 \t336,965 MB \t939,523 MB \tn/a \tn/a\r\n\t\tTotal \t142,063,456 \t142,068,510 \t5,991 \t15 \t996,892 MB \t\r\n\r\nTalked with Wayne and will enable trace events and remove the label from the replica and add more information to this bug. ", "samplequery":"", "sampledata":"", "version":"6.0-2", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, {"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, {"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20531, "support":{"headline":"Local-disk failover or database replication may occasionally fail to replicate a few fragments", "supportDescription":"A small number of fragments may fail to replicate during bulk replication of very large forests. This situation can be identified when the active fragment count is different between the master and replica forest on an idle database.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":"Stop the replica forest's host, delete the replica forest's label, and restart the host. A fresh bulk replication will correctly synchronizes the forests."}, "tags":["Replication", "lratcliff"], "changeHistory":[{"time":"2013-01-21T10:33:03.759206-08:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-21T10:52:01.506785-08:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"After doing the following : \r\n\r\nTrace events: Forest Replicate, Forest Replicate Frame, Forest Replicate\r\nFragment, Forest Replicate Timestamps, Forest State, Forest Label\r\n\r\nWith those on, stop the replica host, remove the forest label, and restart.\r\n\r\nthe final 2 documents did show up in the replica. The error logs with the trace events can be found: \r\n/home/lratcliff/20531/replica-ErrorLog.txt\r\n/home/lratcliff/20531/master-ErrorLog.txt\r\n"}, {"time":"2013-01-22T19:59:42.633084-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"At the end of the bulk replication with the forest synchronized again, we have one missing fragment. I stopped the replica, removed its label, and restarted it. At the end of bulk synchronization, the document and fragment count were correct.\r\n\r\nI've done that twice now, and each time a bunch of the replicate fragments were deleted fragments. I think that's because the replica forest merges when it comes back up and discards the deleted fragments, only to have them replicated again.\r\n\r\nAn optimization to the bulk synchronization protocol would be to have the replica forest not ask for any fragments that were deleted before its min query timestamp."}, {"time":"2013-01-23T22:04:25.388895-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I installed a b5_0 binary on both nodes, restarted, and cleared the replica forest. It's bulk replicating now, but it's a debug build and has lots of logging turned on so it may be a while."}, {"time":"2013-01-25T08:30:15.433139-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The bulk replication completed with no missing documents, however I did a number of server restarts during the replication to refine some new logging to look for potential issues. I cleared the replica forest this morning to restart replication, and we'll see if the issue duplicates."}, {"time":"2013-01-27T13:59:10.182882-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Successful replication. I'll clear the replica and start again."}, {"time":"2013-01-28T19:35:25.120135-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Another successful replication. I've cleared the replica and started things running again."}, {"time":"2013-01-29T19:42:00.3875-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Another successful bulk replication. I'm going to clear the replica and start it again. Seems to be taking about 30 hours to complete."}, {"time":"2013-01-30T22:33:03.215758-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Another successful bulk replication."}, {"time":"2013-01-31T16:42:20.172902-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"130205", "paths":["xdmp/branches/b5_0/src/Forest.cpp"], "affectedBugs":[]}, "comment":"bug:20531 Fixed some incorrect log messages, and added code to warn if necessary fragments aren't found during bulk replication. No changes to algorithm, just logging."}, {"time":"2013-01-31T16:43:25.497786-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"130206", "paths":["xdmp/branches/b6_0/src/Forest.cpp"], "affectedBugs":[]}, "comment":"bug:20531 Fixed some incorrect log messages, and added code to warn if necessary fragments aren't found during bulk replication. No changes to algorithm, just logging."}, {"time":"2013-01-31T17:11:56.578539-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"130211", "paths":["xdmp/trunk/src/Forest.cpp"], "affectedBugs":[]}, "comment":"bug:20531 Fixed some incorrect log messages, and added code to warn if necessary fragments aren't found during bulk replication. No changes to algorithm, just logging."}, {"time":"2013-01-31T20:00:47.568885-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I haven't been able to duplicate this, so sending back Larry's way to see if he has more luck. He's going to run on tonight's build that includes my logging tweaks."}, {"time":"2013-01-31T20:00:47.568885-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-06T13:56:08.393584-08:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"On build 5.0-20130204 it was observed that 1 document failed to replicate. Will gather up the logs after all hands meeting. "}, {"time":"2013-02-06T13:56:08.393584-08:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-06T14:18:01.62143-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Pasting in the beginning of the bulk replication. The interesting thing is that the very first \"bulk replicated ...\" message says it send 999989 and skipped 10, but there is one unaccounted for. For the later messages, these two add up to the expected 1000000 fragments.\r\n\r\n2013-02-05 10:21:08.791 Info: Forest f1-on4 starting synchronization to domestic forest f1r-on5\r\n2013-02-05 10:21:08.791 Info: Forest f1-on4 starting bulk replication to domestic forest f1r-on5\r\n2013-02-05 10:21:17.970 Info: Forest f1-on4 replicating 1000000 keys to domestic forest f1r-on5\r\n2013-02-05 10:21:18.993 Info: Forest f1-on4 needs to replicate 1000000 fragments to domestic forest f1r-on5\r\n2013-02-05 10:51:42.690 Info: Forest f1-on4 bulk replicated 999989 fragments (10 skipped, 0 not found) to domestic forest f1r-on5 (548/sec)\r\n2013-02-05 10:51:42.893 Info: Forest f1-on4 replicating 1000000 keys to domestic forest f1r-on5\r\n2013-02-05 10:51:45.246 Info: Forest f1-on4 needs to replicate 1000000 fragments to domestic forest f1r-on5\r\n2013-02-05 11:21:49.872 Info: Forest f1-on4 bulk replicated 999989 fragments (11 skipped, 0 not found) to domestic forest f1r-on5 (554/sec)\r\n2013-02-05 11:21:51.169 Info: Forest f1-on4 replicating 1000000 keys to domestic forest f1r-on5\r\n2013-02-05 11:21:53.791 Info: Forest f1-on4 needs to replicate 1000000 fragments to domestic forest f1r-on5\r\n2013-02-05 11:51:43.511 Info: Forest f1-on4 bulk replicated 999992 fragments (8 skipped, 0 not found) to domestic forest f1r-on5 (558/sec)\r\n2013-02-05 11:51:56.718 Info: Forest f1-on4 replicating 1000000 keys to domestic forest f1r-on5\r\n2013-02-05 11:51:59.324 Info: Forest f1-on4 needs to replicate 1000000 fragments to domestic forest f1r-on5\r\n2013-02-05 12:22:09.885 Info: Forest f1-on4 bulk replicated 999989 fragments (11 skipped, 0 not found) to domestic forest f1r-on5 (552/sec)\r\n2013-02-05 12:22:46.895 Info: Forest f1-on4 replicating 1000000 keys to domestic forest f1r-on5\r\n2013-02-05 12:22:50.477 Info: Forest f1-on4 needs to replicate 1000000 fragments to domestic forest f1r-on5\r\n2013-02-05 12:53:05.626 Info: Forest f1-on4 bulk replicated 999998 fragments (2 skipped, 0 not found) to domestic forest f1r-on5 (550/sec)\r\n2013-02-05 12:53:58.816 Info: Forest f1-on4 replicating 1000000 keys to domestic forest f1r-on5\r\n2013-02-05 12:54:01.754 Info: Forest f1-on4 needs to replicate 1000000 fragments to domestic forest f1r-on5\r\n2013-02-05 13:23:53.414 Info: Forest f1-on4 bulk replicated 999989 fragments (11 skipped, 0 not found) to domestic forest f1r-on5 (558/sec)\r\n2013-02-05 13:24:45.319 Info: Forest f1-on4 replicating 1000000 keys to domestic forest f1r-on5\r\n2013-02-05 13:24:49.064 Info: Forest f1-on4 needs to replicate 1000000 fragments to domestic forest f1r-on5\r\n2013-02-05 13:54:57.481 Info: Forest f1-on4 bulk replicated 999986 fragments (14 skipped, 0 not found) to domestic forest f1r-on5 (553/sec)\r\n"}, {"time":"2013-02-08T16:03:19.560843-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I stopped the replica host, removed the replica forest's label, and watch it resync with the Replicate Fragment trace flag set. I think this is the missing fragment (because it has a deleted timestamp of -1).\r\n\r\n2013-02-08 15:47:05.025 Info: [Event:id=Forest Replicate Fragment]\r\n Forest f1-on4 replicating document fragment 1 of 4 to domestic forest f1r-on5: 920315207395 13583687210732173 -1 /TZRAZMJRPLBYCGPN/2013016123748701/0/2doc316.xml\r\n\r\nUniqKey = 920315207395\r\nnascent = 13583687210732173\r\ndeleted = -1\r\nuri = /TZRAZMJRPLBYCGPN/2013016123748701/0/2doc316.xml\r\n"}, {"time":"2013-02-08T16:03:19.560843-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-08T16:03:34.866898-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-09T20:39:45.257135-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I'm pretty sure I found the problem. Testing a fix now."}, {"time":"2013-02-11T20:15:46.885872-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Wayne, Larry,\r\n\r\nCurious - did the test run successfully?"}, {"time":"2013-02-11T20:17:30.827577-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Our lines got crossed and the machine was reloaded with last night's build. I'm going to commit tonight and Larry can run tonight's official build."}, {"time":"2013-02-11T21:43:16.151978-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"131340", "paths":["xdmp/branches/b6_0/src/Forest.cpp"], "affectedBugs":[]}, "comment":"bug:20756 Bulk replication would occasionally miss a fragment or two. Added better logging and warnings if fragments aren't found."}, {"time":"2013-02-11T21:47:13.210813-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-11T21:47:13.210813-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-02-11T21:50:14.26495-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-04T15:42:15.352855-07:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on build 6.0-20130402"}, {"time":"2013-04-22T16:28:18.56204-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-04-22T16:28:18.56204-07:00", "fixedAt":"2013-02-11T21:50:14.26495-08:00", "fixedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "shippedAt":"2013-04-04T15:42:15.352855-07:00", "shippedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "closedAt":"2013-04-22T16:28:18.56204-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}