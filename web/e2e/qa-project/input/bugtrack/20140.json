{"id":20140, "kind":"Bug", "createdAt":"2012-11-19T20:50:24.490728-08:00", "status":"Closed", "title":"JNLNOTOPN causing server to restart during MLCP ingestion", "category":"XCC/Java", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"dsheahan", "name":"Denis Sheahan", "email":"Denis.Sheahan@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Testing mlcp ingestion of CPoX data on a 10 node SGI cluster\r\n8 Forests per node\r\nSeparate client\r\n\r\nmlcp.sh import -host r01n12-bond0 -port 10001 -username admin -password admin -input_file_path /dev/shm/cpox2 -input_file_type documents -input_compressed true -document_type xml -archive_metadata_optional true -output_uri_prefix \"/pages/30/\" -mode local -fastload true -thread_count 160  -batch_size 10 -transaction_size 1 \r\n\r\nLatest nightly ML and mlcp\r\n\r\nmlcp reports 82% of the content has been ingested.  In this case we have used zipsplit to create 15,237 files all 1MB\r\n\r\nFailure is as follows----\r\n\r\n12/11/16 11:04:47 INFO contentpump.LocalJobRunner:  completed 82%\r\n12/11/16 11:06:48 ERROR mapreduce.ContentWriter:\r\ncom.marklogic.xcc.exceptions.ServerConnectionException: Error parsing HTTP\r\nheaders: Premature EOF, partial header line read: ''\r\n[Session: user=admin, cb=#1044072723717136800 [ContentSource: user=admin,\r\ncb={none} [provider: address=r01n14-bond0/172.16.1.14:10001, pool=0/64]]]\r\n[Client: XCC/6.0-20121115, Server: XDBC/6.0-20121115]\r\n12/11/16 11:06:48 ERROR mapreduce.ContentWriter:\r\ncom.marklogic.xcc.exceptions.ServerConnectionException: Error parsing HTTP\r\nheaders: Premature EOF, partial header line read: ''\r\n[Session: user=admin, cb=#1044072723717136800 [ContentSource: user=admin,\r\ncb={none} [provider: address=r01n14-bond0/172.16.1.14:10001, pool=0/64]]]\r\n[Client: XCC/6.0-20121115, Server: XDBC/6.0-20121115]\r\n2012-11-16 11:06:48.917 WARNING [12]\r\n(AbstractRequestController.runRequest): Cannot obtain connection:\r\nConnection refused\r\njava.net.ConnectException: Connection refused\r\n        sun.nio.ch.Net.connect(Native Method)\r\n        sun.nio.ch.SocketChannelImpl.connect(SocketChannelImpl.java:500)\r\n        java.nio.channels.SocketChannel.open(SocketChannel.java:146)\r\n        com.marklogic.xcc.impl.SocketPoolProvider.obtainConnection(SocketPoolProvi\r\nder.java:93)\r\n        com.marklogic.xcc.impl.handlers.AbstractRequestController.runRequest(Abstr\r\nactRequestController.java:81)\r\n        com.marklogic.xcc.impl.SessionImpl.submitRequestInternal(SessionImpl.java:\r\n390)\r\n        com.marklogic.xcc.impl.SessionImpl.rollback(SessionImpl.java:183)\r\n        com.marklogic.xcc.impl.SessionImpl.close(SessionImpl.java:196)\r\n        com.marklogic.mapreduce.ContentWriter.write(ContentWriter.java:357)\r\n        com.marklogic.mapreduce.ContentWriter.write(ContentWriter.java:58)\r\n        org.apache.hadoop.mapreduce.TaskInputOutputContext.write(TaskInputOutputCo\r\nntext.java:80)\r\n        com.marklogic.contentpump.DocumentMapper.map(DocumentMapper.java:47)\r\n        com.marklogic.contentpump.DocumentMapper.map(DocumentMapper.java:33)\r\n        org.apache.hadoop.mapreduce.Mapper.run(Mapper.java:144)\r\n        com.marklogic.contentpump.LocalJobRunner$LocalMapTask.call(LocalJobRunner.\r\njava:269)\r\n        java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)\r\n        java.util.concurrent.FutureTask.run(FutureTask.java:138)\r\n        java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.\r\njava:886)\r\n        java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java\r\n:908)\r\n        java.lang.Thread.run(Thread.java:662)\r\n2012-11-16 11:06:48.917 WARNING [42]\r\n(AbstractRequestController.runRequest): Cannot obtain connection:\r\nConnection refused\r\njava.net.ConnectException: Connection refused\r\n        sun.nio.ch.Net.connect(Native Method)\r\n        sun.nio.ch.SocketChannelImpl.connect(SocketChannelImpl.java:500)\r\n        java.nio.channels.SocketChannel.open(SocketChannel.java:146)\r\n        com.marklogic.xcc.impl.SocketPoolProvider.obtainConnection(SocketPoolProvi\r\nder.java:93)\r\n        com.marklogic.xcc.impl.handlers.AbstractRequestController.runRequest(Abstr\r\nactRequestController.java:81)\r\n        com.marklogic.xcc.impl.SessionImpl.submitRequestInternal(SessionImpl.java:\r\n390)\r\n        com.marklogic.xcc.impl.SessionImpl.rollback(SessionImpl.java:183)\r\n        com.marklogic.xcc.impl.SessionImpl.close(SessionImpl.java:196)\r\n        com.marklogic.mapreduce.ContentWriter.write(ContentWriter.java:357)\r\n        com.marklogic.mapreduce.ContentWriter.write(ContentWriter.java:58)\r\n        org.apache.hadoop.mapreduce.TaskInputOutputContext.write(TaskInputOutputCo\r\nntext.java:80)\r\n        com.marklogic.contentpump.DocumentMapper.map(DocumentMapper.java:47)\r\n        com.marklogic.contentpump.DocumentMapper.map(DocumentMapper.java:33)\r\n        org.apache.hadoop.mapreduce.Mapper.run(Mapper.java:144)\r\n        com.marklogic.contentpump.LocalJobRunner$LocalMapTask.call(LocalJobRunner.\r\njava:269)\r\n        java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)\r\n        java.util.concurrent.FutureTask.run(FutureTask.java:138)\r\n        java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.\r\njava:886)\r\n        java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java\r\n:908)\r\n        java.lang.Thread.run(Thread.java:662)\r\n\r\n", "samplequery":"Ingestion via mlcp", "sampledata":"", "version":"6.0-nightly", "tofixin":"N/A", "fixedin":"N/A", "platform":"all", "memory":"128GB", "processors":"2 chip,12 cores", "note":"", "subscribers":[{"username":"dsheahan", "name":"Denis Sheahan", "email":"Denis.Sheahan@marklogic.com"}, {"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20120, "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["XCC/Java", "dsheahan"], "changeHistory":[{"time":"2012-11-19T20:50:24.490728-08:00", "updatedBy":{"username":"dsheahan", "name":"Denis Sheahan", "email":"Denis.Sheahan@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsheahan", "name":"Denis Sheahan", "email":"Denis.Sheahan@marklogic.com"}, "to":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-21T13:26:17.762876-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I'm able to reproduce this in the SGI environment with 40 forests in the cluster.  The error coincides with a merge on the target node.  It doesn't happen consistently.  Sometimes I just get connection refused and the server logs JNLNOTOPN and restarts.\r\n\r\nI can reliably reproduce this using a debugger in my dev environment:\r\n0) Set XDBC Server keepalive to 0.\r\n1) in XCC, stop at ContentInsertController.java:127\r\n2) in Server, stop at XDBCServer.cpp:1187\r\n3) continue in XCC.  The following error will be thrown:\r\n\r\ncom.marklogic.xcc.exceptions.ServerConnectionException: Error parsing HTTP headers: Premature EOF, partial header line read: ''\r\n [Session: user=admin, cb={default} [ContentSource: user=admin, cb={none} [provider: address=jchen/172.16.16.97:5275, pool=0/64]]]\r\n [Client: XCC/6.1-1, Server: XDBC/6.1-20121113]count = 0\r\nerror = 1\r\n\r\n\tat com.marklogic.xcc.impl.handlers.AbstractRequestController.runRequest(AbstractRequestController.java:123)\r\n\tat com.marklogic.xcc.impl.SessionImpl.insertContent(SessionImpl.java:309)\r\n\tat com.marklogic.xcc.impl.SessionImpl.insertContentCollectErrors(SessionImpl.java:283)\r\n\tat com.marklogic.xcc.examples.ContentLoader.load(ContentLoader.java:102)\r\n\tat com.marklogic.xcc.examples.ContentLoader.load(ContentLoader.java:135)\r\n\tat com.marklogic.xcc.examples.ContentLoader.main(ContentLoader.java:198)\r\nCaused by: java.io.IOException: Error parsing HTTP headers: Premature EOF, partial header line read: ''\r\n\tat com.marklogic.http.HttpHeaders.nextHeaderLine(HttpHeaders.java:307)\r\n\tat com.marklogic.http.HttpHeaders.parseResponseHeaders(HttpHeaders.java:270)\r\n\tat com.marklogic.http.HttpChannel.parseHeaders(HttpChannel.java:310)\r\n\tat com.marklogic.http.HttpChannel.receiveMode(HttpChannel.java:283)\r\n\tat com.marklogic.http.HttpChannel.getResponseCode(HttpChannel.java:182)\r\n\tat com.marklogic.xcc.impl.handlers.ContentInsertController.serverDialog(ContentInsertController.java:129)\r\n\tat com.marklogic.xcc.impl.handlers.AbstractRequestController.runRequest(AbstractRequestController.java:84)\r\n\t... 5 more\r\n\r\nIf issueRequest is called after socket is closed (XDBCServer.cpp:1446), I get broken pipe instead.\r\n\r\nTo fix the bug, I will:\r\n1) catch the exception and retry with another connection;\r\n2) catch any exception in Session.close() in ContentWriter, and log the ServerConnectionException caught."}, {"time":"2012-11-21T13:27:03.122211-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "to":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-21T13:27:03.122211-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2012-11-25T14:49:26.906381-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"121430", "paths":["xcc/trunk/xcc/src/java/com/marklogic/http/HttpChannel.java", "xcc/trunk/xcc/src/java/com/marklogic/xcc/impl/SessionImpl.java", "xcc/trunk/xcc/src/java/com/marklogic/http/HttpHeaders.java", "xcc/trunk/xcc/src/java/com/marklogic/xcc/Session.java", "xcc/trunk/xcc/src/java/com/marklogic/xcc/impl/handlers/AbstractRequestController.java", "xcc/trunk/xcc/src/java/com/marklogic/xcc/exceptions/UnexpectedResponseException.java"], "affectedBugs":[]}, "comment":"Bug:20120 - Retry when incomplete response is received.\n"}, {"time":"2012-11-25T14:54:07.895389-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"121431", "paths":["xcc/branches/b6_0/xcc/src/java/com/marklogic/xcc/Session.java", "xcc/branches/b6_0/xcc/src/java/com/marklogic/xcc/impl/handlers/AbstractRequestController.java", "xcc/branches/b6_0/xcc/src/java/com/marklogic/xcc/exceptions/UnexpectedResponseException.java", "xcc/branches/b6_0/xcc/src/java/com/marklogic/xcc/impl/SessionImpl.java", "xcc/branches/b6_0/xcc/src/java/com/marklogic/http/HttpChannel.java", "xcc/branches/b6_0/xcc/src/java/com/marklogic/http/HttpHeaders.java"], "affectedBugs":[]}, "comment":"1) Bug:20120 - Retry when incomplete response is received.\n2) Catch any exception in Session.close().\n"}, {"time":"2012-11-25T15:32:10.169467-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Will file a different one."}, {"time":"2012-11-25T15:32:10.169467-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"assignTo":{"from":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2012-11-25T15:32:10.169467-08:00", "closedAt":"2012-11-25T15:32:10.169467-08:00", "closedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "renderDescriptionAs":"normal", "renderSampleQueryAs":"normal"}