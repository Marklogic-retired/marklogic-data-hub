{"id":20570, "kind":"Bug", "createdAt":"2013-01-23T10:46:05.316194-08:00", "status":"Closed", "title":"FlexRep schema validation can sometimes cause replication to fail", "category":"Replication", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"mhelmstetter", "name":"Mark Helmstetter", "email":"mark.helmstetter@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Currently FlexRep does schema validation of the entire flexrep:update element. This can sometimes fail. For example, if my document properties contain elements in the marklogic http namespace, FlexRep will fail with the error:\r\n\r\nXDMP:VALIDATEUNEXPECTED: (err:XQDY0027) validate { $val } -- Invalid node: Found http:message but expected () at flexrep:update/prop:properties/XXX/ResponseHeader/http:response/http:message using schema \"flexrep.xsd\".\r\n\r\nThere may be other cases where schema validation could fail. It seems desirable from both performance and robustness perspectives to just disable schema validation altogether. We've been doing this for quite sometime by setting $VALIDATE to false in flexrep.xqy:\r\n\r\ndeclare variable $VALIDATE as xs:boolean := fn:false();\r\n\r\nIMO, FlexRep should ship like this, with validate turned off.", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea1", "fixedin":"7.0-ea1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"mhelmstetter", "name":"Mark Helmstetter", "email":"mark.helmstetter@marklogic.com"}, {"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, {"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"edelacruz", "name":"Ed Delacruz", "email":"ed.delacruz@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20569, "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["Replication", "mhelmstetter"], "changeHistory":[{"time":"2013-01-23T11:20:03.733996-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-6"}}, "files":[], "show":true}, {"time":"2013-01-23T11:45:49.004488-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-23T11:45:49.004488-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-23T11:45:49.004488-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"5.0-6", "to":"5.0-5"}}, "files":[], "show":true}, {"time":"2013-01-23T13:24:58.867565-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-23T14:34:49.048733-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Validation was enabled for robustness and it doesn't affect performance that much.  So we should either fix the schema if it is not correct or the \"update\"  if it doesn't follow the right schema. \r\n\r\nFor the example above, it may be an issue with the http schema, not the flexrep schema.   \"Prop:properties\" is defined as \"<xs:any processContents=\"lax\"/>\" in property.xsd.  So the validation skips XXX and ResponseHeader since there is no schema for them.  But http:response has a schema defined in http.xsd.  Http:message currently is defined as a choice:\r\n\r\n   <xs:choice> \r\n      <xs:element ref=\"code\" minOccurs=\"1\" maxOccurs=\"1\"/>\r\n      <xs:element ref=\"message\" minOccurs=\"0\" maxOccurs=\"1\"/>\r\n      <xs:element ref=\"headers\" minOccurs=\"0\" maxOccurs=\"unbounded\"/>\r\n    </xs:choice>\r\n\r\nThis basically says it has to be either a code or a message or a sequence of headers, which doesn't sound right."}, {"time":"2013-01-23T15:12:56.318417-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"129057", "paths":["xdmp/branches/b5_0/src/Config/http.xsd"], "affectedBugs":[]}, "comment":"bug:20562 FlexRep schema validation can sometimes cause replication to fail"}, {"time":"2013-01-23T15:15:14.882844-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The simplest fix is to add maxOccurs=\"unbounded\" to the <choice> for http:response. Here is a test case:\r\n\r\n\r\nimport schema \"http://marklogic.com/xdmp/flexible-replication\" at \"flexrep.xsd\";\r\n\r\ndeclare namespace flexrep = \"http://marklogic.com/xdmp/flexible-replication\";\r\ndeclare namespace doc = \"xdmp:document-load\";\r\ndeclare namespace http = \"xdmp:http\";\r\n\r\nlet $update :=  element flexrep:update {\r\n  <doc:uri>foo.xml</doc:uri>,\r\n  <flexrep:last-updated>2013-01-23T15:00:00</flexrep:last-updated>,\r\n  <doc:format>xml</doc:format>,\r\n  <flexrep:permissions/>,\r\n  <doc:collections/>,\r\n  <doc:quality>1</doc:quality>,\r\n  <flexrep:forests/>,\r\n  <prop:properties>\r\n    <FOO>\r\n      <http:response>\r\n        <http:code>200</http:code>\r\n        <http:message>OK</http:message>\r\n      </http:response>\r\n    </FOO>\r\n  </prop:properties>\r\n}\r\nreturn validate {$update}\r\n\r\nBefore the code change, the validation failed with the exact same error as what Mark saw in his env."}, {"time":"2013-01-23T15:18:53.902347-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-01-23T15:20:54.86708-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"129059", "paths":["xdmp/trunk/src/Config/http.xsd"], "affectedBugs":[]}, "comment":"bug:20570 FlexRep schema validation can sometimes cause replication to fail"}, {"time":"2013-01-23T15:21:12.340547-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-23T15:21:12.340547-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-24T21:26:15.505099-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"129251", "paths":["xdmp/trunk/src/Modules/MarkLogic/flexrep.xqy"], "affectedBugs":[]}, "comment":"bug:20570 disabled validation in flexrep"}, {"time":"2013-03-02T11:24:51.785191-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-06T13:04:56.612564-08:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on build 7.0-ea1_20130306"}], "updatedAt":"2013-03-06T13:04:56.612564-08:00", "fixedAt":"2013-01-23T15:21:12.340547-08:00", "fixedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "shippedAt":"2013-03-06T13:04:56.612564-08:00", "shippedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "renderDescriptionAs":"normal"}