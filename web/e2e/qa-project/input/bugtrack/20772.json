{"id":20772, "kind":"Bug", "createdAt":"2013-02-13T05:43:40.974719-08:00", "status":"Closed", "title":"Passing an XML MarkLogic Node between the Map and Reduce phase triggers a MalformedByteSequenceException: Invalid byte 1 of 1-byte UTF-8 sequence", "category":"Hadoop Connector", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"I've discussed this with Jane over email and she's recommended I file a bug to cover this scenario.\r\n\r\nThe original supoort case is discussed at:\r\nhttps://help.marklogic.com/staff/Tickets/Ticket/View/12403\r\n\r\nZipfile containing an example project is attached with a (hopefully) simple test case; you should be able to open it in an IDE, update the Maven dependencies and run to see the message.  Alternatively, there is a project attached to the support ticket (Archive.zip)  which also shows the same behaviour\r\n\r\ncom.sun.org.apache.xerces.internal.impl.io.MalformedByteSequenceException: Invalid byte 1 of 1-byte UTF-8 sequence.\r\n\tat com.sun.org.apache.xerces.internal.impl.io.UTF8Reader.invalidByte(UTF8Reader.java:687)\r\n\tat com.sun.org.apache.xerces.internal.impl.io.UTF8Reader.read(UTF8Reader.java:557)\r\n\tat com.sun.org.apache.xerces.internal.impl.XMLEntityScanner.load(XMLEntityScanner.java:1753)\r\n\tat com.sun.org.apache.xerces.internal.impl.XMLEntityScanner.skipSpaces(XMLEntityScanner.java:1527)\r\n\tat com.sun.org.apache.xerces.internal.impl.XMLDocumentScannerImpl$TrailingMiscDriver.next(XMLDocumentScannerImpl.java:1359)\r\n\tat com.sun.org.apache.xerces.internal.impl.XMLDocumentScannerImpl.next(XMLDocumentScannerImpl.java:607)\r\n\tat com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:489)\r\n\tat com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:835)\r\n\tat com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:764)\r\n\tat com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:123)\r\n\tat com.sun.org.apache.xerces.internal.parsers.DOMParser.parse(DOMParser.java:237)\r\n\tat com.sun.org.apache.xerces.internal.jaxp.DocumentBuilderImpl.parse(DocumentBuilderImpl.java:300)\r\n\tat javax.xml.parsers.DocumentBuilder.parse(DocumentBuilder.java:121)\r\n\tat org.apache.commons.modeler.util.DomUtil.readXml(DomUtil.java:257)\r\n\tat com.marklogic.mapreduce.MarkLogicNode.readFields(MarkLogicNode.java:150)\r\n\tat org.apache.hadoop.io.serializer.WritableSerialization$WritableDeserializer.deserialize(WritableSerialization.java:67)\r\n\tat org.apache.hadoop.io.serializer.WritableSerialization$WritableDeserializer.deserialize(WritableSerialization.java:40)\r\n\tat org.apache.hadoop.mapreduce.ReduceContext.nextKeyValue(ReduceContext.java:116)\r\n\tat org.apache.hadoop.mapreduce.ReduceContext.nextKey(ReduceContext.java:92)\r\n\tat org.apache.hadoop.mapreduce.Reducer.run(Reducer.java:175)\r\n\tat org.apache.hadoop.mapred.ReduceTask.runNewReducer(ReduceTask.java:566)\r\n\tat org.apache.hadoop.mapred.ReduceTask.run(ReduceTask.java:408)\r\n\tat org.apache.hadoop.mapred.LocalJobRunner$Job.run(LocalJobRunner.java:216)", "samplequery":"I will attach a sample Java project to cover the scenario outlined in this case.", "sampledata":"", "version":"6.0-2.2", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"Tested under Linux, but I suspect this is reproducible under Windows", "subscribers":[{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, {"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}], "attachments":[{"name":"(Hopefully) simplified test project attached to allow you to easily reproduce this issue locally.", "uri":"root/support/bugtracking/attachments/20772/ml-hadoop.tar.gz"}, {"name":"Configuration file to go with Test20772.java", "uri":"root/support/bugtracking/attachments/20772/marklogic-test20772.xml"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"Passing an XML MarkLogic Node between the Map and Reduce phase triggers a MalformedByteSequenceException: Invalid byte 1 of 1-byte UTF-8 sequence", "supportDescription":"A stacktrace is produced with the MalformedByteSequenceException: Invalid byte 1 of 1-byte UTF-8 sequence when MarkLogicNode data is being moved from the Map process to the Reduce process triggering an exception which causes the Hadoop job to fail.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"Medium", "title":"Requires significant or unnatural effort to work around issue or to prevent significant business impact"}, "workaround":"Change the configuration to parse the XML as Text."}, "tags":["Hadoop Connector", "ableasdale"], "changeHistory":[{"time":"2013-02-13T05:43:40.974719-08:00", "updatedBy":{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, "to":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-13T09:35:35.82801-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-02-25T10:50:29.980923-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"support wants this fixed"}, {"time":"2013-03-18T10:36:31.165113-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137105", "paths":["xcc/trunk/mapreduce/src/java/com/marklogic/mapreduce/MarkLogicNode.java"], "affectedBugs":[]}, "comment":"Bug:20772 - Fix serialize/deserialization.\n"}, {"time":"2013-03-18T10:39:11.519047-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137106", "paths":["xcc/branches/b6_0/mapreduce/src/java/com/marklogic/mapreduce/MarkLogicNode.java"], "affectedBugs":[]}, "comment":"Bug:20772 - Fix serialize/deserialization.\n"}, {"time":"2013-03-18T10:41:26.699278-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137107", "paths":["xcc/trunk/mapreduce/src/java/com/marklogic/mapreduce/test/Test20772.java"], "affectedBugs":[]}, "comment":"Bug:20772 - Add test case.\n"}, {"time":"2013-03-18T10:42:09.461974-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137108", "paths":["xcc/branches/b6_0/mapreduce/src/java/com/marklogic/mapreduce/test/Test20772.java"], "affectedBugs":[]}, "comment":"Bug:20772 - Add test case.\n"}, {"time":"2013-03-18T10:45:34.098783-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Test case checked in at mapreduce/src/java/com/marklogic/mapreduce/test/Test20772.java.  \r\n\r\nAlex, can you double-check using tomorrow's nightly with Sam's original test case?  Thanks!"}, {"time":"2013-03-18T10:45:34.098783-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-18T10:45:34.098783-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"assignTo":{"from":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-10T11:45:29.356383-07:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on build 6.0-20130408"}, {"time":"2013-04-22T16:35:07.343853-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-04-22T16:35:07.343853-07:00", "fixedAt":"2013-03-18T10:45:34.098783-07:00", "fixedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "shippedAt":"2013-04-10T11:45:29.356383-07:00", "shippedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "closedAt":"2013-04-22T16:35:07.343853-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal", "renderSampleQueryAs":"normal"}