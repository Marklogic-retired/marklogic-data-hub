{"id":20850, "kind":"Bug", "createdAt":"2013-02-19T11:38:50.438509-08:00", "status":"Closed", "title":"XDMP-MISSINGFILE during replication", "category":"xdmp", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"JPMC encountered this last night while testing out a 5.0-5 nightly build. The same fragment is failing to replicate over and over.\r\n\r\n$ grep XDMP-MISSINGFILE /var/opt/MarkLogic/Logs/ErrorLog_1.txt\r\n2013-02-18 17:19:11.542 Debug: ForestSynchronizeThread::run: DCPP_Forest35 XDMP-MISSINGFILE: Missing file /data/MarkLogic11/Forests/DCPP_Forest35/Large/315/c55ada9ba870453c\r\n2013-02-18 17:20:28.991 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:20:56.665 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:21:21.656 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:21:48.487 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:22:13.598 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:22:39.067 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:23:04.461 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:23:27.455 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:23:52.810 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:24:18.958 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:24:45.280 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:25:12.684 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:25:38.666 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:26:02.461 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n", "samplequery":"", "sampledata":"", "version":"6.0-nightly", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20837, "support":{"headline":"", "supportDescription":"", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "wfeick"], "changeHistory":[{"time":"2013-02-19T11:38:50.438509-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-19T16:39:29.105482-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"132500", "paths":["xdmp/branches/b5_0/src/Forest.cpp", "xdmp/branches/b5_0/src/BinaryManager.h", "xdmp/branches/b5_0/src/BinaryManager.cpp"], "affectedBugs":[]}, "comment":"bug:20837 a speculative fix; more trace events"}, {"time":"2013-02-20T10:56:42.339459-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"132642", "paths":["xdmp/branches/b5_0/src/Forest.cpp"], "affectedBugs":[]}, "comment":"Bug:20837 respond to XDMP-MISSINGFILE during large binary bulk replication by replicating the binary again."}, {"time":"2013-02-20T12:10:18.517304-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-02-21T10:59:36.884414-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"132896", "paths":["xdmp/branches/b6_0/src/Forest.cpp", "xdmp/branches/b6_0/src/BinaryManager.cpp", "xdmp/branches/b6_0/src/BinaryManager.h"], "affectedBugs":[]}, "comment":"bug:20850 XDMP-MISSINGFILE during replication"}, {"time":"2013-02-21T11:08:25.429588-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-21T11:08:25.429588-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-21T23:39:38.859746-07:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-29T16:21:23.025104-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Steps to Verify:\r\n\r\n1. Create Database in two different clusters and enable database replication.\r\n2. Insert Large binaries in Master and let it replicate to replica database.\r\n3. Bring host down in replica that has Forest with replicated binary.\r\n4. Remove forest Label from forest's data directory.\r\n5. Delete large binary from Forests's data directory (on replica)\r\n6. Modify the large binary on Master (add a collection or something).\r\n7. Bring replica host back up.\r\n\r\nWhat should happen:\r\n - It should be reported in ErrorLog that Largebinary is missing with XDMP-MISSINGFILE\r\n - Then replica forest should sync up with master and get the missing file (bulk replicate).\r\n - Check contents of file on master and replica (md5sum) "}, {"time":"2013-03-29T16:48:47.724498-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified with MarkLogic-6.0-20130329\r\n\r\nLogs:\r\n2013-03-29 16:42:46.443 Info: Forest Documents starting synchronization to foreign forest Documents in cluster rh5-intel64-25.marklogic.com-cluster\r\n2013-03-29 16:42:46.443 Info: Forest Documents starting bulk replication to foreign forest Documents in cluster rh5-intel64-25.marklogic.com-cluster\r\n2013-03-29 16:42:46.447 Info: Forest Documents replicating 2 keys to foreign forest Documents in cluster rh5-intel64-25.marklogic.com-cluster\r\n2013-03-29 16:42:46.456 Info: Forest Documents needs to replicate 1 fragments to foreign forest Documents in cluster rh5-intel64-25.marklogic.com-cluster\r\n2013-03-29 16:42:46.480 Warning: Forest Documents missing large binary file: XDMP-MISSINGFILE: Missing file /var/opt/MarkLogic/Forests/Documents/Large/2e8/ba30f03e392dce27\r\n2013-03-29 16:42:47.836 Info: Deleted 15 MB in 1 sec at 383 MB/sec /var/opt/MarkLogic/Forests/Documents/00000003\r\n2013-03-29 16:42:47.854 Info: Deleted 1 MB in 1 sec at 56 MB/sec /var/opt/MarkLogic/Forests/Documents/00000002\r\n2013-03-29 16:43:04.129 Info: Forest Documents bulk replicated 1 fragments (0 skipped, 0 not found) to foreign forest Documents in cluster rh5-intel64-25.marklogic.com-cluster (0/sec)\r\n2013-03-29 16:43:04.220 Info: Forest Documents finished bulk replicating to foreign forest Documents in cluster rh5-intel64-25.marklogic.com-cluster\r\n2013-03-29 16:43:04.237 Info: Forest Documents finished synchronizing to foreign replica forest Documents in cluster rh5-intel64-25.marklogic.com-cluster\r\n\r\n\r\nOn Master:\r\nxdmp:md5(xdmp:subbinary(fn:doc(\"/binary-support/LimitlessTrailer.mp4\")/binary(),1,100),\"hex\") ==> aed892111f0b69c2c6f7050b0c9fe590\r\n\r\nOn Replica:\r\nxdmp:md5(xdmp:subbinary(fn:doc(\"/binary-support/LimitlessTrailer.mp4\")/binary(),1,100),\"hex\") ==> aed892111f0b69c2c6f7050b0c9fe590"}], "updatedAt":"2013-03-29T16:48:47.724498-07:00", "fixedAt":"2013-02-21T11:08:25.429588-08:00", "fixedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "shippedAt":"2013-03-29T16:48:47.724498-07:00", "shippedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "renderDescriptionAs":"normal"}