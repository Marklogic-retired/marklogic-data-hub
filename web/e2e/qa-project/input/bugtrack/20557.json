{"id":20557, "kind":"Bug", "createdAt":"2012-10-10T16:23:21.564619-07:00", "status":"Closed", "title":"mlcp import throws OutOfMemoryError the input_file_path includes millions of documents", "category":"mlcp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"This is a problem found by Steven Brockman and James Kerr.\r\n\r\ninput_file_path points to a directory with 11 million xml documents in it.\r\n\r\n./mlcp.sh import -host localhost -port 8035 -username admin -thread_count 9 -document_type xml \\\r\n    -password password -mode local -fastload -input_file_path /esdata/wikipediaxml -input_file_pattern '.*\\.xml'\r\n----------------------------------------------------------------------------------------------\r\nI get this result after 90 minutes of waiting:\r\n \r\n12/10/04 17:52:17 INFO contentpump.LocalJobRunner: Content type: XML\r\n12/10/04 17:52:17 INFO jvm.JvmMetrics: Initializing JVM Metrics with processName=JobTracker, sessionId=\r\n \r\nException in thread \"main\" java.lang.OutOfMemoryError: Java heap space\r\n                at java.util.Arrays.copyOf(Arrays.java:2882)\r\n                at java.lang.AbstractStringBuilder.expandCapacity(AbstractStringBuilder.java:100)\r\n                at java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:390)\r\n                at java.lang.StringBuffer.append(StringBuffer.java:224)\r\n                at java.net.URI.appendSchemeSpecificPart(URI.java:1873)\r\n                at java.net.URI.toString(URI.java:1903)\r\n                at java.net.URI.<init>(URI.java:732)\r\n                at org.apache.hadoop.fs.Path.<init>(Path.java:65)\r\n                at org.apache.hadoop.fs.Path.<init>(Path.java:50)\r\n                at org.apache.hadoop.fs.RawLocalFileSystem.listStatus(RawLocalFileSystem.java:290)\r\n                at org.apache.hadoop.fs.FileSystem.listStatus(FileSystem.java:721)\r\n                at org.apache.hadoop.fs.FileSystem.listStatus(FileSystem.java:746)\r\n                at org.apache.hadoop.fs.ChecksumFileSystem.listStatus(ChecksumFileSystem.java:465)\r\n                at org.apache.hadoop.fs.FileSystem.listStatus(FileSystem.java:721)\r\n                at org.apache.hadoop.fs.FileSystem.listStatus(FileSystem.java:746)\r\n                at org.apache.hadoop.mapreduce.lib.input.FileInputFormat.listStatus(FileInputFormat.java:212)\r\n                at org.apache.hadoop.mapreduce.lib.input.FileInputFormat.getSplits(FileInputFormat.java:241)\r\n                at com.marklogic.contentpump.FileAndDirectoryInputFormat.getSplits(FileAndDirectoryInputFormat.java:51)\r\n                at com.marklogic.contentpump.CombineDocumentInputFormat.getSplits(CombineDocumentInputFormat.java:64)\r\n                at com.marklogic.contentpump.LocalJobRunner.run(LocalJobRunner.java:113)\r\n                at com.marklogic.contentpump.ContentPump.runJobLocally(ContentPump.java:295)\r\n                at com.marklogic.contentpump.ContentPump.runCommand(ContentPump.java:205)\r\n                at com.marklogic.contentpump.ContentPump.main(ContentPump.java:66)\r\n", "samplequery":"", "sampledata":"", "version":"6.0-1", "tofixin":"6.0-4", "fixedin":"6.0-4", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, {"username":"dcassel", "name":"Dave Cassel", "email":"dave.cassel@marklogic.com"}, {"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, {"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, {"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, {"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}], "attachments":[{"name":"String takes 314MB", "uri":"root/support/bugtracking/attachments/19719/memory view.PNG"}, {"name":"field uri in fs.Path takes 139MB", "uri":"root/support/bugtracking/attachments/19719/fs.Path.PNG"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":19719, "support":{"headline":"mlcp import throws OutOfMemoryError if the input_file_path includes huge number of documents", "supportDescription":"When mlcp import starts, it collects file status for the entire set of document. In this phase, JVM heap consumption for loading each document takes about 1KB. For each 1 million plain documents to be loaded, it is recommended to allocate 1GB JVM heap size for mlcp.  If the JVM heap size is not large enough, an OutOfMemoryError will occur.\r\n\r\n", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":"Allocate enough JVM heap size for mlcp if the number of plain documents to load is huge. e.g., 10 million plain documents.\r\nJVM_OPTS='-Xmx10240M' mclp.sh import … \r\n\r\nA better way to work around this problem is to zip the documents into a small set of zip files. E.g., zip every 64000 docs into a zip file. \r\nmclp.sh import  -compress true …"}, "tags":["mlcp", "ali"], "changeHistory":[{"time":"2012-10-10T16:23:21.564619-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-10-22T14:42:30.417066-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-10-23T17:14:41.161248-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Use mlcp to load 1834894 files. During the loading, after running for a few minutes, Jprofilers shows String objects take 314MB. Field uri in org.apache.hadoop.fs.Path takes 139MB.\r\n\r\norg.apache.hadoop.fs.RawLocalFileSystem.listStatus(RawLocalFileSystem.java:290)  is where a Path objects are created.\r\n\r\nresults[i] = getFileStatus(new Path(f, names[i]));"}, {"time":"2012-10-26T15:58:17.517146-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"We found out each Path contains a URI, and each URI contain a number of Strings.\r\nI have done some measurement for jvm heap consumption during the phase of listStatus (before docs start actually get loaded) using Sun JDK.\r\n\r\n#docs    String jvm heap consumption     URI jvm heap consumption    total jvm heap consumption     comment\r\n1.8mil     362MB                                       292MB                                    1.5GB                                     was able to finish listStatus and loading\r\n3.6mil     644MB                                       530MB                                    2.8GB                                     was able to finish listStatus and loading\r\n5.4mil     836MB                                       752MB                                    2.7GB                                     stuck at listStatus.\r\n\r\njvm heap consumption slightly decreases after listStatus stage, so it peaks at the end of listStatus.\r\nIf I use the measure of 3.6 million docs as a sample, during listStatus stage, jvm heap consumption for each document is 815 bytes.\r\nthat means, if we load 1 million docs, we need roughly 815MB jvm heap. if we load 10 million docs, we need roughly 8.2 GB jvm heap.\r\n\r\nTo fix it requires rethinking about how to implement listStatus (hadoop api related) efficiently, and thinking about how to traverse recursively in FileAndDirectoryInputFormat without using consuming too much memory. So, it is not an easy fix. Therefore, we push it to 6.0-3."}, {"time":"2012-10-26T15:59:06.681087-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"tofixin":{"from":"6.0-2", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-01-21T14:01:58.889643-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Is this an issue of many copies of the same string, or many different strings? If it's about having many copies of the same string, we could make efforts via a hash set to have only one copy.\r\n\r\nString.intern() is a common way to do this, but moves the string to a different area of the JVM's storage. See below for caveats.\r\n\r\nhttp://www.codeinstructions.com/2009/01/busting-javalangstringintern-myths.html\r\n\r\nMoving to ML7, unless there is something easy/simple we can do that makes sense to back port to ML6."}, {"time":"2013-01-21T14:01:58.889643-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"6.0-3", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-01-22T10:51:28.014651-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"listStatus returns a array of FileStatus. Each FileStatus has its own uri. It is essentially an issue of many different strings. I am afraid it is not an easy fix.\r\n\r\nThis is not a problem specifically for mlcp, HDFS has this problem too. And mlcp inherits this problem because we use hadoop api.\r\nhttp://blog.cloudera.com/blog/2009/02/the-small-files-problem/\r\nI haven't seen later hadoop releases solve this problem. \r\n\r\n7.0-ea1 code freezes around mid-Feb. \r\nIs 6.0-3 going to be earlier than 7.0-ea1? "}, {"time":"2013-01-22T10:58:43.271669-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I don't believe we can rely on Hadoop to solve this.  We discussed some workarounds for this that are worth trying."}, {"time":"2013-01-22T15:08:23.042197-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea1", "to":"7.0-1"}}, "files":[], "show":true}, {"time":"2013-01-22T15:10:20.456542-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Jane suggests that we fix it in 6.0-3 since it is a bug from field."}, {"time":"2013-01-22T15:10:20.456542-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-02-27T13:01:59.947831-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"6.0-3", "to":"6.0-4"}}, "files":[], "show":true}, {"time":"2013-06-14T11:59:19.590622-07:00", "updatedBy":{"username":"fsalonga", "name":"Frank Salonga", "email":"franklin.salonga@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"from mrtriage - is this even worth fixing? similar bug was already closed"}, {"time":"2013-06-14T11:59:19.590622-07:00", "updatedBy":{"username":"fsalonga", "name":"Frank Salonga", "email":"franklin.salonga@marklogic.com"}, "change":{"tofixin":{"from":"6.0-4", "to":"6.0-5"}}, "files":[], "show":true}, {"time":"2013-06-14T12:01:03.572072-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Why not?  What's the similar bug that got closed?"}, {"time":"2013-06-14T15:43:43.937661-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Talked to Frank.  Moving it back to 6.0-4."}, {"time":"2013-06-14T15:43:43.937661-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"tofixin":{"from":"6.0-5", "to":"6.0-4"}}, "files":[], "show":true}, {"time":"2013-07-03T19:32:26.389432-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"145758", "paths":["xcc/branches/b6_0/mlcp/src/main/java/com/marklogic/contentpump/SequenceFileReader.java", "xcc/branches/b6_0/mlcp/src/main/java/com/marklogic/contentpump/utilities/FileIterator.java", "xcc/branches/b6_0/mlcp/src/main/java/com/marklogic/contentpump/CompressedAggXMLReader.java", "xcc/branches/b6_0/mlcp/src/main/java/com/marklogic/contentpump/AggregateXMLReader.java", "xcc/branches/b6_0/mlcp/src/main/java/com/marklogic/contentpump/CombineDocumentReader.java", "xcc/branches/b6_0/mlcp/src/main/java/com/marklogic/contentpump/CompressedDelimitedTextReader.java", "xcc/branches/b6_0/mlcp/src/main/java/com/marklogic/contentpump/ConfigConstants.java", "xcc/branches/b6_0/mlcp/src/main/java/com/marklogic/contentpump/ArchiveRecordReader.java", "xcc/branches/b6_0/mlcp/src/main/java/com/marklogic/contentpump/ImportRecordReader.java", "xcc/branches/b6_0/mlcp/src/main/java/com/marklogic/contentpump/FileAndDirectoryInputFormat.java", "xcc/branches/b6_0/mlcp/src/main/java/com/marklogic/contentpump/CompressedDocumentReader.java", "xcc/branches/b6_0/mlcp/src/main/java/com/marklogic/contentpump/DelimitedTextReader.java"], "affectedBugs":[]}, "comment":"Bug:20557\nIntroduce a threshold for #files flatten from input splits. Once the threshold is reached, input split flattening stops and leave it up to the reader to recursively traverse the split if it is a directory."}, {"time":"2013-07-08T11:14:06.101362-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true, "comment":"Please test."}, {"time":"2013-07-08T11:14:06.101362-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-07-19T15:33:14.289783-07:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-07-24T12:10:49.898773-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-07-29T15:13:51.180494-07:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"manually loaded 16,384,146 documents on 6.0-20130728 build. Ship this one now."}, {"time":"2013-07-29T15:13:51.180494-07:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{"assignTo":{"from":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-08-12T18:03:55.298491-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-08-12T18:03:55.298491-07:00", "fixedAt":"2013-07-08T11:14:06.101362-07:00", "fixedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "shippedAt":"2013-07-29T15:13:51.180494-07:00", "shippedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "closedAt":"2013-08-12T18:03:55.298491-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}