{"id":20894, "kind":"Bug", "createdAt":"2013-02-22T03:11:28.16573-08:00", "status":"Closed", "title":"REGR:modular document expansion is not working fine as expected", "category":"xdmp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"REGR:modular document expansion is not working fine as expected\r\n\r\nTest Failing: pdf-conv-mod-alert.xml\r\nML Version: 7.0-20130221\r\nLink to diff on nightly: https://regression-status.marklogic.com/new-app/space2/diff-archive/b7_0-ea1/2013-02-21/linux-64-rh6/diffs/pdf-conv-mod-alert.xml\r\n\r\nSteps to reproduce:\r\n1. Create DB with forest and associate triggers DB with created DB.\r\n2. Enable uri lexicon on DB.\r\n3. Install default cpf and wait for cpf installation\r\nxquery version '1.0-ml';\r\n    let $db-id := xdmp:database('pdf-conv-mod-alert')\r\n          let $modules-id := xdmp:database('Modules')\r\n           let $options :=\r\n            <options xmlns='xdmp:http'>\r\n              <authentication menthod='basic'>\r\n                <username>admin</username>\r\n                <password>admin</password>\r\n              </authentication>\r\n            </options>\r\n          let $url :=\r\n            concat('http://localhost:8001/database-cpf-admin-go.xqy?enable-conversion=true&amp;execution-root=/&amp;database=',\r\n              $db-id,\r\n              '&amp;execution-database=',\r\n              $modules-id)\r\n          let $r := xdmp:http-get($url, $options)\r\n          return ()\r\n4. Add pipelines to default set of pipelines\r\nxquery version '1.0-ml';\r\n        import module namespace dom = 'http://marklogic.com/cpf/domains' at '/MarkLogic/cpf/domains.xqy';\r\n        import module namespace p = 'http://marklogic.com/cpf/pipelines' at '/MarkLogic/cpf/pipelines.xqy';\r\n\r\n        let $pipeline-names := ('Alerting', 'XInclude Processing', 'PDF Conversion', 'DocBook Conversion')\r\n        for $pipeline-name in $pipeline-names\r\n        let $r := dom:add-pipeline('Default pdf-conv-mod-alert', p:get($pipeline-name)/p:pipeline-id)\r\n        return ()\r\n5. Remove unused pipelines from default set of pipelines and wait for cpf installation\r\nxquery version '1.0-ml';\r\n        import module namespace dom = 'http://marklogic.com/cpf/domains' at '/MarkLogic/cpf/domains.xqy';\r\n        import module namespace p = 'http://marklogic.com/cpf/pipelines' at '/MarkLogic/cpf/pipelines.xqy';\r\n\r\n        let $pipeline-names := ('MS Office Conversion', 'HTML Conversion', 'XHTML Conversion Processing')\r\n        for $pipeline-name in $pipeline-names\r\n        let $r := dom:remove-pipeline('Default pdf-conv-mod-alert', p:get($pipeline-name)/p:pipeline-id)\r\n        return ()\r\n6. Insert child pdf document and wait for cpf processing\r\nxquery version '1.0-ml';\r\n        xdmp:document-load('QA_HOME/testdata/cpf/HeaderTest.pdf',\r\n        <options xmlns='xdmp:document-load'><uri>/HeaderTest.pdf</uri><format>binary</format></options>)\r\n7. Insert parent xml document\r\nxquery version '1.0-ml';\r\n     let $ele := <total><values>{xdmp:unquote('<xi:include xmlns:xi=\"http://www.w3.org/2001/XInclude\" href=\"/HeaderTest_pdf.xml\"/>')}</values><a>Bush visited Mary in Netherlands</a></total>\r\n        return xdmp:document-insert('/parent.xml', $ele)\r\n8. Wait for modular document expansion\r\n       xquery version '1.0-ml';\r\n        import module namespace inc-docs='http://marklogic.com/inc-docs' at '/include-docs-mixedpipe-2.xqy';\r\n        inc-docs:check-doc-done('/parent.xml', 30, 20000)\r\n9. Run following query:\r\nxquery version '1.0-ml';\r\n        cts:uri-match('/parent_xml_expanded.xml')\r\n\r\n\r\nActual result:blank\r\nExpected result: /parent_xml_expanded.xml\r\n\r\nFollowing is seen in ErrorLog.txt during above query:\r\n2013-02-21 13:22:10.560 Error: TaskServer: pdf-conv-mod-alert: cpf:failure /parent.xml executing http://marklogic.com/states/xinclude/unexpanded\r\n\r\nNOTE:\r\nFollowing error is also seen after above mentioned error during cleanup of test:\r\n2013-02-21 13:22:52.647 Debug: Detected compatibility for database App-Services\r\n2013-02-21 13:26:52.671 Alert: XDMP-FORESTERR: Error in shutdown of forest pdf-conv-mod-alert: XDMP-FORESTTIM: Forest pdf-conv-mod-alert close operation timed out\r\n2013-02-21 13:26:52.671 Error: Reference /var/opt/MarkLogic/Forests/pdf-conv-mod-alert/00000000 4 2013-02-21T13:21:49 2013-02-21T13:22:50\r\n2013-02-21 13:26:52.814 Notice: Starting MarkLogic Server 7.0-20130221 x86_64 in /opt/MarkLogic with data in /var/opt/MarkLogic\r\n2013-02-21 13:26:52.830 Info: Host rh6-intel64-70-test-2.marklogic.com running Linux 2.6.32-279.el6.x86_64 (Red Hat Enterprise Linux Server release 6.3 (Santiago))", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea1", "fixedin":"7.0-ea1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, {"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}, {"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}], "attachments":[{"name":"Test-case validate-pipeline.xml", "uri":"root/support/bugtracking/attachments/20894/validate-pipeline.xml"}, {"name":"ErrorLog_bug12313.txt", "uri":"root/support/bugtracking/attachments/20894/ErrorLog_bug12313.txt"}, {"name":"ErrorLog_bug12313.txt", "uri":"root/support/bugtracking/attachments/20894/4467678199112148828-ErrorLog_bug12313.txt"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "iagrawal"], "changeHistory":[{"time":"2013-02-22T03:11:28.16573-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-22T10:19:01.275287-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-25T15:20:29.07832-08:00", "updatedBy":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "to":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}}}, "files":[], "show":true, "comment":"I confirm the error (\"2013-02-25 14:51:12.827 Error: TaskServer: pdf-conv-mod-alert: cpf:failure /parent.xml executing http://marklogic.com/states/xinclude/unexpanded\"), but the xdmp:pdf-convert() event appears to be running correctly, so while I'll continue to try to narrow the problem down, it doesn't seem to fall in my area of expertise."}, {"time":"2013-03-01T13:31:24.557259-08:00", "updatedBy":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The first error just seems to be reflecting the fact that the xdmp:sleep(5000) event in test-06--to allow HeaderTest.pdf to be inserted before /parent.xml is inserted with a reference to the former--is not always long enough.  Doubling it to 10000 in pdf-conv-mod-alert.xml removes that error in a release kernel, raising it to 20000 makes it succeed in a debug build with lots of printfs.  So I recommend that test case change.\r\n\r\nNow I'll investigate that second problem, XDMP-FORESTTIM at shutdown."}, {"time":"2013-03-06T02:27:52.707346-08:00", "updatedBy":{"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Facing the same problem at cleanup part in one more test in regression that involves cpf:\r\n\r\nat the time of forest delete its throwing following errors:\r\n2013-03-05 15:20:28.547 Debug: OnDiskStand /var/opt/MarkLogic/Forests/valPipeF/00000000, disk=16MB, memory=16MB\r\n2013-03-05 15:20:28.548 Info: Saved 16 MB in 1 sec at 201 MB/sec to /var/opt/MarkLogic/Forests/valPipeF/00000000\r\n2013-03-05 15:20:28.802 Debug: Detecting indexes for database Schemas\r\n2013-03-05 15:20:28.802 Debug: Detected indexes for database Schemas: sln\r\n2013-03-05 15:20:28.802 Debug: Detecting compatibility for database Schemas\r\n2013-03-05 15:20:28.803 Debug: Detected compatibility for database Schemas\r\n2013-03-05 15:20:28.987 Info: Deleting forest valPipeF\r\n2013-03-05 15:20:29.240 Debug: Detecting indexes for database templateDB\r\n2013-03-05 15:20:29.240 Debug: Detecting indexes for database Last-Login\r\n2013-03-05 15:20:29.240 Debug: Detecting indexes for database valPipeDB\r\n2013-03-05 15:20:29.240 Debug: Detecting indexes for database Triggers\r\n2013-03-05 15:20:29.241 Debug: Detecting indexes for database Security\r\n.......\r\n.......\r\n.......\r\n2013-03-05 15:20:29.250 Debug: Detecting compatibility for database App-Services\r\n2013-03-05 15:20:29.250 Debug: Detected compatibility for database App-Services\r\n2013-03-05 15:20:29.252 Debug: Detected indexes for database dlsDB: ws, ss, ssa, fp, fcs, fds, few, fep, sln\r\n2013-03-05 15:20:29.252 Debug: Detecting compatibility for database dlsDB\r\n2013-03-05 15:20:29.252 Debug: Detected compatibility for database dlsDB\r\n2013-03-05 15:23:31.031 Alert: XDMP-FORESTERR: Error in shutdown of forest valPipeF: XDMP-FORESTTIM: Forest valPipeF close operation timed out\r\n2013-03-05 15:23:31.031 Error: Reference /var/opt/MarkLogic/Forests/valPipeF/00000000 16 2013-03-05T15:17:42 2013-03-05T15:20:28\r\n2013-03-05 15:23:31.239 Notice: Starting MarkLogic Server 7.0-ea1_20130305 x86_64 in /opt/MarkLogic with data in /var/opt/MarkLogic\r\n\r\n\r\nTest synopsis:\r\n1. create a DB and Forest\r\n2. enable uri lexicon\r\n3. install default cpf\r\n4. enable schema validation pipeline on the default pipeline\r\n5. remove DocBook pipeline\r\n6. change the validation type to lax and insert the pipeline\r\n7. load the doc\r\n8. verfy doc got converted\r\n9. change the validation type to strict and insert the pipeline\r\n10. load the doc and  the properties of the doc in strict mode w/o DocBook\r\n.......\r\n........\r\n15. cleanup: delete forest and databases\r\n\r\nFor your reference attaching the test-case as validate-pipeline.xml"}, {"time":"2013-03-06T03:04:50.517284-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The test \"bug12313.xml\" is also failing on nightly regression during performing forest delete operation.\r\n\r\nFollowing is seen in ErrorLog:\r\n2013-03-05 07:21:55.533 Debug: OnDiskStand /var/opt/MarkLogic/Forests/Security/00000091, disk=1MB, memory=1MB\r\n2013-03-05 07:21:55.533 Info: Merged 1 MB in 1 sec at 11 MB/sec to /var/opt/MarkLogic/Forests/Security/00000091\r\n2013-03-05 07:21:55.536 Debug: ~OnDiskStand /var/opt/MarkLogic/Forests/Security/00000090\r\n2013-03-05 07:24:42.567 Alert: XDMP-FORESTERR: Error in shutdown of forest bug12313F1: XDMP-FORESTTIM: Forest bug12313F1 close operation timed out\r\n2013-03-05 07:24:42.574 Error: Reference /var/opt/MarkLogic/Forests/bug12313F1/00000000 1 2013-03-05T07:21:37 2013-03-05T07:21:39\r\n2013-03-05 07:24:42.694 Notice: Starting MarkLogic Server 7.0-ea1_20130305 x86_64 in /opt/MarkLogic with data in /var/opt/MarkLogic\r\n2013-03-05 07:24:42.710 Info: Host rh5-intel64-70-build.marklogic.com running Linux 2.6.18-308.el5 (Red Hat Enterprise Linux Server release 5.8 (Tikanga))\r\n\r\nHere is the link to diff:\r\nhttps://regression-status.marklogic.com/new-app/space2/diff-archive/b7_0-ea1/2013-03-05/linux-64-rh5-cluster/diffs/bug12313.xml\r\n\r\nAttaching the ErrorLog as ErrorLog_bug12313.xml for reference\r\n"}, {"time":"2013-03-07T02:46:14.03489-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Created task 21083 and moved test pdf-conv-mod-alert.xml to end of list"}, {"time":"2013-03-07T23:38:39.546437-08:00", "updatedBy":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"For the error in \"Shutdown of forest\" we already have a bug 20102. "}, {"time":"2013-03-08T13:19:21.612192-08:00", "updatedBy":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"Issue appears resolved in b7_0-ea1 build (no changes of mine).\r\n"}, {"time":"2013-03-08T13:19:21.612192-08:00", "updatedBy":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "change":{"assignTo":{"from":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-09T10:26:26.324363-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-11T00:44:33.514462-07:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Closing the bug as  test pdf-conv-mod-alert.xml passe on all platforms except solaris64 cluster. I will add sleep(in subtest to wait for cpf processing) in this test for solaris64. \r\n"}, {"time":"2013-03-11T00:44:33.514462-07:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-03-11T00:44:33.514462-07:00", "fixedAt":"2013-03-08T13:19:21.612192-08:00", "fixedBy":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "closedAt":"2013-03-11T00:44:33.514462-07:00", "closedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "renderDescriptionAs":"normal"}