{"id":20902, "kind":"Bug", "createdAt":"2013-02-22T11:52:39.477329-08:00", "status":"Closed", "title":"XDMP-CHILDLINK/XDMP-PARENTLINK error when field range index with fragment roots", "category":"xdmp", "severity":"Minor", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"In Support Ticket #12531 the customer (Envisn) reported the occurrence of an DMP-CHILDLINK error when inserting content.  I have narrowed down there case to the following test case:\r\n\r\nCreate a new DB with default settings.\r\nAdd a Fragment Root with localname = \"Policy\"\r\nAdd a Field with \r\n          Name = Test, \r\n          Includes = auditHistory,\r\n          Excludes = audit\r\nAdd a Field Range Index for Test\r\n\r\nOnce the DB has been created attempt to insert a document:\r\n\r\nxdmp:document-insert(\"/foo.xml\", \r\n<auditHistory xmlns=\"http://developer.envisn.com/xmlns/envisn/netvisn/\">\r\n     <audit>\r\n          <Policy>\r\n          </Policy>\r\n     </audit>\r\n</auditHistory>\r\n)\r\n\r\nThe document insert will fail with the XDMP-CHILDLINK error.  If the <audit> element is removed the error becomes XDMP-PARENTLINK.", "samplequery":"", "sampledata":"", "version":"5.0-3.3", "tofixin":"5.0-6", "fixedin":"5.0-6", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, {"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[20903, 20905], "cloneOf":"", "support":{"headline":"XDMP-CHILDLINK error ", "supportDescription":"When a fragment-root is defined on an element that is nested inside an included or excluded element of a field, server throws XDMP-CHILDLINK error. The document is well-formed but it has an element that is defined as a fragment-root. The document also has elements that are defined as included or excluded elements in a field. The server didn't allow insertion of this document as the field present in this document cannot be indexed.", "publishStatus":"Prepare", "tickets":[], "customerImpact":{"level":"Low", "title":"Minimal business impact or reasonable workaround is available"}, "workaround":"Remove the fragment root definition."}, "tags":["xdmp", "rjovanovich"], "changeHistory":[{"time":"2013-02-22T11:52:39.477329-08:00", "updatedBy":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-22T12:12:43.030659-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-6"}}, "files":[], "show":true}, {"time":"2013-02-23T09:15:15.677908-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"should treat it as a documentation issue"}, {"time":"2013-02-23T09:20:49.609522-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"or throw a better error that says values cannot cross fragment boundaries"}, {"time":"2013-02-23T14:34:29.975314-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"We decided that the document should be let in, a configuration error should not prevent insertion of any well-formed document. So we do let the document go in, but insert a range index error key in the fragment. Probably we also add these error messages to the errorlog.\r\n\r\nWe will fix this exactly in the same way as we fixed the earlier bugs."}, {"time":"2013-03-04T15:11:29.696983-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"No more reproducible on b5_0 build immediately after 5.0.5. Looks like this has been fixed by Wayne's changes for 19422 in Forest.cpp.\r\n\r\nr118198 | wfeick | 2012-10-18 11:30:11 -0700 (Thu, 18 Oct 2012) | 1 line\r\n\r\nBug:19422 CompressTreeIterator is now used by bulk replication to achieve higher efficiency by doing a better job of streaming compressed trees and not putting them in the cache.\r\n\r\nThe document can be inserted now.\r\n\r\nGood Test will be:\r\n1. Change the above doc a little bit:\r\nxdmp:document-insert(\"/foo.xml\",\r\n<auditHistory xmlns=\"http://developer.envisn.com/xmlns/envisn/netvisn/\">\r\n    first\r\n     <audit>second\r\n          <Policy>third\r\n          </Policy>\r\n     </audit>\r\n</auditHistory>\r\n) \r\n\r\n2. When there is no fragment root: cts:field-values(\"Test\") should return: first.\r\n3. When there is a fragment root, it should return empty but cts:search(doc(),cts:field-range-query(\"Test\",\"=\",\"first\") should return the doc.\r\n4, When audit element is deleted from the above doc but still keeping the Policy, the value of the field is \"first third\". But due to fragment root on Policy, again cts:field-values(\"Test\") should return empty. But the cts:field range query on \"first third\" should return the doc."}, {"time":"2013-03-04T15:23:31.679579-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-04T15:23:31.679579-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-08T10:52:18.814831-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true, "comment":"With namespace, the bug happens."}, {"time":"2013-03-08T10:52:18.814831-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-09T05:03:48.129548-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Testing:\r\n\r\nTry out the filter in the presence of fragment root:\r\ncts:contains(doc(),cts:field-range-query(\"Test\",\"=\",\"\r\n    first\r\n     \")),\r\ncts:contains(doc(),cts:field-value-query(\"Test\",\r\n    first\r\n     \")),\r\ncts:contains(doc(),cts:field-word-query(\"Test\",\"first\"))"}, {"time":"2013-03-09T05:36:10.59442-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"135841", "paths":["xdmp/branches/b5_0/src/Indexer.cpp"], "affectedBugs":[]}, "comment":"Fix for bug:20902.\n"}, {"time":"2013-03-09T05:37:06.636552-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"For the tests using field-value-query and foeld-word-query, enable appropriate indexes."}, {"time":"2013-03-09T05:39:50.297722-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true, "comment":"Please file a separate bug for filter query. It exists on b5_0, b6_0 and HEAD."}, {"time":"2013-03-09T05:39:50.297722-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-09T19:47:39.701289-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Use this document for your testing. Here I have removed unnecessary white spaces to simplify designing the range query.\r\n\r\nxdmp:document-insert(\"/foo.xml\",\r\n<auditHistory\r\n xmlns=\"http://developer.envisn.com/xmlns/envisn/netvisn/\">first<audit>Second<Policy>Third</Policy></audit></auditHistory>\r\n)"}, {"time":"2014-03-24T13:49:52.334541-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"This test is already in regression and has been passing as of build 5.0-20140323"}, {"time":"2014-04-09T16:12:27.290865-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"ga"}], "updatedAt":"2014-04-09T16:12:27.290865-07:00", "fixedAt":"2013-03-09T05:39:50.297722-08:00", "fixedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "shippedAt":"2014-03-24T13:49:52.334541-07:00", "shippedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "closedAt":"2014-04-09T16:12:27.290865-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}