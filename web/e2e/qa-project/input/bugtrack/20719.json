{"id":20719, "kind":"Bug", "createdAt":"2013-02-01T13:57:30.506311-08:00", "status":"Closed", "title":"FlexRep fails with XDMP-FORESTNID error due to in-forest queries including replica forests", "category":"Replication", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"mhelmstetter", "name":"Mark Helmstetter", "email":"mark.helmstetter@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Currently FlexRep will start throwing errors when 1 or more forests are failed over when using forest level failover. The error thrown is XDMP-FORESTNID and indicates \"Specified forest 99999 not in database\". In this particular case it occurs at flexrep.xqy:2578. I believe this is from within a push-local-forests call.\r\n\r\nI imagine this scenario might impact other areas and applications that use forest keys for queries.\r\n\r\nPerhaps flexrep should look at the forest-status/state to include which forests to include? Or perhaps it would be possible/desirable to allow the server to do the right thing when low level queries are processed that include forest keys.", "samplequery":"", "sampledata":"", "version":"6.0-1", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"mhelmstetter", "name":"Mark Helmstetter", "email":"mark.helmstetter@marklogic.com"}, {"username":"edelacruz", "name":"Ed Delacruz", "email":"ed.delacruz@marklogic.com"}, {"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20684, "support":{"headline":"cts search with placeKeys and Flexible Replication stop working after forest failover", "supportDescription":"There are two issues in this one bug:\r\n1) With a local disk failover configuration,  cts:search with placesKey doesn't give the right result after a forest failover event where the configured replica forest takes over (it works again once configured master forests come back).\r\n2) With a local disk failover configuration,  Flexible Replication stops pushing documents after a forest failover event where the configured replica forest takes over (it works again once configured master forests come back).", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"Medium", "title":"Requires significant or unnatural effort to work around issue or to prevent significant business impact"}, "workaround":""}, "tags":["Replication", "mhelmstetter"], "changeHistory":[{"time":"2013-02-01T14:57:37.53019-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true, "comment":"We should probably move this to 5.0-6, but Wayne, giving you an opportunity to comment on it first."}, {"time":"2013-02-01T14:57:37.53019-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-01T14:57:37.53019-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-5"}}, "files":[], "show":true}, {"time":"2013-02-04T13:18:57.473046-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I expect this will be an easy fix. Haitao, can you take a quick look?"}, {"time":"2013-02-04T13:18:57.473046-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-04T22:04:34.649854-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I reproduced the issue. However, the potential fix appears to be quite intrusive.  Wayne and I will talk to Raghu tomorrow and see if this should be in 6.0-3/5.0-6 instead."}, {"time":"2013-02-05T16:35:46.140388-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"talked to Raghu. Moving this to 5.0-6.  will get the code change into 6.0-3 first."}, {"time":"2013-02-05T16:35:46.140388-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"tofixin":{"from":"5.0-5", "to":"5.0-6"}}, "files":[], "show":true}, {"time":"2013-02-05T16:36:06.896335-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-02-27T14:02:13.649422-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-27T14:16:26.205181-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Test case created internally from support ticket 12520\r\n\r\nRJ> \"I have run into an interesting issue ... we are attempting to use cts:search() while specifying the forest-id where the search should be performed.  This works great provided that the Master forest is open.  When we fail the host with the Master and attempt the same search we get an error stating that the forest is not in the DB.  The error seems to make sense, so I attempted with the forest-id of the Replica.  When specifying the Replica forest-id, my query returns no results.  To be thorough, I attempted a search with no forest-id and saw all the expected docs.\r\nI know that xdmp:document-insert() will also take a forest-id, so I performed an insert using the Master forest-id with no issues.  This is what I would expect, even with the Master forest failed.  \r\nDo you know why search that specifies a forest-id fails when the using the Replica forest?\"\"\r\n\r\n\r\n"}, {"time":"2013-03-14T16:20:02.422323-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"136736", "paths":["xdmp/branches/b6_0/src/SearchBuiltins.cpp", "xdmp/branches/b6_0/src/DatabaseQuery.cpp"], "affectedBugs":[]}, "comment":"bug:20719 FlexRep fails with XDMP-FORESTNID error due to in-forest queries including replica forests"}, {"time":"2013-03-14T16:28:28.063357-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The committed change solves the issue in Support Ticket 12520: now a user can pass in the configured master forest key as placeKeys to cts:search even after a failover.\r\n\r\nThe change partially solves the FlexRep issue. After the master forest fails, no FORESTNID will be reported. However, FlexRep won't \"resume\" until the master comes back online.  I have tried to use  configured master forests keys in on-restart.xqy but the result appears to be the same."}, {"time":"2013-03-14T21:35:12.359712-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Take a look at flexrep:push-local-forests(). It looks for master forests on the current host. You'll need to map the master forest ids with xdmp:forest-open-replica() and then check if that is a local forest via xdmp:forest-host() (more efficient than the xdmp:forest-status() that's being used now). If so, then the push-local-forest.xqy task should be spawned with the master forest id.\r\n\r\nI think that'll make things work properly."}, {"time":"2013-03-14T22:24:40.027938-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"136771", "paths":["xdmp/branches/b6_0/src/Modules/MarkLogic/flexrep.xqy"], "affectedBugs":[]}, "comment":"bug:20719 FlexRep fails with XDMP-FORESTNID error due to in-forest queries including replica forests"}, {"time":"2013-03-15T09:34:41.155094-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"http://svn.marklogic.com/trac.engsvn/changeset/136869\r\nMessage:\r\n    bug 20719 : the first check-in caused a regression on Bug 12268\r\nFiles:\r\n        1 modified\r\n        *  xdmp/branches/b6_0/src/SearchBuiltins.cpp (modified) (1 diff)\r\n"}, {"time":"2013-03-15T13:26:17.008295-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"To QA:\r\n\r\nThe code change improves the server on the following two things:\r\n\r\n1) cts search (and related APIs) with placeKeys (master forests keys) now works after a failover (the master forest dies and the replica forest takes over). \r\n\r\nI changed the code that \"decodes\" the placeKeys passed in. The following APIs use the decode logic:\r\n\r\ncts:element-attribute-pair-geospatial-boxes()\r\ncts:element-attribute-pair-geospatial-value-match()\r\ncts:element-attribute-pair-geospatial-values()\r\ncts:element-attribute-value-co-occurrences()\r\ncts:element-attribute-value-geospatial-co-occurrences()\r\ncts:element-attribute-value-match()\r\ncts:element-attribute-value-ranges()\r\ncts:element-attribute-values()\r\ncts:element-attribute-word-match()\r\ncts:element-attribute-words()\r\ncts:element-child-geospatial-boxes()\r\ncts:element-child-geospatial-value-match()\r\ncts:element-child-geospatial-values()\r\ncts:element-geospatial-boxes()\r\ncts:element-geospatial-value-match()\r\ncts:element-geospatial-values()\r\ncts:element-pair-geospatial-boxes()\r\ncts:element-pair-geospatial-value-match()\r\ncts:element-pair-geospatial-values()\r\ncts:element-value-co-occurrences()\r\ncts:element-value-geospatial-co-occurrences()\r\ncts:element-value-match()\r\ncts:element-value-ranges()\r\ncts:element-values()\r\ncts:element-word-match()\r\ncts:element-words()\r\ncts:field-value-co-occurrences()\r\ncts:field-value-match()\r\ncts:field-value-ranges()\r\ncts:field-values()\r\ncts:field-word-match()\r\ncts:field-words()\r\ncts:geospatial-co-occurrences()\r\ncts:search()\r\ncts:uri-match()\r\ncts:uris()\r\ncts:word-match()\r\ncts:words()\r\n\r\n\r\n2) FlexRep now continues to push things to the target after a failover.\r\n\r\n\r\n\r\n"}, {"time":"2013-03-15T13:26:38.825268-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-15T13:26:38.825268-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-18T16:58:46.871926-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-26T16:07:54.100568-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I was talking to Haitao about testing this fix and these were his comments:\r\n\r\nBefore the fix, if the node with the master forest is killed, flexrep will stop.\r\nBut it will resume after the master comes back .\r\n\r\nWith the fix, flexrep will continue working with the master forest down.\r\nIf the test just checks the end result, it won't tell the difference.\r\n\r\nI think cts:search and flexrep should be run separately. \r\nFor cts: search, you can use the test case described in 12520.\r\nFor flexrep, you can use the test case described in the bug (the original comment made by Mark Helmstetter)\r\n\r\n One problem is that there are many many functions similar to cts : search that go through the code paths I changed. I am not sure if it is easy to cover all of them"}, {"time":"2013-04-11T23:01:04.623469-07:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Larry, Since Maha is in India, Please work with Haitao on this bug fix verification."}, {"time":"2013-04-11T23:01:04.623469-07:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-15T15:46:51.843946-07:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Manually verified on build 6.0-20130415"}, {"time":"2013-04-22T16:28:03.863685-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-04-22T16:28:03.863685-07:00", "fixedAt":"2013-03-15T13:26:38.825268-07:00", "fixedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "shippedAt":"2013-04-15T15:46:51.843946-07:00", "shippedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "closedAt":"2013-04-22T16:28:03.863685-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}