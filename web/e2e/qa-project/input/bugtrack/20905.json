{"id":20905, "kind":"Bug", "createdAt":"2013-02-22T11:52:39.477329-08:00", "status":"Closed", "title":"XDMP-CHILDLINK/XDMP-PARENTLINK error when field range index with fragment roots", "category":"xdmp", "severity":"Minor", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"In Support Ticket #12531 the customer (Envisn) reported the occurrence of an DMP-CHILDLINK error when inserting content.  I have narrowed down there case to the following test case:\r\n\r\nCreate a new DB with default settings.\r\nAdd a Fragment Root with localname = \"Policy\"\r\nAdd a Field with \r\n          Name = Test, \r\n          Includes = auditHistory,\r\n          Excludes = audit\r\nAdd a Field Range Index for Test\r\n\r\nOnce the DB has been created attempt to insert a document:\r\n\r\nxdmp:document-insert(\"/foo.xml\", \r\n<auditHistory xmlns=\"http://developer.envisn.com/xmlns/envisn/netvisn/\">\r\n     <audit>\r\n          <Policy>\r\n          </Policy>\r\n     </audit>\r\n</auditHistory>\r\n)\r\n\r\nThe document insert will fail with the XDMP-CHILDLINK error.  If the <audit> element is removed the error becomes XDMP-PARENTLINK.", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-1", "fixedin":"7.0-1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, {"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20902, "support":{"headline":"When a fragment-root is defined on an element nested in an included or excluded element of a field, server throws XDMP-CHILDLINK error.", "supportDescription":"The document is well-formed but it has an element that is defined as a fragment-root. The document also has elements that are defined as included or excluded elements in a field. The server didn't allow insertion of this document as the field present in this document cannot be indexed.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"Low", "title":"Minimal business impact or reasonable workaround is available"}, "workaround":""}, "tags":["xdmp", "rjovanovich"], "changeHistory":[{"time":"2013-02-22T11:52:39.477329-08:00", "updatedBy":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-22T12:12:43.030659-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-6"}}, "files":[], "show":true}, {"time":"2013-02-22T12:13:13.591829-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-02-22T13:44:42.794244-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Since this is a customer reported bug, I am assigning \"major\" severity to it."}, {"time":"2013-02-23T09:16:07.020223-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"should treat it as a documentation issue"}, {"time":"2013-02-23T09:19:05.030789-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"or throw a better error that says values cannot cross fragment boundaries"}, {"time":"2013-02-23T14:34:01.482585-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"In past we fixed such bugs in the context of element and path range indexes. We decided that the document should be let in, a configuration error should not prevent insertion of any well-formed document. So we do let the document go in, but insert a range index error key in the fragment. Probably we also add these error messages to the errorlog.\r\n\r\nWe will fix this exactly in the same way as we fixed the earlier bugs."}, {"time":"2013-02-26T13:17:07.833494-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea1", "to":"7.0-1"}}, "files":[], "show":true}, {"time":"2013-02-26T15:59:05.095093-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Related Bug 20209."}, {"time":"2013-02-27T12:11:55.428955-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Another Related bug 19941 (20045)."}, {"time":"2013-03-04T15:20:17.755272-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This should have been fixed by Wayne's check-in:\r\n\r\nBug:19534 Bulk replication now uses a compressed tree iterator that does not put fragments into the cache since they're unlikely to be needed again any time soon.\r\n\r\nRevision: 116727\r\n\r\nRefer to Bug 20902 for a detailed test-case."}, {"time":"2013-03-04T15:22:32.909668-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"Please refer to my detailed comment in bug 20902."}, {"time":"2013-03-04T15:22:32.909668-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-04T15:22:32.909668-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"tofixin":{"from":"7.0-1", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-03-07T12:09:32.658608-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-08T10:49:44.128447-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true, "comment":"We should remember to include the namespace for includes/excludes and fragment roots. While we do that, inserting the document throws:\r\n[1.0-ml] XDMP-CHILDLINK: (err:XPTY0004) xdmp:eval(\"xquery version &quot;1.0-ml&quot;;&#10;xdmp:document-insert(&quo...\", (), <options xmlns=\"xdmp:eval\"><database>2723001663917857536</database><default-xquery-version>...</options>) -- Invalid child link node\r\n\r\nStack Trace\r\nIn /MarkLogic/appservices/qconsole/qconsole-amped.xqy on line 180\r\nIn amped-qconsole:qconsole-eval(\"xquery version &quot;1.0-ml&quot;;&#10;xdmp:document-insert(&quo...\", (), <options xmlns=\"xdmp:eval\"><database>2723001663917857536</database><default-xquery-version>...</options>)\r\n\r\n$xquery := \"xquery version &quot;1.0-ml&quot;;&#10;xdmp:document-insert(&quo...\"\r\n$vars := ()\r\n$options := <options xmlns=\"xdmp:eval\"><database>2723001663917857536</database><default-xquery-version>...</options>"}, {"time":"2013-03-08T10:49:44.128447-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-08T12:14:28.834116-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This is simply a clone of a bug that is going to be fixed in 5.0.6. Even the original bug is not any critical. So moving this to 7.0-ea2 as it makes no difference even if we fix it in 7.0-ea1."}, {"time":"2013-03-08T12:14:28.834116-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea1", "to":"7.0-ea2"}}, "files":[], "show":true}, {"time":"2013-03-09T05:09:34.755807-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"135839", "paths":["xdmp/trunk/src/Indexer.cpp"], "affectedBugs":[]}, "comment":"Fix for bug:20905.\n"}, {"time":"2013-03-09T05:40:46.690534-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-09T05:40:46.690534-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-05-07T11:27:22.722793-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on build 7.0-20130506."}], "updatedAt":"2013-05-07T11:27:22.722793-07:00", "fixedAt":"2013-03-09T05:40:46.690534-08:00", "fixedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "shippedAt":"2013-05-07T11:27:22.722793-07:00", "shippedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "renderDescriptionAs":"normal"}