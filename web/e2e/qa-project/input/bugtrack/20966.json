{"id":20966, "kind":"Bug", "createdAt":"2013-02-27T16:34:24.077591-08:00", "status":"Closed", "title":"REGR: Java Client API is not returning the correct documents on search", "category":"MarkLogic Java API", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"StringQueryDefinition querydef = queryMgr.newStringDefinition(queryOptionName);\r\nquerydef.setCriteria(\"intitle:1945 OR inprice:12\");\r\n\r\nquery options:\r\n<options xmlns=\"http://marklogic.com/appservices/search\">\r\n  <return-metrics>false</return-metrics>\r\n  <debug>true</debug>\r\n  <return-qtext>false</return-qtext>\r\n  <transform-results apply=\"raw\"/>\r\n  <sort-order>\r\n    <element ns=\"\" name=\"title\"/>\r\n  </sort-order>\r\n  <constraint name=\"intitle\">\r\n    <word>\r\n      <element ns=\"\" name=\"title\"/>\r\n    </word>\r\n  </constraint>\r\n  <constraint name=\"inprice\">\r\n    <word>\r\n      <element ns=\"http://cloudbank.com\" name=\"price\"/>\r\n      <attribute ns=\"\" name=\"amt\"/>\r\n    </word>\r\n  </constraint>\r\n</options>\r\n\r\nIt shouldn't return this document, but the search returns it:\r\n<root>\r\n  <title>The memex</title>\r\n  <popularity>5</popularity>\r\n  <id>0026</id>\r\n  <date xmlns=\"http://purl.org/dc/elements/1.1/\">2009-05-05</date>\r\n  <price xmlns=\"http://cloudbank.com\" amt=\"123.45\"/>\r\n  <p>The Memex, unfortunately, had no automated search feature.</p>\r\n</root>\r\n", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea1", "fixedin":"7.0-ea1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, {"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, {"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["MarkLogic Java API", "ayuwono"], "changeHistory":[{"time":"2013-02-27T16:34:24.077591-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-27T17:07:58.216639-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Here is the complete code of the test:\r\n\r\n\t\tSystem.out.println(\"Running testWithElementAndAttributeIndex\");\r\n\t\t\r\n\t\tString[] filenames = {\"constraint1.xml\", \"constraint2.xml\", \"constraint3.xml\", \"constraint4.xml\", \"constraint5.xml\"};\r\n\t\tString queryOptionName = \"wordConstraintWithElementAndAttributeIndexOpt.xml\";\r\n\r\n\t\tDatabaseClient client = DatabaseClientFactory.newClient(\"localhost\", 8011, \"rest-admin\", \"x\", Authentication.DIGEST);\r\n\t\t\t\t\r\n\t\t// write docs\r\n\t\tfor(String filename : filenames)\r\n\t\t{\r\n\t\t\twriteDocumentUsingInputStreamHandle(client, filename, \"/word-constraint/\", \"XML\");\r\n\t\t}\r\n\t\t\r\n\t\tsetQueryOption(client, queryOptionName);\r\n\t\t\r\n\t\tQueryManager queryMgr = client.newQueryManager();\r\n\t\t\r\n\t\t// create query def\r\n\t\tStringQueryDefinition querydef = queryMgr.newStringDefinition(queryOptionName);\r\n\t\tquerydef.setCriteria(\"intitle:1945 OR inprice:12\");\r\n\r\n\t\t// create handle\r\n\t\tDOMHandle resultsHandle = new DOMHandle();\r\n\t\tqueryMgr.search(querydef, resultsHandle);\r\n\t\t\r\n\t\t// get the result\r\n\t\tDocument resultDoc = resultsHandle.get();\r\n\t\t\r\n\t\tassertXpathEvaluatesTo(\"3\", \"string(//*[local-name()='result'][last()]//@*[local-name()='index'])\", resultDoc);\r\n\t\tassertXpathEvaluatesTo(\"For 1945\", \"string(//*[local-name()='result'][1]//*[local-name()='title'])\", resultDoc);\r\n\t\tassertXpathEvaluatesTo(\"The Bush article\", \"string(//*[local-name()='result'][2]//*[local-name()='title'])\", resultDoc);\r\n\t\tassertXpathEvaluatesTo(\"Vannevar served\", \"string(//*[local-name()='result'][3]//*[local-name()='title'])\", resultDoc);\r\n\t\tassertXpathEvaluatesTo(\"1.23\", \"string(//*[local-name()='result'][1]//@*[local-name()='amt'])\", resultDoc);\r\n\t\tassertXpathEvaluatesTo(\"0.12\", \"string(//*[local-name()='result'][2]//@*[local-name()='amt'])\", resultDoc);\r\n\t\tassertXpathEvaluatesTo(\"12.34\", \"string(//*[local-name()='result'][3]//@*[local-name()='amt'])\", resultDoc);\r\n\t    \t\t\r\n\t\t// release client\r\n\t\tclient.release();\t\t\r\n\r\n// writeDocumentUsingInputStreamHandle() method\r\n\t\t// create doc manager\r\n\t\tDocumentManager docMgr = null;\r\n\t\tdocMgr = documentManagerSelector(client, docMgr, type);\t\r\n\r\n\t\t// create handle\r\n\t\tInputStreamHandle contentHandle = new InputStreamHandle();\r\n\r\n\t\t// get the file\r\n\t\tInputStream inputStream = new FileInputStream(\"src/junit/com/marklogic/javaclient/data/\" + filename);\r\n\t\t\r\n\t\t// set uri\r\n\t\tString docId = uri + filename;\r\n\r\n\t\tcontentHandle.set(inputStream);\r\n\t\t\t\r\n\t\t// write doc\r\n\t\tdocMgr.write(docId, contentHandle);\r\n\t\t\r\n\t\tSystem.out.println(\"Write \" + docId + \" to database\");\r\n\r\n//setQueryOptions() method:\r\n\t\t// create a manager for writing query options\r\n\t\tQueryOptionsManager optionsMgr = client.newServerConfigManager().newQueryOptionsManager();\r\n\r\n\t\t// create handle\r\n\t\tReaderHandle handle = new ReaderHandle();\r\n\t\t\r\n\t\t// write the files\r\n\t\tBufferedReader docStream = new BufferedReader(new FileReader(\"src/junit/com/marklogic/javaclient/queryoptions/\" + queryOptionName));\r\n\t\thandle.set(docStream);\r\n\t\t\r\n\t\t// write the query options to the database\r\n\t\toptionsMgr.writeOptions(queryOptionName, handle);\t\t    \r\n\r\n\t\tSystem.out.println(\"Write \" + queryOptionName + \" to database\");\r\n\r\nData:\r\nconstraint1.xml:\r\n<root>\r\n  <title>Vannevar Bush</title>\r\n  <popularity>5</popularity>\r\n  <id>0011</id>\r\n  <date xmlns=\"http://purl.org/dc/elements/1.1/\">2005-01-01</date>\r\n  <price xmlns=\"http://cloudbank.com\" amt=\"0.1\"/>\r\n  <p>Vannevar Bush wrote an article for The Atlantic Monthly</p>\r\n</root>\r\n\r\nconstraint2.xml:\r\n<root>\r\n  <title>The Bush article</title>\r\n  <popularity>4</popularity>\r\n  <id>0012</id>\r\n  <date xmlns=\"http://purl.org/dc/elements/1.1/\">2006-02-02</date>\r\n  <price xmlns=\"http://cloudbank.com\" amt=\"0.12\"/>\r\n  <p>The Bush article described a device called a Memex.</p>\r\n</root>\r\n\r\nconstraint3.xml:\r\n<root>\r\n  <title>For 1945</title>\r\n  <popularity>3</popularity>\r\n  <id>0113</id>\r\n  <date xmlns=\"http://purl.org/dc/elements/1.1/\">2007-03-03</date>\r\n  <price xmlns=\"http://cloudbank.com\" amt=\"1.23\"/>\r\n  <p>For 1945, the thoughts expressed in The Atlantic Monthly were groundbreaking.</p>\r\n</root>\r\n\r\nconstraint4.xml:\r\n<root>\r\n  <title>Vannevar served</title>\r\n  <popularity>5</popularity>\r\n  <id>0024</id>\r\n  <date xmlns=\"http://purl.org/dc/elements/1.1/\">2008-04-04</date>\r\n  <price xmlns=\"http://cloudbank.com\" amt=\"12.34\"/>\r\n  <p>Vannevar served as a prominent policymaker and public intellectual.</p>\r\n</root>\r\n\r\nconstraint5.xml:\r\n<root>\r\n  <title>The memex</title>\r\n  <popularity>5</popularity>\r\n  <id>0026</id>\r\n  <date xmlns=\"http://purl.org/dc/elements/1.1/\">2009-05-05</date>\r\n  <price xmlns=\"http://cloudbank.com\" amt=\"123.45\"/>\r\n  <p>The Memex, unfortunately, had no automated search feature.</p>\r\n</root>\r\n\r\nquery options:\r\n<options xmlns=\"http://marklogic.com/appservices/search\">\r\n  <return-metrics>false</return-metrics>\r\n  <debug>true</debug>\r\n  <return-qtext>false</return-qtext>\r\n  <transform-results apply=\"raw\"/>\r\n  <sort-order>\r\n    <element ns=\"\" name=\"title\"/>\r\n  </sort-order>\r\n  <constraint name=\"intitle\">\r\n    <word>\r\n      <element ns=\"\" name=\"title\"/>\r\n    </word>\r\n  </constraint>\r\n  <constraint name=\"inprice\">\r\n    <word>\r\n      <element ns=\"http://cloudbank.com\" name=\"price\"/>\r\n      <attribute ns=\"\" name=\"amt\"/>\r\n    </word>\r\n  </constraint>\r\n</options>"}, {"time":"2013-02-28T07:29:20.211222-08:00", "updatedBy":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Server debugging shows the Java client request is:  GET /v1/search?options=bug20966\r\n\r\nThat's why the request qualifies all documents.\r\n"}, {"time":"2013-02-28T08:07:46.232024-08:00", "updatedBy":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "to":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}}}, "files":[], "show":true, "comment":"Patch in review including unit test so this kind of problem is caught early in the future.\r\n"}, {"time":"2013-02-28T09:23:08.5342-08:00", "updatedBy":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"134130", "paths":["client-api/java/trunk/src/test/java/com/marklogic/client/test/StructuredSearchTest.java", "client-api/java/trunk/src/main/java/com/marklogic/client/impl/JerseyServices.java", "client-api/java/trunk/src/test/java/com/marklogic/client/test/RawQueryDefinitionTest.java", "client-api/java/trunk/src/test/java/com/marklogic/client/test/StringSearchTest.java"], "affectedBugs":[]}, "comment":"Bug:20966 query parameter with negative test for search that should fail"}, {"time":"2013-02-28T09:24:16.231418-08:00", "updatedBy":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "to":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}}}, "files":[], "show":true, "comment":"passing query parameter"}, {"time":"2013-02-28T09:24:16.231418-08:00", "updatedBy":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "to":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-28T14:10:03.15987-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"All tests are passing when regression I re-run the regression using latest ea1 jar with the fix. I will ship it tomorrow when the nightly regression is not showing any failure"}, {"time":"2013-03-01T15:12:11.472878-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified passed on 03/01 regression"}, {"time":"2013-03-01T15:12:11.472878-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-03-01T15:12:11.472878-08:00", "fixedAt":"2013-02-28T09:24:16.231418-08:00", "fixedBy":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "shippedAt":"2013-03-01T15:12:11.472878-08:00", "shippedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "renderDescriptionAs":"normal"}