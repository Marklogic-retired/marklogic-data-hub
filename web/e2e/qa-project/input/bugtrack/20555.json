{"id":20555, "kind":"Bug", "createdAt":"2012-10-30T11:07:18.248664-07:00", "status":"Closed", "title":"Some Russian documents are intermittently not returned from search containing й", "category":"search", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"This issue was reported by LDS in support ticket #12019.  The issue is being seen when using Russian language documents.\r\n\r\nTo observe the issue create a new DB with default settings (be sure to have a Russian Language key).  Ingest the attached document and then immediately perform the following query:\r\n\r\ncts:search(fn:doc(), cts:element-value-query(xs:QName('permalink'), '/статья/старейшина-даллин-х-оукс', 'lang=rus'))\r\n\r\nThe document should be returned if you are quick enough.  However, subsequent runs will produce no results.  If the document is then modified, such as being included in a collection (xdmp:document-add-collections(\"/rus.xml\", \"russia-web-live\")), the document will then appear in the search again.  However, this appearance is also short lived.\r\n\r\nI have reproduced this issue in both 5.0-4 and 6.0-1.1.", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-1", "fixedin":"7.0-1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, {"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}], "attachments":[{"name":"Document for testing", "uri":"root/support/bugtracking/attachments/19958/elder-dallin-h-oaks.xml"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":19958, "support":{"headline":"cts:search works inconsistently for some Russian documents", "supportDescription":"A search for Russian words containing the short i (й) may work against a newly loaded document and then fail a short time later. This may occur if the same word is present several times in the document.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"Medium", "title":"Requires significant or unnatural effort to work around issue or to prevent significant business impact"}, "workaround":""}, "tags":["search", "rjovanovich"], "changeHistory":[{"time":"2012-10-30T11:10:58.148221-07:00", "updatedBy":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"One other thing worth mentioning.  I also attempted to ingest a trivial document to reproduce the issue.\r\n\r\n<article xml:lang=\"rus\">\r\n<permalink>/статья/старейшина-даллин-х-оукс</permalink>\r\n<title>Старейшина Даллин Х. Оукс</title>\r\n</article>\r\n\r\nThis document will always return in the same search as the search listed  in the original description."}, {"time":"2012-10-30T13:15:12.503032-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-10-30T13:15:12.503032-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-5"}}, "files":[], "show":true}, {"time":"2012-10-30T17:40:21.617817-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2012-10-30T17:40:21.617817-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2012-12-10T13:27:46.530266-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Mary,\r\nPlease look into this bug."}, {"time":"2013-01-03T14:08:52.800623-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"I have not been able to replicate this."}, {"time":"2013-01-21T14:21:18.505163-08:00", "updatedBy":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I still had a VM setup that displayed this issue.  I upgraded to the latest linux nightly, and I still see the same behavior.  Below is the information to access the instance that displays the defect.\r\n\r\nConnect to http://slap-inc.gotdns.com:8000/qconsole/  with the super secure user/login as admin/admin\r\nThere are 2 files in the Russian Database.  If you run Query1, it will return 1 document.\r\nIf you run Query2 (which redundantly adds the document to a collection) immediately followed by Query1, you will see 2 documents returned.\r\nIf you wait for a short period of time and rerun Query1, you will be back to returning 1 document.\r\n"}, {"time":"2013-01-22T08:06:31.222027-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"This has nothing to do with in-memory vs on-disk. When the stem key for the second word (старейшина) is retrieved during query construction from the tokenizer's cache the value returned in  7917026300245675324, and when it is not the value is  16729435125747912281. This leads to different queries being constructed with different keys, only one of which matches. I do not currently understand why different results are being returned and why the smaller document always works."}, {"time":"2013-01-22T11:56:07.435371-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"What is going on here is that lcKey(й) == lcdlKey(й) because diacritic-less(й)=й\r\nHowever й has a NFKD decomposition to и + a combining character, which LCDLNFKDCodepointIterator dutifully removes. So there is a single key (lcKey==lcdlKey) with two possible values in the tokenizer cache.\r\n\r\nAny character that has a compatibilitty decomposition to a combining character but that is not in the dlTable will have this issue.  The fact that to satisfy some languages we push strings through NFKD and then back to NFC is causing the problem for Russian here.\r\n"}, {"time":"2013-01-22T12:47:54.095969-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"Looks like the same issue as 8553, essentially."}, {"time":"2013-01-22T13:36:29.028492-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-01-22T14:15:34.241291-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"128812", "paths":["xdmp/trunk/src/Stemmer.cpp"], "affectedBugs":[]}, "comment":"Bug:20555 DLNFKD on Russian messes up short i"}, {"time":"2013-01-22T15:34:32.572537-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Looks like this fixed 20468 as well. I just ran field-value-query-16.xml and it passed."}, {"time":"2013-01-24T13:12:04.679501-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"Fixed 7.0-20130123"}, {"time":"2013-01-24T13:12:04.679501-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-02T10:44:08.56028-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-04T13:36:18.775059-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on build 7.0-ea1_20130227"}], "updatedAt":"2013-03-04T13:36:18.775059-08:00", "fixedAt":"2013-01-24T13:12:04.679501-08:00", "fixedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "shippedAt":"2013-03-04T13:36:18.775059-08:00", "shippedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "renderDescriptionAs":"normal"}