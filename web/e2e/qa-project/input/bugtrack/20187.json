{"id":20187, "kind":"Bug", "createdAt":"2012-12-04T01:45:23.055934-08:00", "status":"Closed", "title":"Automatically manage XDMP-LABELBADMAGIC: Bad forest label magic number: 0x0 instead of 0x1020304 error messages", "category":"xdmp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"We have been seeing a lot of occurrences of this in support recently where upgrades from 4.2-x/5.0-x to 6.0-x are concerned.  \r\n\r\nOne such example is a case I have open right now:\r\nhttps://help.marklogic.com/staff/Tickets/Ticket/View/12197\r\n\r\nIn every case I've seen this, the Label file is 0 bytes in size (often a result of the server running out of disk space).   Extra space is made and then - on restart - we see a lot of XDMP-LABELBADMAGIC: Bad forest label magic number: 0x0 instead of 0x1020304 error messages and the server is unable to start.\r\n\r\nWould it be feasible for the server to detect a 0-byte Label file and - given adequate disk space - to automatically replace it?", "samplequery":"", "sampledata":"", "version":"6.0-2", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, {"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, {"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[21334, 21335], "cloneOf":"", "support":{"headline":"Insufficient disk space causes corrupt Label files within forests", "supportDescription":"Where disk space is exhausted, Label files containing essential server metadata for each forest on the server are truncated by the file system to 0 byte files.   After more disk space has been provisioned, a restart yields the message:\r\n\r\nXDMP-FORESTERR: Error in mount of forest aswc-triggers: XDMP-LABELBADMAGIC: Bad forest label magic number: 0x0 instead of 0x1020304", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"Low", "title":"Minimal business impact or reasonable workaround is available"}, "workaround":"Stop each MarkLogic process in the cluster, delete the Label file for the forest in question, restart each MarkLogic process in the cluster."}, "tags":["xdmp", "ableasdale"], "changeHistory":[{"time":"2012-12-04T02:45:25.309042-08:00", "updatedBy":{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Could this be a regression for bug 16821 (fixed in 5.0-3)?\r\nhttp://bugtrack.marklogic.com/bug-details.xqy?bn=16821"}, {"time":"2012-12-04T07:20:20.432572-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true, "comment":" "}, {"time":"2012-12-04T07:20:20.432572-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"assignTo":{"from":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-04T07:20:20.432572-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-01-21T13:51:04.845171-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-25T11:29:03.746975-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This is significant from a support perspective"}, {"time":"2013-03-12T11:57:21.167969-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I'm concerned about the interaction with local-disk failover, since we store our notion of who the current master is inside the forest label. Recreating a fresh label when a disk runs out of space has the potential to cause the configured master to reassert itself as master if there is no information available from the replica forest either. This would happen if the master were to run out of space while rewriting its label and the replica was unreachable.\r\n\r\nIn 7.0, we're planning on managing multiple versions of the label (separate .old/.new or maybe _1, _2, etc. like config files). That work is much more involved and would need extensive shared-disk failover testing to make sure there are no gotchas.\r\n\r\nMaybe just writing to a new file, and then doing a rename() to place it over top of the original file would be simplest.\r\n\r\nThe posix rename() operation looks to have the right behavior. We'll want to make sure Windows will work with this approach as well."}, {"time":"2013-03-15T11:34:12.17578-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi Wayne, it sounds like changes in this area could potentially affect many areas of the server. What is the risk profile for doing something in the 6.0-3 timeframe?  "}, {"time":"2013-03-18T10:39:33.374942-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I think the risk is not too high, especially considering how many times we're seeing this issue.\r\n"}, {"time":"2013-03-18T10:48:27.297415-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137110", "paths":["xdmp/branches/b6_0/src/ForestLabel.cpp"], "affectedBugs":[]}, "comment":"bug:20187 Automatically manage XDMP-LABELBADMAGIC: Bad forest label magic number: 0x0 instead of 0x1020304 error messages"}, {"time":"2013-03-18T10:49:30.826179-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The fix appears to be working fine on Linux; yet to be verified on Windows."}, {"time":"2013-03-20T16:55:07.915832-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The above change caused a regression on HDFS (bug 21225), and I'm trying to figure out what to do with it."}, {"time":"2013-03-22T16:51:25.675005-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137527", "paths":["xdmp/branches/b6_0/src/ForestLabel.cpp"], "affectedBugs":[]}, "comment":"bug:20187 backed out the previous change, which is broken on Windows"}, {"time":"2013-03-26T16:34:20.553358-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"discussed with Wayne. What we will do is to do something similar to the configuration file management (i.e. versioning). Apparently, we don't need 10  versions of a Label so it will be limited to 2 versions."}, {"time":"2013-03-27T18:00:18.128376-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137911", "paths":["xdmp/branches/b6_0/src/ForestLabel.cpp", "xdmp/branches/b6_0/src/ForestLabel.h"], "affectedBugs":[]}, "comment":"bug:20187 Automatically manage XDMP-LABELBADMAGIC: Bad forest label magic number: 0x0 instead of 0x1020304 error messages"}, {"time":"2013-03-27T21:00:15.010096-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-27T21:00:15.010096-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-01T12:18:17.435476-07:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-05T15:53:07.814145-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Am able to reproduce it using 6.0-2 build.\r\n\r\nSteps:\r\n1. Create a forest and attach it to a database.\r\n2. Load documents into the database to fill up disk upto 95%.\r\n3. Copy some stuff into Forest's data directory to fill up disk 100%.\r\n4. Try to do a Merge of the forest. You should see this error:\r\nXDMP-FORESTERR: Error in merge of forest F1-M: SVC-FILWRT: File write error: write '/tmp/mldata/Forests/F1-M/00000008/Label': No space left on device\r\n5. At this point, restarting the host is reproducing the issue:\r\nError Log has these errors:\r\n2013-04-05 15:48:59.792 Alert: XDMP-FORESTERR: Error in mount of forest F-4: XDMP-LABELBADMAGIC: Bad forest label magic number: 0x0 instead of 0x1020304\r\n2013-04-05 15:48:59.792 Error: NullAssignment::localMount: XDMP-LABELBADMAGIC: Bad forest label magic number: 0x0 instead of 0x1020304\r\n\r\nZero sized forest label can be seen:\r\n[svempati@svempati Forests]$ find . -name \"Label\" | xargs ls -l\r\n-rw-r--r-- 1 daemon daemon 0 Apr  5 15:48 ./dummy/Label\r\n-rw-r--r-- 1 daemon daemon 0 Apr  5 15:48 ./F-4/Label\r\n\r\n"}, {"time":"2013-04-05T16:25:46.465316-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Verified with MarkLogic-6.0-20130405 on Linux\r\n\r\nErrorLog:\r\n2013-04-05 16:19:54.723 Error: NullAssignment::localMount: SVC-FILWRT: File write error: write '/var/tmp/Forests/F-1/Label_new': No space left on device\r\n\r\n[svempati@svempati Forests]$ find . -name \"Label\" | xargs ls -ltr\r\n-rw-r--r-- 1 daemon daemon   16 Apr  5 16:11 ./F-1/00000002/Label\r\n-rw-r--r-- 1 daemon daemon 4096 Apr  5 16:14 ./F-1/Label\r\n[svempati@svempati Forests]$\r\n\r\n<<<Space is made available in forest's data directory >>>\r\n\r\nErrorLog:\r\n2013-04-05 16:21:06.816 Info: Mounted forest F-1 locally on /var/tmp/Forests/F-1 (sda7 ext3 rw)\r\n2013-04-05 16:21:06.817 Debug: OnDiskStand /var/tmp/Forests/F-1/00000002, disk=0MB, memory=1MB\r\n2013-04-05 16:21:06.820 Debug: Recovering redo from {fsn=10, off=3144, sk=17272061383418195111} on forest F-1\r\n2013-04-05 16:21:06.820 Debug: Found journal /var/tmp/Forests/F-1/Journals/Journal1-19700101080000-0-10-0 with fsns 0..10\r\n2013-04-05 16:21:06.820 Debug: Recovered redo of 0 records at {fsn=10, off=3144, sk=17272061383418195111} on forest F-1, lmfsn=18446744073709551615\r\n2013-04-05 16:21:06.820 Debug: Found FSN 10 in journal /var/tmp/Forests/F-1/Journals/Journal1-19700101080000-0-10-0 with fsns 0..10\r\n2013-04-05 16:21:06.820 Debug: Opening journal /var/tmp/Forests/F-1/Journals/Journal1-19700101080000-0-10-0 0..10 at {fsn=10, off=3144, sk=17272061383418\r\n195111}\r\n2013-04-05 16:21:06.820 Debug: Recovering undo on forest F-1\r\n2013-04-05 16:21:06.820 Debug: Recovered undo at endTimestamp 13652031366186280 on forest F-1\r\n\r\n\r\n[svempati@svempati Forests]$ find . -name \"Label\" | xargs ls -ltr\r\n-rw-r--r-- 1 daemon daemon   16 Apr  5 16:11 ./F-1/00000002/Label\r\n-rw-r--r-- 1 daemon daemon 4096 Apr  5 16:21 ./F-1/Label\r\n[svempati@svempati Forests]$ \r\n\r\n\r\n\r\n"}, {"time":"2013-04-05T19:48:56.475145-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Verified on Windows with 6.0-20130405\r\n\r\nErrorLog:\r\n2013-04-05 19:31:41.981 Alert: XDMP-FORESTERR: Error in checkpoint of forest T-1: SVC-FILWRT: File write error: write 'e:\\mldata4\\Forests\\T-1\\00000001\\TreeData': No space left on device\r\n\r\nRebooting ML or that particular forest was taking the forest back into Error state with similar Error as above.\r\n\r\nAfter creating more space in the data directory and restarting the host brought the forest back in open state and I was able to load more documents etc (did not have to remove Label file).\r\n\r\n"}, {"time":"2013-04-05T19:50:20.528006-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on 6.0-20130405"}, {"time":"2013-04-22T16:19:45.223416-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-04-22T16:19:45.223416-07:00", "fixedAt":"2013-03-27T21:00:15.010096-07:00", "fixedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "shippedAt":"2013-04-05T19:50:20.528006-07:00", "shippedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "closedAt":"2013-04-22T16:19:45.223416-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}