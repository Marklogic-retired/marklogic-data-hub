{"id":20302, "kind":"Bug", "createdAt":"2012-11-06T09:43:41.559711-08:00", "status":"Closed", "title":"search:parse issue with xs namespace", "category":"Search API", "severity":"Minor", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"dchander", "name":"Dinesh Chander", "email":"dinesh.chander@globallogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Reported by user in case #12074. Behavior is same on 5.0 and 6.0.\r\n---------------------------------------------------------------------------------------------------------\r\nDear support,\r\n\r\nWe have found a problem with the search:parse function. When the returned value contains a serialized cts:element-range-query whose scalar type is string, the XML does not include a namespace definition for the xs prefix. This is difficult to explain, so here is an example.\r\n\r\nLets start without using the search api. If you execute the following script,\r\n<tmp>{\r\ncts:element-range-query(xs:QName(\"person\"), \"=\", \"test\")\r\n}</tmp>/element()\r\n\r\nyou should get,\r\n\r\n<cts:element-range-query operator=\"=\" xmlns:cts=\"http://marklogic.com/cts\">\r\n<cts:element>person</cts:element>\r\n<cts:value xsi:type=\"xs:string\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">test</cts:value>\r\n<cts:option>collation=http://marklogic.com/collation/</cts:option>\r\n</cts:element-range-query>\r\n\r\n-- Notice <cts:value> has a prefix namespace definition for xs (xmlns:xs=\"http://www.w3.org/2001/XMLSchema\")\r\n------------------------------------------------------------------------------------------------------\r\nNow lets look at the results of using search:parse to accomplish the same thing. Executing this script,\r\n\r\nimport module namespace search = \"http://marklogic.com/appservices/search\" at \"/MarkLogic/appservices/search/search.xqy\";\r\nsearch:parse(\"person:test\",\r\n<options xmlns=\"http://marklogic.com/appservices/search\">\r\n<constraint name=\"person\">\r\n<range type=\"xs:string\">\r\n<element ns=\"http://ensco.com/entity\" name=\"person\"/>\r\n</range>\r\n</constraint>\r\n</options>)\r\n\r\nresults in,\r\n<cts:element-range-query qtextpre=\"person:\" qtextref=\"cts:annotation\" operator=\"=\" xmlns:cts=\"http://marklogic.com/cts\">\r\n<cts:element>person</cts:element>\r\n<cts:annotation qtextref=\"following-sibling::cts:value\"/>\r\n<cts:value xsi:type=\"xs:string\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">test</cts:value>\r\n</cts:element-range-query>\r\n\r\n-- Notice the same <cts:value> does not have a namespace declaration for the prefix xs\r\n------------------------------------------------------------------------------------------------------\r\nFinally, when we combine these 2 scripts, we get the correct output.\r\nimport module namespace search = \"http://marklogic.com/appservices/search\" at \"/MarkLogic/appservices/search/search.xqy\";\r\n<tmp>{\r\ncts:query(\r\nsearch:parse(\"person:test\",\r\n<options xmlns=\"http://marklogic.com/appservices/search\">\r\n<constraint name=\"person\">\r\n<range type=\"xs:string\">\r\n<element name=\"person\"/>\r\n</range>\r\n</constraint>\r\n</options>\r\n)\r\n)\r\n}</tmp>/element()\r\n\r\n\r\n... and the ouput is,\r\n<cts:element-range-query operator=\"=\" xmlns:cts=\"http://marklogic.com/cts\">\r\n<cts:element>person</cts:element>\r\n<cts:value xsi:type=\"xs:string\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">test</cts:value>\r\n<cts:option>collation=http://marklogic.com/collation/</cts:option>\r\n</cts:element-range-query>\r\n\r\n-- Looking at <cts:value>, there is once again a namespace definition for the xs prefix.\r\n\r\nThe problem this has created is quite strange. For starters, we don't understand why the value of an attribute is being interpreted and requires the xs prefix to be defined. Beyond that, we have been storing the serialized query in the database in an XML file and there has been no problem. The issue has shown up because we are migrating to a new server. As part of this process, the database is being zipped up and then unzipped on the new server, but we see the exception XDMP-DOCNONSBIND when xdmp:zip-get is called. I have also found that quoting, then unquoting the second example above also results in the same exception.\r\n\r\nWe have not had a chance to test this in Marklogic 6, we are currently running version 5.0.3-1.\r\n\r\nThanks\r\nEric Bower\r\nENSCO, Inc\r\n---------------------------------------------------------------------------------------------------------", "samplequery":"Doing a simple quote and unquote on search:parse output is throwing XDMP-DOCNONSBIND error.\r\n\r\nimport module namespace search = \"http://marklogic.com/appservices/search\" at \"/MarkLogic/appservices/search/search.xqy\";\r\nxdmp:unquote( xdmp:quote(\r\nsearch:parse(\"person:test\",\r\n<options xmlns=\"http://marklogic.com/appservices/search\">\r\n<constraint name=\"person\">\r\n<range type=\"xs:string\">\r\n<element ns=\"http://ensco.com/entity\" name=\"person\"/>\r\n</range>\r\n</constraint>\r\n</options>)\r\n))", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-1", "fixedin":"7.0-1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"dchander", "name":"Dinesh Chander", "email":"dinesh.chander@globallogic.com"}, {"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20004, "support":{"headline":"Round-tripping from XML to cts:query fails with Namespace issue.", "supportDescription":"When you store a serialized search:options node that happens to contain a serialized cts:query, it doesn't write a required namespace.  Importing one of these serialized options nodes fails with a namespace error.\r\n", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"Medium", "title":"Requires significant or unnatural effort to work around issue or to prevent significant business impact"}, "workaround":"Edit the serialized node to include a namespace declaration for xmlns:xs=\"http://www.w3.org/2001/XMLSchema\""}, "tags":["Search API", "dchander"], "changeHistory":[{"time":"2012-11-06T21:28:11.995243-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Please clone in 6.0-nightly and also 6.1-nightly if you think this is a defect and has to be fixed. Thanks."}, {"time":"2012-11-06T21:28:11.995243-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-06T21:28:11.995243-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-5"}}, "files":[], "show":true}, {"time":"2012-11-07T08:44:15.907375-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I remember working on this issue once before.  Acked, after spec work this week I'll dig into the solution.  I don't remember whether it was a bug or not but we did find resolution.  Perhaps it's just not backported to 5."}, {"time":"2012-11-30T16:44:14.241891-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-17T15:56:06.17376-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"124457", "paths":["xdmp/trunk/src/Modules/MarkLogic/appservices/search/search-impl.xqy"], "affectedBugs":[]}, "comment":"bug:20302 xs namespace missing on search:parse output"}, {"time":"2012-12-17T15:58:28.084624-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true, "comment":"This bug adds a namespace declaration to the output for search:parse and may cause regressions.\r\n\r\nOtherwise no change in functionality should be observed."}, {"time":"2012-12-17T15:58:28.084624-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-01-30T16:22:48.471558-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Forgot to assign this to you earlier -- see clone in 6-- you tested it there already."}, {"time":"2013-01-30T16:22:48.471558-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"vkorolev", "name":"Vitaly Korolev", "email":"vitaly.korolev@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-21T15:57:49.813162-08:00", "updatedBy":{"username":"vkorolev", "name":"Vitaly Korolev", "email":"vitaly.korolev@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"vkorolev", "name":"Vitaly Korolev", "email":"vitaly.korolev@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Updated the keys with new namespace and there is no change in functionality related to this fix."}], "updatedAt":"2013-02-21T15:57:49.813162-08:00", "fixedAt":"2012-12-17T15:58:28.084624-08:00", "fixedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "shippedAt":"2013-02-21T15:57:49.813162-08:00", "shippedBy":{"username":"vkorolev", "name":"Vitaly Korolev", "email":"vitaly.korolev@marklogic.com"}, "renderDescriptionAs":"normal", "renderSampleQueryAs":"normal"}