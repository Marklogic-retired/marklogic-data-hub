{"id":20581, "kind":"Bug", "createdAt":"2013-01-24T08:40:43.89033-08:00", "status":"Closed", "title":"Use of multiple predicates in a for loop returns incorrect results", "category":"search", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"A user has reported an issue in which using a predicate followed by a position predicate in a for loop will return inconsistent results with what was seen in MarkLogic 6.0-1.1.  I have reproduced this issue using 6.0-2 through 6.0-2.2 using the sample query found below.\r\n\r\n", "samplequery":"(: Populate repository with some simple documents :)\r\n\r\ndeclare function local:insertFileForTest($docId) {\r\n    let $uri := fn:concat(\"/SUPPORT_20130124/doc-\", $docId, \".xml\")\r\n    let $doc := <doc docId=\"{$docId}\"><title>Issue Test {$docId}</title></doc>\r\n    return xdmp:document-insert($uri, $doc, (), (\"SUPPORT_20130124\"))\r\n};\r\n\r\nfor $i in 1 to 10\r\nreturn local:insertFileForTest($i);\r\n\r\n(: Run test cases :)\r\nfn:count(for $doc in fn:collection(\"SUPPORT_20130124\")[1 to 2][fn:contains(doc, \"Issue\")] return $doc)\r\n\r\n\r\n(:results:)\r\n6.0-1.1 => 2\r\n\r\n6.0-2.2 => 10", "sampledata":"", "version":"6.0-2", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, {"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, {"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[20583], "cloneOf":"", "support":{"headline":"Multiple predicates in a for expression returns incorrect results", "supportDescription":"Multiple predicates in a for expression returns incorrect results. This issue is specific to versions 6.0.1 and 6.0.2.x..", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"Medium", "title":"Requires significant or unnatural effort to work around issue or to prevent significant business impact"}, "workaround":""}, "tags":["search", "rjovanovich"], "changeHistory":[{"time":"2013-01-24T08:48:54.913723-08:00", "updatedBy":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-24T09:18:32.636502-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"What is the level of urgency of this issue?"}, {"time":"2013-01-24T09:29:43.803235-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-01-24T13:32:32.640568-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-25T11:16:40.663612-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"It would be nice to understand this and to have a fix in hand in case this becomes important to someone, as it appears to be a worong answer.."}, {"time":"2013-01-25T11:24:09.712543-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Agreed. I will look at this asap."}, {"time":"2013-01-26T00:11:35.077799-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Here is a simplified repro:\r\n\r\nDefine a string path range index on /a/b/c and insert the document:\r\nxdmp:document-insert(\"/abc.xml\",\r\n<a>\r\n  <b><c>C1</c></b>\r\n  <b><c>C2</c></b>\r\n</a>)\r\n\r\n/a/b[c>=\"C\"][1]\r\n=>\r\n<b><c>C1</c></b>\r\n<b><c>C2</c></b>\r\n\r\nThis should have returned only the first b.\r\n/a/b[c>=\"C\"][2]\r\n=>\r\nyour query returned an empty sequence\r\n\r\nThis should have returned the second b.\r\n\r\nConceivably, this problem should be reproduced using element range index or element-attribute range index.\r\n\r\nFrom my investigations and some interactions with CJL, here is analysis.\r\n\r\nUntil 6.0.1, if we found a positional predicate in a step we would mark the step unsearchable. As a result even if other predicates on the step can be resolved using indexes, we would simply ignore indexes and the predicates would be applied just like a filter.\r\n\r\nIn 6.0.1 we introduced path range indexes which are more selective than just element or element-attribute range indexes. So we changed the criterion of searchability. If none of the predicates on a step is searchable then only the step is unsearchable. That gave us freedom to use range indexes even when one of the predicates is searchable.\r\n\r\nBut this regression pointed to a fact that we do not apply positional predicates on searchable steps. We apply them only when the step is unsearchable. So we have two choices for fixing the bug:\r\n1) back out the multi-predicate optimization and go back on 6.0.1 level of optimization, or\r\n2) extend the optimization by allowing positional predicates even on searchable steps.\r\n\r\nAlthough I favor (2), the complexity and the side-effects are unclear yet. We will continue to investigate this for a fix that will not compromise with the new optimization we introduced in 6.0.2.\r\n"}, {"time":"2013-01-28T13:46:14.647352-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Backing out the optimization introduced as a part of bug 19794."}, {"time":"2013-01-28T13:47:43.628279-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"129756", "paths":["xdmp/branches/b6_0/src/XQuery.cpp"], "affectedBugs":["19794"]}, "comment":"Fix for bug:20581. Backing out the optimization doen for bug:19794.\n"}, {"time":"2013-01-28T13:54:15.045848-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-28T13:54:15.045848-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-19T00:44:02.307864-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on build 6.0-20130221."}, {"time":"2013-04-22T16:28:13.725753-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-04-22T16:28:13.725753-07:00", "fixedAt":"2013-01-28T13:54:15.045848-08:00", "fixedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "shippedAt":"2013-03-19T00:44:02.307864-07:00", "shippedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "closedAt":"2013-04-22T16:28:13.725753-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal", "renderSampleQueryAs":"normal"}