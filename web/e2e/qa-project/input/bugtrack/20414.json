{"id":20414, "kind":"Bug", "createdAt":"2013-01-08T03:06:02.713338-08:00", "status":"Closed", "title":"Missing results for different distance-weight values in cts:element-word-query() when search has Unfiltered option", "category":"xdmp", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"ML Version: 5.0-20130107\r\nTest Name: Proximityboost_2.xml\r\n\r\nLink to diff: \r\nhttps://regression-status.marklogic.com/new-app/space2/diff-archive/b5_0/2013-01-07/linux-64-rh54-cluster-RH5.4/diffs/Proximityboost_2.xml\r\n************************************************************************************************************************************************\r\n\r\nSteps to reproduce:\r\n*********************\r\n\r\n1. Create New DB (say ProximityboostDB)\r\n2. Create 2 new Forests and associate with DB\r\n3. Associate new DB with Triggers DB\r\n4. Associate database with xdbc server\r\n5. Add fragment root\r\n\t\txquery version \"1.0-ml\";\r\n        import module namespace admin=\"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n        let $config := admin:get-configuration()\r\n        let $names := (\"near\")\r\n        let $dbid := admin:database-get-id($config, \"ProximityboostDB\")\r\n        let $elements := \r\n\t\t(\r\n            for $i in $names\r\n            return admin:database-fragment-root(\"\", $i)\r\n\t\t)\r\n        let $c := admin:database-add-fragment-root($config, $dbid, $elements)\r\n        return admin:save-configuration($c)\r\n6. Add database fields\r\n\t\txquery version \"1.0-ml\";\r\n\t\timport module namespace admin = \"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n\t\tlet $config := admin:get-configuration()\r\n\t\tlet $dbid := xdmp:database(\"ProximityboostDB\")\r\n\t\tlet $fieldspec1 := admin:database-field(\"info\", fn:false())\r\n\t\tlet $c := admin:database-add-field($config, $dbid, $fieldspec1)\r\n\t\tlet $fieldspec2 :=   admin:database-included-element(\"\",\"near\", 1.0, \"\", \"\", \"\")\r\n\t\tlet $c :=  admin:database-add-field-included-element($c, $dbid,\"info\", $fieldspec2)\r\n\t\treturn admin:save-configuration($c)\r\n7. Turn on word-positions\r\n\t\tlet $c :=  adm:database-set-word-positions($config, $dbid, fn:true())\r\n        let $c := adm:database-set-element-word-positions($c, $dbid, fn:true())\r\n        let $c := adm:database-set-word-searches($c, $dbid, fn:true())\r\n8. Insert documents\r\n\t\txquery version \"1.0-ml\";\r\n\t\txdmp:document-insert(\"/test/near.xml\",\r\n        <info>\r\n        <near>dog is near to cat but not very very very very very very very very very very near to monkey</near>\r\n        <near>lion is very near to lion but not very very very very very very very very very very near to tiger</near>\r\n        <near val=\"dog and word1 are very near to cat and word2 but not very very very very very very very very very very near to monkey\">Dog testing attribute word query of the is  very very very very very very very very very very very very very very very very very very very very very very very very very very very very very far pretty cool  very very very very very very very pretty cool Cat</near>\r\n        <near>word1 is very near to word2 but not many many many many many many many many many many</near>\r\n        <notext/>\r\n        </info>) ;\r\n\t\txdmp:document-insert(\"/test/far.xml\",\r\n        <info>\r\n         <near>dog is very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very  very very very very very very very very very far from cat and also from monkey</near>\r\n         <near>lion is very far to  tiger but not very very very very very very very very very very far to lion</near>\r\n         <near val=\"dog and word1 are very very very very very very very very very very very very very very far from cat, word2 also from monkey and many many many many many many many many many many many many many many many many word1\">Dog testing attribute word query of the pretty cool very yyyy very  very very very very very far pretty cool Cat</near>\r\n        <near>word1 is very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very very  very very very very very very very very very very very very very very very very very very very very very far from word2 but there are very very very very very very very very very very very very very very very very very very very very  many many many many many many many many many many manymany many many many many many many many many many word1 with very very very very very very very very very very very very very very very very very very very very very  very very very very very very very very very very very very very very very very very very very very very far from very very very very very very very very very very very very very very very very very very very very word2 </near>\r\n        <notext/>\r\n        </info>\r\n      );\r\n9. Perform Merge\r\n10. Run the following XQUERY:\r\n\txquery version \"1.0-ml\";\r\n    try{\r\n        for $d in (-16,-1,0,1,16)\r\n        for $doc in  cts:search(fn:collection(),cts:element-word-query(xs:QName(\"near\"),(\"cat\",\"dog\"),fn:concat(\"distance-weight=\",$d)),\"unfiltered\")\r\n         return\r\n        (\"\",\"distance-weight=\",$d,\" \", base-uri($doc),\"==>\",cts:score($doc),\" \")\r\n        }\r\n\t\tcatch($ex)\r\n        { $ex/*:code/text() }\t\r\n\r\n************************************************************************************************************************************************\r\n\r\nActual Result: \r\ndistance-weight=0 /test/near.xml==>20480 \r\ndistance-weight=0 /test/near.xml==>20480 \r\ndistance-weight=0 /test/far.xml==>20480 \r\ndistance-weight=0 /test/far.xml==>20480</h:result-text>\r\n************************************************************************************************************************************************\r\n\r\nExpected Result:\r\ndistance-weight=-16 /test/far.xml==>-18432 \r\ndistance-weight=-16 /test/near.xml==>-20480 \r\ndistance-weight=-16 /test/far.xml==>-43264 \r\ndistance-weight=-16 /test/near.xml==>-76032 \r\ndistance-weight=-1 /test/far.xml==>17920 \r\ndistance-weight=-1 /test/near.xml==>17792 \r\ndistance-weight=-1 /test/far.xml==>16384 \r\ndistance-weight=-1 /test/near.xml==>14336 \r\ndistance-weight=0 /test/near.xml==>20480 \r\ndistance-weight=0 /test/near.xml==>20480 \r\ndistance-weight=0 /test/far.xml==>20480 \r\ndistance-weight=0 /test/far.xml==>20480 \r\ndistance-weight=1 /test/near.xml==>26624 \r\ndistance-weight=1 /test/far.xml==>24576 \r\ndistance-weight=1 /test/near.xml==>23168 \r\ndistance-weight=1 /test/far.xml==>23040 \r\ndistance-weight=16 /test/near.xml==>116224 \r\ndistance-weight=16 /test/far.xml==>83712 \r\ndistance-weight=16 /test/near.xml==>61184 \r\ndistance-weight=16 /test/far.xml==>59136\r\n\r\n", "samplequery":"", "sampledata":"", "version":"6.0-nightly", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, {"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20398, "support":{"headline":"", "supportDescription":"Nightly", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "ksaxena"], "changeHistory":[{"time":"2013-01-08T03:06:02.713338-08:00", "updatedBy":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-09T11:03:05.667239-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2013-01-09T14:28:08.608638-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-01-09T14:59:21.644574-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"127258", "paths":["xdmp/branches/b6_0/src/SearchBuiltins.cpp"], "affectedBugs":["20011"]}, "comment":"Bug:20414 multiple words in element-word-query wrongly handled due to fix for Bug:20011"}, {"time":"2013-01-09T15:00:47.147702-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}}}, "files":[], "show":true, "comment":"Fixed 6.0-20130110"}, {"time":"2013-01-09T15:00:47.147702-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-14T21:17:30.159774-08:00", "updatedBy":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified in ML 6.0-20130114"}, {"time":"2013-01-14T21:17:30.159774-08:00", "updatedBy":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-01-14T21:17:30.159774-08:00", "fixedAt":"2013-01-09T15:00:47.147702-08:00", "fixedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "shippedAt":"2013-01-14T21:17:30.159774-08:00", "shippedBy":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, "renderDescriptionAs":"normal"}