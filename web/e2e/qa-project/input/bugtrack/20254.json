{"id":20254, "kind":"Bug", "createdAt":"2012-11-26T18:20:45.507009-08:00", "status":"Closed", "title":"large binary files may get lost on a replica cluster when switching from flexrep to db rep between two clusters  and under heavy IO", "category":"", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"I noted a harmful time window in the code:  in BinaryManager when the ref count to a large binary is reduced to 0,  the code enqueues a file deletion but quits the critical section without waiting for the file to be actually deleted. But Forest::replicateFragment replies  on the existence of the file to decide whether to throw a retry (see Bug 19914).  In one stress test when IO is very slow due to heavy load,  I noted it can take minutes before a file is actually deleted after en-queueing the deletion request. That means while the retry process does re-replicate the binary file, the deletion request enqueued earlier (before the retry is thrown) can cause the file to get deleted again.   After I move the real deletion into the critical section (which is an experiment, not a desirable fix), the issue no longer happens.  So this timing window must be closed.", "samplequery":"", "sampledata":"", "version":"6.0-nightly", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20146, "support":{"headline":"On rare occasions, large binary files may get lost on a replica cluster when switching from flexible replication to database replication", "supportDescription":"On rare occasions, large binary files may get lost on a replica cluster when switching from flexible replication to database replication between two clusters. This has only been observed in stress tests under very heavy IO.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":"Remove the large binary fragment on the replicate cluster so the large binary file will get re-replicated."}, "tags":["", "hwu"], "changeHistory":[{"time":"2012-11-26T18:20:45.507009-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-11T17:28:46.09333-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-01-15T17:29:46.339814-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"127900", "paths":["xdmp/branches/b6_0/src/services/File.h", "xdmp/branches/b6_0/src/Forest.cpp", "xdmp/branches/b6_0/src/BinaryManager.cpp", "xdmp/branches/b6_0/src/services/File.cpp"], "affectedBugs":[]}, "comment":"bug:20254 large binary files may get lost on a replica cluster when switching from flexrep to db rep between two clusters and under heavy IO"}, {"time":"2013-01-15T17:30:10.490673-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-15T17:30:10.490673-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-11T03:34:21.953518-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on build 6.0-20130407"}, {"time":"2013-04-22T16:33:12.622905-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-04-22T16:33:12.622905-07:00", "fixedAt":"2013-01-15T17:30:10.490673-08:00", "fixedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "shippedAt":"2013-04-11T03:34:21.953518-07:00", "shippedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "closedAt":"2013-04-22T16:33:12.622905-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}