{"id":20815, "kind":"Bug", "createdAt":"2013-02-18T04:15:43.895596-08:00", "status":"Closed", "title":"Seeing error \"Need privilege\" during xdmp:http-get with InfostudioUser", "category":"xdmp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Seeing error \"Need privilege\" during xdmp:http-get with InfostudioUser.\r\n\r\nFailing Test: bug10682.xml\r\nML Version: 7.0-20130217\r\nMachine Name:rh5-intel64-70-test-3\r\nPath to Logs: /space/builder/builds/linux64/HEAD/logs.20130217.0/reg-results\r\n\r\nSteps to reproduce:\r\n\r\n1. Create db and forest.\r\n2. Create test role and user.\r\n\r\nXquery:\r\n\r\nxquery version \"1.0-ml\";\r\n(:  create role  :)\r\n        import module namespace sec = 'http://marklogic.com/xdmp/security' at '/MarkLogic/security.xqy';\r\n        let $res := if (exists(//sec:role[sec:role-name = 'Read-Insert-Role']))\r\n        then ()\r\n        else sec:create-role('Read-Insert-Role', 'role that has only eval and any uri privilege', (\"eval\"), (), ()) > 0\r\n        return ();\r\n(:  add priv to role  :)\r\n        xquery version \"1.0-ml\";\r\n        import module namespace sec = 'http://marklogic.com/xdmp/security' at '/MarkLogic/security.xqy';\r\n        sec:privilege-add-roles('http://marklogic.com/xdmp/privileges/any-uri', 'execute', 'Read-Insert-Role');\r\n(:  create user with role  :)\r\n        xquery version \"1.0-ml\";\r\n        import module namespace sec = 'http://marklogic.com/xdmp/security' at '/MarkLogic/security.xqy';\r\n        let $res :=\r\n          if (exists(//sec:user[sec:user-name = 'InfostudioUser']))\r\n          then ()\r\n          else sec:create-user('InfostudioUser', 'User with only eval role, infostudio- user role and any-uri execution privilege', 'password',('Read-Insert-Role','infostudio-user'), (), ())\r\n        return ()\r\n\t\t\r\n3. Create http server.\r\n4. Insert document.\r\nQuery1:\r\nxquery version \"1.0-ml\";\r\n    xdmp:document-insert(\"/Test.xqy\",text{\"\r\n     xquery version '1.0-ml';\r\n       import module namespace amped-info = 'http://marklogic.com/appservices/infostudio/util-amped' at '/MarkLogic/appservices/infostudio/info-amped.xqy';\r\n         try {\r\n           amped-info:infostudio-spawn('/hello.xqy', (),\r\n                <options xmlns='xdmp:eval'>\r\n                <database>{xdmp:database('bug10682DB')}</database>\r\n                <time-limit>1800</time-limit>\r\n                </options>)\r\n\t\t\t\t}\r\n        catch ($e) {$e} \"},(xdmp:permission('infostudio-user','update'),xdmp:permission('infostudio-user','read'),xdmp:permission('infostudio-user','execute') ))\r\n\r\nQuery2:\r\nxquery version \"1.0-ml\";\r\nxdmp:document-insert(\"/hello.xqy\",text{\"\r\n        xquery version '1.0-ml';\r\n        try {        \r\n\t\txdmp:document-insert('/hello.xml',<insert>successful</insert>,(xdmp:permission('infostudio-user','update'),xdmp:permission('infostudio-user','read'))) }\r\n        catch ($e) { $e} \"},(xdmp:permission('infostudio-user','update'),xdmp:permission('infostudio-user','read'),xdmp:permission('infostudio-user','execute')))\r\n\r\n5. Run following query:\r\n\r\ntry {\r\n  let $base-url := \"http://localhost:8022/Test.xqy\"\r\n  let $response :=\r\n    xdmp:http-get($base-url,\r\n     <options xmlns=\"xdmp:http\">\r\n         <authentication method=\"digest\">\r\n           <username>InfostudioUser</username>\r\n           <password>password</password>\r\n         </authentication>\r\n       </options>)\r\nreturn\r\n  $response//message\r\n} catch ($e) {$e}\r\n\r\nActual result:\r\n<error:error xmlns:error=\"http://marklogic.com/xdmp/error\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://marklogic.com/xdmp/error error.xsd\">\r\n  <error:code>SEC-PRIV</error:code>\r\n  <error:name/>\r\n  <error:xquery-version>0.9-ml</error:xquery-version>\r\n  <error:message>Need privilege</error:message>\r\n  <error:format-string>SEC-PRIV: xdmp:http-get(\"http://localhost:8022/Test.xqy\", <options xmlns=\"xdmp:http\"><authentication method=\"digest\"><username>InfostudioUser</userna...</options>) -- Need privilege: http://marklogic.com/xdmp/privileges/xdmp-http-get</error:format-string>\r\n  <error:retryable>false</error:retryable>\r\n  <error:expr>xdmp:http-get(\"http://localhost:8022/Test.xqy\", <options xmlns=\"xdmp:http\"><authentication method=\"digest\"><username>InfostudioUser</userna...</options>)</error:expr>\r\n  <error:data>\r\n    <error:datum>http://marklogic.com/xdmp/privileges/xdmp-http-get</error:datum>\r\n  </error:data>\r\n  <error:stack>\r\n    <error:frame>\r\n      <error:line>5</error:line>\r\n      <error:column>0</error:column>\r\n      <error:variables>\r\n\t<error:variable>\r\n\t  <error:name xmlns=\"\">base-url</error:name>\r\n\t  <error:value>\"http://localhost:8022/Test.xqy\"</error:value>\r\n\t</error:variable>\r\n      </error:variables>\r\n      <error:xquery-version>0.9-ml</error:xquery-version>\r\n    </error:frame>\r\n  </error:stack>\r\n</error:error>\r\n\r\nExpected Result: blank (should not throw any exception)\r\n\r\nNote: This test started failing since 2013-01-12", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea1", "fixedin":"N/A", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "iagrawal"], "changeHistory":[{"time":"2013-02-18T04:15:43.895596-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-18T06:46:09.413766-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"The http-get in your test is failing because you need a privilege to do an http-get now.\r\nSee bug 20437.\r\nIt looks like the http-get is not part of the thing you are testing, but is part of the test script.\r\nSo I think the thing to so is run the test request that does the http-get as an admin user, and not as infostdio user.\r\nI *do not* think this test means that infostdio user needs the http-get privilege."}, {"time":"2013-02-19T04:47:33.283805-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-19T04:48:29.319928-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"As per above suggestion, updated the test bug10682.xml for admin user.hence,closing the bug"}], "updatedAt":"2013-02-19T04:48:29.319928-08:00", "closedAt":"2013-02-19T04:48:29.319928-08:00", "closedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "renderDescriptionAs":"normal"}