{"id":20502, "kind":"Bug", "createdAt":"2012-07-18T00:54:56.275494-07:00", "status":"Closed", "title":"xdmp:document-load XDMP-DOCSTARTTAGCHAR error with Kanji tags and \"auto\" encoding", "category":"InfoStudio UI", "severity":"Minor", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"denise", "name":"Denise Miura", "email":"denise.skarupski@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"The attached xml file loads fine using xdmp:document-load(), but information studio throws the error below. File appears to be valid UTF-8. Only thing \"special\" is that the tag names are in kanji. This is just one of many similar files that exhibit this problem. Let me know if you need more. \r\n\r\nXDMP-DOCXMLCHAR: xdmp:invoke(\"/MarkLogic/appservices/infostudio/transaction.xqy\", (fn:QName(\"\", \"args\"), map:map(<map:map xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:map=\"http://marklogic.com/xdmp/map\"><map:entry key=\"ticket-id\"><map:value xsi:type=\"xs:string\">/tick...</map:map>)), <options xmlns=\"xdmp:eval\"><database>9625854619432509687</database></options>) -- Invalid XML character codepoint 16 at 01_TestFiles/.0.xml.swp line 1 -- document contains non-XML character\r\nIn /MarkLogic/appservices/utils/common-amped.xqy on line 176\r\nIn amped-common:appservices-invoke(\"/MarkLogic/appservices/infostudio/transaction.xqy\", (fn:QName(\"\", \"args\"), map:map(<map:map xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:map=\"http://marklogic.com/xdmp/map\"><map:entry key=\"ticket-id\"><map:value xsi:type=\"xs:string\">/tick...</map:map>)), <options xmlns=\"xdmp:eval\"><database>9625854619432509687</database></options>)\r\n\r\n    $path = \"/MarkLogic/appservices/infostudio/transaction.xqy\"\r\n    $vars = (fn:QName(\"\", \"args\"), map:map(<map:map xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:map=\"http://marklogic.com/xdmp/map\"><map:entry key=\"ticket-id\"><map:value xsi:type=\"xs:string\">/tick...</map:map>))\r\n    $options = <options xmlns=\"xdmp:eval\"><database>9625854619432509687</database></options>\r\n\r\nIn /MarkLogic/appservices/infostudio/info-impl.xqy on line 821\r\nIn impl:do-transaction-stream((\"01_TestFiles/.0.xml.swp\", \"01_TestFiles/0.xml\"), \"/tickets/ticket/2583379330435947273\", xdmp:function(fn:QName(\"http://marklogic.com/extension/plugin/filescan\", \"process-file\")), <info:options xmlns:info=\"http://marklogic.com/appservices/infostudio\"/>, xs:untypedAtomic(\"1\"), \"\", ())\r\n\r\n    $source-locations = (\"01_TestFiles/.0.xml.swp\", \"01_TestFiles/0.xml\")\r\n    $ticket-id = \"/tickets/ticket/2583379330435947273\"\r\n    $function = xdmp:function(fn:QName(\"http://marklogic.com/extension/plugin/filescan\", \"process-file\"))\r\n    $input-deltas = <info:options xmlns:info=\"http://marklogic.com/appservices/infostudio\"/>\r\n    $transaction-index = 1\r\n    $context = \"\"\r\n    $error-log-level = ()\r\n    $database = \"Documents\"\r\n    $args = map:map(<map:map xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:map=\"http://marklogic.com/xdmp/map\"><map:entry key=\"ticket-id\"><map:value xsi:type=\"xs:string\">/tick...</map:map>)\r\n    $_ = ()\r\n\r\nIn /MarkLogic/appservices/infostudio/tasks/transaction-manager.xqy on line 62\r\n\r\n    $count = xs:unsignedLong(\"1\")\r\n    $end = 10\r\n    $ticket-id = \"/tickets/ticket/2583379330435947273\"\r\n    $ticket = <ticket id=\"/tickets/ticket/2583379330435947273\" timestamp=\"2012-07-18T16:37:48.169887+09:00\" xmlns=\"http://marklogic.com/appservices/infostudio\"><status>active</status><start-time>2012-07-18T16:37:45.275538+09...</ticket>\r\n    $active = fn:true()\r\n    $done = ()\r\n    $policy-name = \"2247461789591674058\"\r\n    $policy-deltas = <info:options xmlns:info=\"http://marklogic.com/appservices/infostudio\"/>\r\n    $collector-options = <options xmlns=\"xdmp:document-get\"><encoding>ISO-2022-JP</encoding><format>xml</format></options>\r\n    $transaction = <transaction document-count=\"2\" ticket-id=\"/tickets/ticket/2583379330435947273\" database=\"Documents\" index=\"1\" xmlns=\"http://marklogic.com/appservices/infostudio\"><source-location>01_TestFiles/.0.xml.swp</source-location><sourc...</transaction>\r\n    $trace = \"Ticket /tickets/ticket/2583379330435947273 loading task: 1 trans...\"\r\n    $source-locations = (\"01_TestFiles/.0.xml.swp\", \"01_TestFiles/0.xml\")\r\n\r\n", "samplequery":"", "sampledata":"", "version":"6.0-2", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"denise", "name":"Denise Miura", "email":"denise.skarupski@marklogic.com"}, {"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, {"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, {"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, {"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}], "attachments":[{"name":"0.xml", "uri":"root/support/bugtracking/attachments/18373/0.xml"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":18373, "support":{"headline":"xdmp:document-load and xdmp:document-get failing with \"auto\" encoding on XML documents with encoding declaration set correctly", "supportDescription":"xdmp:document-load and xdmp:document-get may fail with XDMP-DOCUTF8SEQ or XDMP-DOCSTARTTAGCHAR errors when encoding is set to \"auto\" on some XML documents with their encoding declaration correctly identifying their encoding. This was observed with some UTF-8 documents containing Kanji element names, where the best guess for the encoding was incorrect. Where possible, \"auto\" encoding should give greater weight to the XML encoding declaration.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"Medium", "title":"Requires significant or unnatural effort to work around issue or to prevent significant business impact"}, "workaround":"Explicitly set the encoding, instead of relying on \"auto\"."}, "tags":["InfoStudio UI", "denise"], "changeHistory":[{"time":"2012-07-18T00:56:23.250317-07:00", "updatedBy":{"username":"denise", "name":"Denise Miura", "email":"denise.skarupski@marklogic.com"}, "change":{}, "files":[], "show":false}, {"time":"2012-07-18T12:32:59.924217-07:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"Do they also have a file named \".0.xml.swp\".\r\nIt seems to be complaining about that file, not about the file named \"0.xml\"."}, {"time":"2012-07-18T12:32:59.924217-07:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":false}, {"time":"2012-07-18T13:21:44.97766-07:00", "updatedBy":{"username":"denise", "name":"Denise Miura", "email":"denise.skarupski@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"not sure how/when the swp file appeared in the load directory, but it's unrelated. just reproduced again using 0.xml and here's the error message:\r\n\r\nXDMP-DOCSTARTTAGCHAR: xdmp:invoke(\"/MarkLogic/appservices/infostudio/transaction.xqy\", (fn:QName(\"\", \"args\"), map:map(<map:map xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:map=\"http://marklogic.com/xdmp/map\"><map:entry key=\"ticket-id\"><map:value xsi:type=\"xs:string\">/tick...</map:map>)), <options xmlns=\"xdmp:eval\"><database>9625854619432509687</database></options>) -- Unexpected character \"&#187;\" in start tag at loadkanji/0.xml line 4\r\n\r\nIn /MarkLogic/appservices/utils/common-amped.xqy on line 176\r\nIn amped-common:appservices-invoke(\"/MarkLogic/appservices/infostudio/transaction.xqy\", (fn:QName(\"\", \"args\"), map:map(<map:map xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:map=\"http://marklogic.com/xdmp/map\"><map:entry key=\"ticket-id\"><map:value xsi:type=\"xs:string\">/tick...</map:map>)), <options xmlns=\"xdmp:eval\"><database>9625854619432509687</database></options>)\r\n$path = \"/MarkLogic/appservices/infostudio/transaction.xqy\"\r\n$vars = (fn:QName(\"\", \"args\"), map:map(<map:map xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:map=\"http://marklogic.com/xdmp/map\"><map:entry key=\"ticket-id\"><map:value xsi:type=\"xs:string\">/tick...</map:map>))\r\n$options = <options xmlns=\"xdmp:eval\"><database>9625854619432509687</database></options>\r\nIn /MarkLogic/appservices/infostudio/info-impl.xqy on line 821\r\nIn impl:do-transaction-stream(\"loadkanji/0.xml\", \"/tickets/ticket/13932728709214018765\", xdmp:function(fn:QName(\"http://marklogic.com/extension/plugin/filescan\", \"process-file\")), <info:options xmlns:info=\"http://marklogic.com/appservices/infostudio\"/>, xs:untypedAtomic(\"1\"), \"\", ())\r\n$source-locations = \"loadkanji/0.xml\"\r\n$ticket-id = \"/tickets/ticket/13932728709214018765\"\r\n$function = xdmp:function(fn:QName(\"http://marklogic.com/extension/plugin/filescan\", \"process-file\"))\r\n$input-deltas = <info:options xmlns:info=\"http://marklogic.com/appservices/infostudio\"/>\r\n$transaction-index = 1\r\n$context = \"\"\r\n$error-log-level = ()\r\n$database = \"Documents\"\r\n$args = map:map(<map:map xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:map=\"http://marklogic.com/xdmp/map\"><map:entry key=\"ticket-id\"><map:value xsi:type=\"xs:string\">/tick...</map:map>)\r\n$_ = ()\r\nIn /MarkLogic/appservices/infostudio/tasks/transaction-manager.xqy on line 62\r\n$count = xs:unsignedLong(\"1\")\r\n$end = 10\r\n$ticket-id = \"/tickets/ticket/13932728709214018765\"\r\n$ticket = <ticket id=\"/tickets/ticket/13932728709214018765\" timestamp=\"2012-07-19T05:18:49.631016+09:00\" xmlns=\"http://marklogic.com/appservices/infostudio\"><status>active</status><start-time>2012-07-19T05:18:48.860534+09...</ticket>\r\n$active = fn:true()\r\n$done = ()\r\n$policy-name = \"3066649637587671916\"\r\n$policy-deltas = <info:options xmlns:info=\"http://marklogic.com/appservices/infostudio\"/>\r\n$collector-options = <options xmlns=\"xdmp:document-get\"><encoding>auto</encoding></options>\r\n$transaction = <transaction document-count=\"1\" ticket-id=\"/tickets/ticket/13932728709214018765\" database=\"Documents\" index=\"1\" xmlns=\"http://marklogic.com/appservices/infostudio\"><source-location>loadkanji/0.xml</source-location></transaction>\r\n$trace = \"Ticket /tickets/ticket/13932728709214018765 loading task: 1 tran...\"\r\n$source-locations = \"loadkanji/0.xml\""}, {"time":"2012-07-18T13:21:44.97766-07:00", "updatedBy":{"username":"denise", "name":"Denise Miura", "email":"denise.skarupski@marklogic.com"}, "change":{}, "files":[], "show":false}, {"time":"2012-07-18T17:26:14.119433-07:00", "updatedBy":{"username":"denise", "name":"Denise Miura", "email":"denise.skarupski@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"clue: if you explicitly set *both*  format=xml and encoding=UTF-8 in the \"ingestion\" popup in information studio, the file loads w/out error. "}, {"time":"2012-07-18T17:26:14.119433-07:00", "updatedBy":{"username":"denise", "name":"Denise Miura", "email":"denise.skarupski@marklogic.com"}, "change":{}, "files":[], "show":false}, {"time":"2012-07-19T14:58:33.743846-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-07-19T14:58:33.743846-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-07-19T14:58:33.743846-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-4"}}, "files":[], "show":true}, {"time":"2012-12-09T01:17:49.981585-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-11T10:43:01.365566-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hex dump of 0.xml\r\n\r\n0000: 3C 3F 78 6D 6C 20 76 65 72 73 69 6F 6E 3D 22 31 \t<?xml version=\"1\r\n0010: 2E 30 22 20 65 6E 63 6F 64 69 6E 67 3D 22 55 54 \t.0\" encoding=\"UT\r\n0020: 46 2D 38 22 3F 3E 0A 3C 43 4F 53 54 3E 0A 20 20 \tF-8\"?>.<COST>.  \r\n0030: 3C E6 B8 AF 49 44 3E 31 3C 2F E6 B8 AF 49 44 3E \t<...ID>1</...ID>\r\n0040: 0A 20 20 3C E4 BA BA E4 BB B6 E8 B2 BB E7 AD 89 \t.  <............\r\n0050: 3E 31 38 39 3C 2F E4 BA BA E4 BB B6 E8 B2 BB E7 \t>189</..........\r\n0060: AD 89 3E 0A 20 20 3C E7 87 83 E6 96 99 E8 B2 BB \t..>.  <.........\r\n0070: 3E 38 37 38 3C 2F E7 87 83 E6 96 99 E8 B2 BB 3E \t>878</.........>\r\n0080: 0A 20 20 3C E5 85 A5 E6 B8 AF E6 96 99 3E 34 30 \t.  <.........>40\r\n0090: 38 3C 2F E5 85 A5 E6 B8 AF E6 96 99 3E 0A 20 20 \t8</.........>.  \r\n00A0: 3C E9 81 95 E7 B4 84 E9 87 91 E7 AD 89 3E 31 35 \t<............>15\r\n00B0: 30 3C 2F E9 81 95 E7 B4 84 E9 87 91 E7 AD 89 3E \t0</............>\r\n00C0: 0A 20 20 3C E3 81 9D E3 81 AE E4 BB 96 E7 B5 8C \t.  <............\r\n00D0: E8 B2 BB 3E 35 36 30 3C 2F E3 81 9D E3 81 AE E4 \t...>560</.......\r\n00E0: BB 96 E7 B5 8C E8 B2 BB 3E 0A 3C 2F 43 4F 53 54 \t........>.</COST\r\n00F0: 3E    \r\n\r\nThe error message is  Unexpected character \"&#187; which is the same as 0xBB, which is in there, but would only be seen when trying to interpret the document as ISO-8859-1 or something. So the question is, where is the encoding getting confused?\r\n"}, {"time":"2012-12-11T10:52:33.99012-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"If you load this file as a binary and call\r\n\r\nxdmp:encoding-language-detect( doc(\"/Users/mdubinko/Downloads/kanji/0.bin\"))\r\nyou get =>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1251</encoding>\r\n  <language>ru</language>\r\n  <score>5.37</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>ja</language>\r\n  <score>5.11</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>zh-Hant</language>\r\n  <score>3.608</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>zh</language>\r\n  <score>3.256</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>TIS-620</encoding>\r\n  <language>th</language>\r\n  <score>2.828</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>en</language>\r\n  <score>2.434</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>it</language>\r\n  <score>2.412</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>es</language>\r\n  <score>2.405</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>ca</language>\r\n  <score>2.266</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1252</encoding>\r\n  <language>pt</language>\r\n  <score>2.253</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>pt</language>\r\n  <score>2.182</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1252</encoding>\r\n  <language>en</language>\r\n  <score>2.089</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1252</encoding>\r\n  <language>it</language>\r\n  <score>2.071</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1252</encoding>\r\n  <language>es</language>\r\n  <score>2.064</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1252</encoding>\r\n  <language>ca</language>\r\n  <score>1.945</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>nl</language>\r\n  <score>1.8</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>fr</language>\r\n  <score>1.779</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>ro</language>\r\n  <score>1.747</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>nn</language>\r\n  <score>1.55</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1252</encoding>\r\n  <language>nl</language>\r\n  <score>1.545</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>sl</language>\r\n  <score>1.529</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1252</encoding>\r\n  <language>fr</language>\r\n  <score>1.527</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1252</encoding>\r\n  <language>nn</language>\r\n  <score>1.525</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1250</encoding>\r\n  <language>ro</language>\r\n  <score>1.445</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1252</encoding>\r\n  <language>nb</language>\r\n  <score>1.339</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>de</language>\r\n  <score>1.335</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>nb</language>\r\n  <score>1.334</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>da</language>\r\n  <score>1.33</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>sv</language>\r\n  <score>1.321</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>sr</language>\r\n  <score>1.318</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>sk</language>\r\n  <score>1.302</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>ISO_8859-2:1987</encoding>\r\n  <language>ro</language>\r\n  <score>1.272</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1250</encoding>\r\n  <language>sl</language>\r\n  <score>1.265</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1253</encoding>\r\n  <language>el</language>\r\n  <score>1.165</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1252</encoding>\r\n  <language>de</language>\r\n  <score>1.146</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1252</encoding>\r\n  <language>da</language>\r\n  <score>1.142</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1252</encoding>\r\n  <language>sv</language>\r\n  <score>1.134</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>ISO_8859-2:1987</encoding>\r\n  <language>sl</language>\r\n  <score>1.113</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>cs</language>\r\n  <score>1.098</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>hr</language>\r\n  <score>1.092</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1250</encoding>\r\n  <language>sr</language>\r\n  <score>1.09</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>fi</language>\r\n  <score>1.09</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1250</encoding>\r\n  <language>sk</language>\r\n  <score>1.077</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>ISO_8859-5:1988</encoding>\r\n  <language>ru</language>\r\n  <score>1.048</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>ISO_8859-2:1987</encoding>\r\n  <language>sr</language>\r\n  <score>0.9591</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>ISO_8859-2:1987</encoding>\r\n  <language>sk</language>\r\n  <score>0.9478</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1252</encoding>\r\n  <language>fi</language>\r\n  <score>0.9356</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1250</encoding>\r\n  <language>cs</language>\r\n  <score>0.9087</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1250</encoding>\r\n  <language>hr</language>\r\n  <score>0.9031</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>pl</language>\r\n  <score>0.8733</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>ISO_8859-2:1987</encoding>\r\n  <language>cs</language>\r\n  <score>0.7995</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>ISO_8859-2:1987</encoding>\r\n  <language>hr</language>\r\n  <score>0.7946</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1250</encoding>\r\n  <language>pl</language>\r\n  <score>0.7225</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>tr</language>\r\n  <score>0.6696</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>UTF-8</encoding>\r\n  <language>hu</language>\r\n  <score>0.6411</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>ISO_8859-2:1987</encoding>\r\n  <language>pl</language>\r\n  <score>0.6357</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>windows-1250</encoding>\r\n  <language>hu</language>\r\n  <score>0.5304</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>ISO_8859-9:1989</encoding>\r\n  <language>tr</language>\r\n  <score>0.5226</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>ISO_8859-2:1987</encoding>\r\n  <language>hu</language>\r\n  <score>0.4667</score>\r\n</encoding-language>\r\n<encoding-language xmlns=\"xdmp:encoding-language-detect\">\r\n  <encoding>gb18030</encoding>\r\n  <language>zh</language>\r\n  <score>0.3468</score>\r\n</encoding-language>\r\n\r\nRussian beats Japanese. So I'm guessing that xdmp:encoding-language-detect doesn't weight very heavily either the characters in tag names or the prolog declaration..."}, {"time":"2012-12-11T13:47:33.758456-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Here's a simplified test case that shows the failure without information studio. As Denise said, explicitly specifying an encoding works, but relying on auto-detect doesn't.\r\n\r\nxdmp:document-load(\"/Users/mdubinko/Downloads/kanji/0.xml\",\r\n<options xmlns=\"xdmp:document-load\">\r\n    <format>xml</format>\r\n    <encoding>auto</encoding>\r\n</options>\r\n)\r\n=>\r\n[1.0-ml] XDMP-DOCSTARTTAGCHAR: xdmp:eval(\"import module namespace sem = &quot;http://marklogic.com/semanti...\", (), <options xmlns=\"xdmp:eval\"><database>16652286882181952736</database><modules>17176808388767...</options>) -- Unexpected character \"&#187;\" in start tag at /Users/mdubinko/Downloads/kanji/0.xml line 4\r\n"}, {"time":"2012-12-11T13:49:00.611915-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"<format>xml</format> not even needed.\r\n\r\nxdmp:document-load(\"/Users/mdubinko/Downloads/kanji/0.xml\",\r\n<options xmlns=\"xdmp:document-load\">\r\n    <encoding>auto</encoding>\r\n</options>\r\n)"}, {"time":"2012-12-12T11:24:23.669966-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"CJL in email:\r\nI would call it a minor bug that the encoding declaration is ignored\r\ncompletely when auto-detecting encoding.\r\nEven though it is often wrong, it is also often right.\r\nWe could peek at the encoding declaration and bias the detector results\r\nwith it.\r\nSo the UTF-8 in the declaration would bias the results enough so the UTF-8\r\nencoding would win.\r\n\r\nFlipping the over to Mary. (If you'd like, I'd be happy to whiteboard out a possible solution when you're back)"}, {"time":"2012-12-12T11:24:23.669966-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{"assignTo":{"from":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2013-01-17T13:59:51.006119-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-01-17T15:23:19.52674-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"128132", "paths":["xdmp/branches/b6_0/src/Extension.h", "xdmp/branches/b6_0/src/Extension.cpp", "xdmp/branches/b6_0/src/XQueryInterpreter.cpp"], "affectedBugs":[]}, "comment":"Bug:20502 if 'auto' encoding fails on XML document with error associated with bad encoding, try again with encoding peeked from XML declaration, if any"}, {"time":"2013-01-18T12:39:53.292431-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"128314", "paths":["xdmp/branches/b6_0/src/Indexer.h", "xdmp/branches/b6_0/src/Extension.cpp", "xdmp/branches/b6_0/src/UpdateBuiltins.cpp", "xdmp/branches/b6_0/src/ParseXML.h", "xdmp/branches/b6_0/src/Indexer.cpp", "xdmp/branches/b6_0/src/ParseXML.cpp"], "affectedBugs":[]}, "comment":"Bug:20502 peek the encoding on xdmp:document-load (file)"}, {"time":"2013-01-18T13:43:45.011943-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"128322", "paths":["xdmp/branches/b6_0/src/ParseXML.cpp"], "affectedBugs":[]}, "comment":"Bug:20502 sense of test backwards"}, {"time":"2013-01-18T13:47:37.96697-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"Fixed 6.0-20130119\r\nxdmp:document-load, xdmp:document-get will peek at the encoding in the XML declaration and attempt to use it if the \"auto\" encoding gave an error that tends to mean an encoding problem."}, {"time":"2013-01-18T13:47:37.96697-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-18T23:43:17.451708-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-26T13:28:20.074806-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-29T13:58:34.931626-07:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Aries, You tested the clone, but does not look like you added a test. Let us add a test."}, {"time":"2013-04-01T15:07:41.956363-07:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified passed\r\nAdded automation test info-bug20502.xml"}, {"time":"2013-04-01T15:07:41.956363-07:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-22T16:32:43.443047-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-04-22T16:32:43.443047-07:00", "fixedAt":"2013-01-18T13:47:37.96697-08:00", "fixedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "shippedAt":"2013-04-01T15:07:41.956363-07:00", "shippedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "closedAt":"2013-04-22T16:32:43.443047-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}