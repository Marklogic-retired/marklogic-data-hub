{"id":20741, "kind":"Bug", "createdAt":"2012-11-12T09:17:56.093361-08:00", "status":"Closed", "title":"MLCP: Stack error when copying large number of documents (16606)  ", "category":"mlcp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"pcaine", "name":"Penny Caine", "email":"Penny.Caine@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"When attempting to copy contents of a database on localhost to another database on same host the copy stops at approximately 66-68%. 11000 of the 11606 documents are copied.\r\n\r\nEnvironment:\r\nMarkLogic Server Standard Edition 6.0-1.1\r\nWindows 7\r\nmlcp download from DMC\r\n\r\nSteps to reproduce:\r\n1. Create an admin user mlcp-user with hadoop-user-all priviledges thrown in for good measure.\r\n2. As admin user (not mlcp-user), create a database called socialmedia, and then create and associate an XDBC server called Social_Media using port 8012.\r\n3. Copy, then extract the attached Twitter.zip to the local file system - and in a command prompt load the twitter data with mlcp.bat import into socialmedia. (9896 twitter docs are ingested.)\r\n4. Copy, but don't extract the attached Intense_Debate.zip - and import the compressed file into socialmedia. (6710 intense debate documents are loaded.)\r\n5. As admin user (not mlcp-user), create a second database called sentiment, and then create and associate an XDBC server called Sentiment using port 8014.\r\n6. Run mlcp.bat copy -mode local -input_host localhost -input_port 8012 -input_username admin -input_password admin -output_host localhost -output_port 8014 -output_username mlcp-user -output_password password.\r\n7. Check status. At around 68%:\r\n12/11/09 15:02:21 ERROR contentpump.LocalJobRunner: Error running task: attempt_\r\n_0000_m_000000_0\r\ncom.thoughtworks.xstream.mapper.CannotResolveClassException: com.marklogic.ps.xq\r\nsync.XQSyncDocumentMetadata\r\n        at com.thoughtworks.xstream.mapper.DefaultMapper.realClass(DefaultMapper\r\n.java:56)\r\n\r\nNote: Unable to reproduce the error with smaller content source such as Top Songs data (all 1839 docs copy with no errors). \r\n\r\n", "samplequery":"mlcp.bat copy -mode local -input_host localhost -input_port 8012 -input_username admin -input_password admin -output_host localhost -output_port 8014 -output_username mlcp-user -output_password password\t\r\n", "sampledata":"See attached Twitter.zip and Intense_Debate.zip.", "version":"7.0-nightly", "tofixin":"7.0-ea2", "fixedin":"7.0-ea2", "platform":"windows(64-bit)", "memory":"4 GB", "processors":"", "note":"", "subscribers":[{"username":"pcaine", "name":"Penny Caine", "email":"Penny.Caine@marklogic.com"}, {"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, {"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}], "attachments":[{"name":"social media source data", "uri":"root/support/bugtracking/attachments/20059/Social_Media.zip"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20059, "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["mlcp", "pcaine"], "changeHistory":[{"time":"2012-11-12T09:25:30.90307-08:00", "updatedBy":{"username":"pcaine", "name":"Penny Caine", "email":"Penny.Caine@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Social_Media.zip contain Twitter.zip and Intense_Debate.zip."}, {"time":"2012-11-12T15:59:16.21075-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}}}, "files":[], "show":true, "comment":"Jane, does this look like something that might already be fixed?"}, {"time":"2012-11-12T15:59:16.21075-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-12T15:59:16.21075-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2012-11-12T18:13:00.961877-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Penny, how is the data loaded into the source database?"}, {"time":"2012-11-12T18:13:00.961877-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"assignTo":{"from":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-12T22:19:50.563826-08:00", "updatedBy":{"username":"pcaine", "name":"Penny Caine", "email":"Penny.Caine@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi Jane, data is loaded by using the mlcp.bat import command; for eaxmple:\r\nmlcp.bat import -host localhost -port 8012 -username admin -password admin -input_file_path C:\\Social_Media\\Twitter -mode local\r\nmlcp.bat import -host localhost -port 8012 -username admin -password admin -input_file_path C:\\Social_Media\\Intense_Debate.zip -mode local"}, {"time":"2012-11-13T12:23:47.084514-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"[ali@ali Twitter]$ grep -R -i xqsync *\r\nTwitter/twitter_1332448843475.xml.metadata:<com.marklogic.ps.xqsync.XQSyncDocumentMetadata>\r\nTwitter/twitter_1332448843475.xml.metadata:</com.marklogic.ps.xqsync.XQSyncDocumentMetadata>\r\n\r\nThere is a file named twitter_1332448843475.xml.metadata in twitter directory. I guess this twitter zip file was generated from XQSync.\r\n\r\nIn socialmedia database, there is \r\ntwitter_1332448843475.xml\r\ntwitter_1332448843475.xml.metadata\r\n\r\nThey confuses mlcp when doing copy, because mlcp is going to generate XXX.metadata for uri XXX. The existing twitter_1332448843475.xml.metadata is considered as the metadata generated by mlcp but it is not! \r\n\r\ndelete twitter_1332448843475.xml.metadata in the source directory then import,  or delete it in the source database can fix the problem."}, {"time":"2012-11-13T12:24:58.212665-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"It is also worth fixing it in mlcp, by changing the internal naming for metadata."}, {"time":"2012-11-13T12:24:58.212665-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-13T14:14:46.48236-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"As COPY and EXPORT use the same DatabaseContentReader, changing the internal naming for metadata will cause the compatibility problem - archives generated by mlcp 6.0-1 can't be imported by mlcp 6.0-1. \r\n\r\nWe need to think about how to fix it.\r\n"}, {"time":"2012-11-13T14:14:46.48236-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-13T15:38:58.379595-08:00", "updatedBy":{"username":"pcaine", "name":"Penny Caine", "email":"Penny.Caine@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Verified: Thank you Aries. You are right, in deleting twitter_1332448843475.xml.metadata it fixed the problem. I am able to copy with no error."}, {"time":"2013-01-23T10:34:44.991018-08:00", "updatedBy":{"username":"jmakeig", "name":"Justin Makeig", "email":"jmakeig@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Help me understand: This is a file naming incompatibility with XQSync? Is the work-around to delete the *.metadata in the source database? (The fact that they were there was probably a mistake, no?)"}, {"time":"2013-01-23T10:48:35.862959-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"mlcp and XQSync use the same suffix \".metadata\" for document's metadata. This XQSync metadata file is imported by mlcp, but mlcp is confused by the XQSync metadata file while doing copy. \r\n\r\nYes, the work around is to delete *.metadata in the source database.\r\nI guess having the .metadata file in the database was not intentional, however, I think mlcp should have a better way to differentiate its own metadata from other documents with suffix \".metadata\"."}, {"time":"2013-01-28T11:27:55.374532-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Aries plans to fix it in 6.0-3."}, {"time":"2013-01-28T11:27:55.374532-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-11T11:12:12.96192-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea2"}}, "files":[], "show":true}, {"time":"2013-02-26T17:15:32.916487-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"133766", "paths":["xcc/trunk/mlcp/src/test/java/com/marklogic/contentpump/TestCopy.java", "xcc/trunk/mlcp/src/test/resources/20059", "xcc/trunk/mlcp/src/main/java/com/marklogic/contentpump/DatabaseContentWriter.java", "xcc/trunk/mlcp/src/test/resources/20059/twitter_1332448843475.xml.metadata", "xcc/trunk/mlcp/src/main/java/com/marklogic/contentpump/ArchiveWriter.java", "xcc/trunk/mlcp/src/test/resources/20059/twitter_1332448843475.xml", "xcc/trunk/mlcp/src/main/java/com/marklogic/contentpump/DatabaseContentReader.java"], "affectedBugs":["20948"]}, "comment":"bug:20948 bug:20741\n1.DatabaseContentReader always get value as MarkLogicDocumentWithMeta\n2.refactor DatabaseContentWriter\n3.test cases"}, {"time":"2013-02-26T18:15:30.303809-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true, "comment":"The attachment is a good data set to test.\r\nAnd please keep an eye on regression."}, {"time":"2013-02-26T18:15:30.303809-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-10T15:17:23.328936-07:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on build 7.0-20130410"}], "updatedAt":"2013-04-10T15:17:23.328936-07:00", "fixedAt":"2013-02-26T18:15:30.303809-08:00", "fixedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "shippedAt":"2013-04-10T15:17:23.328936-07:00", "shippedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "renderDescriptionAs":"normal", "renderSampleQueryAs":"normal", "renderSampleDataAs":"normal"}