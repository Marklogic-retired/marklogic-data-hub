{"id":20692, "kind":"RFE", "createdAt":"2011-06-30T13:02:31.011598-07:00", "status":"Closed", "title":"Replace MD5 for security-relevant purposes", "category":"xdmp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"jhoy", "name":"Joe Hoy", "email":"Joe.Hoy@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"The MD5 hashing algorithm is well beyond End of Life. We should migrate to properly salted SHA2 for <sec:password> and <sec:digest-password>. We can do this in a backward-compatible fashion using the method of Unix password fields, encoding the hash type (e.g. $6$ prefix for SHA-2). At upgrade time, old passwords could be put through a second stage of hashing with SHA2. Proper salting requires a random nonce, as the current approach is vulnerable to construction of a rainbow table for hash values beginning with \"admin:public:...\", after which security of individual user passwords would be moot.\r\n\r\nSee http://cwe.mitre.org/top25/#CWE-327 for general guidance away from MD5. Specifically, MD5 hash security will be completely broken when a general attack is found for its preimage resistance (given a hashed value, efficiently find an encodable input that produces that value). Preimage attacks have emerged only since 2009 and are still at the theoretical level (http://en.wikipedia.org/wiki/MD5#cite_note-31). But this represents the last straw in the progressive breakdown since 1996 of MD5 as a cryptographic hash algorithm. We should be ahead of this before it becomes an emergency requirement for a security fix and potentially publicized as a CVE vulnerability.", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-1", "fixedin":"7.0-1", "platform":"all", "memory":"", "processors":"", "note":"Pushed from RFE #2124 in RFETrack by jhoy on Mon Feb 04 2013, 10:29AM.", "subscribers":[{"username":"jhoy", "name":"Joe Hoy", "email":"Joe.Hoy@marklogic.com"}, {"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, {"username":"sanand", "name":"Sumit Anand", "email":"Sumit.Anand@marklogic.com"}, {"username":"sbuxton", "name":"Stephen Buxton", "email":"stephen.buxton@marklogic.com"}, {"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, {"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, {"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}], "attachments":[], "includeInTaskList":false, "proceduralTasks":{"Requirements Task":[], "Functional Specification Task":[], "Test Specification Task":[], "Test Automation Task":[], "Documentation Task":[]}, "subTasks":[], "tags":["xdmp", "jhoy"], "changeHistory":[{"time":"2012-06-06T12:41:08.145675-07:00", "updatedBy":{"username":"cbiow", "name":"Christopher Biow", "email":"chris.biow@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Not properly salting passwords has been highlighted as a security failure at LinkedIn, in wake of the compromise of their user DB. http://www.informationweek.com/news/security/attacks/240001623\r\n\r\nWe are using a fixed salt, as opposed to none at all at LinkedIn, which is still deficient if we ever have our user docs exposed. "}, {"time":"2012-06-07T10:32:31.026461-07:00", "updatedBy":{"username":"cbiow", "name":"Christopher Biow", "email":"chris.biow@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Preimage attacks have now been demonstrated, as early as 2008 in principle (http://www.win.tue.nl/hashclash/rogue-ca/) and 2012 in operation as part of the Flame malware (http://nakedsecurity.sophos.com/2012/06/07/microsoft-speaks-out-on-flame-malware-certificate-forgery/)."}, {"time":"2013-01-30T02:48:19.837202-08:00", "updatedBy":{"username":"afowler", "name":"Adam Fowler", "email":"afowler@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"+1 This will be a problem in the UK Public Sector space. I have already had a security consultant question me at length on this. I doubt he will be convinced by MD5+fixed salt. This could put this $281K deal at risk, plus all future UK Public Sector deals, unless a workaround is found or fix created."}, {"time":"2013-01-31T07:44:49.094476-08:00", "updatedBy":{"username":"afowler", "name":"Adam Fowler", "email":"afowler@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Why not turn late adoption in to early adoption? Move straight to SHA-3: http://www.nist.gov/itl/csd/sha-100212.cfm"}, {"time":"2013-01-31T16:28:41.860697-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Looking around on the internet today, I don't see a solid RFC for more secure HTTP digest authentication hashes. I did find something proposed by some people at Avaya dated July 2012, but it didn't have an RFC number on it. \n\nIf we have passwords encrypted internally with something other than MD5, it's not clear to me that we can do MD5 digest authentication with clients anymore. We'll need to think this through."}, {"time":"2013-02-06T09:53:11.03267-08:00", "updatedBy":{"username":"sbuxton", "name":"Stephen Buxton", "email":"stephen.buxton@marklogic.com"}, "change":{"assignTo":{"from":{"username":"sbuxton", "name":"Stephen Buxton", "email":"stephen.buxton@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-06T13:24:55.712516-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"Presumably digest-password would remain the same since we don't control how it works.\r\nWe would change password and use basic authentication over https."}, {"time":"2013-02-06T20:05:17.133747-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-1"}}, "files":[], "show":true}, {"time":"2013-02-15T13:21:18.351288-08:00", "updatedBy":{"username":"dgorbet", "name":"David Gorbet", "email":"David.Gorbet@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dgorbet", "name":"David Gorbet", "email":"David.Gorbet@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true, "comment":"Changing to verify."}, {"time":"2013-03-01T13:47:36.178143-08:00", "updatedBy":{"username":"dgorbet", "name":"David Gorbet", "email":"David.Gorbet@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Need to code prior to 7.0-1, and may need to backport to 6.0. Steve Guttman working on timing requirements. If we need to do this in 6.0, will need a 6.0 clone. If we can get it done by ea2, then it should be easy enough to get it into 6.0-4 as well."}, {"time":"2013-03-01T13:47:36.178143-08:00", "updatedBy":{"username":"dgorbet", "name":"David Gorbet", "email":"David.Gorbet@marklogic.com"}, "change":{"tofixin":{"from":"7.0-1", "to":"7.0-ea2"}}, "files":[], "show":true}, {"time":"2013-03-11T15:06:26.323096-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-18T11:49:17.217739-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137111", "paths":["xdmp/trunk/src/Makefile.macosx", "xdmp/trunk/src/Makefile.winnt", "xdmp/trunk/src/Makefile.linux", "xdmp/trunk/src/Makefile.solaris", "xdmp/trunk/src/Crypt.cpp"], "affectedBugs":[]}, "comment":"Part of fix for bug:20692. Added new builtin xdmp_crypt2 that uses sha256 algorithm and a random salt.\n"}, {"time":"2013-03-18T21:06:39.474616-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137139", "paths":["xdmp/trunk/src/ODBCServer.cpp", "xdmp/trunk/src/Modules/MarkLogic/security.xqy", "xdmp/trunk/src/Crypt.h", "xdmp/trunk/src/HTTPServer.cpp", "xdmp/trunk/src/Crypt.cpp"], "affectedBugs":[]}, "comment":"Second batch for bug:20692.\n"}, {"time":"2013-03-19T08:10:13.751519-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137159", "paths":["xdmp/trunk/src/ODBCServer.cpp", "xdmp/trunk/src/Crypt.h", "xdmp/trunk/src/HTTPServer.cpp", "xdmp/trunk/src/Crypt.cpp"], "affectedBugs":[]}, "comment":"Code clean-up bug:20692.\n"}, {"time":"2013-03-19T08:45:55.020378-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137163", "paths":["xdmp/trunk/src/ODBCServer.cpp", "xdmp/trunk/src/Crypt.h", "xdmp/trunk/src/HTTPServer.cpp", "xdmp/trunk/src/Crypt.cpp"], "affectedBugs":[]}, "comment":"More optimization bug:20692.\n"}, {"time":"2013-03-19T11:22:45.495373-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Suggested Test Plan for QA:\r\n\r\n1. We need to test all kinds of app-servers: HTTP, XDBC, WebDav, and ODBC.\r\n\r\n2. On 7.0 Database just create a new user and make sure that the user can log-in to the server.\r\n\r\n3. Try running some queries for that user.\r\n\r\nUpgrade Tests:\r\n---------------------\r\n5. On 6.0 Server, create a user and perform various operations using all the four types of app-servers.\r\n\r\n6. Upgrade to 7.0 and create another user.\r\n\r\n7. Both the user from 6.0 db and the new 7.0 user should be able to perform the same set of operations as tested in (5) using all the four types of app-servers.\r\n\r\n8. QA can also look into the security database and check both the passwords. The 7.0 password will start with a magic string $2$ and it will have one more occurrence of this magic string. The 6.0 password will not have this magic string at all. Here is the query to look for the password given the user name.\r\n\r\ndeclare namespace sec= \"http://marklogic.com/xdmp/security\";\r\ndoc()//sec:user[sec:user-name=\"user-name\"]\r\n\r\n8. The new built-in xdmp:crypt2() be repeatedly run with the same user name and make sure that the passwords are different each time.\r\n\r\n9. You can also try multiple xdmp:crypt2() calls in a single transaction. Even then all the passwords must be distinct."}, {"time":"2013-03-19T11:24:35.856162-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"We also need to check that both basic and digest authentication work on all the server types.\r\n"}, {"time":"2013-03-19T11:31:54.055602-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Since MD5 is mandated for digest authentication, all the above tests should work only with basic authorization on the app-server.\r\n\r\nFor app-servers with digest authorization, the new encryption algorithm (sha256) will not kick-in. Hence the encrypted password should be the same as a 6.0 encrypted password."}, {"time":"2013-03-19T11:32:48.630629-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Gajanan, a couple more things to consider.\r\n\r\n1. We might want to just put the crypt algorithm on the beginning of the string \"$SHA256$\" instead of \"$2$\" so that we have an easy way to choose different algorithms going forward.\r\n\r\n2. We should have some API in security.xqy so that users can determine which users have weak old MD5 hashes vs. strong new SHA256 hashes so they can manage those sets of users. This is important for users who are upgrading and want to be sure their users have transitioned to the strong new hashes.\r\n"}, {"time":"2013-03-19T11:33:18.514906-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Another QA point is that we should test changing of passwords on an upgrade system, and verify that the new password uses the new hash."}, {"time":"2013-03-19T11:35:57.807978-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Re: Gajanan's point about MD5, agreed, the point I was making was that we need to verify that normal digest authentication continues to work with this change since many users require that."}, {"time":"2013-03-19T15:30:54.444292-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"About point (1) above, the longer the string the slower will be the comparison. Initially I thought of $256$ but then decided to make it $2$. These string comparisons are going to happen on each http call.\r\n\r\n(2) Good idea. I will think and do it asap.\r\n"}, {"time":"2013-03-19T15:31:35.083719-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137202", "paths":["xdmp/trunk/src/AppServerBuiltins.cpp"], "affectedBugs":[]}, "comment":"One more piece for bug:20692.\n"}, {"time":"2013-03-19T16:31:03.23745-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"A character comparison of 6 characters instead of 1 (or is it 8 instead of 3?)  in C++ isn't going to make any difference in the performance of an HTTP call."}, {"time":"2013-03-22T13:23:30.35157-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137494", "paths":["xdmp/trunk/src/Crypt.cpp"], "affectedBugs":[]}, "comment":"Performance improvements bug:20692.\n"}, {"time":"2013-03-22T13:55:04.125533-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137499", "paths":["xdmp/trunk/src/Crypt.cpp"], "affectedBugs":[]}, "comment":"Copy strings before releasing the mutex bug:20692.\n"}, {"time":"2013-03-22T15:18:17.219047-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"137516", "paths":["xdmp/trunk/src/Crypt.cpp"], "affectedBugs":[]}, "comment":"Fixing documentation for xdmp:crypt2 bug:20692.\n"}, {"time":"2013-03-23T21:49:53.166547-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Tested http, xdbc and webdav serevrs with basic authentication."}, {"time":"2013-03-23T21:49:53.166547-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-23T21:49:53.166547-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-07-13T11:47:07.555557-07:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-08-13T14:31:44.474325-07:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-09-19T19:02:31.198482-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Verified on build: MarkLogic-7.0-20130919\r\n\r\nTest in regression: bug20692.xml\r\ntestsuite: bugs70\r\n\r\nUpgrade scenario will be covered by Shiva / Sumit\r\n\r\n\r\n"}, {"time":"2013-09-19T19:04:21.274503-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Shiva / Sumit,\r\n\r\nPlease use steps from bug22156 for upgrade testing. Once done, please move this bug to 'ship'.\r\n\r\n"}, {"time":"2013-09-19T19:04:21.274503-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-09-26T09:56:36.390971-07:00", "updatedBy":{"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified and already a part of upgrade plan"}, {"time":"2013-09-26T09:56:36.390971-07:00", "updatedBy":{"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}, "change":{"assignTo":{"from":{"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-09-30T00:42:03.701066-07:00", "updatedBy":{"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}, "change":{"status":{"from":null, "to":"Ship"}, "assignTo":{"from":{"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Mistakenly moved the bug to verify. \r\n\r\nAlready verified and added to plan. moving to ship"}, {"time":"2013-09-30T00:42:03.701066-07:00", "updatedBy":{"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea2", "to":"7.0-1"}}, "files":[], "show":true}], "updatedAt":"2013-09-30T00:42:03.701066-07:00", "fixedAt":"2013-03-23T21:49:53.166547-07:00", "fixedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "shippedAt":"2013-09-30T00:42:03.701066-07:00", "shippedBy":{"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}}