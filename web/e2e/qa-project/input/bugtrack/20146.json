{"id":20146, "kind":"Bug", "createdAt":"2012-11-26T18:20:45.507009-08:00", "status":"Closed", "title":"large binary files may get lost on a replica cluster when switching from flexrep to db rep between two clusters  and under heavy IO", "category":"", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"I noted a harmful time window in the code:  in BinaryManager when the ref count to a large binary is reduced to 0,  the code enqueues a file deletion but quits the critical section without waiting for the file to be actually deleted. But Forest::replicateFragment replies  on the existence of the file to decide whether to throw a retry (see Bug 19914).  In one stress test when IO is very slow due to heavy load,  I noted it can take minutes before a file is actually deleted after en-queueing the deletion request. That means while the retry process does re-replicate the binary file, the deletion request enqueued earlier (before the retry is thrown) can cause the file to get deleted again.   After I move the real deletion into the critical section (which is an experiment, not a desirable fix), the issue no longer happens.  So this timing window must be closed.", "samplequery":"", "sampledata":"", "version":"5.0-nightly", "tofixin":"5.0-5", "fixedin":"5.0-5", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[20254, 20477], "cloneOf":"", "support":{"headline":" large binary files may get lost on a replica cluster when switching from flexrep to db rep between two clusters", "supportDescription":"This is only observed in stress tests under very heavy IO.  Given that the symptom is very similar to Bug 19913 (which will be published) and it is only found during an internal stress test,  I set this to \"never publish\".", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":"Remove the large binary fragment on the replicate cluster so the large binary file will get re-replicated."}, "tags":["", "hwu"], "changeHistory":[{"time":"2012-11-26T18:20:45.507009-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-25T22:46:05.343129-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Note: the test case I used to reproduce the issue:\r\n\r\n1) set up two clusters, each with 3 nodes (1E2D).  I used three boxes (hwu, hwu2, hwu3) to run 6 servers, which implies very heavy IO on these boxes. With more hardware and faster IO,  the issue may be less likely to get reproduced.\r\n\r\n2) Create a database with failover on both clusters.  The forests of the two databases should have the same names. Then setup flexrep between the two databases.\r\n\r\n3) Load many large binaries into the flexrep master database and let the replication finish.\r\n\r\n4) Remove the flexrep configuration and setup db replication between the two databases (the database that was used as the flexrep master should also be the master in the db rep setup). \r\n\r\nAll existing large binaries on the replica side are now marked as deleted and all existing large binaries on the master side will get replicated again (but now through db rep instead of flexrep).\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n3) "}, {"time":"2013-01-15T17:48:40.022492-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"127902", "paths":["xdmp/branches/b5_0/src/Forest.cpp", "xdmp/branches/b5_0/src/services/File.cpp", "xdmp/branches/b5_0/src/BinaryManager.cpp", "xdmp/branches/b5_0/src/services/File.h"], "affectedBugs":[]}, "comment":"bug:20146 large binary files may get lost on a replica cluster when switching from flexrep to db rep between two clusters and under heavy IO"}, {"time":"2013-01-15T17:50:16.841387-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-15T17:50:16.841387-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-23T16:11:58.259853-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Will be verifying this bug once the current run of flexrep stress tests are done, so that the setup could be used as-is for this bug."}, {"time":"2013-01-25T15:25:29.738379-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified manually on the flexrep stress test setup with a single-node (as a cluster) on both master and replica sides.  Inserted about 24 binaries... with this code:\r\n\r\nxquery version \"1.0-ml\";\r\n  xdmp:log(\"LOADING Lady.mpeg\");\r\n        declare function local:load($file as xs:string)\r\n        {\r\n          let $prefix := if (xdmp:platform()=\"winnt\")\r\n                         then \"C:\\tmp\\binary-support\\\"\r\n                         else \"/project/engineering/qa/data/binary-support/\"\r\n          let $path := fn:concat($prefix, $file)\r\n          return \r\n            xdmp:document-load($path,\r\n                               <options xmlns=\"xdmp:document-load\">\r\n                                 <uri>{fn:concat(\"/binary-support/\",$file,\"3\")}</uri>\r\n                               </options>) \r\n        };\r\n\r\n        (: reading from /project/engineering can be slow :)\r\n        xdmp:set-request-time-limit(1800),\r\n       \r\n  \r\n        local:load(\"AlbertFarrington-ItsALongWayToTipperary1915.mp3\"),\r\n local:load(\"BlindBlake-EarlyMorningBlues.mp3\"),\r\n  local:load(\"Charleston7-Toodles.mp3\"),\r\n   local:load(\"lemon.gif\"),\r\n        local:load(\"logo.gif\"),\r\n        local:load(\"Bon-Jovi.jpeg\"),\r\n  local:load(\"suddenly.mpeg\"),\r\n  local:load(\"showdown.mpeg\")\r\n\r\nAfter that changed flexrep to DBREP and then after all the replication was done, verified that all the 24 binaries were present both on Master and Replica."}, {"time":"2013-02-25T16:59:28.630611-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-02-25T16:59:28.630611-08:00", "fixedAt":"2013-01-15T17:50:16.841387-08:00", "fixedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "shippedAt":"2013-01-25T15:25:29.738379-08:00", "shippedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "closedAt":"2013-02-25T16:59:28.630611-08:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}