{"id":20881, "kind":"Bug", "createdAt":"2013-02-21T14:13:34.029114-08:00", "status":"Closed", "title":"preallocated journals don't work well with local-disk failover", "category":"xdmp", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Denis ran into this with his performance work. The default setting for preallocation of journals is false, but he's setting it to true for his database.\r\n\r\n1. Create a database with preallocate journals set to true.\r\n2. Create a master/replica forest pair.\r\n3. Attach the master forest to the database.\r\n\r\nSometimes the replica will sync, but sometimes it will fail complaining that the replayed FSN is unexpected.\r\n\r\nIf it does sync, killing and then restarting the servers a few times results in an XDMP-DFBUFREAD complaining about a bad checksum.\r\n\r\nThere may also be issues with killing the server while it's doing the initial preallocation (it takes quite a while for a big journal) and restarting it.\r\n\r\nMy suspicion is that this has something to do with the headerless journal work.", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea1", "fixedin":"7.0-ea1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"dsheahan", "name":"Denis Sheahan", "email":"Denis.Sheahan@marklogic.com"}, {"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[20882], "cloneOf":"", "support":{"headline":"Forest in error state due to XDMP-DFBUFREAD when using local-disk failover and journal preallocation", "supportDescription":"When the journal preallocate is set to true for a database and local-disk failover is being used, Forests may enter the error state due to an XDMP-DFBUFREAD.", "publishStatus":"Prepare", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":"Disable journal preallocation for the database and remove the journal files."}, "tags":["xdmp", "wfeick"], "changeHistory":[{"time":"2013-02-21T14:13:34.029114-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-21T19:42:35.664112-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Without preallocation, once things come up I see the following.\r\n\r\n-rw-rw-r-- 1 wfeick wfeick  0 Feb 21 13:52 /net/wfeick2/space/wfeick/Data-denis/Forests/F1AM/Journals/Journal1-19700101160000-0-18446744073709551615-0\r\n-rw-rw-r-- 1 wfeick wfeick  0 Feb 21 13:52 /net/wfeick2/space/wfeick/Data-denis/Forests/F1BM/Journals/Journal1-19700101160000-0-18446744073709551615-0\r\n-rw-rw-r-- 1 wfeick wfeick 84 Feb 21 13:53 /net/wfeick2/space/wfeick/Data-denis/Forests/F2AR/Journals/Journal1-19700101160000-0-18446744073709551615-0\r\n-rw-rw-r-- 1 wfeick wfeick 84 Feb 21 13:53 /net/wfeick2/space/wfeick/Data-denis/Forests/F2BR/Journals/Journal1-19700101160000-0-18446744073709551615-0\r\n-rw-rw-r-- 1 wfeick wfeick 84 Feb 21 13:53 /net/wfeick3/space/wfeick/Data-denis/Forests/F1AR/Journals/Journal1-19700101160000-0-18446744073709551615-0\r\n-rw-rw-r-- 1 wfeick wfeick 84 Feb 21 13:53 /net/wfeick3/space/wfeick/Data-denis/Forests/F1BR/Journals/Journal1-19700101160000-0-18446744073709551615-0\r\n-rw-rw-r-- 1 wfeick wfeick  0 Feb 21 13:52 /net/wfeick3/space/wfeick/Data-denis/Forests/F2AM/Journals/Journal1-19700101160000-0-18446744073709551615-0\r\n-rw-rw-r-- 1 wfeick wfeick  0 Feb 21 13:52 /net/wfeick3/space/wfeick/Data-denis/Forests/F2BM/Journals/Journal1-19700101160000-0-18446744073709551615-0\r\n\r\nWith preallocation, I see the following.\r\n\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:39 /net/wfeick2/space/wfeick/Data-denis/Forests/F1AM/Journals/Journal1-19700101000000-18446744073709551615-18446744073709551615-13615044960599150\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:41 /net/wfeick2/space/wfeick/Data-denis/Forests/F1AM/Journals/Journal2-19700101000000-18446744073709551615-0-0\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:39 /net/wfeick2/space/wfeick/Data-denis/Forests/F1BM/Journals/Journal1-19700101000000-18446744073709551615-18446744073709551615-13615045085221670\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:41 /net/wfeick2/space/wfeick/Data-denis/Forests/F1BM/Journals/Journal2-19700101000000-18446744073709551615-0-0\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:39 /net/wfeick2/space/wfeick/Data-denis/Forests/F2AR/Journals/Journal1-19700101000000-18446744073709551615-18446744073709551615-13615045073091280\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:41 /net/wfeick2/space/wfeick/Data-denis/Forests/F2AR/Journals/Journal2-19700101000000-18446744073709551615-0-0\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:39 /net/wfeick2/space/wfeick/Data-denis/Forests/F2BR/Journals/Journal1-19700101000000-18446744073709551615-18446744073709551615-13615044960599150\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:41 /net/wfeick2/space/wfeick/Data-denis/Forests/F2BR/Journals/Journal2-19700101000000-18446744073709551615-0-0\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:39 /net/wfeick3/space/wfeick/Data-denis/Forests/F1AR/Journals/Journal1-19700101000000-18446744073709551615-18446744073709551615-13615043998380400\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:41 /net/wfeick3/space/wfeick/Data-denis/Forests/F1AR/Journals/Journal2-19700101000000-18446744073709551615-0-0\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:39 /net/wfeick3/space/wfeick/Data-denis/Forests/F1BR/Journals/Journal1-19700101000000-18446744073709551615-18446744073709551615-13615044882361850\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:41 /net/wfeick3/space/wfeick/Data-denis/Forests/F1BR/Journals/Journal2-19700101000000-18446744073709551615-0-0\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:39 /net/wfeick3/space/wfeick/Data-denis/Forests/F2AM/Journals/Journal1-19700101000000-18446744073709551615-18446744073709551615-13615044882361850\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:41 /net/wfeick3/space/wfeick/Data-denis/Forests/F2AM/Journals/Journal2-19700101000000-18446744073709551615-0-0\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:39 /net/wfeick3/space/wfeick/Data-denis/Forests/F2BM/Journals/Journal1-19700101000000-18446744073709551615-18446744073709551615-13615044946877670\r\n-rw-rw-r-- 1 wfeick wfeick 1788870656 Feb 21 19:41 /net/wfeick3/space/wfeick/Data-denis/Forests/F2BM/Journals/Journal2-19700101000000-18446744073709551615-0-0\r\n"}, {"time":"2013-02-27T11:30:19.651557-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea1", "to":"7.0-ea2"}}, "files":[], "show":true}, {"time":"2013-02-27T11:31:01.763301-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I have a reviewed fix, just haven't had time to commit it yet."}, {"time":"2013-02-27T11:31:01.763301-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea2", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-02-27T12:41:28.152196-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea1", "to":"7.0-ea2"}}, "files":[], "show":true}, {"time":"2013-02-27T16:01:26.62304-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea2", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-02-27T21:17:07.316292-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"134029", "paths":["xdmp/trunk/src/Recovery.cpp"], "affectedBugs":[]}, "comment":"bug:20881 tweak to make headerless journals work with preallocated journals"}, {"time":"2013-02-27T21:37:14.845423-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"134030", "paths":["xdmp/branches/b7_0-ea1/src/Recovery.cpp"], "affectedBugs":[]}, "comment":"bug:20881 tweak to make headerless journals work with preallocated journals"}, {"time":"2013-02-27T21:39:31.36166-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"Configure local disk failover with preallocated journals. Don't put any documents into the forests. You end up with XDMP-DFBUFREAD errors while trying to synchronize the forests."}, {"time":"2013-02-27T21:39:31.36166-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-02T10:44:29.906767-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-09T02:15:06.127812-08:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Wayne,\r\n\r\nI ran Local Disk Failover + DB Replication stress test setting \"Preallocate Journal\" to true on MedlineDB on both Master and Replica databases. The test completed successfully.\r\n\r\nLet me know if you want me to verify something on the cluster. If this is fine, I can move this bug to \"ship\". Please let me know.\r\n\r\nThese are the machines if you want to take a look:\r\n\r\nMaster Cluster:\r\nrh5-amd64-failover-1 [E-Node]\r\nrh5-intel64-21 [D-Node]\r\nrh5-intel64-22 [D-Node]\r\n\r\nReplica Cluster:\r\nrh5-amd64-failover-2 [E-Node]\r\nrh5-intel64-23 [D-Node]\r\nrh5-intel64-24 [D-Node]\r\n\r\n"}, {"time":"2013-03-09T02:15:26.590751-08:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-18T09:51:31.61875-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-18T09:51:31.61875-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-03-18T09:51:31.61875-07:00", "fixedAt":"2013-02-27T21:39:31.36166-08:00", "fixedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "shippedAt":"2013-03-18T09:51:31.61875-07:00", "shippedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "renderDescriptionAs":"normal"}