{"id":20942, "kind":"Task", "createdAt":"2013-02-26T13:58:36.367139-08:00", "shippedAt":"2016-02-24T18:14:07.617Z", "fixedAt":"2015-12-22T00:01:40.478Z", "status":"Ship", "title":"mlcp should support Kerberos ticket authentication", "category":"mlcp", "severity":"Major", "priority":{"level":"2", "title":"Not required for product release"}, "days":null, "period":{"startDate":"", "endDate":""}, "submittedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "shippedBy":{"name":"Paul Low", "email":"paul.low@marklogic.com", "username":"plow"}, "fixedBy":{"name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com", "username":"atsoi"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"add kerberos support  in mlcp local mode", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"8.0-5", "fixedin":"8.0-5", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, {"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, {"username":"jsun", "name":"Junfeng Sun", "email":"junfeng.sun@marklogic.com"}, {"username":"skottam", "email":"sravan.kottam@marklogic.com", "name":"Sravan Kottam"}, {"username":"plow", "email":"paul.low@marklogic.com", "name":"Paul Low"}, {"name":"Larry Ratcliff", "email":"lratcliff@marklogic.com", "username":"lratcliff"}], "attachments":[], "includeInTaskList":false, "proceduralTasks":{"Requirements Task":[], "Functional Specification Task":[], "Test Specification Task":[], "Test Automation Task":[], "Documentation Task":[]}, "subTasks":[], "tags":["mlcp", "wfeick"], "changeHistory":[{"time":"2013-02-26T13:58:36.367139-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-05-16T11:00:49.552665-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"7.0-1", "to":"7.0-ea3"}}, "files":[], "show":true}, {"time":"2013-06-21T14:48:02.78405-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea3", "to":"8.0-1"}}, "files":[], "show":true}, {"time":"2014-10-31T22:50:21.105936-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"tofixin":{"from":"8.0-1", "to":"N/A"}}, "files":[], "show":true}, {"time":"2015-09-22T15:00:22.593297-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"assignTo":{"from":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "to":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}}}, "files":[], "show":true}, {"time":"2015-09-22T15:00:22.593297-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"tofixin":{"from":"N/A", "to":"8.0-5"}}, "files":[], "show":true}, {"time":"2015-11-10T12:57:23.433031-08:00", "updatedBy":{"username":"jsun", "name":"Junfeng Sun", "email":"junfeng.sun@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Tried MLCP with kerberos authentication in local mode. With the user authenticated, mlcp can run without providing password.\r\n----------------------------------------------------------------------------------------------------------------------\r\n[jsun@msun-z620 mlcp-9.0]$  bin/mlcp.sh import -username jsun -password helloworld -port 8275 -host msun-z620.marklogic.com -input_file_path file:/space/tmp/data.xml -mode local                      15/11/10 12:52:29 INFO contentpump.LocalJobRunner: Content type is set to MIXED.  The format of the  inserted documents will be determined by the MIME  type specification configured on MarkLogic Server.\r\n15/11/10 12:52:29 INFO input.FileInputFormat: Total input paths to process : 1\r\n15/11/10 12:52:30 INFO contentpump.LocalJobRunner:  completed 100%\r\n15/11/10 12:52:30 INFO contentpump.LocalJobRunner: com.marklogic.mapreduce.ContentPumpStats:\r\n15/11/10 12:52:30 INFO contentpump.LocalJobRunner: INPUT_RECORDS: 1\r\n15/11/10 12:52:30 INFO contentpump.LocalJobRunner: OUTPUT_RECORDS: 1\r\n15/11/10 12:52:30 INFO contentpump.LocalJobRunner: OUTPUT_RECORDS_COMMITTED: 1\r\n15/11/10 12:52:30 INFO contentpump.LocalJobRunner: OUTPUT_RECORDS_FAILED: 0\r\n15/11/10 12:52:30 INFO contentpump.LocalJobRunner: Total execution time: 0 sec\r\n\r\nRun the same command with distributed mode, I see these output\r\n----------------------------------------------------------------------------------------------------------------------\r\n[jsun@msun-z620 mlcp-9.0]$  bin/mlcp.sh import -username jsun -password helloworld -port 8275 -host msun-z620.marklogic.com -input_file_path file:/space/tmp/data.xml -mode distributed\r\n15/11/10 12:52:38 INFO contentpump.LocalJobRunner: Content type is set to MIXED.  The format of the  inserted documents will be determined by the MIME  type specification configured on MarkLogic Server.\r\n15/11/10 12:52:39 INFO client.RMProxy: Connecting to ResourceManager at master/172.18.130.0:8032\r\n15/11/10 12:52:40 INFO hdfs.DFSClient: Created HDFS_DELEGATION_TOKEN token 6 for jsun on 172.18.130.0:9000\r\n15/11/10 12:52:40 INFO security.TokenCache: Got dt for hdfs://master:9000; Kind: HDFS_DELEGATION_TOKEN, Service: 172.18.130.0:9000, Ident: (HDFS_DELEGATION_TOKEN token 6 for jsun)\r\n15/11/10 12:52:44 INFO input.FileInputFormat: Total input paths to process : 1\r\n15/11/10 12:52:44 INFO mapreduce.JobSubmitter: number of splits:1\r\n15/11/10 12:52:45 INFO mapreduce.JobSubmitter: Submitting tokens for job: job_1444673903016_0006\r\n15/11/10 12:52:45 INFO mapreduce.JobSubmitter: Kind: HDFS_DELEGATION_TOKEN, Service: 172.18.130.0:9000, Ident: (HDFS_DELEGATION_TOKEN token 6 for jsun)\r\n15/11/10 12:52:46 INFO impl.YarnClientImpl: Submitted application application_1444673903016_0006\r\n15/11/10 12:52:46 INFO mapreduce.Job: The url to track the job: http://master:8088/proxy/application_1444673903016_0006/\r\n15/11/10 12:52:46 INFO mapreduce.Job: Running job: job_1444673903016_0006\r\n15/11/10 12:52:51 WARN ipc.Client: Exception encountered while connecting to the server : org.apache.hadoop.security.AccessControlException: Client cannot authenticate via:[TOKEN, KERBEROS]\r\n15/11/10 12:52:51 WARN ipc.Client: Exception encountered while connecting to the server : org.apache.hadoop.security.AccessControlException: Client cannot authenticate via:[TOKEN, KERBEROS]\r\n15/11/10 12:52:51 WARN ipc.Client: Exception encountered while connecting to the server : org.apache.hadoop.security.AccessControlException: Client cannot authenticate via:[TOKEN, KERBEROS]\r\n15/11/10 12:52:51 WARN ipc.Client: Exception encountered while connecting to the server : org.apache.hadoop.security.AccessControlException: Client cannot authenticate via:[TOKEN, KERBEROS]\r\n15/11/10 12:52:51 WARN ipc.Client: Exception encountered while connecting to the server : org.apache.hadoop.security.AccessControlException: Client cannot authenticate via:[TOKEN, KERBEROS]\r\n15/11/10 12:52:51 WARN ipc.Client: Exception encountered while connecting to the server : org.apache.hadoop.security.AccessControlException: Client cannot authenticate via:[TOKEN, KERBEROS]\r\n15/11/10 12:52:51 WARN ipc.Client: Exception encountered while connecting to the server : org.apache.hadoop.security.AccessControlException: Client cannot authenticate via:[TOKEN, KERBEROS]\r\n15/11/10 12:52:51 WARN ipc.Client: Exception encountered while connecting to the server : org.apache.hadoop.security.AccessControlException: Client cannot authenticate via:[TOKEN, KERBEROS]\r\n15/11/10 12:52:52 WARN ipc.Client: Exception encountered while connecting to the server : org.apache.hadoop.security.AccessControlException: Client cannot authenticate via:[TOKEN, KERBEROS]\r\n15/11/10 12:52:52 WARN ipc.Client: Exception encountered while connecting to the server : org.apache.hadoop.security.AccessControlException: Client cannot authenticate via:[TOKEN, KERBEROS]\r\n15/11/10 12:52:52 WARN ipc.Client: Exception encountered while connecting to the server : org.apache.hadoop.security.AccessControlException: Client cannot authenticate via:[TOKEN, KERBEROS]\r\n15/11/10 12:52:52 WARN ipc.Client: Exception encountered while connecting to the server : org.apache.hadoop.security.AccessControlException: Client cannot authenticate via:[TOKEN, KERBEROS]\r\n\r\nIt's keeping printing out this message so I killed the process.\r\n"}, {"time":"2015-11-10T13:08:49.412966-08:00", "updatedBy":{"username":"jsun", "name":"Junfeng Sun", "email":"junfeng.sun@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Another observation. You need to specify the right kerberos user name when you use MLCP. For example, if you want to use jsun as MLCP user (meaning you put \"-username jsun\" in mlcp command), you need to have jsun authenticated in the system. If you kinit yourself as \"test1\", then you will see:\r\n[jsun@msun-z620 mlcp-9.0]$ kinit test1\r\nPassword for test1@MLTEST1.LOCAL:\r\n[jsun@msun-z620 mlcp-9.0]$ klist\r\nTicket cache: FILE:/tmp/krb5cc_3325\r\nDefault principal: test1@MLTEST1.LOCAL\r\n\r\nValid starting       Expires              Service principal\r\n11/10/2015 13:01:17  11/10/2015 23:01:17  krbtgt/MLTEST1.LOCAL@MLTEST1.LOCAL\r\n        renew until 11/17/2015 13:01:12\r\n[jsun@msun-z620 mlcp-9.0]$  bin/mlcp.sh import -username jsun -password helloworld -port 8275 -host msun-z620.marklogic.com -input_file_path file:/space/tmp/data.xml -mode local\r\n15/11/10 13:01:55 INFO contentpump.LocalJobRunner: Content type is set to MIXED.  The format of the  inserted documents will be determined by the MIME  type specification configured on MarkLogic Server.\r\n15/11/10 13:01:55 INFO input.FileInputFormat: Total input paths to process : 1\r\n15/11/10 13:01:56 ERROR contentpump.LocalJobRunner: Error checking output specification:\r\n15/11/10 13:01:56 ERROR contentpump.LocalJobRunner: java.lang.RuntimeException: GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)\r\n"}, {"time":"2015-11-10T15:34:44.617632-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Matt,\r\n\r\nIn Active Directory, can you set the delegation for the users that map to hadoop machines to the followings:\r\n\r\n\"Trust this user for delegation to any service (Kerberos only)\"\r\n\r\nAfter that, can you try running with distributed mode again?\r\n\r\nThanks,\r\nArthur"}, {"time":"2015-11-10T16:45:17.602431-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Matt,\r\n\r\nI just looked at Arthur's change for 20941 and I found it to be self-explanatory.  I'd suggest that you do so too.  It's more efficient than making assumptions and observations through experiments.\r\n\r\nJane"}, {"time":"2015-11-12T13:21:09.898836-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I used mlcp with distributed mode on the kerberos hadoop cluster. I got the same result as Matt.\r\nI looked at the log. The user ticket is not forwarded when connecting to MarkLogic.\r\n\r\nhttp://172.18.130.0:19888/jobhistory/attempts/job_1444673903016_0012/m/FAILED\r\n\r\nError: java.lang.RuntimeException: GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt) at com.marklogic.xcc.impl.ContentSourceImpl$Credentials.toHttpNegotiateAuth(ContentSourceImpl.java:484) at com.marklogic.xcc.impl.ContentSourceImpl.getAuthString(ContentSourceImpl.java:211) at com.marklogic.xcc.impl.handlers.AbstractRequestController.addCommonHeaders(AbstractRequestController.java:233) at com.marklogic.xcc.impl.handlers.ContentInsertController.resetHttpChannel(ContentInsertController.java:221) at com.marklogic.xcc.impl.handlers.ContentInsertController.serverDialog(ContentInsertController.java:126) at com.marklogic.xcc.impl.handlers.AbstractRequestController.runRequest(AbstractRequestController.java:87) at com.marklogic.xcc.impl.SessionImpl.insertContent(SessionImpl.java:314) at com.marklogic.xcc.impl.SessionImpl.insertContentCollectErrors(SessionImpl.java:286) at com.marklogic.mapreduce.ContentWriter.insertBatch(ContentWriter.java:420) at com.marklogic.mapreduce.ContentWriter.close(ContentWriter.java:657) at org.apache.hadoop.mapred.MapTask$NewDirectOutputCollector.close(MapTask.java:667) at org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:790) at org.apache.hadoop.mapred.MapTask.run(MapTask.java:341) at org.apache.hadoop.mapred.YarnChild$2.run(YarnChild.java:163) at java.security.AccessController.doPrivileged(Native Method) at javax.security.auth.Subject.doAs(Subject.java:415) at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1628) at org.apache.hadoop.mapred.YarnChild.main(YarnChild.java:158) Caused by: GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt) at sun.security.jgss.krb5.Krb5InitCredential.getInstance(Krb5InitCredential.java:147) at sun.security.jgss.krb5.Krb5MechFactory.getCredentialElement(Krb5MechFactory.java:121) at sun.security.jgss.GSSManagerImpl.getCredentialElement(GSSManagerImpl.java:192) at sun.security.jgss.GSSCredentialImpl.add(GSSCredentialImpl.java:406) at sun.security.jgss.GSSCredentialImpl.<init>(GSSCredentialImpl.java:60) at sun.security.jgss.GSSManagerImpl.createCredential(GSSManagerImpl.java:153) at com.marklogic.xcc.impl.ContentSourceImpl$Credentials.toHttpNegotiateAuth(ContentSourceImpl.java:465) ... 17 more"}, {"time":"2015-12-21T23:24:09.161Z", "updatedBy":{"name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com", "username":"atsoi"}, "change":{"startDate":{"from":"", "to":""}, "endDate":{"from":"", "to":""}, "description":{"from":"", "to":"add kerberos support  in mlcp local mode"}}, "comment":"\n_Description updated_\n\n", "files":[]}, {"time":"2015-12-21T16:00:54.989644-08:00", "updatedBy":{"username":"atsoi", "email":"arthur.tsoi@marklogic.com", "name":"Arthur Tsoi"}, "change":{}, "files":[], "svn":{"repository":"/project/engsvn", "revision":"215740", "paths":["xcc/branches/b8_0/mlcp/src/main/mlcp.bat", "xcc/branches/b8_0/mlcp/src/main/java/com/marklogic/contentpump/Command.java", "xcc/branches/b8_0/mlcp/src/main/mlcp.sh"], "affectedBugs":[]}, "comment":"bug:20942 kerberos support for mlcp", "show":true}, {"time":"2015-12-22T00:01:40.478Z", "updatedBy":{"name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com", "username":"atsoi"}, "change":{"status":{"from":"Fix", "to":"Test"}, "assignTo":{"from":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "to":{"username":"skottam", "email":"sravan.kottam@marklogic.com", "name":"Sravan Kottam"}}, "fixedin":{"from":"", "to":"8.0-5"}}, "comment":"", "files":[]}, {"time":"2016-01-15T22:35:48.071Z", "updatedBy":{"name":"Larry Ratcliff", "email":"lratcliff@marklogic.com", "username":"lratcliff"}, "change":{"assignTo":{"from":{"username":"skottam", "name":"Sravan Kottam", "email":"sravan.kottam@marklogic.com"}, "to":{"username":"plow", "email":"paul.low@marklogic.com", "name":"Paul Low"}}}, "comment":"", "files":[]}, {"time":"2016-02-23T13:00:01.218206-08:00", "updatedBy":{"username":"plow", "email":"paul.low@marklogic.com", "name":"Paul Low"}, "change":{}, "files":[], "svn":{"repository":"/project/engsvn", "revision":"220048", "paths":["qa/branches/b8_0/scripts/tests/mlcp-kerberos.xml"], "affectedBugs":[]}, "comment":"bug:20942 Test/key to verify bug 20942", "show":true}, {"time":"2016-02-23T13:00:16.164081-08:00", "updatedBy":{"username":"plow", "email":"paul.low@marklogic.com", "name":"Paul Low"}, "change":{}, "files":[], "svn":{"repository":"/project/engsvn", "revision":"220049", "paths":["qa/branches/b8_0/scripts/keys/mlcp-kerberos.xml"], "affectedBugs":[]}, "comment":"bug:20942 Test/key to verify bug 20942", "show":true}, {"time":"2016-02-24T18:14:07.617Z", "updatedBy":{"name":"Paul Low", "email":"paul.low@marklogic.com", "username":"plow"}, "change":{"status":{"from":"Test", "to":"Ship"}, "assignTo":{"from":{"username":"plow", "name":"Paul Low", "email":"paul.low@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "comment":"Fix is validated on Linux 8.0-5 build (MarkLogic-RHEL7-8.0-20160219.x86_64.rpm).  \nRegression test added to b8_0 from trunk: mlcp-kerberos.xml.  \n  \nRan the following setup to verify MLCP works with kerberos.  \n    create XDBC server A  \n    enable kerberos on A using kinit to create certificate  \n    run MLCP IMPORT/EXPORT/COPY omitting username/password => successful  \n    enable kerberos on port 8000  \n    run MLCP IMPORT/EXPORT against 8000 omitting username/password => successful", "files":[], "renderCommentAs":"markdown"}], "updatedAt":"2016-02-24T18:14:07.617Z", "parent":{"type":"", "parentId":"", "taskOrRfe":""}}