{"id":20236, "kind":"Bug", "createdAt":"2012-12-10T10:45:00.791824-08:00", "status":"Closed", "title":"xdmp:node-replace() on root node of a binary document does not work", "category":"xdmp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"mhelmstetter", "name":"Mark Helmstetter", "email":"mark.helmstetter@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"In 5.0-4, if I do xdmp:node-replace() on the root node of a binary document, the resulting document is empty. See sample query below for test case.", "samplequery":"(: Sample 1 :)\r\nxdmp:document-insert(\"/test/binary.gif\",binary{xs:hexBinary(xs:base64Binary(\"R0lGODlhQAASAKIAAKAALl0AG5gAMvLrzvTu1////wAAAAAAACH5BAEAAAUALAAAAABAABIAAANuCErc/jDKSZW1bOjNu/9gKArClYloqo4kcK5wnJKCbN8fje+kHfQy4E0IC/xsxGBNZlzGiDRndBN1Fo1I6TLZAyZVxkCWui3rvNZVeKxBD9xuJlZ51rWnb3xsvevLxX6BYHOChSB8hokciIqKYQkAOw==\"))})\r\n;\r\nxdmp:node-replace(fn:doc(\"/test/binary.gif\")/node(), binary{xs:hexBinary(xs:base64Binary(\"R0lGODlhQAASAKIAAKAALl0AG5gAMvLrzvTu1////wAAAAAAACH5BAEAAAUALAAAAABAABIAAANuCErc/jDKSZW1bOjNu/9gKArClYloqo4kcK5wnJKCbN8fje+kHfQy4E0IC/xsxGBNZlzGiDRndBN1Fo1I6TLZAyZVxkCWui3rvNZVeKxBD9xuJlZ51rWnb3xsvevLxX6BYHOChSB8hokciIqKYQkAOw==\"))})\r\n;\r\nxdmp:describe(fn:doc(\"/test/binary.gif\")/node())\r\n\r\n==>\r\n()\r\n\r\n(: Sample 2 :)\r\nxdmp:document-insert(\"/test/binary.gif\",binary{xs:hexBinary(xs:base64Binary(\"R0lGODlhQAASAKIAAKAALl0AG5gAMvLrzvTu1////wAAAAAAACH5BAEAAAUALAAAAABAABIAAANuCErc/jDKSZW1bOjNu/9gKArClYloqo4kcK5wnJKCbN8fje+kHfQy4E0IC/xsxGBNZlzGiDRndBN1Fo1I6TLZAyZVxkCWui3rvNZVeKxBD9xuJlZ51rWnb3xsvevLxX6BYHOChSB8hokciIqKYQkAOw==\"))})\r\n;\r\nxdmp:node-replace(fn:doc(\"/test/binary.gif\")/node(), xdmp:document-get(\"/opt/MarkLogic/Admin/images/narrow-load-fg.gif\")/node())\r\n;\r\nxdmp:describe(fn:doc(\"/test/binary.gif\")/node())\r\n\r\n==>\r\n()", "sampledata":"", "version":"5.0-4", "tofixin":"5.0-5", "fixedin":"5.0-5", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"mhelmstetter", "name":"Mark Helmstetter", "email":"mark.helmstetter@marklogic.com"}, {"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[20320], "cloneOf":"", "support":{"headline":"xdmp:node-replace() on root node of a binary document does not work", "supportDescription":"After calling xdmp:node-replace() on root node of a binary document, the resulting document is empty.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":"node-replace the document node rather than the root node"}, "tags":["xdmp", "mhelmstetter"], "changeHistory":[{"time":"2012-12-10T10:48:58.96336-08:00", "updatedBy":{"username":"mhelmstetter", "name":"Mark Helmstetter", "email":"mark.helmstetter@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Another workaround that I just discovered is to node-replace the document node rather than the root node, e.g. xdmp:node-replace(fn:doc(\"/test/binary.gif\"), document{xdmp:document-get(\"/opt/MarkLogic/Admin/images/narrow-load-fg.gif\")}"}, {"time":"2012-12-11T07:13:18.259751-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "to":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}}}, "files":[], "show":true, "comment":" "}, {"time":"2012-12-11T07:13:18.259751-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"assignTo":{"from":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "to":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-11T07:13:18.259751-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"tofixin":{"from":"", "to":"5.0-5"}}, "files":[], "show":true}, {"time":"2012-12-20T11:09:49.340876-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I tried the test cases on 4.2 and they show the same results."}, {"time":"2012-12-20T11:49:47.450784-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The two cases (node() vs. document) go through slightly different code path although both end up creating a NodeReplaceUpdate (apparently with different node kind). The same flow works fine for text."}, {"time":"2012-12-20T16:33:30.908942-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"124875", "paths":["xdmp/branches/b5_0/src/UpdateBuiltins.cpp", "xdmp/branches/b5_0/src/Tree.h", "xdmp/branches/b5_0/src/Tree.cpp"], "affectedBugs":[]}, "comment":"bug:20236 xdmp:node-replace() on root node of a binary document does not work"}, {"time":"2012-12-20T18:23:30.794705-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"124892", "paths":["xdmp/branches/b5_0/src/UpdateBuiltins.cpp"], "affectedBugs":[]}, "comment":"bug:20236 xdmp:node-replace() on root node of a binary document does not work"}, {"time":"2012-12-20T18:37:05.219069-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"It would good to have test cases that use different binary types, for example, replace with a small, large or even external binary."}, {"time":"2012-12-20T18:37:05.219069-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-07T10:27:16.714272-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-08T16:37:10.168534-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on build 5.0-20130107. \r\nLike Haitao suggested, I have verified the node-replace of the following:\r\n1. a small with large binary, \r\n2. a large binary with small binary,\r\n3. a small binary with another small binary (as given in the bug),\r\n4. a large binary with another large binary,\r\n5. an external binary with small binary,\r\n6. an external binary with another external binary and \r\n7. a small binary with an external binary"}, {"time":"2013-02-25T17:08:20.050238-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-02-25T17:08:20.050238-08:00", "fixedAt":"2012-12-20T18:37:05.219069-08:00", "fixedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "shippedAt":"2013-01-08T16:37:10.168534-08:00", "shippedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "closedAt":"2013-02-25T17:08:20.050238-08:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal", "renderSampleQueryAs":"normal"}