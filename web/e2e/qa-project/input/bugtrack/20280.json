{"id":20280, "kind":"Bug", "createdAt":"2012-12-11T17:18:24.802077-08:00", "status":"Closed", "title":"Order by optimization does not seem to be using index and results in  XDMP-EXPNTREECACHEFULL on Markmail environment", "category":"xdmp", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"On the large markmail dataset (22M docs), order by optimization is causing XDMP-EXPNTREECACHEFULL. Based on the log it looks like it is using the indexes. We tried it using the steps below which uses one document and the log shows it uses the index though.\r\n\r\nJason and Eric are seeing the same issue with their 6.0-2 markmail testing and we are able to reproduce it with our markmail performance environment as well.\r\n\r\nI will able to help in getting the markmail perf environment up if needed.\r\n\r\n1. Create a DB and create a attribute range index on message/@list (no namespace)\r\n2. Load the document using the query in same query section\r\n3. Execute the optimized order by query (also in same query section below)\r\n\r\nThe log below shows that it is not making use of the message/@list index.\r\n\r\n2012-12-11 16:58:33.013 Info: App-Services: at 3:12: Analyzing path for $x: fn:collection()/message\r\n2012-12-11 16:58:33.013 Info: App-Services: at 3:12: Step 1 is searchable: fn:collection()\r\n2012-12-11 16:58:33.013 Info: App-Services: at 3:12: Step 2 is searchable: message\r\n2012-12-11 16:58:33.013 Info: App-Services: at 3:12: Path is fully searchable.\r\n2012-12-11 16:58:33.013 Info: App-Services: at 3:12: Gathering constraints.\r\n2012-12-11 16:58:33.013 Info: App-Services: at 3:12: Step 2 contributed 1 constraint: message\r\n2012-12-11 16:58:33.013 Info: App-Services: at 3:12: Executing search.\r\n2012-12-11 16:58:33.013 Info: App-Services: at 3:12: Selected 1 fragment to filter.\r\n", "samplequery":"Load the document:\r\n==============\r\nxdmp:document-insert(\"a.xml\",\r\n<message message-id=\"af7b71f20612010648r2390c7c5q6ea62ec85e0d8796@mail.gmail.com\" list=\"org.openssl.openssl-users\" id=\"3rwvxv5ghcwyrzwc\" type=\"users\" date=\"2006-12-01T20:18:21+05:30\" year=\"2006-01-01\" year-month=\"2006-12-01\" year-month-day=\"2006-12-01\" thread-id=\"22wuifocvb4dexk6\">\r\n  <headers>\r\n    <envelope-from-line>From nntpsnarfer@fakefrom.com  Mon Jan  1 12:00:00 1990</envelope-from-line>\r\n    <from personal=\"Kingston Smiler\" address=\"kingstonsmiler-Re5JQEeQqe8AvxtiuMwx3w@public.gmane.org\">Kingston Smiler &lt;kingstonsmiler-Re5JQEeQqe8AvxtiuMwx3w@public.gmane.org&gt;</from>\r\n    <subject normal=\"Doubts in the error codes returned by SSL_Write and SSL_Connect\">Doubts in the error codes returned by SSL_Write and SSL_Connect</subject>\r\n    <path>news.gmane.org!not-for-mail</path>\r\n    <newsgroups>gmane.comp.encryption.openssl.user</newsgroups>\r\n    <date>Fri, 1 Dec 2006 20:18:21 +0530</date>\r\n    <lines>59</lines>\r\n    <approved>news@gmane.org</approved>\r\n    <message-id>af7b71f20612010648r2390c7c5q6ea62ec85e0d8796@mail.gmail.com</message-id>\r\n    <reply-to>openssl-users-MCmKBN63+BlAfugRpC6u6w@public.gmane.org</reply-to>\r\n    <nntp-posting-host>main.gmane.org</nntp-posting-host>\r\n    <mime-version>1.0</mime-version>\r\n    <content-type>multipart/alternative; &#13;\r\n\tboundary=\"----=_Part_1054_4959933.1164984501285\"</content-type>\r\n    <x-trace>sea.gmane.org 1164984932 29135 80.91.229.2 (1 Dec 2006 14:55:32 GMT)</x-trace>\r\n    <x-complaints-to>usenet@sea.gmane.org</x-complaints-to>\r\n    <nntp-posting-date>Fri, 1 Dec 2006 14:55:32 +0000 (UTC)</nntp-posting-date>\r\n    <original-x-from>owner-mmx-openssl-users-JaO/zf/mEB0FxBIgtc4dClaTQe2KTcn/@public.gmane.org Fri Dec 01 15:55:30 2006</original-x-from>\r\n    <return-path>owner-mmx-openssl-users-JaO/zf/mEB0FxBIgtc4dClaTQe2KTcn/@public.gmane.org</return-path>\r\n    <envelope-to>openssl-users@m.gmane.org</envelope-to>\r\n    <original-received>from mmx1.engelschall.com ([195.30.6.154])&#13;\r\n\tby ciao.gmane.org with esmtp (Exim 4.43)&#13;\r\n\tid 1Gq9nF-0001sz-9S&#13;\r\n\tfor openssl-users@m.gmane.org; Fri, 01 Dec 2006 15:55:13 +0100</original-received>\r\n    <original-received>by mmx1.engelschall.com (Postfix)&#13;\r\n\tid B025B56586; Fri,  1 Dec 2006 15:54:55 +0100 (CET)</original-received>\r\n    <original-received>from master.openssl.org (master.openssl.org [195.30.6.166])&#13;\r\n\tby mmx1.engelschall.com (Postfix) with ESMTP id AB1C85641A&#13;\r\n\tfor &lt;mmx-openssl-users-w8N0r6uhvJHfKM7srBC2yEEOCMrvLtNR@public.gmane.org&gt;; Fri,  1 Dec 2006 15:54:55 +0100 (CET)</original-received>\r\n    <original-received>by master.openssl.org (Postfix)&#13;\r\n\tid 75D211AC6103; Fri,  1 Dec 2006 15:54:55 +0100 (CET)</original-received>\r\n    <delivered-to>openssl-users-l-P6BqreUs7qIPwi1/lhCOyh2eb7JE58TQ@public.gmane.org</delivered-to>\r\n    <original-received>by master.openssl.org (Postfix, from userid 29101)&#13;\r\n\tid 619A31AC60E5; Fri,  1 Dec 2006 15:54:55 +0100 (CET)</original-received>\r\n    <x-original-to>openssl-users-MCmKBN63+BlAfugRpC6u6w@public.gmane.org</x-original-to>\r\n    <delivered-to>openssl-users-MCmKBN63+BlAfugRpC6u6w@public.gmane.org</delivered-to>\r\n    <original-received>from hu-out-0506.google.com (hu-out-0506.google.com [72.14.214.227])&#13;\r\n\tby master.openssl.org (Postfix) with ESMTP id F179B1AC6049&#13;\r\n\tfor &lt;openssl-users-MCmKBN63+BlAfugRpC6u6w@public.gmane.org&gt;; Fri,  1 Dec 2006 15:54:54 +0100 (CET)</original-received>\r\n    <original-received>by hu-out-0506.google.com with SMTP id 21so3306846hug&#13;\r\n        for &lt;openssl-users-MCmKBN63+BlAfugRpC6u6w@public.gmane.org&gt;; Fri, 01 Dec 2006 06:54:34 -0800 (PST)</original-received>\r\n    <domainkey-signature>a=rsa-sha1; q=dns; c=nofws;&#13;\r\n        s=beta; d=gmail.com;&#13;\r\n        h=received:message-id:date:from:to:subject:mime-version:content-type;&#13;\r\n        b=f75trU9qkL3TbUO8EnQHuoXUrW5AfMHOdaRWa/uWfRCkvOUgHbKI3/h35oRJ8ry1SvbPfiuVSAddg2etEqaM2r9chgZkwvWI+2vKhp63SOFPMXm95X6j023WnlIJfxmPuB3VezZwkzgEvOia224M2VzI7apSRgDouu1E4pVQ05k=</domainkey-signature>\r\n    <original-received>by 10.78.138.6 with SMTP id l6mr4840033hud.1164984501516;&#13;\r\n        Fri, 01 Dec 2006 06:48:21 -0800 (PST)</original-received>\r\n    <original-received>by 10.78.150.5 with HTTP; Fri, 1 Dec 2006 06:48:21 -0800 (PST)</original-received>\r\n    <original-to>openssl-users-MCmKBN63+BlAfugRpC6u6w@public.gmane.org</original-to>\r\n    <original-sender>owner-openssl-users-MCmKBN63+BlAfugRpC6u6w@public.gmane.org</original-sender>\r\n    <precedence>bulk</precedence>\r\n    <x-sender>\"Kingston Smiler\" &lt;kingstonsmiler-Re5JQEeQqe8AvxtiuMwx3w@public.gmane.org&gt;</x-sender>\r\n    <x-list-manager>OpenSSL Majordomo [version 1.94.5]</x-list-manager>\r\n    <x-list-name>openssl-users</x-list-name>\r\n    <xref>news.gmane.org gmane.comp.encryption.openssl.user:24731</xref>\r\n    <archived-at>&lt;http://permalink.gmane.org/gmane.comp.encryption.openssl.user/24731&gt;</archived-at>\r\n  </headers>\r\n  <normalized-references>\r\n    <normalized-message-id>af7b71f20612010648r2390c7c5q6ea62ec85e0d8796@mail.gmail.com</normalized-message-id>\r\n  </normalized-references>\r\n  <body multipart=\"multipart/alternative; &#13;&#10;&#9;boundary=&quot;----=_part_1054_4959933.1164984501285&quot;\" type=\"text/plain; charset=ISO-8859-1; format=flowed\">\r\n    <greeting depth=\"0\">Hi,\r\n</greeting>\r\n    <para depth=\"0\">\r\nI've couple of doubts regarding error set by the SSL_Write and SSL_Connect\r\nCalls.\r\n\r\n</para>\r\n    <para depth=\"0\">1. The SSL_Write call could set the error buffer with the values as\r\n    SSL_WANT_WRITE_ERROR / SSL_WANT_READ_ERROR. I could\r\n    understand the scenarios where the SSL_Write could return the\r\n    WANT_READ error. But at which sceario this call will return the\r\n    WANT_WRITE error.\r\n\r\n</para>\r\n    <para depth=\"0\">2. Regarding the SSL_Connect call, When this call will set the error values\r\n    as SSL_WANT_CONNECT_ERROR / SSL_WANT_ACCEPT_ERROR.\r\n\r\n</para>\r\n    <para depth=\"0\">3. Is it possible that either SSL_Write or Read call could set the error as\r\n    SSL_WANT_CONNECT_ERROR / SSL_WANT_ACCEPT_ERROR. If\r\n    so how and when?\r\n\r\n</para>\r\n    <footer type=\"signature\" depth=\"0\" hash=\"6374447010093016615\">Thanks in Advance,\r\nS.Kingston Smiler.\r\n</footer>\r\n  </body>\r\n</message>\r\n)\r\n\r\nQuery to repro the bug:\r\n==================\r\nxquery version \"1.0-ml\";\r\ndeclare default collation \"http://marklogic.com/collation/\";\r\nxdmp:query-trace(fn:true()),\r\n(for $x in /message\r\norder by $x/@list\r\nreturn $x)[1]", "sampledata":"", "version":"6.0-2", "tofixin":"6.0-2.1", "fixedin":"6.0-2.1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, {"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, {"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"jhunter", "name":"Jason Hunter", "email":"jhunter@servlets.com"}, {"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20253, "support":{"headline":"In MarkLogic server 6.0.2 the order by clause on an attribute doesn't use element-attribute range index", "supportDescription":"In MarkLogic server 6.0.2 if an element-attribute range index matches an order by clause in XQuery, the index doesn't get used. This causes a large number of documents getting fetched in the memory and in some situations it causes XDMP-EXPNTREECACHEFULL error. \r\n", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":"Define a path range index. i.e. if an element book has title as its attribute define a path range index on book/@title."}, "tags":["xdmp", "msarma"], "changeHistory":[{"time":"2012-12-11T17:18:24.802077-08:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "to":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}}}, "files":[], "show":true}, {"time":"2012-12-11T17:39:05.801604-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Oh, Megha and I read the doc wrong, the log output does indicate that the index is *not* being using.  If it used the index, it should say something like:\r\n\r\nOrder by clause contributed 1 range ordering constraint for $x: order by $x/list ascending\r\n\r\nAnd it does not.\r\n\r\nWhat are we missing here, is it possible these are not working in 6.0?"}, {"time":"2012-12-11T17:50:45.436023-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"One other tidbit:  we saw this with both a string and a dateTime range index."}, {"time":"2012-12-11T19:09:23.226515-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Looks like issue is with fast order using attribute range indexes.  Fast order by seems to work fine using element range indexes. I tested using int and string range indexes on 6.0-2. Looks like a regression from 5.0."}, {"time":"2012-12-12T11:07:36.084689-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This is preventing MarkMail from upgrading; they cannot upgrade marmail.org until this is resolved."}, {"time":"2012-12-12T12:08:26.484835-08:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Giving it to Gajanan as per CJL's suggestion"}, {"time":"2012-12-12T12:08:26.484835-08:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-12T21:55:20.284536-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Fixed checked in r123796."}, {"time":"2012-12-13T15:48:55.707354-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-2.1"}}, "files":[], "show":true}, {"time":"2012-12-13T17:29:08.202788-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"123951", "paths":["xdmp/branches/b6_0-2/src/XQuery.cpp"], "affectedBugs":[]}, "comment":"Fix for bug:20280.\n"}, {"time":"2012-12-13T17:29:54.668974-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"gchinchwadkar@gchinchwadkar xdmp]$ svn info\r\nPath: .\r\nURL: svn+ssh://svn.marklogic.com/project/engsvn/xdmp/branches/b6_0-2\r\nRepository Root: svn+ssh://svn.marklogic.com/project/engsvn\r\nRepository UUID: 62cac252-8da6-4816-9e9d-6dc37b19578c\r\nRevision: 123948\r\nNode Kind: directory\r\nSchedule: normal\r\nLast Changed Author: builder\r\nLast Changed Rev: 120714\r\nLast Changed Date: 2012-11-19 11:34:37 -0800 (Mon, 19 Nov 2012)\r\n\r\n[gchinchwadkar@gchinchwadkar xdmp]$ svn commit\r\nSending        src/XQuery.cpp\r\nTransmitting file data .\r\nCommitted revision 123951.\r\n"}, {"time":"2012-12-13T17:29:54.668974-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-13T17:29:54.668974-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-19T10:19:30.891152-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on build 6.0-2.1.20121218."}, {"time":"2012-12-21T12:28:44.847559-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2012-12-21T12:28:44.847559-08:00", "fixedAt":"2012-12-13T17:29:54.668974-08:00", "fixedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "shippedAt":"2012-12-19T10:19:30.891152-08:00", "shippedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "closedAt":"2012-12-21T12:28:44.847559-08:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal", "renderSampleQueryAs":"normal"}