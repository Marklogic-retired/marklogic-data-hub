{"id":20863, "kind":"Bug", "createdAt":"2013-02-20T16:06:02.821023-08:00", "status":"Closed", "title":"XDMP-TOOMANYSTANDS when a forest is restarted too frequently", "category":"Replication", "severity":"Minor", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Local Disk + DB Rep with flash backups : Forests getting into error state and documents missing at the end of stress test\r\n\r\nI started DB Rep + Local Disk Failover stress test to verify this bug:\r\nBug 20601 -  Replica forest stays in \"Finish Closing\" for 3 minutes before going back to \"Open Replica\" state, when moved from flash-backup to all\r\n\r\nMachines used:\r\nMaster Cluster:\r\nrh5-amd64-failover-1 [E-Node]\r\nrh5-intel64-21 [D-Node]\r\nrh5-intel64-22 [D-Node]\r\n  \r\nReplica Cluster:\r\nrh5-amd64-failover-2 [E-Node]\r\nrh5-intel64-23 [D-Node]\r\nrh5-intel64-24 [D-Node] \r\n\r\nModified cronjobs to take \"Modules\", \"Triggers\" and \"MedlineDB\" databases into flash backup mode and out every 20 minutes on Master and replica (sleep 25 seconds after taking forests into flash backup mode before taking them back into updates allowed=all)\r\n\r\nCronjob on Master E-node:\r\n0,20,40 * * * * /home/builder/flash_backup.sh\r\n\r\nCronjob on Replica E-node:\r\n10,30,50 * * * * /home/builder/flash_backup.sh\r\n\r\n\r\nI am seeing following Error on one of the forests in Master Cluster:\r\nXDMP-FORESTERR: Error in startup of forest F1B-R: XDMP-RECOVERY: Recovery error on forest F1B-R after 1 redo records -- {{fsn=9875157, chksum=0x98058e30, words=2469}, op=insert, time=1361398836, mfor=7770072018240975050, mtim=13613442063879610, mfsn=9874702, fmcl=15575198503299167945, fmf=7770072018240975050, fmfsn=9874702, sk=3970617330858001244} XDMP-TOOMANYSTANDS: Too many stands\r\n\r\nAnd the following Error on one of the forests in Replica cluster:\r\nXDMP-FORESTERR: Error in startup of forest F1A-R: XDMP-RECOVERY: Recovery error on forest F1A-R after 0 redo records -- {{fsn=8178825, chksum=0x9bc948a0, words=3064}, op=replicateFragment, time=1361399540, mfor=0, mtim=0, mfsn=0, fmcl=0, fmf=0, fmfsn=0, sk=3253209527467517604} XDMP-TOOMANYSTANDS: Too many stands\r\n\r\nI will attach the scripts I used to take the forests into flash-backup mode and out and also attach ErrorLogs from all the hosts.\r\n\r\n", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea3", "fixedin":"7.0-ea3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, {"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, {"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}], "attachments":[{"name":"Shell script used in cron job", "uri":"root/support/bugtracking/attachments/20857/flash_backup.sh"}, {"name":"xquery module under qa appserver root", "uri":"root/support/bugtracking/attachments/20857/flash_backup.xqy"}, {"name":"second module under qa appserver root", "uri":"root/support/bugtracking/attachments/20857/updates_all.xqy"}, {"name":"ErrorLogs from all hosts on Master Cluster", "uri":"root/support/bugtracking/attachments/20857/masterlogs-022013-155732.tar.gz"}, {"name":"ErrorLogs from all hosts on Replica Cluster", "uri":"root/support/bugtracking/attachments/20857/replicalogs-022013-155821.tar.gz"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20857, "support":{"headline":"", "supportDescription":"", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["Replication", "svempati"], "changeHistory":[{"time":"2013-02-20T16:06:02.821023-08:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-20T16:18:44.011808-08:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Steps:\r\n1. Setup Local disk Failover on Master and Replica.\r\n2. Have modules to be used by shred.sh under Modules database.\r\n3. Change FailoverTest appserver setting pointing modules to \"Modules\" database\r\n4. Change qa appserver setting to use \"basic\" as authentication method.\r\n5. change bootstrap hosts on both clusters to the ones on which Security-M and Security-R reside.\r\n6. couple clusters and enable database replication between MedlineDB.\r\n7. Copy attached xqy modules into qa appserver's root.\r\n8. start medline.sh on master cluster.\r\n9. setup cronjobs on Master and Replica with flash_backup.sh script (attached).\r\n\r\nAfter loading about 10 million documents I see that forests are getting into Error state. \r\n\r\nLast night I saw the forests go into Error state much quicker if I have more number of forests (16 per host)."}, {"time":"2013-02-20T17:29:49.232429-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I spoke with Sundeep about this. He's transitioning to flash backup mode every 20 minutes, which worked for a while until a 20G merge needed to happen that could not finish in the 20 minutes. After that point in time, we started accumulating stands but never merging any and eventually we had too many stands.\r\n\r\nI'm pushing this out to 5.0-6 because it's a contrived case that I wouldn't expect a user to hit in the real world.\r\n\r\nI think a sufficient fix might be to not throw XDMP-TOOMANYSTANDS if the forest is recovering. This would allow the forest to at least get back to an open state at which time I think it would start rejecting new update transactions until a merge is able to successfully complete."}, {"time":"2013-02-20T17:29:49.232429-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"5.0-5", "to":"5.0-6"}}, "files":[], "show":true}, {"time":"2013-02-20T17:31:51.92797-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-20T17:31:51.92797-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea2"}}, "files":[], "show":true}, {"time":"2013-04-18T21:35:05.22541-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Not a regression, and not an expected use case to restart a forest so frequently and repeatedly. Moving to EA3."}, {"time":"2013-04-18T21:35:05.22541-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea2", "to":"7.0-ea3"}}, "files":[], "show":true}, {"time":"2013-05-01T13:43:55.642522-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Arthur, can you take care of this?\r\n"}, {"time":"2013-05-01T13:43:55.642522-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-06-10T13:45:06.978676-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Setting the background I/O throttle on the group configuration will make it easier to demonstrate this.\r\n\r\nA single forests with no local-disk failover should be fine as well.\r\n\r\nIf push comes to shove, this is a long standing bug that doesn't need to be fixed in EA3."}, {"time":"2013-06-13T15:29:16.308318-07:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea3", "to":"7.0-1"}}, "files":[], "show":true}, {"time":"2013-06-19T10:13:58.507749-07:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"I don't think we should do anything to fix this."}, {"time":"2013-06-20T12:42:28.264432-07:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"assignTo":{"from":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "to":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}}}, "files":[], "show":true}, {"time":"2013-06-20T13:42:49.844521-07:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true, "comment":"fixed in 7.0-20130621\r\nnow during recovery:\r\nthe stand limit is double the normal value\r\nthere is no insert throttle so recovery should finish faster\r\nmerges are limited to 4GB so they should finish faster"}, {"time":"2013-06-20T13:42:49.844521-07:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"assignTo":{"from":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-06-20T13:42:49.844521-07:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"tofixin":{"from":"7.0-1", "to":"7.0-ea3"}}, "files":[], "show":true}, {"time":"2013-06-20T21:40:13.237662-07:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"144829", "paths":["xdmp/trunk/src/Forest.h", "xdmp/trunk/src/Forest.cpp", "xdmp/trunk/src/StandManager.cpp"], "affectedBugs":[]}, "comment":"bug:20863"}, {"time":"2013-06-20T22:20:09.304898-07:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"144832", "paths":["xdmp/trunk/src/Forest.cpp"], "affectedBugs":[]}, "comment":"bug:20863"}, {"time":"2013-10-08T18:54:10.108809-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"To insert modules used by shred.sh into 'Modules' database, run xquery below against Modules database:\r\n\r\nxquery version \"1.0-ml\";\r\nfor $uri in (\"load-and-shred.xqy\",\"insert-citations.xqy\")\r\nlet $path := fn:concat(\"/space/builder/trunk/qa/failover/medline/\",$uri)\r\nreturn\r\nxdmp:document-load($path,\r\n    <options xmlns=\"xdmp:document-load\">\r\n      <uri>{concat(\"medline/\",$uri)}</uri>\r\n      <repair>none</repair>\r\n      <permissions>{xdmp:default-permissions()}</permissions>\r\n    </options>)"}, {"time":"2013-10-09T10:24:35.451353-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on 7.0-20131008"}], "updatedAt":"2013-10-09T10:24:35.451353-07:00", "fixedAt":"2013-06-20T13:42:49.844521-07:00", "fixedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "shippedAt":"2013-10-09T10:24:35.451353-07:00", "shippedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "renderDescriptionAs":"normal"}