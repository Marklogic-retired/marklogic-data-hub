{"id":20899, "kind":"Bug", "createdAt":"2013-02-22T09:35:13.116452-08:00", "status":"Closed", "title":"Collection lexicon returning too few results for short wildcarded expressions", "category":"xdmp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"I'm not sure about the pathology of the bug, but it's causing AppServices tests to fail.  The failure affects search suggestions starting with one character.\r\n\r\nHere's how to reproduce:\r\n\r\n1.enable collection lexicon.\r\n\r\n2.\r\nfor $x in (1 to 10)\r\n\r\n  return xdmp:document-insert(fn:concat(\"document\"||$x),\r\n     <document>\r\n        <e1 xmlns=\"http://marklogic.com/ns\">text and a little {$x}</e1>\r\n     </document>, (), (\"collection\"||$x))\r\n\r\n\r\n3.\r\ncts:collection-match(\"c*\")\r\nreturns one string.  This result is not deterministic for me though.  Sometimes 0, sometimes 1.  I'd expect all the collection strings to match.\r\n\r\n4.\r\ncts:collection-match(\"co*\")\r\nreturns all 10 collection strings.\r\n\r\n", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea1", "fixedin":"7.0-ea1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, {"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, {"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "cgreer"], "changeHistory":[{"time":"2013-02-22T12:09:17.289247-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-22T12:09:17.289247-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-22T13:00:15.197034-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2013-02-22T13:14:33.930748-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"I really can't replicate this at all.\r\n"}, {"time":"2013-02-22T15:56:46.725895-08:00", "updatedBy":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I just rebuilt the ea branch (7.0-ea1_20130222) on Fedora 13 (still looking for that window to upgrade) and see the same issue.\r\n\r\n(Well, I added \".xml\" extensions to the URIs for the documents but the collection URIs were the same. )\r\n\r\n"}, {"time":"2013-02-25T11:09:29.265921-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"Suspect this may be related to your other bug."}, {"time":"2013-02-25T11:09:29.265921-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-25T14:27:42.642802-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This is related to my recent change on lexicon optimization. Could not reproduce the deterministic part, getting constant 0 for (3). "}, {"time":"2013-02-25T14:41:46.646374-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I cannot always reproduce it eigther Fei.  Let me know if you'd like me to run any patches you get together, I'd be happy to test them.\r\n"}, {"time":"2013-02-25T15:01:14.138276-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"133565", "paths":["xdmp/trunk/src/Collation.cpp", "xdmp/trunk/src/OnDiskRangeIndexes.cpp"], "affectedBugs":[]}, "comment":"Bug:20899 fix lexicon optimization on small wc"}, {"time":"2013-02-25T15:03:39.225373-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi Charles, I checked in a change on trunk and verified on the following queries:\r\n\r\nfn:count(cts:collection-match(\"co*\",(\"diacritic-sensitive\",\"case-insensitive\"))),\r\nfn:count(cts:collection-match(\"co*\",(\"diacritic-sensitive\",\"case-sensitive\"))),\r\nfn:count(cts:collection-match(\"co*\",(\"diacritic-insensitive\",\"case-insensitive\"))),\r\nfn:count(cts:collection-match(\"co*\",(\"diacritic-insensitive\",\"case-sensitive\"))),\r\nfn:count(cts:collection-match(\"c*\",(\"diacritic-sensitive\",\"case-insensitive\"))),\r\nfn:count(cts:collection-match(\"c*\",(\"diacritic-sensitive\",\"case-sensitive\"))),\r\nfn:count(cts:collection-match(\"c*\",(\"diacritic-insensitive\",\"case-insensitive\"))),\r\nfn:count(cts:collection-match(\"c*\",(\"diacritic-insensitive\",\"case-sensitive\"))),\r\nfn:count(cts:collection-match(\"co*\")),\r\nfn:count(cts:collection-match(\"c*\"))\r\n\r\nAll should return 10. Let me know if you run into anything abnormal and if this fixes your broken test.\r\nFix on ea1 will be checked in after code review.\r\nThank you! \r\n\r\nFei"}, {"time":"2013-02-25T15:29:27.994496-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"133577", "paths":["xdmp/branches/b7_0-ea1/src/OnDiskRangeIndexes.cpp", "xdmp/branches/b7_0-ea1/src/InMemoryRangeIndexes.cpp", "xdmp/branches/b7_0-ea1/src/Collation.cpp"], "affectedBugs":["20918", "20893"]}, "comment":"Bug:20918 Bug:20899 Bug:20893 port to b7.0-ea1"}, {"time":"2013-02-25T16:33:51.459293-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"Thanks Charles! Moving to test.\r\n\r\n-----Original Message-----\r\nFrom: Charles Greer [mailto:cgreer@marklogic.com] \r\nSent: Monday, February 25, 2013 3:52 PM\r\nTo: Fei Xue\r\nCc: Charles Greer; Mary Holstege; Ron Hu\r\nSubject: Re: Bug 20899 Change Notification\r\n\r\nYes, and the appservices search tests pass now too, thank you!\r\n\r\nCharles\r\n\r\n"}, {"time":"2013-02-25T16:33:51.459293-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{"assignTo":{"from":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-02T11:05:55.026158-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-13T01:18:33.748814-07:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on ML 7.0-ea1-20130312 and added test bug20899.xml to bugs70 list in regression. Hence,shipping the bug."}, {"time":"2013-03-13T01:18:33.748814-07:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-03-13T01:18:33.748814-07:00", "fixedAt":"2013-02-25T16:33:51.459293-08:00", "fixedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "shippedAt":"2013-03-13T01:18:33.748814-07:00", "shippedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "renderDescriptionAs":"normal"}