{"id":20525, "kind":"Bug", "createdAt":"2012-10-23T09:37:08.230186-07:00", "status":"Closed", "title":"incorrect x509 version in generated certificates", "category":"security", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"fsalonga", "name":"Frank Salonga", "email":"franklin.salonga@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"from this case: https://help.marklogic.com/staff/Tickets/Ticket/View/11919\r\n\r\nRFC2986 requires the x509 version to be 0. We generate certificates with version set to 2. It's possible to workaround the issue by creating/inserting a certificate with the fields set appropriately (see below), but we really should not be requiring customers to go through this exercise.\r\n\r\nxquery version \"1.0-ml\";\r\nimport module namespace pki = \"http://marklogic.com/xdmp/pki\"\r\nat \"/MarkLogic/pki.xqy\";\r\n\r\ndeclare namespace x509 = \"http://marklogic.com/xdmp/x509\";\r\ndeclare namespace ssl = \"http://marklogic.com/xdmp/ssl\";\r\n\r\nlet $x509 :=\r\n<x509:req>\r\n<x509:version>0</x509:version>\r\n<x509:subject>\r\n<x509:organizationName>UBS AG</x509:organizationName>\r\n<x509:organizationalUnitName>CDC RRR</x509:organizationalUnitName>\r\n</x509:subject>\r\n</x509:req>\r\n\r\nlet $options :=\r\n<pki:key-options xmlns=\"ssl:options\">\r\n<key-length>2048</key-length>\r\n</pki:key-options>\r\n\r\n\r\nreturn pki:insert-template(\r\npki:create-template(\r\n\"newTemplate\",\r\n\"Creating a new template\",\r\n\"rsa\",\r\n$options,\r\n$x509))", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-1", "fixedin":"7.0-1", "platform":"linux(64-bit)", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"fsalonga", "name":"Frank Salonga", "email":"franklin.salonga@marklogic.com"}, {"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":19874, "support":{"headline":"Generated X509 certificate requests have incorrect version", "supportDescription":"X509 certificate requests are generated incorrectly with a version of 2 rather than 0.", "workaround":"", "publishStatus":"Publish", "tickets":["11919", "12212"], "customerImpact":{"level":"Medium", "title":"Requires significant or unnatural effort to work around issue or to prevent significant business impact"}}, "tags":["security", "fsalonga"], "changeHistory":[{"time":"2012-10-25T14:29:14.067747-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-10-25T14:29:14.067747-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-10-25T14:29:14.067747-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-5"}}, "files":[], "show":true}, {"time":"2013-01-07T21:08:39.62205-08:00", "updatedBy":{"username":"dchander", "name":"Dinesh Chander", "email":"dinesh.chander@globallogic.com"}, "change":{}, "files":[], "show":true, "comment":"Similar issue reported in support case #12300.\r\n\r\nHere error is coming when the certificate template is generated from the Admin UI and the CSR is signed using openSSL. Importing the signed certificate produces same error.\r\n\r\nXDMP-AS: (err:XPTY0004) xdmp:apply(map:get($args, \"fn\"), map:get($args, \"1\")) -- Invalid coercion: (fn:doc(\"http://marklogic.com/xdmp/pki/certificates/17097325431760028169.xml\"<http://marklogic.com/xdmp/pki/certificates/17097325431760028169.xml>)/pki:certificate, fn:doc(\"http://marklogic.com/xdmp/pki/certificates/6597029119674534806.xml\"<http://marklogic.com/xdmp/pki/certificates/6597029119674534806.xml>)/pki:certificate) as element(pki:certificate)?\r\nIn /MarkLogic/pki.xqy on line 323..."}, {"time":"2013-01-18T21:43:19.751306-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"128364", "paths":["xdmp/branches/b5_0/src/Admin/lib/certificate-template-admin-form.xqy", "xdmp/branches/b5_0/src/Messages/PKI-en.xml", "xdmp/branches/b5_0/src/Modules/MarkLogic/pki.xqy"], "affectedBugs":[]}, "comment":"bug:19874 CSR version must always be 0, but the certificate itself should be 2."}, {"time":"2013-01-18T22:22:35.550085-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"128372", "paths":["xdmp/trunk/src/Modules/MarkLogic/pki.xqy", "xdmp/trunk/src/Messages/PKI-en.xml", "xdmp/trunk/src/Admin/lib/certificate-template-admin-form.xqy"], "affectedBugs":[]}, "comment":"bug:20525 CSR version must always be 0, but the certificate itself should be 2."}, {"time":"2013-01-18T22:27:25.234936-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-18T22:27:25.234936-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-02-27T12:38:07.328633-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"THis should be in test."}, {"time":"2013-03-02T11:23:01.378584-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-06T17:04:03.970025-08:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified with MarkLogic-7.0-ea1_20130306\r\n\r\nTest in regression: bug20525.xml\r\ntest suite: bugs50"}], "updatedAt":"2013-03-06T17:04:03.970025-08:00", "fixedAt":"2013-02-27T12:38:07.328633-08:00", "fixedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "shippedAt":"2013-03-06T17:04:03.970025-08:00", "shippedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "renderDescriptionAs":"normal"}