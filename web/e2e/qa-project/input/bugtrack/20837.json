{"id":20837, "kind":"Bug", "createdAt":"2013-02-19T11:38:50.438509-08:00", "status":"Closed", "title":"XDMP-MISSINGFILE during replication", "category":"xdmp", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"JPMC encountered this last night while testing out a 5.0-5 nightly build. The same fragment is failing to replicate over and over.\r\n\r\n$ grep XDMP-MISSINGFILE /var/opt/MarkLogic/Logs/ErrorLog_1.txt\r\n2013-02-18 17:19:11.542 Debug: ForestSynchronizeThread::run: DCPP_Forest35 XDMP-MISSINGFILE: Missing file /data/MarkLogic11/Forests/DCPP_Forest35/Large/315/c55ada9ba870453c\r\n2013-02-18 17:20:28.991 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:20:56.665 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:21:21.656 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:21:48.487 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:22:13.598 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:22:39.067 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:23:04.461 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:23:27.455 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:23:52.810 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:24:18.958 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:24:45.280 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:25:12.684 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:25:38.666 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:26:02.461 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n", "samplequery":"", "sampledata":"", "version":"5.0-nightly", "tofixin":"5.0-5", "fixedin":"5.0-5", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[20850, 20851], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "wfeick"], "changeHistory":[{"time":"2013-02-19T11:38:50.438509-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-19T16:39:29.105482-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"132500", "paths":["xdmp/branches/b5_0/src/Forest.cpp", "xdmp/branches/b5_0/src/BinaryManager.h", "xdmp/branches/b5_0/src/BinaryManager.cpp"], "affectedBugs":[]}, "comment":"bug:20837 a speculative fix; more trace events"}, {"time":"2013-02-20T10:56:42.339459-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"132642", "paths":["xdmp/branches/b5_0/src/Forest.cpp"], "affectedBugs":[]}, "comment":"Bug:20837 respond to XDMP-MISSINGFILE during large binary bulk replication by replicating the binary again."}, {"time":"2013-02-20T15:49:24.709258-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"132714", "paths":["xdmp/branches/b5_0/src/Forest.cpp", "xdmp/branches/b5_0/src/BinaryManager.cpp"], "affectedBugs":[]}, "comment":"bug:20837 added 2 fsyncDir for large binary writes"}, {"time":"2013-02-20T21:30:33.532258-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-20T21:30:33.532258-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-21T13:45:28.610517-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-22T11:17:25.870461-08:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Tested with 2/21 build. Now master sees XDMP-MISSINGFILE and bulk replicates the missing file. \r\n\r\n2013-02-22 10:10:44.099 Info: Forest Documents starting synchronization to foreign forest Documents in cluster rh5-intel64-25.marklogic.com-cluster\r\n2013-02-22 10:10:44.099 Info: Forest Documents starting bulk replication to foreign forest Documents in cluster rh5-intel64-25.marklogic.com-cluster\r\n2013-02-22 10:10:44.224 Info: Forest Documents replicating 10 keys to foreign forest Documents in cluster rh5-intel64-25.marklogic.com-cluster\r\n2013-02-22 10:10:44.346 Info: Forest Documents needs to replicate 2 fragments to foreign forest Documents in cluster rh5-intel64-25.marklogic.com-cluster\r\n2013-02-22 10:10:44.576 Warning: Forest Documents missing large binary file: XDMP-MISSINGFILE: Missing file /var/opt/MarkLogic/Forests/Documents/Large/202/809746a3da0ae687\r\n2013-02-22 10:18:40.046 Debug: Detecting indexes for database App-Services\r\n2013-02-22 10:18:40.047 Debug: Detected indexes for database App-Services: sln\r\n2013-02-22 10:18:40.047 Debug: Detecting compatibility for database App-Services\r\n2013-02-22 10:18:40.047 Debug: Detected compatibility for database App-Services\r\n2013-02-22 10:18:40.436 Debug: InMemoryStand /var/opt/MarkLogic/Forests/App-Services/0000000d, disk=15MB, memory=655MB, list=512MB, tree=128MB, rangeIndex=16MB, reverseIndex=16MB\r\n2013-02-22 10:18:56.842 Debug: Retrying AppConnectionTask::handleEvalLocked 2130474199839987202 Update 1 because XDMP-DEADLOCK: Deadlock detected locking App-Services /workspaces/6137040295055727033.xml\r\n2013-02-22 10:19:04.856 Debug: Detecting indexes for database Documents\r\n2013-02-22 10:19:04.857 Debug: Detected indexes for database Documents: ss, fp, fcs, fds, few, fep, sln\r\n2013-02-22 10:19:04.857 Debug: Detecting compatibility for database Documents\r\n2013-02-22 10:19:04.857 Debug: Detected compatibility for database Documents\r\n2013-02-22 10:20:29.389 Info: Saving /var/opt/MarkLogic/Forests/App-Services/0000000d\r\n2013-02-22 10:20:30.107 Debug: OnDiskStand /var/opt/MarkLogic/Forests/App-Services/0000000d, disk=15MB, memory=16MB\r\n2013-02-22 10:20:30.109 Info: Saved 15 MB in 1 sec at 21 MB/sec to /var/opt/MarkLogic/Forests/App-Services/0000000d\r\n2013-02-22 10:20:30.109 Debug: ~InMemoryStand /var/opt/MarkLogic/Forests/App-Services/0000000d\r\n2013-02-22 10:20:30.190 Info: Merging 4 MB from /var/opt/MarkLogic/Forests/App-Services/0000000c and /var/opt/MarkLogic/Forests/App-Services/0000000d to /var/opt/MarkLogic/Forests/App-Services/0000000e\r\n2013-02-22 10:20:31.205 Debug: OnDiskStand /var/opt/MarkLogic/Forests/App-Services/0000000e, disk=0MB, memory=1MB\r\n2013-02-22 10:20:31.205 Info: Merged 1 MB in 1 sec at 1 MB/sec to /var/opt/MarkLogic/Forests/App-Services/0000000e\r\n2013-02-22 10:20:31.370 Debug: ~OnDiskStand /var/opt/MarkLogic/Forests/App-Services/0000000c\r\n2013-02-22 10:20:31.370 Debug: ~OnDiskStand /var/opt/MarkLogic/Forests/App-Services/0000000d\r\n2013-02-22 10:20:33.745 Info: Deleted 1 MB in 1 sec at 32 MB/sec /var/opt/MarkLogic/Forests/App-Services/0000000c\r\n2013-02-22 10:20:33.764 Info: Deleted 15 MB in 1 sec at 797 MB/sec /var/opt/MarkLogic/Forests/App-Services/0000000d\r\n2013-02-22 10:22:23.529 Info: Forest Documents bulk replicated 2 fragments (0 skipped, 0 not found) to foreign forest Documents in cluster rh5-intel64-25.marklogic.com-cluster (0/sec)\r\n2013-02-22 10:22:23.613 Info: Forest Documents finished bulk replicating to foreign forest Documents in cluster rh5-intel64-25.marklogic.com-cluster\r\n2013-02-22 10:22:23.631 Info: Forest Documents finished synchronizing to foreign replica forest Documents in cluster rh5-intel64-25.marklogic.com-cluster\r\n\r\n\r\nAfter Bulk Replication, verified the binary content on Master and replica (md5 on first 100 bytes)\r\n\r\nxdmp:md5(xdmp:subbinary(fn:doc(\"/binary-support/suddenly.mpeg\")/binary(),1,100),\"hex\") ==> a60f968dc6406144e211aa00a208ee79\r\n\r\n"}, {"time":"2013-02-22T13:26:24.445635-08:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified it with MarkLogic-5.0-20130222 build as well."}, {"time":"2013-02-25T17:04:51.544138-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-02-25T17:04:51.544138-08:00", "fixedAt":"2013-02-20T21:30:33.532258-08:00", "fixedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "shippedAt":"2013-02-22T13:26:24.445635-08:00", "shippedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "closedAt":"2013-02-25T17:04:51.544138-08:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}