{"id":20663, "kind":"Bug", "createdAt":"2013-01-31T09:00:03.727458-08:00", "status":"Closed", "title":"admin:forest-delete deleting forest data even when $delete-data flag set to fn:false()", "category":"documentation", "severity":"Minor", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"derickson", "name":"David Erickson", "email":"David.Erickson@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"We are writing an admin script to move a forest between drives.\r\nWe detatch and then delete the forest (config only) but find that the forest is deleted on the hard drive.\r\n\r\nHappens in Windows 6.0-2.2 and Mac 6.0-2.1", "samplequery":"xquery version \"1.0-ml\";\r\n\r\nimport module namespace admin = \"http://marklogic.com/xdmp/admin\" \r\n\t  at \"/MarkLogic/admin.xqy\";\r\n\r\nlet $name := \"TestingDelete\"\r\nlet $config := admin:get-configuration()\r\n(: Create Database :)\r\nlet $config := \r\n    admin:database-create($config, $name, xdmp:database(\"Security\"), xdmp:database(\"Schemas\"))\r\n(: Create Forest :)\r\nlet $config := admin:forest-create($config, $name, xdmp:host(), ())\r\nreturn\r\nadmin:save-configuration($config);\r\n\r\n\r\nxquery version \"1.0-ml\";\r\n\r\nimport module namespace admin = \"http://marklogic.com/xdmp/admin\" \r\n\t  at \"/MarkLogic/admin.xqy\";\r\n\r\nlet $name := \"TestingDelete\"\r\nlet $config := admin:get-configuration()\r\n\r\n(: Attach Forest:)\r\nlet $config := admin:database-attach-forest($config, xdmp:database($name), xdmp:forest($name) )\r\nreturn\r\n\r\nadmin:save-configuration($config);\r\n\r\n\r\nxquery version \"1.0-ml\";\r\n\r\nimport module namespace admin = \"http://marklogic.com/xdmp/admin\" \r\n\t  at \"/MarkLogic/admin.xqy\";\r\n\r\nlet $name := \"TestingDelete\"\r\nlet $config := admin:get-configuration()\r\n\r\nreturn\r\nif(\r\n\tfn:exists(\r\n\t\txdmp:filesystem-directory(\r\n\t\t\tfn:concat(xs:string(\r\n\t\t\t\txdmp:forest-status(admin:forest-get-id($config, $name))/*:data-dir\r\n\t\t\t), \"/Forests/\",$name)\r\n\t\t)\r\n\t)\r\n)\r\nthen fn:concat($name, \"Forest Directory Exists\")\r\nelse fn:concat($name, \"Forest Directory Does not Exist\")\r\n    \r\n  \r\n  \r\n  \r\n  \r\n########################\r\n\r\n\r\nxquery version \"1.0-ml\";\r\n\r\nimport module namespace admin = \"http://marklogic.com/xdmp/admin\" \r\n\t  at \"/MarkLogic/admin.xqy\";\r\n\r\nlet $name := \"TestingDelete\"\r\n\r\nlet $config := admin:get-configuration()\r\nlet $data-dir := fn:concat(xs:string(xdmp:forest-status(admin:forest-get-id($config, $name))/*:data-dir), \"\\Forests\\\",$name)\r\n(: Detach Forest :)\r\nlet $config := admin:database-detach-forest($config, xdmp:database($name), xdmp:forest($name) )\r\nreturn\r\nadmin:save-configuration($config);\r\n\r\n\r\nxquery version \"1.0-ml\";\r\n\r\nimport module namespace admin = \"http://marklogic.com/xdmp/admin\" \r\n\t  at \"/MarkLogic/admin.xqy\";\r\n\r\nlet $name := \"TestingDelete\"\r\n\r\nlet $config := admin:get-configuration()\r\n\r\n(: Delete Forest Configuration Only :)\r\nlet $config := admin:forest-delete($config, admin:forest-get-id($config, $name), fn:false())\r\nreturn\r\nadmin:save-configuration($config)", "sampledata":"", "version":"6.0-2.2", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"windows(64-bit)", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"derickson", "name":"David Erickson", "email":"David.Erickson@marklogic.com"}, {"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, {"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, {"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["documentation", "derickson"], "changeHistory":[{"time":"2013-01-31T14:15:54.983502-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"The $delete-data parameter only applies when the forest is a public forest,\r\nin that is has a specified public data directory, and not the default private data directory.\r\nFrom the looks of your forest-create function it does not look like you are specifying one."}, {"time":"2013-01-31T14:31:51.078412-08:00", "updatedBy":{"username":"derickson", "name":"David Erickson", "email":"David.Erickson@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"That's correct.  In both the script for recreating our issue and in the customer's environment we are trying to move forests from the default ML install directory to a larger \"public\" drive with more space.\r\n\r\nThanks for this clarification.  Should I adjust the bug to be against documentation as (http://docs.marklogic.com/admin:forest-delete) does not mention the distinction?\r\n\r\nFor reference this is CGI CMS which left to their own devices had a 4 core VM with around 200 forests hosting 5 independent copies of a 30 DB solution that probably should have been closer to 5 DBs.  I think we can script this another way (detatch , copy files to new drive, delete forest, create new forest in new location)"}, {"time":"2013-01-31T22:20:39.687758-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}}}, "files":[], "show":true, "comment":"Danny,\r\n\r\nAs per inout from David, I am assigning this to your team"}, {"time":"2013-01-31T22:20:39.687758-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-31T22:20:39.687758-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-02-15T11:11:48.440011-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/docsvn", "revision":"6263", "paths":["docs/branches/b5_0/modules/admin.xml"], "affectedBugs":[]}, "comment":"bug:20663 -- config-only deletes only apply to public forests"}, {"time":"2013-02-15T11:13:43.145539-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/docsvn", "revision":"6264", "paths":["docs/branches/b6_0/modules/admin.xml"], "affectedBugs":[]}, "comment":"bug:20663 -- config-only deletes only apply to public forests"}, {"time":"2013-02-15T11:15:10.151688-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/docsvn", "revision":"6265", "paths":["docs/trunk/modules/admin.xml"], "affectedBugs":[]}, "comment":"bug:20663 -- config-only deletes only apply to public forests"}, {"time":"2013-02-15T11:17:06.957103-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}}}, "files":[], "show":true, "comment":"I changed the description of the $delete-data parameter to the following:\r\n\r\nIf set to true, deletes the data directory as well as the\r\n\t\t    configuration (Note: all documents in the forest will be \r\n\t\t    permanently deleted).  For public forests, if set to false, \r\n        deletes only the\r\n\t\t    configuration information, leaving the forest data in the \r\n\t\t    data directory on disk. Configuration-only deletes are available \r\n        only for public forests \r\n        (forests that have a data directory specified); private forests\r\n        (forests that have no data directory specified and therefore are \r\n        stored in the default MarkLogic data directory) will ignore this \r\n        parameter and the forest data will always be deleted. \r\n"}, {"time":"2013-02-15T11:17:06.957103-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-12T11:12:10.199499-07:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "to":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-26T14:47:04.873063-07:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified passed"}, {"time":"2013-03-26T14:47:04.873063-07:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-03-26T14:47:04.873063-07:00", "fixedAt":"2013-02-15T11:17:06.957103-08:00", "fixedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "shippedAt":"2013-03-26T14:47:04.873063-07:00", "shippedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "renderDescriptionAs":"normal", "renderSampleQueryAs":"normal"}