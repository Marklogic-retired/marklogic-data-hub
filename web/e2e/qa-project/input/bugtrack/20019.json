{"id":20019, "kind":"Bug", "createdAt":"2012-11-07T07:50:16.497049-08:00", "status":"Closed", "title":"Implement covering union optimization", "category":"XQuery", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"If an index path has unions that cover individual paths in queries, the index should be used in the query plans.\r\n\r\nExample:\r\n\r\nIndex: /a/(b|c)/d\r\nQuery: /a/b[d='k'] or /a/c[d='k'] or for $x in /a/b where $x/d='k' return $x ", "samplequery":"", "sampledata":"", "version":"6.0-nightly", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20015, "support":{"headline":"", "supportDescription":"", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["XQuery", "gchinchwadkar"], "changeHistory":[{"time":"2012-11-07T07:50:16.497049-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-07T11:34:39.187328-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2012-11-28T14:51:35.860034-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"121808", "paths":["xdmp/branches/b6_0/src/PathIndexes.cpp"], "affectedBugs":[]}, "comment":"Fix for bug:20019.\n"}, {"time":"2012-11-28T14:51:59.28748-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-28T14:51:59.28748-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-28T14:25:45.896424-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true, "comment":"The query plan includes the index for the FLOWR expression i.e., I see\r\nWhere clause contributed 1 constraint for $x: $x/d = \"k\"\r\n\r\nbut while running the queries, /a/b[d='k'] or /a/c[d='k'], the query plan does not include the index.\r\nThis is what I see:\r\n Info: App-Services: at 3:4: Analyzing path: fn:collection()/a/c[d = \"k\"]\r\n2012-12-28 14:17:02.861 Info: App-Services: at 3:4: Step 1 is searchable: fn:collection()\r\n2012-12-28 14:17:02.861 Info: App-Services: at 3:4: Step 2 is searchable: a\r\n2012-12-28 14:17:02.861 Info: App-Services: at 3:4: Step 3 is searchable: c[d = \"k\"]\r\n2012-12-28 14:17:02.861 Info: App-Services: at 3:4: Path is fully searchable.\r\n2012-12-28 14:17:02.861 Info: App-Services: at 3:4: Gathering constraints.\r\n2012-12-28 14:17:02.861 Info: App-Services: at 3:2: Step 2 contributed 1 constraint: a\r\n2012-12-28 14:17:02.861 Info: App-Services: at 3:6: Comparison contributed hash value constraint: d = \"k\"\r\n2012-12-28 14:17:02.861 Info: App-Services: at 3:4: Step 3 predicate 1 contributed 1 constraint: d = \"k\"\r\n2012-12-28 14:17:02.861 Info: App-Services: at 3:6: Comparison contributed hash value constraint: d = \"k\"\r\n2012-12-28 14:17:02.861 Info: App-Services: at 3:4: Step 3 predicate 1 contributed 1 constraint: d = \"k\"\r\n2012-12-28 14:17:02.861 Info: App-Services: at 3:4: Step 3 contributed 2 constraints: c[d = \"k\"]\r\n2012-12-28 14:17:02.861 Info: App-Services: at 3:4: Executing search.\r\n2012-12-28 14:17:02.861 Info: App-Services: at 3:4: Selected 0 fragments to filter\r\n\r\n"}, {"time":"2012-12-28T14:25:45.896424-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-28T10:40:07.894957-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This one was already fixed. I just need to verify why Maha didn't see the right output. "}, {"time":"2013-01-28T14:12:25.063593-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I am not sure what was different in your test set-up, but I am seeing index being correctly used for query optimization.\r\n\r\nxdmp:query-trace(fn:true()),\r\n/a/b[d='k'],\r\nxdmp:query-trace(fn:false())\r\n\r\nErrorLog shows:\r\n2013-01-28 14:07:03.252 Info: cq: at 4:3: Analyzing path: fn:collection()/a/b[d = \"k\"]\r\n2013-01-28 14:07:03.252 Info: cq: at 4:3: Step 1 is searchable: fn:collection()\r\n2013-01-28 14:07:03.252 Info: cq: at 4:3: Step 2 is searchable: a\r\n2013-01-28 14:07:03.252 Info: cq: at 4:3: Step 3 is searchable: b[d = \"k\"]\r\n2013-01-28 14:07:03.252 Info: cq: at 4:3: Path is fully searchable.\r\n2013-01-28 14:07:03.252 Info: cq: at 4:3: Gathering constraints.\r\n2013-01-28 14:07:03.252 Info: cq: at 4:1: Step 2 contributed 1 constraint: a\r\n2013-01-28 14:07:03.252 Info: cq: at 4:5: Comparison contributed string range value constraint: /a/(b|c)/d = \"k\"\r\n2013-01-28 14:07:03.252 Info: cq: at 4:5: Comparison contributed hash value constraint: d = \"k\"\r\n2013-01-28 14:07:03.252 Info: cq: at 4:3: Step 3 predicate 1 contributed 1 constraint: d = \"k\"\r\n2013-01-28 14:07:03.252 Info: cq: at 4:5: Comparison contributed string range value constraint: /a/(b|c)/d = \"k\"\r\n2013-01-28 14:07:03.252 Info: cq: at 4:5: Comparison contributed hash value constraint: d = \"k\"\r\n2013-01-28 14:07:03.252 Info: cq: at 4:3: Step 3 predicate 1 contributed 1 constraint: d = \"k\"\r\n2013-01-28 14:07:03.253 Info: cq: at 4:3: Step 3 contributed 2 constraints: b[d = \"k\"]\r\n2013-01-28 14:07:03.253 Info: cq: at 4:3: Executing search.\r\n2013-01-28 14:07:03.253 Info: cq: at 4:3: Selected 0 fragments to filter\r\n\r\n\r\nxdmp:query-trace(fn:true()),\r\n/a/c[d='k'],\r\nxdmp:query-trace(fn:false())\r\n=>\r\nErrorLog shows:\r\n\r\n2013-01-28 14:08:51.006 Info: cq: at 4:3: Analyzing path: fn:collection()/a/c[d = \"k\"]\r\n2013-01-28 14:08:51.006 Info: cq: at 4:3: Step 1 is searchable: fn:collection()\r\n2013-01-28 14:08:51.006 Info: cq: at 4:3: Step 2 is searchable: a\r\n2013-01-28 14:08:51.007 Info: cq: at 4:3: Step 3 is searchable: c[d = \"k\"]\r\n2013-01-28 14:08:51.007 Info: cq: at 4:3: Path is fully searchable.\r\n2013-01-28 14:08:51.007 Info: cq: at 4:3: Gathering constraints.\r\n2013-01-28 14:08:51.007 Info: cq: at 4:1: Step 2 contributed 1 constraint: a\r\n2013-01-28 14:08:51.007 Info: cq: at 4:5: Comparison contributed string range value constraint: /a/(b|c)/d = \"k\"\r\n2013-01-28 14:08:51.007 Info: cq: at 4:5: Comparison contributed hash value constraint: d = \"k\"\r\n2013-01-28 14:08:51.007 Info: cq: at 4:3: Step 3 predicate 1 contributed 1 constraint: d = \"k\"\r\n2013-01-28 14:08:51.007 Info: cq: at 4:5: Comparison contributed string range value constraint: /a/(b|c)/d = \"k\"\r\n2013-01-28 14:08:51.007 Info: cq: at 4:5: Comparison contributed hash value constraint: d = \"k\"\r\n2013-01-28 14:08:51.007 Info: cq: at 4:3: Step 3 predicate 1 contributed 1 constraint: d = \"k\"\r\n2013-01-28 14:08:51.007 Info: cq: at 4:3: Step 3 contributed 2 constraints: c[d = \"k\"]\r\n2013-01-28 14:08:51.007 Info: cq: at 4:3: Executing search.\r\n2013-01-28 14:08:51.007 Info: cq: at 4:3: Selected 0 fragments to filter\r\n\r\n\r\nxdmp:query-trace(fn:true()),\r\nfor $x in /a/b where $x/d='k' return $x ,\r\nxdmp:query-trace(fn:false())\r\n=>\r\n\r\nErrorLog shows:\r\n2013-01-28 14:09:51.379 Info: cq: at 4:13: Analyzing path for $x: fn:collection()/a/b\r\n2013-01-28 14:09:51.379 Info: cq: at 4:13: Step 1 is searchable: fn:collection()\r\n2013-01-28 14:09:51.379 Info: cq: at 4:13: Step 2 is searchable: a\r\n2013-01-28 14:09:51.379 Info: cq: at 4:13: Step 3 is searchable: b\r\n2013-01-28 14:09:51.379 Info: cq: at 4:13: Path is fully searchable.\r\n2013-01-28 14:09:51.379 Info: cq: at 4:13: Gathering constraints.\r\n2013-01-28 14:09:51.379 Info: cq: at 4:11: Step 2 contributed 1 constraint: a\r\n2013-01-28 14:09:51.379 Info: cq: at 4:13: Step 3 contributed 1 constraint: b\r\n2013-01-28 14:09:51.380 Info: cq: at 4:21: Comparison contributed hash value constraint: b = \"k\"\r\n2013-01-28 14:09:51.380 Info: cq: at 4:24: Comparison contributed hash value constraint: d = \"k\"\r\n2013-01-28 14:09:51.380 Info: cq: at 4:24: Comparison contributed string range value constraint: /a/(b|c)/d = \"k\"\r\n2013-01-28 14:09:51.380 Info: cq: at 4:13: Where clause contributed 1 constraint for $x: $x/d = \"k\"\r\n2013-01-28 14:09:51.380 Info: cq: at 4:13: Executing search.\r\n2013-01-28 14:09:51.380 Info: cq: at 4:13: Selected 0 fragments to filter\r\n\r\n"}, {"time":"2013-01-28T14:12:25.063593-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-28T14:12:25.063593-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-28T14:22:19.11841-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-28T14:22:19.11841-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-28T14:23:33.526999-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true, "comment":"Something erratic is going on in my browser..."}, {"time":"2013-01-28T14:23:33.526999-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-25T15:54:17.726835-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on build 6.0-20130324 that test query-opt-bug20015.xml passed in regression."}], "updatedAt":"2013-03-25T15:54:17.726835-07:00", "fixedAt":"2013-01-28T14:23:33.526999-08:00", "fixedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "shippedAt":"2013-03-25T15:54:17.726835-07:00", "shippedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "renderDescriptionAs":"normal"}