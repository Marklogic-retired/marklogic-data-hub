{"id":20394, "kind":"Bug", "createdAt":"2013-01-07T13:57:54.851474-08:00", "status":"Closed", "title":"FlexRep status page is slow, querying individual target status details when it doesn't need to", "category":"Replication", "severity":"Performance", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"mhelmstetter", "name":"Mark Helmstetter", "email":"mark.helmstetter@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"The FlexRep status page can be extremely slow, especially when there are large numbers of errors across a large number of domains.\r\n\r\nIn Admin/lib/database-replication-form.xqy:434 it is passing fn:true() to the domain-status() call. I'm pretty sure the target status isn't needed/used there (I've hacked our local copy), and this is making the status page much slower than it needs to be.\r\n", "samplequery":"", "sampledata":"", "version":"5.0-4.1", "tofixin":"5.0-5", "fixedin":"5.0-5", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"mhelmstetter", "name":"Mark Helmstetter", "email":"mark.helmstetter@marklogic.com"}, {"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, {"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, {"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[20431, 20432], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["Replication", "mhelmstetter"], "changeHistory":[{"time":"2013-01-08T17:07:57.87225-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}}}, "files":[], "show":true, "comment":"Low-hanging fruit, since Mark gave the code change suggestion?"}, {"time":"2013-01-08T17:07:57.87225-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-08T17:07:57.87225-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-5"}}, "files":[], "show":true}, {"time":"2013-01-09T10:50:11.717583-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Megha,\r\n\r\nDo we have tests for this page? I want to make sure there are no regressions with this change. I would like if there were QA tests to verify that there are no regressions. Thanks."}, {"time":"2013-01-09T13:19:25.058486-08:00", "updatedBy":{"username":"mhelmstetter", "name":"Mark Helmstetter", "email":"mark.helmstetter@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"There seem to be some deeper performance issues with cases where there are large numbers of flexrep errors. I haven't had the time to dig into them yet. But I think this fix is easy (and should be safe based on our usage) and does help a bit on the main status page."}, {"time":"2013-01-10T18:13:12.088086-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Thanks Mark. I will take your word for it and get this fix in. "}, {"time":"2013-01-10T18:21:36.616666-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"127376", "paths":["xdmp/branches/b5_0/src/Admin/lib/database-replication-form.xqy"], "affectedBugs":[]}, "comment":"bug:20394 FlexRep status page is slow, querying individual target status details when it doesn't need to"}, {"time":"2013-01-10T18:24:44.373673-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"127377", "paths":["xdmp/trunk/src/Admin/lib/database-replication-form.xqy"], "affectedBugs":[]}, "comment":"bug:20394 FlexRep status page is slow, querying individual target status details when it doesn't need to"}, {"time":"2013-01-10T18:27:22.487895-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"127378", "paths":["xdmp/branches/b6_0/src/Admin/lib/database-replication-form.xqy"], "affectedBugs":[]}, "comment":"bug:20394 FlexRep status page is slow, querying individual target status details when it doesn't need to"}, {"time":"2013-01-10T18:29:17.377374-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}}}, "files":[], "show":true, "comment":"Megha,\r\n\r\nPLease assign to right QA person. THanks"}, {"time":"2013-01-10T18:29:17.377374-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-28T14:03:02.609055-08:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Steps to reproduce this bug: (From Mark)\r\n\r\nProbably the easiest way that I can think of would be to setup FlexRep between 2 servers and then break the destination server (shut it down or disable the app server). You may need to setup a relatively large number of domains and corresponding targets in order to amplify the problem, e.g. In our case we have about 50 domains each with 1 or 2 targets.\r\n\r\nOnce you have it setup and have the destination severed such that every document will error, load about 50-100k documents per domain. That should be enough to illustrate the problem. Let me know if you have questions or need help."}, {"time":"2013-01-29T16:17:19.650747-08:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Larry, I am giving you this bug for verification. This requires understanding of Flexible replication as it requires quite a bit of setup (See steps from Mike in my earlier comment). If you are not the right person, please assign to someone else as appropriate"}, {"time":"2013-01-29T16:17:29.704983-08:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-30T09:39:55.537975-08:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"giving to maha since she has the flexrep stress test"}, {"time":"2013-01-30T09:39:55.537975-08:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-04T16:19:37.155232-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"I tested this on the flexrep stress test environment on build 5.0-20130125. I have only 1 machine on the Master side and one on the Replica side. But after kicking off the cpox-load, I disabled the app-server on the replica and checked the flexrep status page on the Master. The number of error documents kept increasing and the response time is very low for every refresh of the page. I assume that verifies the fix. If there is anything more to it, please let me know. Thanks!!"}, {"time":"2013-02-25T21:21:26.131123-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-02-25T21:21:26.131123-08:00", "fixedAt":"2013-01-10T18:29:17.377374-08:00", "fixedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "shippedAt":"2013-02-04T16:19:37.155232-08:00", "shippedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "closedAt":"2013-02-25T21:21:26.131123-08:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}