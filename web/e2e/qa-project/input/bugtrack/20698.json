{"id":20698, "kind":"Bug", "createdAt":"2013-02-04T15:08:42.864891-08:00", "status":"Closed", "title":"[TRIAGED_10_11} Unsupported character encoding: utf-8le running MLCP with -content_encoding utf-8", "category":"mlcp", "severity":"Major", "priority":{"level":"1", "title":"Required for product release"}, "submittedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"\r\n\r\nCommand:\r\ncom.marklogic.contentpump.ContentPump import -username admin -password admin -host jsolis.marklogic.com -port 5275 -copy_collections true -copy_permissions true -copy_properties true -copy_quality true -input_file_path /space/jsolis/b6_0/qa/mlcp/data/xml/bigdata -input_file_type documents -content_encoding utf-8le -input_file_pattern doc108.*\r\n\r\nstderr/out from shell cmd: 13/02/04 15:03:18 INFO contentpump.LocalJobRunner: Content type is set to MIXED.  The format of the  inserted documents will be determined by the MIME  type specification configured on MarkLogic Server.\r\nstderr/out from shell cmd: 13/02/04 15:03:18 INFO jvm.JvmMetrics: Initializing JVM Metrics with processName=JobTracker, sessionId=\r\nstderr/out from shell cmd: 13/02/04 15:03:18 INFO input.FileInputFormat: Total input paths to process : 11\r\nstderr/out from shell cmd: 13/02/04 15:03:20 INFO contentpump.LocalJobRunner:  completed 100%\r\ncom.marklogic.contentpump.ContentPump import -username admin -password admin -host jsolis.marklogic.com -port 5275 -copy_collections true -copy_permissions true -copy_properties true -copy_quality true -input_file_path /space/jsolis/b6_0/qa/mlcp/data/xml/bigdata -input_file_type documents -content_encoding utf-8le -input_file_pattern doc108.*\r\nstderr/out from shell cmd: 2013-02-04 15:03:49.116 WARNING [10] (AbstractRequestController.runRequest): Error parsing HTTP headers: Premature EOF, partial header line read: ''\r\n\r\nResults in the following errors from ErrorLog.txt:\r\n2013-02-04 15:03:49.115 Error: XDBCConnectionTask::run: XDMP-ENCODING: (err:XQST0087) Unsupported character encoding: utf-8le\r\n2013-02-04 15:04:19.277 Error: XDBCConnectionTask::run: XDMP-ENCODING: (err:XQST0087) Unsupported character encoding: utf-8le\r\n2013-02-04 15:04:49.563 Error: XDBCConnectionTask::run: XDMP-ENCODING: (err:XQST0087) Unsupported character encoding: utf-8le\r\n2013-02-04 15:05:20.097 Error: XDBCConnectionTask::run: XDMP-ENCODING: (err:XQST0087) Unsupported character encoding: utf-8le\r\n2013-02-04 15:05:51.133 Error: XDBCConnectionTask::run: XDMP-ENCODING: (err:XQST0087) Unsupported character encoding: utf-8le\r\n2013-02-04 15:06:12.564 Error: XDBCConnectionTask::run: XDMP-ENCODING: (err:XQST0087) Unsupported character encoding: utf-8le\r\n\r\nThis is occurring on the latest 60 build: MarkLogic-6.0-20130204.x86_64. The test case is bug19093.xml and it first started failing on 1/23/2013/\r\n\r\n", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-1", "fixedin":"7.0-1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, {"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, {"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, {"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[24650], "cloneOf":20697, "support":{"headline":"mlcp import hangs if content encoding set to an invalid encoding", "supportDescription":"If -content_encoding is set to an invalid encoding, such as UTF-8LE, mlcp hangs and keep printing the following warning:\r\nWARNING [10] (AbstractRequestController.runRequest): Error parsing HTTP headers: Premature EOF, partial header line read: '' ", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":"Ctrl+C\r\nthen rerun mlcp with an valid encoding"}, "tags":["mlcp", "jsolis"], "changeHistory":[{"time":"2013-02-04T15:08:42.864891-08:00", "updatedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "change":{"assignTo":{"from":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "to":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-04T15:11:59.758592-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"assignTo":{"from":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-04T15:11:59.758592-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-02-04T15:22:20.896036-08:00", "updatedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This is occurring on latest 70 build: MarkLogic-7.0-20130204.x86_64\r\n"}, {"time":"2013-02-04T15:51:44.952244-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Is utf8-le a standard charset? Does XCC support it?\r\n\r\nle means   little-endian byte order. However, utf8 only has one byte, there is no difference of the \"ording\" for the single byte.\r\n\r\nhttp://docs.oracle.com/javase/6/docs/api/java/nio/charset/Charset.html"}, {"time":"2013-02-06T12:34:18.671967-08:00", "updatedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "change":{"assignTo":{"from":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "to":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-06T12:35:50.412032-08:00", "updatedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"After digging into this a little more, utf8-le should result in XDMP-ENCODING from the server side. XCC was able to handle this before but on 1/22 XCC began throwing Premature EOF, partial header line errors. So seems something changed in XCC. Will most likely re-assign to XCC."}, {"time":"2013-02-12T10:49:55.269199-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-02-27T12:28:34.419913-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea1", "to":"7.0-ea2"}}, "files":[], "show":true}, {"time":"2013-03-06T13:47:43.805447-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea2", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-03-06T15:42:55.780644-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Jane, this bug is considered to be regression in b7-ea1.\r\nSince you already have the clone one on 6.0-4, I assign this bug to you."}, {"time":"2013-03-06T15:42:55.780644-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-06T15:45:50.827495-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I don't think this is a regression.  Please talk to me if you have any questions."}, {"time":"2013-03-06T15:45:50.827495-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea1", "to":"7.0-ea2"}}, "files":[], "show":true}, {"time":"2013-04-17T15:51:46.720589-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea2", "to":"7.0-ea3"}}, "files":[], "show":true}, {"time":"2013-06-18T08:53:31.779695-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea3", "to":"7.0-1"}}, "files":[], "show":true}, {"time":"2013-08-16T12:36:17.736985-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I don't reproduce this.  I'm getting this instead:\r\n\r\n13/08/16 12:17:28 ERROR mapreduce.ContentWriter: com.marklogic.xcc.exceptions.ServerResponseException: Unrecognized response code (415). Is this an XDBC server?\r\n [Session: user=admin, cb={default} [ContentSource: user=admin, cb={none} [provider: address=jchen.marklogic.com/127.0.0.1:5275, pool=0/64]]]\r\n [Client: XCC/7.0-1]\r\n"}, {"time":"2013-08-19T10:31:41.159586-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"For my own note:\r\n\r\n1) I cannot reproduce the premature EOF error.  I got the above error instead.  So need to think about a strategy to cover all possible error code the server sends in a more graceful way.\r\n2) This is an invalid setting on the client side.  Because mlcp continues with the next document when an error from the server is thrown, mlcp keeps sending the next document even when there's an error.  Need to think about introducing a max_error_tolerated parameter so that mlcp stops in a controlled manner.\r\n\r\nAlso see 23464 for the same behavior, but not sure why I can't reproduce."}, {"time":"2013-09-30T14:13:35.884827-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"assignTo":{"from":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-10-09T20:57:34.460035-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Continue to investigate"}, {"time":"2013-10-10T11:47:37.4778-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true, "comment":"Reproduced this problem.\r\n\r\nSaw the following on server side:\r\nError: XDBCRequestTask::run: XDMP-ENCODING: (err:XQST0087) Unsupported character encoding: UTF-8LE\r\n\r\nsaw the following on client side:\r\ncom.marklogic.xcc.exceptions.ServerResponseException: Unrecognized response code (415). Is this an XDBC server?"}, {"time":"2013-10-11T11:06:02.369014-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"153452", "paths":["xcc/trunk/xcc/src/java/com/marklogic/xcc/impl/handlers/BadMethodHandler.java", "xcc/trunk/xcc/src/java/com/marklogic/xcc/impl/handlers/EntityTooLargeHandler.java", "xcc/trunk/xcc/src/java/com/marklogic/xcc/impl/handlers/UnSupportedTypeHandler.java", "xcc/trunk/xcc/src/java/com/marklogic/xcc/impl/handlers/ContentInsertController.java"], "affectedBugs":[]}, "comment":"Bug:20698\nadd a few error handlers"}, {"time":"2013-10-11T11:24:16.606187-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true, "comment":"\"com.marklogic.xcc.exceptions.RequestException: Unsupported Media Type \" on client side should be  caught in case unsupported character encoding is set in mlcp"}, {"time":"2013-10-11T11:24:16.606187-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-10-11T17:03:50.497951-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true, "comment":"need some change on mlcp side to control the max # errors"}, {"time":"2013-10-11T17:03:50.497951-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-10-12T19:44:42.647327-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"[TRIAGED_10_11] Jane to update the defect with ETA. We want to fix the defects as early as possible next week to give some time for nightly build to stabilize"}, {"time":"2013-10-14T09:39:11.62418-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"With the partial code checkin, XCC catches exception for inserting small doc of unsupported character encoding. But for Julio's test (files are ~100kb each), it still shows Premature EOF after a long wait (~10 minutes). I need to debug the both xcc and server to further investigate.\r\n\r\nOther than that, additional changed needed to control the max # errors on xcc side."}, {"time":"2013-10-16T11:11:01.768194-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"In Julio's test, as the input file is relatively big, input files are chunk-encoded and streamed in. For example, an input file is split into two chunks. When reading the first chunk, exception is thrown because of invalid charset utf-8le, therefore only one out of two chunks has been read, resulting in Premature EOF."}, {"time":"2013-10-16T13:04:59.025941-07:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This reminds me of 19150.  Even when we throw an error, we need to drain and we can't shut down the channel.  That's what I learned from that bug."}, {"time":"2013-10-17T23:14:20.822314-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"154124", "paths":["xcc/trunk/mlcp/src/main/java/com/marklogic/contentpump/Command.java"], "affectedBugs":[]}, "comment":"bug:20698\ncheck whether encoding is valid"}, {"time":"2013-10-17T23:25:30.965398-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"If input file is not chunk-encoded during insert, when an invalid content_encoding is used, 415 error is caught and handled by revision 153452.\r\nIf input file is large enough to be chunk-encoded, server tries to send out a 415 response but nothing got sent out but a FIN ( based on tcpdump analysis). This takes more time to investigate. For now, we fix it on mlcp side to throw exception on mlcp side so that mlcp won't hang in this scenario.\r\n\r\nWe will clone this bug so as to investigate this permature eof further in 7.0-2 time frame."}, {"time":"2013-10-17T23:28:48.268167-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true, "comment":"the following exception should be thrown if an invalid content_encoding (e.g., utf-8le) is set in mlcp command-line.\r\n\"java.lang.IllegalArgumentException: UTF-8LE encoding is not supported\"\r\n\r\nplease test."}, {"time":"2013-10-17T23:28:48.268167-07:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-10-21T16:12:32.32238-07:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-10-21T17:10:32.152476-07:00", "updatedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"For reference this bug is tested by:  bug19093.xml"}, {"time":"2013-10-21T17:10:32.152476-07:00", "updatedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "change":{"tofixin":{"from":"7.0-2", "to":"7.0-1"}}, "files":[], "show":true}, {"time":"2013-10-22T15:29:06.26447-07:00", "updatedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on build MarkLogic-7.0-20131022.x86_64. Re-enabled test bug19093.xml."}], "updatedAt":"2013-10-22T15:29:06.26447-07:00", "fixedAt":"2013-10-17T23:28:48.268167-07:00", "fixedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "shippedAt":"2013-10-22T15:29:06.26447-07:00", "shippedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "renderDescriptionAs":"normal"}