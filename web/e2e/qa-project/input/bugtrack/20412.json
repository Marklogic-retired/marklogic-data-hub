{"id":20412, "kind":"Bug", "createdAt":"2009-10-23T14:21:00.677227-07:00", "status":"Closed", "title":"Misleading XDMP-REQUTF8SEQ 500 Error response when the request has a malformed query string", "category":"xdmp", "severity":"Minor", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"ebloch", "name":"Eric Bloch", "email":"eric.bloch@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Send a MarkLogic server and URL like http://foo/bar.xqy?q=%E7\r\n\r\nNote that %E7 is not a valid character in UTF-8.  (In latin-1 it is lower case c with a cedilla).\r\n\r\nThe server sends back an inappropriate 500 Error with\r\n\r\nXDMP-REQUTF8SEQ: Invalid UTF-8 escape sequence -- request headers are not UTF-8 encoded\r\nin /browse.xqy [0.9-ml]\r\n\r\nIn truth, there is an invalid escape sequence in the status line (query string) and not the request headers.\r\n\r\nAlso, this request should not really generate a 500 error.  (Try an URL like that at apache httpd or google for example).  Appropriate behavior more inline with the 2616 rfc would be to log an error or warning and simply skip over the invalid bits (or the entire query string).  500 errors are intended for actual internal failures/errors as opposed to bad incoming data.  Another choice would be to send a 400 (Bad request) response (which, when seen in a deployment, can safely be ignored).\r\n\r\nI\"m reporting this against 3.2 and 4.0.\r\n\r\n", "samplequery":"", "sampledata":"", "version":"6.0-1", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"ebloch", "name":"Eric Bloch", "email":"eric.bloch@marklogic.com"}, {"username":"cwang", "name":"Chonghai Wang", "email":"cwang@marklogic.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, {"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":8976, "support":{"headline":"Misleading XDMP-REQUTF8SEQ 500 Error returned when the request has a malformed query string", "supportDescription":"When sending a request containing an invalid UTF-8 character in the query string to MarkLogic Server, the server responds with an inappropriate 500 Error: XDMP-REQUTF8SEQ: Invalid UTF-8 escape sequence -- request headers are not UTF-8 encoded. The problem is with the query string, not the request headers.\r\n", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "ebloch"], "changeHistory":[{"time":"2009-10-26T15:45:28.585044-07:00", "updatedBy":{"username":"schen", "name":"Sidney Chen", "email":"schen@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"schen", "name":"Sidney Chen", "email":"schen@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"This may also exist in 4.0 and 4.1 but this bug is filed for logging purposes and there is no real need to fix. "}, {"time":"2009-11-04T10:38:39.171549-08:00", "updatedBy":{"username":"schen", "name":"Sidney Chen", "email":"schen@marklogic.com"}, "change":{"assignTo":{"from":{"username":"schen", "name":"Sidney Chen", "email":"schen@marklogic.com"}, "to":{"username":"aagrawal", "name":"Andy Agrawal", "email":"aagrawal@marklogic.com"}}}, "files":[], "show":true}, {"time":"2009-11-04T10:38:50.672332-08:00", "updatedBy":{"username":"schen", "name":"Sidney Chen", "email":"schen@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"schen", "name":"Sidney Chen", "email":"schen@marklogic.com"}, "to":{"username":"aagrawal", "name":"Andy Agrawal", "email":"aagrawal@marklogic.com"}}}, "files":[], "show":true, "comment":" "}, {"time":"2009-12-22T13:07:19.792061-08:00", "updatedBy":{"username":"ebloch", "name":"Eric Bloch", "email":"eric.bloch@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Fwiw, I see several of these (or more) each day at Mark Mail - it would really be nice to fix the reporting (at least in 4.2) as I have to look at each 500 error when they come in to determine whether or not it's a real problem.\r\n\r\n"}, {"time":"2012-09-13T09:18:04.996223-07:00", "updatedBy":{"username":"ebloch", "name":"Eric Bloch", "email":"eric.bloch@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I am getting hit with this on DMC every day now via bogus php attack urls - they are causing MarkLogic to send 500 errors erroneously.  DMC is currently running 5.0 - I don't know why Sidney said there was no need to fix, although it is not a high priority issue.\r\n\r\n"}, {"time":"2012-11-05T11:03:35.966104-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I am not sure why this got put in never-never land.  I moved it to 5.0-5.  You can reproduce this against any MarkLogic instance with the following:\r\n\r\ncurl --anyauth admin:password -X GET http://localhost:8000/?q=%E7"}, {"time":"2012-11-05T11:03:35.966104-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-05T11:03:35.966104-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"N/A", "to":"5.0-5"}}, "files":[], "show":true}, {"time":"2012-12-10T12:29:13.645725-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"assign to Chonghai?  Haitao can lead him to do it. "}, {"time":"2012-12-10T12:29:13.645725-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-12T17:45:41.465647-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Chonghai, you can get leadership from Haitao on this."}, {"time":"2012-12-12T17:45:41.465647-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"cwang", "name":"Chonghai Wang", "email":"cwang@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-07T21:34:49.513094-08:00", "updatedBy":{"username":"cwang", "name":"Chonghai Wang", "email":"cwang@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I found that Unicode::isUTF8() did not work correctly. When this function checks \"/foo.xqy?q=%E7\" or \"%E7\", it returns true. \"%E7\" is not a valid character in UTF-8. If Unicode::isUTF8() works fine, then the error in this bug should not exist."}, {"time":"2013-01-08T06:30:00.634-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"The isUTF8() function is not the problem here.\r\nThe isUTF8() function validates whether a string is valid UTF-8.\r\nThe string “%E7” contains the bytes %, E and 7, a perfectly valid sequence of bytes for a UTF-8 encoded string.\r\nIt is not the job of isUTF8() to valid whether a string is valid URL-encoded UTF-8.\r\n"}, {"time":"2013-01-09T11:44:22.402179-08:00", "updatedBy":{"username":"cwang", "name":"Chonghai Wang", "email":"cwang@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"127225", "paths":["xdmp/branches/b5_0/src/AppServer.cpp", "xdmp/branches/b5_0/src/Messages/XDMP-en.xml"], "affectedBugs":[]}, "comment":"bug:8976 update the code to send a 400 response for the request"}, {"time":"2013-01-09T11:52:12.425137-08:00", "updatedBy":{"username":"cwang", "name":"Chonghai Wang", "email":"cwang@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"127226", "paths":["xdmp/branches/b6_0/src/Messages/XDMP-en.xml", "xdmp/branches/b6_0/src/AppServer.cpp"], "affectedBugs":[]}, "comment":"bug:20412 update the code to send a 400 response for the request"}, {"time":"2013-01-09T12:09:09.515654-08:00", "updatedBy":{"username":"cwang", "name":"Chonghai Wang", "email":"cwang@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"127227", "paths":["xdmp/trunk/src/Messages/XDMP-en.xml", "xdmp/trunk/src/AppServer.cpp"], "affectedBugs":[]}, "comment":"bug:20412 update the code in trunk to send a 400 error for the request"}, {"time":"2013-01-09T12:14:41.87573-08:00", "updatedBy":{"username":"cwang", "name":"Chonghai Wang", "email":"cwang@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"cwang", "name":"Chonghai Wang", "email":"cwang@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"I misunderstood the function isUTF8(). It works correctly. I updated the code and now a 400 response is sent for this request."}, {"time":"2013-01-09T12:14:41.87573-08:00", "updatedBy":{"username":"cwang", "name":"Chonghai Wang", "email":"cwang@marklogic.com"}, "change":{"assignTo":{"from":{"username":"cwang", "name":"Chonghai Wang", "email":"cwang@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-09T14:38:04.476627-08:00", "updatedBy":{"username":"cwang", "name":"Chonghai Wang", "email":"cwang@marklogic.com"}, "change":{"tofixin":{"from":"5.0-5", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-01-25T14:21:21.224506-08:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{"assignTo":{"from":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "to":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-25T14:51:37.267565-08:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"129399", "paths":["qa/branches/b6_0/app/bug20412.xqy", "qa/branches/b6_0/scripts/keys/bug20412.xml", "qa/branches/b6_0/scripts/list/bugs50.txt", "qa/branches/b6_0/scripts/tests/bug20412.xml"], "affectedBugs":[]}, "comment":"bug:20412"}, {"time":"2013-01-25T14:51:52.875754-08:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-25T14:51:52.875754-08:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{"assignTo":{"from":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-22T16:23:39.123902-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-04-22T16:23:39.123902-07:00", "fixedAt":"2013-01-09T12:14:41.87573-08:00", "fixedBy":{"username":"cwang", "name":"Chonghai Wang", "email":"cwang@marklogic.com"}, "shippedAt":"2013-01-25T14:51:52.875754-08:00", "shippedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "closedAt":"2013-04-22T16:23:39.123902-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}