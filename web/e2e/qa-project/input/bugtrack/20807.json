{"id":20807, "kind":"Bug", "createdAt":"2013-02-15T13:34:59.538545-08:00", "status":"Closed", "title":"NOT_IN query is throwing an error when running it using operator options", "category":"Search API", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Build: 7.0-20130213\r\n\r\nSteps:\r\n=====\r\n1) Run this query\r\n\r\nxquery version \"1.0-ml\";\r\nimport module namespace search = \"http://marklogic.com/appservices/search\"\r\n    at \"/MarkLogic/appservices/search/search.xqy\";\r\n    \r\nlet $options :=\r\n<options xmlns=\"http://marklogic.com/appservices/search\">\r\n  <return-results>true</return-results>\r\n  <operator name=\"sort\">\r\n    <state name=\"relevance\">\r\n      <sort-order>\r\n         <score/>\r\n      </sort-order>\r\n     </state>\r\n   </operator>  \r\n</options>\r\n\r\nreturn \r\nsearch:search('sort:summer NOT_IN \"summer time\"', $options)\r\n\r\nActual Result\r\n===========\r\n[1.0-ml] XDMP-QUERYELEM: cts:query(<cts:not-in-query qtextjoin=\"NOT_IN\" strength=\"35\" qtextgroup=\"( )\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:cts=\"http://marklogic.com/cts\"><cts:positive qtextref=\"schema-element(cts:query)\"/><cts:negativ...</cts:not-in-query>) -- Query element contains unknown child: /cts:not-in-query/cts:positive\r\n\r\nExpected Result\r\n=============\r\nShould not return an error\r\n\r\nIf I have:\r\nsearch:search('sort:summer AND \"summer time\"', $options)\r\nthis query doesn't return an error", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea1", "fixedin":"7.0-ea1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, {"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["Search API", "ayuwono"], "changeHistory":[{"time":"2013-02-15T13:34:59.538545-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-19T12:41:49.596143-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true, "comment":"You're right about the behavior, but I'm not sure what the fix should be.  The query as you have it written is indeed invalid, because NOT_IN requires a query before NOT_IN and another one after it.\r\n\r\nYour test case has a predicate that evaluates to no query before NOT_IN.  So it's translated underneath to an empty <cts:positive/> element, which is invalid.\r\n\r\nI think the right answer here is to rethrow some kind of error, but I'll investigate what that error should be."}, {"time":"2013-02-19T12:43:01.490307-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Probably Search API should do the same thing as for this\r\n\r\nsearch:search('NOT_IN \"summer time\"', $options) \r\n\r\nwhich is interpreting NOT_IN as text, not as a joiner.\r\n"}, {"time":"2013-02-20T13:45:47.025026-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea1", "to":"7.0-ea2"}}, "files":[], "show":true}, {"time":"2013-02-20T14:10:41.809103-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I've got a fix together for this.  It doesn't unparse properly though, so I need to consult with strategies for configuring the unparse step."}, {"time":"2013-03-06T16:57:10.460676-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}}}, "files":[], "show":true, "comment":"Hi Aries, this is fixed now as a result of remove-constraint implementation.\r\n\r\nIt won't throw an error any more, but this will not behave as you might thing because there's no valid left-hand side to NOT_IN.\r\n"}, {"time":"2013-03-06T16:57:10.460676-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-06T16:57:10.460676-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea2", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-03-07T10:25:45.888155-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified passed on 03/07 build"}, {"time":"2013-03-07T10:25:45.888155-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-03-07T10:25:45.888155-08:00", "fixedAt":"2013-03-06T16:57:10.460676-08:00", "fixedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "shippedAt":"2013-03-07T10:25:45.888155-08:00", "shippedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "renderDescriptionAs":"normal"}