{"id":20313, "kind":"Bug", "createdAt":"2012-07-19T17:50:16.956636-07:00", "status":"Closed", "title":"Search API NEAR and NEAR/10 inconsistent behavior", "category":"search", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"sravotto", "name":"Silvano  Ravotto", "email":"sravotto@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"\r\ncts:contains(text {\"a 0 1 2 3 4 5 6 7 8  b 0 1 2 3 4 5 6 7 8  c\"}, cts:query(search:parse(\"a NEAR b NEAR c\") ))  \r\n\r\n>> FALSE\r\n\r\n\r\ncts:contains(text {\"a 0 1 2 3 4 5 6 7 8  b 0 1 2 3 4 5 6 7 8  c\"}, cts:query(search:parse(\"a NEAR/10 b NEAR/10 c\") ))  \r\n\r\n>> TRUE\r\n\r\nQuery are parsing differently if you use NEAR vs NEAR/ operator.\r\n\r\n\r\n\r\nsearch:parse(\"a NEAR b NEAR c\")\r\n\r\n\r\n\r\n<cts:near-query qtextjoin=\"NEAR\" strength=\"30\" qtextgroup=\"( )\" xmlns:cts=\"http://marklogic.com/cts\">\r\n\r\n    <cts:word-query qtextref=\"cts:text\">\r\n\r\n      <cts:text>a</cts:text>\r\n\r\n    </cts:word-query>\r\n\r\n    <cts:word-query qtextref=\"cts:text\">\r\n\r\n      <cts:text>b</cts:text>\r\n\r\n    </cts:word-query>\r\n\r\n    <cts:word-query qtextref=\"cts:text\">\r\n\r\n      <cts:text>c</cts:text>\r\n\r\n    </cts:word-query>\r\n\r\n  </cts:near-query>\r\n\r\n\r\n\r\nsearch:parse(\"a NEAR/10 b NEAR/10 c\")\r\n\r\n\r\n\r\n<cts:near-query distance=\"10\" qtextjoin=\"NEAR/10\" strength=\"30\" xmlns:cts=\"http://marklogic.com/cts\">\r\n\r\n    <cts:near-query distance=\"10\" qtextjoin=\"NEAR/10\" strength=\"30\">\r\n\r\n      <cts:word-query qtextref=\"cts:text\">\r\n\r\n       <cts:text>a</cts:text>\r\n\r\n      </cts:word-query>\r\n\r\n      <cts:word-query qtextref=\"cts:text\">\r\n\r\n       <cts:text>b</cts:text>\r\n\r\n      </cts:word-query>\r\n\r\n    </cts:near-query>\r\n\r\n    <cts:word-query qtextref=\"cts:text\">\r\n\r\n      <cts:text>c</cts:text>\r\n\r\n    </cts:word-query>\r\n\r\n  </cts:near-query\r\n\r\n", "samplequery":"", "sampledata":"", "version":"6.0-nightly", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"sravotto", "name":"Silvano  Ravotto", "email":"sravotto@marklogic.com"}, {"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, {"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, {"username":"cwhitney", "name":"Colleen  Whitney", "email":"colleen.whitney@marklogic.com"}, {"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, {"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, {"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":18425, "support":{"headline":"Search expressions with more than one NEAR make outer terms seem NEAR too.", "supportDescription":"For search terms of the form \"a NEAR b NEAR c\" only returns results where a is NEAR c.  Expectation is that a is NEAR b  and b NEAR c but not necessarily a NEAR c.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":"Express as an AND query i.e. \"a NEAR b and b NEAR c\"."}, "tags":["search", "sravotto"], "changeHistory":[{"time":"2012-07-20T12:58:45.685487-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2012-07-20T12:58:45.685487-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2012-07-20T12:58:45.685487-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-4"}}, "files":[], "show":true}, {"time":"2012-07-20T18:19:16.292498-07:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"cwhitney", "name":"Colleen  Whitney", "email":"colleen.whitney@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-06T14:44:06.573331-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Micah,\r\n\r\nPlease look at this and let us know if this is a bug and if this needs fixing in 5.0-5. If not, please give the reason why. Thanks"}, {"time":"2012-12-06T14:44:06.573331-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-06T14:54:35.197564-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"It looks like the opt-pattern-1 optimization is kicking in for the NEAR case, but it's not implemented for NEAR/. Not sure if different results from this parsing is expected or not.\r\n\r\nAt one point, we made the optimization only happen for AND/OR. I wonder if that needs to be reinstated... -m"}, {"time":"2012-12-10T10:47:55.656151-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"As we discussed, let's make this optimization enabled only for AND & OR."}, {"time":"2012-12-10T10:47:55.656151-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{"assignTo":{"from":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-17T13:32:44.425359-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true, "comment":"Agreed on pathology and fix.    However this IS a change to search semantics.  Current search semantics indicates that\r\n\r\na NEAR b NEAR c   entails   a NEAR c\r\n\r\nThis is currrently not true with NEAR/\r\n\r\nThis fix causes unit test cases to change and almost certainly QA regressions as well.   I can work up a patch fairly quickly given we agree on the solution."}, {"time":"2012-12-17T14:10:39.44198-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Verified and I can see where NEAR cannot be treated the same as the other infix operators."}, {"time":"2012-12-17T14:10:39.44198-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-19T13:51:01.296277-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified and have a patch proposal.  About to clone."}, {"time":"2012-12-19T14:47:43.349807-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2012-12-20T16:50:14.954492-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"124879", "paths":["xdmp/branches/b6_0/src/Apps/test/appservices/search-unittest/parse-unittest.xqy", "xdmp/branches/b6_0/src/Modules/MarkLogic/appservices/search/search-impl.xqy", "xdmp/branches/b6_0/src/Modules/MarkLogic/appservices/search/ast.xqy"], "affectedBugs":[]}, "comment":"bug:20313  NEAR can't optimize like other infix operators."}, {"time":"2012-12-20T17:02:07.387037-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}}}, "files":[], "show":true, "comment":"Hi Megha,\r\n\r\nThis bug can be reproduced easily with the expression at the top of the ticket.  Before this patch:\r\n\r\ncts:contains(text {\"a 0 1 2 3 4 5 6 7 8 b 0 1 2 3 4 5 6 7 8 c\"}, cts:query(search:parse(\"a NEAR b NEAR c\") )) \r\nwas false (because a is not NEAR c)\r\n\r\nnow it's true.\r\n\r\nThis is a change in behavior, so there may be regressions.\r\n\r\n"}, {"time":"2012-12-20T17:02:07.387037-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-21T17:32:08.605739-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I moved the fix-in and fixed-in to 6.0-3, because if it is checked in now, then it is in 6.0-3."}, {"time":"2012-12-21T17:32:08.605739-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"6.0-4", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-03-12T11:05:49.230496-07:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Aries, you already verified the clone 18425 and I believe you must have checked in the test for this. Please check the same test into 6.0 and ship this."}, {"time":"2013-03-12T11:05:49.230496-07:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "to":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-29T13:54:40.943143-07:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "to":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-01T11:01:26.631792-07:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Automated test searchAPI-bug20313.xml is added to regression and is passing on 6.0 0401 nightly run"}, {"time":"2013-04-01T11:01:26.631792-07:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-22T16:31:42.941241-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-04-22T16:31:42.941241-07:00", "fixedAt":"2012-12-20T17:02:07.387037-08:00", "fixedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "shippedAt":"2013-04-01T11:01:26.631792-07:00", "shippedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "closedAt":"2013-04-22T16:31:42.941241-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}