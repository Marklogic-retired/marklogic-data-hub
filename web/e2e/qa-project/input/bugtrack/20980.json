{"id":20980, "kind":"Bug", "createdAt":"2013-02-27T14:54:01.566755-08:00", "status":"Closed", "title":"mlcp imports aggregate with uri_id could lose data", "category":"mlcp", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Found by investigating regression of bug19151. It happens intermittently.\r\n\r\nThere supposed to be 1162 docs loaded, however about 300 deleted fragments are found after ingestion. Apparently, duplicate uris are generated.\r\n\r\nrunning following shell command: /space2/qa/mlcp/runmlcp.sh /space2/qa -options_file /space2/qa/mlcp/data/agg/input-files/bug19151.txt\r\nstderr/out from shell cmd: /space2/qa/mlcp/data/agg/input-files/bug19151_tmp.txt /space2/qa/mlcp/data/agg/input-files/bug19151.txt\r\nstderr/out from shell cmd: 2013-02-27\r\nstderr/out from shell cmd: drwxrwxrwx 5 ali ali 4096 2013-02-27 14:08:25.234544706 -0800 marklogic-contentpump\r\nstderr/out from shell cmd: directory exists\r\nstderr/out from shell cmd: however, it was created today\r\nstderr/out from shell cmd: data/xml/bigdata directory exists.\r\nstderr/out from shell cmd: 13/02/27 14:36:24 DEBUG contentpump.ContentPump: Command: IMPORT\r\nstderr/out from shell cmd: 13/02/27 14:36:24 DEBUG contentpump.ContentPump: Arguments: -username admin -password admin -host ali.marklogic.com -port 5275 -mode local -input_file_path /space2/qa/mlcp/data/agg/bug19151 -input_file_type aggregates -aggregate_uri_id ArticleTitle -output_uri_replace \\[,'',\\],'',:,'' \r\nstderr/out from shell cmd: 13/02/27 14:36:24 DEBUG contentpump.ContentPump: Running in: localmode\r\nstderr/out from shell cmd: 13/02/27 14:36:24 INFO contentpump.LocalJobRunner: Content type: XML\r\nstderr/out from shell cmd: 13/02/27 14:36:24 INFO jvm.JvmMetrics: Initializing JVM Metrics with processName=JobTracker, sessionId=\r\nstderr/out from shell cmd: 13/02/27 14:36:24 DEBUG contentpump.LocalJobRunner: Thread pool size: 4\r\nstderr/out from shell cmd: 13/02/27 14:36:24 INFO input.FileInputFormat: Total input paths to process : 1\r\nstderr/out from shell cmd: 13/02/27 14:36:24 DEBUG contentpump.LocalJobRunner: Thread Count for Split#0 : 4\r\nstderr/out from shell cmd: 13/02/27 14:36:24 DEBUG contentpump.MultithreadedMapper: Running with 4 threads\r\nstderr/out from shell cmd: 13/02/27 14:36:25 INFO contentpump.LocalJobRunner:  completed 0%\r\nstderr/out from shell cmd: 13/02/27 14:36:26 INFO contentpump.LocalJobRunner:  completed 26%\r\nstderr/out from shell cmd: 13/02/27 14:36:27 INFO contentpump.LocalJobRunner:  completed 63%\r\nstderr/out from shell cmd: 13/02/27 14:36:28 INFO contentpump.LocalJobRunner:  completed 92%\r\nstderr/out from shell cmd: 13/02/27 14:36:31 INFO contentpump.LocalJobRunner:  completed 100%\r\nstderr/out from shell cmd: 13/02/27 14:36:31 INFO contentpump.LocalJobRunner: com.marklogic.contentpump.ContentPumpStats: \r\nstderr/out from shell cmd: 13/02/27 14:36:31 INFO contentpump.LocalJobRunner: ATTEMPTED_INPUT_RECORD_COUNT: 1177\r\nstderr/out from shell cmd: 13/02/27 14:36:31 INFO contentpump.LocalJobRunner: SKIPPED_INPUT_RECORD_COUNT: 0\r\nstderr/out from shell cmd: 13/02/27 14:36:31 INFO contentpump.LocalJobRunner: Total execution time: 7 sec\r\nstderr/out from shell cmd: removing temp file /space2/qa/mlcp/data/agg/input-files/bug19151_tmp.txt\r\n\r\nBy enabling debug log level, it shows MultithreadedMapper is used. By setting thread_count to 1 (use DocumentMapper) seems to make the problem goes away. I suspect it is a bug in MultithreadedMapper.", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea2", "fixedin":"7.0-ea2", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, {"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20964, "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["mlcp", "ali"], "changeHistory":[{"time":"2013-02-27T14:54:01.566755-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-27T14:55:48.992605-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true, "comment":"As it causes losing data, it is worth fixing in 7.0-ea1."}, {"time":"2013-02-28T13:16:07.941029-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The bug is a synchronization issue of multi-threads in MultithreadedMapper. \r\nThe fix is to synchronize the following three operations as a whole so that these three operations do not get overlapped: nextKeyValue, getCurrentKey, getCurrentValue.\r\n"}, {"time":"2013-02-28T16:35:49.51617-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"clone to trunk"}, {"time":"2013-02-28T16:35:49.51617-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea2"}}, "files":[], "show":true}, {"time":"2013-03-06T23:49:46.818086-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"135389", "paths":["xcc/trunk/mlcp/src/main/java/com/marklogic/contentpump/MultithreadedMapper.java", "xcc/trunk/mlcp/src/main/java/com/marklogic/contentpump/InputType.java", "xcc/trunk/mlcp/src/main/java/com/marklogic/contentpump/DocumentMapper.java", "xcc/trunk/mlcp/src/main/java/com/marklogic/contentpump/Command.java", "xcc/trunk/mlcp/src/main/java/com/marklogic/contentpump/BaseMapper.java"], "affectedBugs":[]}, "comment":"bug:20980\n-add BaseMapper\n-make MultithreadedMapper thread-safe"}, {"time":"2013-03-07T00:02:25.939931-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true, "comment":"Please keep an eye on bug19151 in regression."}, {"time":"2013-03-07T00:02:25.939931-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-10T15:16:24.615668-07:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on build 7.0-20130410"}], "updatedAt":"2013-04-10T15:16:24.615668-07:00", "fixedAt":"2013-03-07T00:02:25.939931-08:00", "fixedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "shippedAt":"2013-04-10T15:16:24.615668-07:00", "shippedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "renderDescriptionAs":"normal"}