{"id":20429, "kind":"Bug", "createdAt":"2013-01-09T16:13:03.412405-08:00", "status":"Closed", "title":"back slash is lost when doing JSON->XML->JSON", "category":"xdmp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Here's one of the test in regression\r\n\r\n-----------------------------------------------------\r\nxquery version \"1.0-ml\";\r\nimport module namespace json = \"http://marklogic.com/xdmp/json\" at \"/MarkLogic/json/json.xqy\";\r\ndeclare option xdmp:mapping \"false\";\r\n\r\nlet $j_o := ' [ \"\\\"\\\\u000d\\\"\" ] '\r\nlet $x_d := json:transform-from-json( $j_o )\r\nlet $j_d := json:transform-to-json($x_d)\r\nlet $c := json:config(\"basic\")\r\nlet $x_b := json:transform-from-json($j_o, $c)\r\nlet $j_b := json:transform-to-json($x_b, $c)\r\n\r\nreturn (element x_d {$x_d}, element x_b {$x_b}, element j_d {$j_d}, element j_b {$j_b})\r\n-----------------------------------------------------\r\n\r\nIt returns\r\n\r\n-----------------------------------------------------\r\n<x_d>\r\n  <json type=\"array\" xmlns=\"http://marklogic.com/xdmp/json/basic\">\r\n    <item type=\"string\">\"\\u000d\"</item>\r\n  </json>\r\n</x_d>\r\n<x_b>\r\n  <json type=\"array\" xmlns=\"http://marklogic.com/xdmp/json/basic\">\r\n    <item type=\"string\">\"\\u000d\"</item>\r\n  </json>\r\n</x_b>\r\n<j_d>[\"\\\"\\u000d\\\"\"]</j_d>\r\n<j_b>[\"\\\"\\u000d\\\"\"]</j_b>\r\n-----------------------------------------------------\r\n\r\nIn returned JSON ($j_d and $j_b, [\"\\\"\\u000d\\\"\"]), there should be 2 back slashes together, but now there only 1, which is not the same as original json file ([ \"\\\"\\\\u000d\\\"\" ] ). \r\n\r\n\r\n", "samplequery":"", "sampledata":"", "version":"6.0-nightly", "tofixin":"6.0-5", "fixedin":"N/A", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, {"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20419, "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "lling"], "changeHistory":[{"time":"2013-01-09T16:13:03.412405-08:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{"assignTo":{"from":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "to":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-09T16:21:38.584101-08:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"To me it looks like the backslash is being eliminated (correctly) by the XQuery parser of literal strigns, not by the JSON conversion\r\n\r\nlet $j_o := ' [ \"\\\"\\\\u000d\\\"\" ] '\r\n\r\nThe \\\\u and \\\" are being correctly turned into \\u and \"\r\nTurning back into JSON is correct without the extra \\\\ is correct I belive.\r\n\r\nCan you issolate this to reading and writing from a file to remove the XQuery parser as a culprit ?"}, {"time":"2013-01-09T16:44:44.20259-08:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"There's something similar when doing XML->JSON->XML, back slash is lost during transformation. \r\n\r\nin Test json_custom_2.xml, \r\nin Test-21, using custom strategy, it used to be\r\n<a>\\u0033</a> -> {\"a\":\"\\\\u0033\"} -> <a>\\u0033</a>\r\nNow it is\r\n<a>\\u0033</a> -> {\"a\":\"\\u0033\"} -> ><a>3</a>\r\n\r\nIn Test-23, also custom strategy\r\nit used to be \r\n<item type=\"string\">\\/    w&#13;x\r\n\\</item> \r\n-> {\"item\":{\"type\":\"string\", \"_value\":\"\\\\\\/    w\\rx\\n\\\\\"}}  \r\n\r\nNow it is\r\n<item type=\"string\">\\/    w&#13;x\r\n\\</item>\r\n-> {\"item\":{\"type\":\"string\", \"_value\":\"\\\\/    w\\rx\\n\\\\\"}}\r\n\r\n"}, {"time":"2013-01-09T16:54:21.623145-08:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The new behaviour is correct\r\n\r\n\\u0033 in XML to JSON really means the letter \"3\"\r\n\r\nThis is a special case to handle JSON data which has non valid XML unicode escapes.\r\n\r\n"}, {"time":"2013-01-09T17:22:47.777112-08:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"How about the lost back slash?  \"\\/\" is transformed to \"\\\\/\" instead of \"\\\\\\/\""}, {"time":"2013-01-09T17:26:35.268364-08:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I think all stuff above is about the slash in xml, when it is transformed to json, is it transformed to double slash or single slash. All examples above, when XML - JSON\r\n\r\n\\ -> \\\r\n/ -> \\/\r\n\r\nBefore\r\n\r\n/ -> //\r\n\\ -> /\\"}, {"time":"2013-01-09T18:39:27.011946-08:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I will study this further.  There *was* a change and it fixed a lot of thigns but definately changed things.  I am not yet convinced anything is \"wrong\" ...\r\nFirst step is to get rid of XQuery parsing ...\r\nthen look at the results and see if they make sense or not.\r\nByte-for-byte round tripping is not a requirement.\r\nOnly \"equivient parsed data\" ... where possible that is.\r\n"}, {"time":"2013-01-11T06:17:19.580996-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-02-27T13:48:58.826535-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"6.0-3", "to":"6.0-4"}}, "files":[], "show":true}, {"time":"2013-06-24T11:58:02.270561-07:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"partly fixed in Bug 22757, now the diff is the only one in \"Steps to Recreate\""}, {"time":"2013-06-24T13:40:49.510069-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"6.0-4", "to":"6.0-5"}}, "files":[], "show":true}, {"time":"2013-07-12T10:41:28.987699-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"Applied same fix as trunk (7.0) to branch (6.0)\r\nSee SVN# 146535 bug# 22798\r\n\r\n"}, {"time":"2013-07-12T10:41:28.987699-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-07-12T10:41:28.987699-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{"tofixin":{"from":"6.0-5", "to":"6.0-4"}}, "files":[], "show":true}, {"time":"2013-07-13T11:26:52.243097-07:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-07-15T15:41:01.352932-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"146789", "paths":["xdmp/branches/b6_0/src/JSONBuiltins.cpp"], "affectedBugs":[]}, "comment":"bug:20429 Revert changes to 6.0.4 - they caused regressions in REST layer\n"}, {"time":"2013-07-15T15:42:38.999746-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "to":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}}}, "files":[], "show":true, "comment":"This fix caused regressions in the REST layer.\r\nPushing this bug to 6.0.5 IF we fix it at all in the 6.0 branch.\r\nRequires REST layer changes "}, {"time":"2013-07-15T15:42:38.999746-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "to":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-07-15T15:42:38.999746-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{"tofixin":{"from":"6.0-4", "to":"6.0-5"}}, "files":[], "show":true}, {"time":"2013-08-14T06:27:21.161963-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Dup of 22798"}, {"time":"2014-02-21T13:55:07.360716-08:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"161928", "paths":["qa/branches/b6_0/scripts/keys/json_custom_1.xml", "qa/branches/b6_0/scripts/keys/json_full_1.xml", "qa/branches/b6_0/scripts/keys/json_basic_1.xml", "qa/branches/b6_0/scripts/keys/json_custom_2.xml"], "affectedBugs":["22798"]}, "comment":"bug:20429 bug:22798 In bug 20429, the fix was reverted, so reverting the key change to let regression pass"}], "updatedAt":"2014-02-21T13:55:07.360716-08:00", "fixedAt":"2013-07-12T10:41:28.987699-07:00", "fixedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "closedAt":"2013-08-14T06:27:21.161963-07:00", "closedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "renderDescriptionAs":"normal"}