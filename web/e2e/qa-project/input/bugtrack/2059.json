{"id":2059, "kind":"Bug", "createdAt":"2005-08-04T10:31:57.862809-07:00", "status":"Closed", "title":"fast order by isn't on single node systems", "category":"xdmp", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"ian", "name":"Ian Small", "email":"ian@cerisent.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"in 3.0-1, the following query:\n\nxdmp:log(\"new query\"),\nxdmp:query-trace(true()),\n(for $doc in //size-100\norder by xs:long($doc/long-100)\nreturn base-uri($doc)\n)[1 to 10],\nxdmp:query-meters()\n\nyields:\n\n  <qm:expanded-tree-cache-hits>1</qm:expanded-tree-cache-hits> \n  <qm:expanded-tree-cache-misses>26</qm:expanded-tree-cache-misses> \n  <qm:compressed-tree-cache-hits>0</qm:compressed-tree-cache-hits> \n  <qm:compressed-tree-cache-misses>16</qm:compressed-tree-cache-misses> \n\nAgainst the same dataset, the same query, running in 3.0-2, yields:\n\n  <qm:expanded-tree-cache-hits>30000</qm:expanded-tree-cache-hits> \n  <qm:expanded-tree-cache-misses>0</qm:expanded-tree-cache-misses> \n  <qm:compressed-tree-cache-hits>0</qm:compressed-tree-cache-hits> \n  <qm:compressed-tree-cache-misses>0</qm:compressed-tree-cache-misses> \n\nThere are 30000 matches to //size-100\n\nLooks to me like we broke fast order by in 3.0-2.", "samplequery":"", "sampledata":"", "version":"3.0-2", "tofixin":"3.0-3", "fixedin":"3.0-3", "platform":"linux", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"ian", "name":"Ian Small", "email":"ian@cerisent.com"}], "attachments":[], "clones":[], "cloneOf":"", "support":{"headline":"Order by not using range indexes for acceleration", "supportDescription":"In 3.0, an order by clause that makes reference to a range indexed element or attribute value should in certain situations leverage that range index to significantly accelerate query evaluation.  In 3.0-2, the optimizer is not leveraging those range indexes correctly.  Queries will evaluate more slowly than they should, but will nonetheless return correct results.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "ian"], "changeHistory":[{"time":"2005-08-04T10:32:53.001778-07:00", "updatedBy":{"username":"ian", "name":"Ian Small", "email":"ian@cerisent.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"ian", "name":"Ian Small", "email":"ian@cerisent.com"}, "to":{"username":"rwang", "name":"Rachel Link", "email":"rwang@cerisent.com"}}}, "files":[], "show":true, "comment":"rachel, please run ron hitchen's test suite to verify this bug.  if this bug is true, we will need to notify some customers running 3.0 in production."}, {"time":"2005-08-06T09:24:55.647706-07:00", "updatedBy":{"username":"ian", "name":"Ian Small", "email":"ian@cerisent.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"ian", "name":"Ian Small", "email":"ian@cerisent.com"}, "to":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}}}, "files":[], "show":true, "comment":"Fast order by results are correct but are not optimizing for at least some cases.  This has been validated in 3.0-2 and 3.0-20050805 for the queries of the following form\n\n(for $doc in //size-1\n order by xs:int($doc/tiny-1)\n return $doc\n)[1 to 10]\n\nwhere docs have no fragmentation, size-1 is not the document root, and tiny-1 is a child of size-1.  The datatype of tiny-1 does not make a difference.\n\nA test case, with test data already loaded, exists on rh3-32-3:8002.\n\nRun the following query:\nhttp://rh3-32-3:8002/test-correctness.xqy\n\nand note that the number of expanded-tree-cache fetches is unchanged whether the order by clause is evaluated in an optimized or unoptimized form.\n\nThis problem was introduced in 3.0-2, since the query tests out fine in 3.0-1 and fails in 3.0-2 and at least up until 3.0-20050805.\n"}, {"time":"2005-08-06T10:02:29.631614-07:00", "updatedBy":{"username":"ian", "name":"Ian Small", "email":"ian@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"baseline performance of this query - ie. no order by clause at all - has deteriorated significantly.  So perhaps it's not even an order by problem.\n\nI will send you comparison spreadsheets by e-mail, but here's the top-line for baseline comparisons between 3.0-1 and 3.0-20050805.\n\nFor 3.0-1:\nSort Size\tTerm Suffix\tResult Subset\tbaseline\n300\t1\t10\t0.002039\n600\t2\t10\t0.002554\n900\t3\t10\t0.002997\n1800\t6\t10\t0.003992\n3000\t10\t10\t0.005696\n\nFor 3.0-20050805:\nSort Size\tTerm Suffix\tResult Subset\tbaseline\n300\t1\t10\t0.082451\n600\t2\t10\t0.151359\n900\t3\t10\t0.198614\n1800\t6\t10\t0.328576\n3000\t10\t10\t0.485732\n"}, {"time":"2005-08-14T20:09:15.484005-07:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "to":{"username":"ian", "name":"Ian Small", "email":"ian@cerisent.com"}}}, "files":[], "show":true, "comment":"fixed in 3.0-20050815\nand in 3.1-20050815"}, {"time":"2005-08-29T16:35:42.227184-07:00", "updatedBy":{"username":"ian", "name":"Ian Small", "email":"ian@cerisent.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"ian", "name":"Ian Small", "email":"ian@cerisent.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"i have run the performance test and order by is fast again, although not as fast as 3.0-1 (see separate bug \"FLWR expressions slower by half\")"}], "updatedAt":"2005-08-29T16:35:42.227184-07:00", "fixedAt":"2005-08-14T20:09:15.484005-07:00", "fixedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "shippedAt":"2005-08-29T16:35:42.227184-07:00", "shippedBy":{"username":"ian", "name":"Ian Small", "email":"ian@cerisent.com"}, "renderDescriptionAs":"normal"}