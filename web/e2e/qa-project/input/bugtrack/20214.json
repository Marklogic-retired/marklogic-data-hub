{"id":20214, "kind":"Bug", "createdAt":"2012-12-06T08:16:52.973783-08:00", "status":"Closed", "title":"default transform on document uri for appbuilder REST server does not let binaries pass thru", "category":"App Builder", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"jfuller", "name":"Jim Fuller", "email":"jim.fuller@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"\r\nFirst: MarkLogic 6.0-2 on Mac.\r\nhttp://localhost:8040/v1/documents?uri=/profiles/images/1.png\r\n\r\nRelevant (I think) documentation<http://docs.marklogic.com/REST/GET/v1/documents>.\r\n\r\nThe parameters include\r\n\r\n*   uri (specified in the URL)\r\n*   format: accepted values are \"xml\" or \"json\"\r\n*   and some others\r\n\r\nI should mention this is an App Builder-based application, so that likely comes into play. What I'm getting is the App Builder detail page. It includes a <div id=\"content-area\"> whose content is a long hex string -- presumably my image. So I guess App Builder is set up to apply an XSL transformation. My next step is to figure out how to selectively turn that off -- I want it for the actual detail page, but I want to be able to ask for something with no transformation.\r\n\r\nI just tried adding \"&transform=\" and \"&transform=none\" to the URL, but neither worked (\"message-code\":\"PLUGIN-NOTREGISTERED\"). Can you point me in the right direction?\r\n\r\nThanks,\r\n\r\nDave.\r\n\r\nDavid Cassel", "samplequery":"", "sampledata":"", "version":"6.0-2", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"jfuller", "name":"Jim Fuller", "email":"jim.fuller@marklogic.com"}, {"username":"gghai", "name":"Gaurav Ghai", "email":"Gaurav.ghai@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["App Builder", "jfuller"], "changeHistory":[{"time":"2012-12-06T08:21:23.844087-08:00", "updatedBy":{"username":"jfuller", "name":"Jim Fuller", "email":"jim.fuller@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"the issue here is that the default transform as defined in Asserts/components/custom-resource/content.xsl is naive with respect to managing the scenario when binary content is the context.\r\n\r\n"}, {"time":"2012-12-11T03:34:16.352369-08:00", "updatedBy":{"username":"jfuller", "name":"Jim Fuller", "email":"jim.fuller@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"copying email to here for context;\r\n\r\nThere is no reliable way to pass binaries through xslt transform and make sure stuff like server content type is being set properly (our xslt does not have extended output types like saxon does for doing xsl:result-document trickery with binaries). I also think there is a related scenario in term of introspecting a document properites, but lets not expand at this stage and focus on getting Pete/David working.\r\n\r\nAfter this short analysis i've come to the conclusion that the right way to approach enabling this scenario is modification at the xslt transform plugin level … Erik seeking your sage advice here.\r\n\r\nThis would require a change in logic in Modules/MarkLogic/rest-api/models/transform-model.xqy\r\n\r\nline 345 tformod:apply-transform() function\r\n\r\nprobably needs to sniff if the content is binary in nature, something inserted at line 381\r\n\r\n               else if($content/binary())\r\n               then (xdmp:set-response-content-type(\"*/*\"),$content)\r\n\r\nwould branch the logic to output the raw content, but as you can see we also need to formulate response content type based on content (probably sniffing uri for now ?\r\n\r\nlastly, as Erik has previously mentioned (but not documented in http://docs.marklogic.com/REST/GET/v1/documents) the format url param needs to be set to binary e.g. here is an example URL that would work\r\n\r\nhttp://localhost:8013/v1/documents?uri=%2Ftestdocs%2Fstored%2Fdoc-2012-12-11T11%3A39%3A59.634965%2B01%3A00-Apps%2F%2Ftest%2Fappservices%2Fdeploy-unittest%2Fdata%2Fbinary%2Fdatabase.png&format=binary\r\n\r\nso all this works.\r\n\r\nthoughts ? specifically on;\r\n\r\n* is this valid approach\r\n* how we what to set content type … we could just set it to */* and let the browser deal with it\r\n* how to override/force to set url param format =  binary when binary content is being processed, otherwise we will have to change results widget to determine when it 'sees' a binary ..\r\n\r\n"}, {"time":"2012-12-12T03:16:33.140008-08:00", "updatedBy":{"username":"jfuller", "name":"Jim Fuller", "email":"jim.fuller@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"123747", "paths":["xdmp/trunk/src/Assets/appbuilder/components/custom-resource/content.xsl"], "affectedBugs":[]}, "comment":"initial fix for bug:20214"}, {"time":"2012-12-12T04:31:18.442108-08:00", "updatedBy":{"username":"jfuller", "name":"Jim Fuller", "email":"jim.fuller@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"jfuller", "name":"Jim Fuller", "email":"jim.fuller@marklogic.com"}, "to":{"username":"gghai", "name":"Gaurav Ghai", "email":"Gaurav.ghai@marklogic.com"}}}, "files":[], "show":true, "comment":"there is a unit test testDefect20214() that explicitly tests this e.g. if \r\nhttp://localhost:8000/test/appservices/driver.xqy?module=/test/appservices/deploy-unittest/appbuilder-unittest.xqy&setup=true&load=true&\r\n\r\npasses then this is fixed.\r\n\r\nto manually test\r\n\r\n1) deploy an app with appbuilder with binaries instead of xml\r\n2) click on link to binary from result.js\r\n3) you should get \r\n\r\ni;ve fixed this in trunk as I dont know if we have a 6.03 branch setup yet"}, {"time":"2012-12-12T04:31:18.442108-08:00", "updatedBy":{"username":"jfuller", "name":"Jim Fuller", "email":"jim.fuller@marklogic.com"}, "change":{"assignTo":{"from":{"username":"jfuller", "name":"Jim Fuller", "email":"jim.fuller@marklogic.com"}, "to":{"username":"gghai", "name":"Gaurav Ghai", "email":"Gaurav.ghai@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-13T08:05:01.225678-08:00", "updatedBy":{"username":"jfuller", "name":"Jim Fuller", "email":"jim.fuller@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"123911", "paths":["xdmp/branches/b6_0/src/Assets/appbuilder/components/custom-resource/content.xsl"], "affectedBugs":[]}, "comment":"apply fix to bug:20214 to b6_0 branch"}, {"time":"2013-03-27T13:31:37.466563-07:00", "updatedBy":{"username":"gghai", "name":"Gaurav Ghai", "email":"Gaurav.ghai@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"gghai", "name":"Gaurav Ghai", "email":"Gaurav.ghai@marklogic.com"}, "to":{"username":"jfuller", "name":"Jim Fuller", "email":"jim.fuller@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on 03/27 build.  As part of the test data i verified this bug with png , jpeg , pdf and doc .Out of which only .doc file type when i try to open from result.js it ask me to save to local drive and when i try to open it seems corrupted . \r\n\r\nI have one app for you  : http://gghai.marklogic.com:5075/   Un : au1 pwd : au1 \r\n\r\nTry accessing all the result file one by one , only the one *.doc has issue . Please suggest ."}, {"time":"2013-03-27T13:31:37.466563-07:00", "updatedBy":{"username":"gghai", "name":"Gaurav Ghai", "email":"Gaurav.ghai@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gghai", "name":"Gaurav Ghai", "email":"Gaurav.ghai@marklogic.com"}, "to":{"username":"jfuller", "name":"Jim Fuller", "email":"jim.fuller@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-28T21:06:54.172899-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This is a browser issue. In case of pdf and jpg, browser is able to render it based on its extension. In case of word document, it cannot render natively. IF you try this in IE, the browser prompts for the app to render the file in and if you choose word, the document will show up correctlt.\r\n\r\nI believe this is working as expected. If you agree, please clost it. Thx."}, {"time":"2013-03-28T21:06:54.172899-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"gghai", "name":"Gaurav Ghai", "email":"Gaurav.ghai@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-28T21:06:54.172899-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"gghai", "name":"Gaurav Ghai", "email":"Gaurav.ghai@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-29T11:08:36.368697-07:00", "updatedBy":{"username":"gghai", "name":"Gaurav Ghai", "email":"Gaurav.ghai@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"gghai", "name":"Gaurav Ghai", "email":"Gaurav.ghai@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Yes i am able to access the doc in IE browser . Thanks Ganesh . "}, {"time":"2013-03-29T11:08:36.368697-07:00", "updatedBy":{"username":"gghai", "name":"Gaurav Ghai", "email":"Gaurav.ghai@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gghai", "name":"Gaurav Ghai", "email":"Gaurav.ghai@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-03-29T11:08:36.368697-07:00", "fixedAt":"2013-03-28T21:06:54.172899-07:00", "fixedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "shippedAt":"2013-03-29T11:08:36.368697-07:00", "shippedBy":{"username":"gghai", "name":"Gaurav Ghai", "email":"Gaurav.ghai@marklogic.com"}, "renderDescriptionAs":"normal"}