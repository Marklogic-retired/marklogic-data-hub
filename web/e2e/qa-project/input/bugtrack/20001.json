{"id":20001, "kind":"Bug", "createdAt":"2012-10-31T04:48:55.46754-07:00", "status":"Closed", "title":"Performance Bug with Memory Leak Happening in 4.2-9.1 ", "category":"xdmp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"bgupta", "name":"Balkrishna Gupta", "email":"balkrishna.gupta@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Hi,\r\n\r\nWe have a case #11957 where customer is experiencing unresponsiveness in MarkLogic after some interval. I have been able to replicate the behavior and can notice significant memory uses and swapping happening. I have used Apache JMeter to simulate parallel request behavior with 25 threads causes memory utilization remain high and swapping happening on MarkLogic after processing 1000 requests average which remains same until MarkLogic server is restarted (However I have stopped the request threads already).\r\n\r\nI am attaching sar data report and MarkLogic Error logs for the reference. The setup is available on cluster-009.marklogic.com with app server configured as 11957_test. The module can be invoked using below url:\r\n                 http://cluster-009.marklogic.com:8057/xqy/api/get-article-svrl.xqy?id=<document name>&format=json\r\n\r\nXQuery modules and documents are available at /tmp/11957 on the same lab machine (cluster-009.marklogic.com).\r\n\r\nPlease let me know if you need any information.", "samplequery":"", "sampledata":"", "version":"6.0-1", "tofixin":"6.0-2", "fixedin":"6.0-2", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"bgupta", "name":"Balkrishna Gupta", "email":"balkrishna.gupta@marklogic.com"}, {"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, {"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}], "attachments":[{"name":"SAR data and MarkLogic error logs", "uri":"root/support/bugtracking/attachments/19964/11957.zip"}, {"name":"SAR Data of 6.0 Nightly Test", "uri":"root/support/bugtracking/attachments/20001/Test6.0-07Nov.txt"}, {"name":"SAR report of 6.0 Nightly Test", "uri":"root/support/bugtracking/attachments/20001/Test6.0-07Nov.pdf"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":19964, "support":{"headline":"XSLT choose instruction leaks memory", "supportDescription":"XSLT choose instruction leaks memory.  This may result in degraded performance over time.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"High", "title":"Significant business impact with no reasonable workaround"}, "workaround":""}, "tags":["xdmp", "bgupta"], "changeHistory":[{"time":"2012-10-31T09:57:27.30156-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-10-31T10:03:16.938033-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"John, can you work with Balkrishna to understand whether this is a product issue or not, and if so whether it's resolved in a later release?"}, {"time":"2012-10-31T10:03:16.938033-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-10-31T10:50:01.358043-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"4.2-10"}}, "files":[], "show":true}, {"time":"2012-11-02T05:33:41.485349-07:00", "updatedBy":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Looks like a memory leak to me, but I won't know where from until I can reproduce on my own machines.\r\n\r\nBalkrishna, can you give me a step by step guide to reproducing the problem, including loading the initial documents, and which URLs to fetch."}, {"time":"2012-11-02T05:33:41.485349-07:00", "updatedBy":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "change":{"assignTo":{"from":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "to":{"username":"bgupta", "name":"Balkrishna Gupta", "email":"balkrishna.gupta@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-02T10:10:55.660765-07:00", "updatedBy":{"username":"bgupta", "name":"Balkrishna Gupta", "email":"balkrishna.gupta@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi John,\r\n\r\nYou can use RecordLoader to load the documents into 11957 database. The documents are available on cluster-009.marklogic.com at /tmp/11957/sample_docs.zip.Below are the steps to setup the application to be able to reproduce the issue:\r\n1. Clear 11957 dataabse and load the documents into 11957 database using below RecordLoader command:\r\njava -cp marklogic-xcc-4.2.9.jar;xpp3.jar;recordloader.jar -DCONNECTION_STRING=xcc://admin:admin@cluster-009.marklogic.com:8038  -DINPUT_PATH=/tmp/11957/sample_docs.zip -DIGNORE_FILE_BASENAME=true -DURI_PREFIX=/articles/xml/ -DUSE_FILENAME_COLLECTION=true -DID_NAME=#FILENAME com.marklogic.ps.RecordLoader\r\n\r\n2. Load pa_xml.xml into the database as below:\r\nxdmp:document-load(\"/tmp/11957/docs/pa_xml.xml\",\r\n<options xmlns=\"xdmp:document-load\">\r\n  <uri>/articles/schematron/pa_xml.xml</uri>\r\n</options>)\r\n\r\n3. You can access below url to access the module\r\n       http://cluster-009.marklogic.com:8057/xqy/api/get-article-svrl.xqy?id=<document name>&format=json\r\n\r\nAdditionally, I have setup JMeter on  w2k3v-intel64-1.marklogic.com and have JMeter thread setup is available in bin folder of JMeter installation folder. You can make use of JMeter to simulate parallel requests. You can refer /tmp/11957 folder to look through modules and initial documents. Also, the step by step instructions are available in support case at below location: \r\n                https://help.marklogic.com/staff/Tickets/Ticket/View/11957/mytickets/-1/-1/-1\r\n\r\nBalkrishna"}, {"time":"2012-11-05T21:06:38.397586-08:00", "updatedBy":{"username":"bgupta", "name":"Balkrishna Gupta", "email":"balkrishna.gupta@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I am able to notice same behavior on 6.0-1.1. So, creating clone of the bug on 6.0 branch."}, {"time":"2012-11-06T10:35:13.037188-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Balkrishna, can you verify that this is reproducible in the latest 6.0-nightly.  Since this issue is not reproducible in v5.0-4, it is possible that it is also resolved by other code changes in this branch since 6.0-1.1 release.\r\n\r\nThanks,"}, {"time":"2012-11-07T01:54:38.42025-08:00", "updatedBy":{"username":"bgupta", "name":"Balkrishna Gupta", "email":"balkrishna.gupta@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi Rick,\r\n\r\nI performed the test on 6.0-nightly (6.0-20121106) and it also has memory leak issue. I am attaching the sar data and sar data reports for the reference.\r\n\r\nBalkrishna"}, {"time":"2012-11-07T06:38:19.947596-08:00", "updatedBy":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I can reproduce this on b4_2. It turns out it's this bug:\r\n \r\nhttp://bugtrack.marklogic.com/16846\r\n \r\nIt's been fixed in b5_0 and trunk, but not b6_0 and b4_2. The fix has been released in 5.0-4, but not in 6.0-1.1 or the forthcoming 6.0-2.\r\n"}, {"time":"2012-11-07T06:38:51.641316-08:00", "updatedBy":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-2"}}, "files":[], "show":true}, {"time":"2012-11-07T10:12:37.024033-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}}}, "files":[], "show":true, "comment":"In that case, it needs to be fixed in b6_0.  John, can you do that?"}, {"time":"2012-11-07T10:12:37.024033-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-07T10:48:58.111679-08:00", "updatedBy":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I'm currently waiting on a response to an email asking if it should go in 6.0-2 or not."}, {"time":"2012-11-07T11:04:59.306275-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"It should go into 6.0-2.   Who are you waiting on an email from?  I will poke them if need be."}, {"time":"2012-11-07T11:22:02.843657-08:00", "updatedBy":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"119874", "paths":["xdmp/branches/b6_0/src/XSLTParser.cpp"], "affectedBugs":["16846"]}, "comment":"bug:16846,20001 - fix a memory leak by assigning a 'new' result to a local handle"}, {"time":"2012-11-07T11:22:55.375672-08:00", "updatedBy":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"Fixed."}, {"time":"2012-11-07T11:22:55.375672-08:00", "updatedBy":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "change":{"assignTo":{"from":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-07T17:03:34.901736-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-12T10:20:29.981534-08:00", "updatedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Scott did run the Valgrind on the latest build and test passed."}, {"time":"2012-11-21T14:10:41.29982-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2012-11-21T14:10:41.29982-08:00", "fixedAt":"2012-11-07T11:22:55.375672-08:00", "fixedBy":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "shippedAt":"2012-11-12T10:20:29.981534-08:00", "shippedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "closedAt":"2012-11-21T14:10:41.29982-08:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}