{"id":20229, "kind":"Bug", "createdAt":"2012-06-01T11:01:58.793694-07:00", "status":"Closed", "title":"Database status page extremely slow with over a billion documents in the db", "category":"adminGUI", "severity":"Performance", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Using 5.0-3.1 the following was observed : \r\n\r\nwith 60 forests 1,468,321,919 fragments it takes the database status page several minutes to render. \r\n\r\nTo see this behavior at least for the moment one can log into rh6-intel64-7:8001 and navigate to the database status page for the documents db. \r\n\r\n", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-1", "fixedin":"7.0-1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, {"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, {"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, {"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":17406, "support":{"headline":"", "supportDescription":"", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["adminGUI", "lratcliff"], "changeHistory":[{"time":"2012-06-01T11:01:58.793694-07:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-06-04T10:28:06.859948-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-06-20T15:37:33.001836-07:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Can you be more specific about how long it took.  Maybe put an xdmp:elapsed-time() in the page.  Also, aren't you happy that it even renders at all?  This is expected to be slow."}, {"time":"2012-06-20T18:06:41.761915-07:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"It was ~ 5-7 minutes. long enough to fix a coffee come back and have the page still not render. "}, {"time":"2012-12-06T18:51:51.374581-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2012-12-07T07:53:48.207395-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"Generally forest-status shouldn't slow down with large forests, but forest-counts should.\r\nSo we should be careful about when we call forest-counts."}, {"time":"2013-01-30T16:41:53.976581-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"130054", "paths":["xdmp/trunk/src/StatusBuiltins.cpp", "xdmp/trunk/src/Stand.cpp", "xdmp/trunk/src/Stand.h"], "affectedBugs":[]}, "comment":"bug:20229 in forest-counts, go through the timestamps file once to get all three fragment counts"}, {"time":"2013-01-30T16:51:17.033458-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"When the database is neither reindex/rebalancing nor in \"preview\" mode,   most work in forest-counts is to get the document and fragment counts.   For each stand, it used to go through the timestamps file three times to get fragment counts. I just checked in a change that made it go through the file only once. This change should make this flow (neither reindex/rebalancing nor in \"preview\" mode) go twice to three times faster with large forests.  \r\n\r\nThat said, forest-counts can still be hundreds of times slower than forest-status.   To completely get rid of the problem, I would suggest not to show the document and fragment counts on the forest-status page until the user hits a \"show details\" kind of button.\r\n\r\n\r\n\r\n"}, {"time":"2013-02-19T19:31:00.600402-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea1", "to":"7.0-1"}}, "files":[], "show":true}, {"time":"2013-07-02T14:01:04.447935-07:00", "updatedBy":{"username":"bmo", "name":"Brian Mo", "email":"brian.mo@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Two frontend solutions for this problem:\r\n\r\n1)  Add a \"Show Details\" button for refreshing the page with additional info (\"Reindexing/Refragmenting State\", Documents, Fragments, Deleted Fragments counts).\r\n      Cons:  users need to click the Show Details button to see the info even for small counts (fast).  After clicking the Show Details button, the users still need to wait for the same amount of time for the page to refresh.\r\n2)   Web 2.0 way - after the page being loaded, starts prefetching the counts data (ajax) and do dynamic UI update when the data  arrives.\r\n      Cons:   more development cost and there may be unknown issues doing so for admin pages.\r\n\r\nMy cost estimates for solutions\r\n1) about 2 days\r\n2) about 4+ days.\r\n\r\nPersonally, I like solution 2 better."}, {"time":"2013-08-16T07:54:24.950868-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Haitao,\r\n\r\nI was spawning a request per forest to get forest-count to try and fix this issue (or at least improve performance). Chris feels that we should have a built-in to help with this issue. Here is is his reply - \r\n\r\n\"I donâ€™t think using the task server for interactive concurrency is the right approach for this, as it could be very busy at the time.\r\nThe right way to do it is the way we do it for forest-status, by passing all the forests to it at once, and having the built-in compute counts for multiple forests concurrently.\"\r\n\r\nI have subscribed Wayne to the defect so that you can decide about the built-in. If we decide to go that approach, please take the defect and assign it back to Brian once you have the built-in code checked-in.\r\n\r\nIf built-in is cost prohibitive in ML7, we can look at Brian's solution #2 (though even that could have issues, since we do not do ajax in admin UI in too many places and this introduces JS in a page that field could be using to script).\r\n"}, {"time":"2013-08-16T11:38:56.673957-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"149383", "paths":["xdmp/trunk/src/Admin/lib/database-status-form.xqy"], "affectedBugs":[]}, "comment":"Bug:20229 -  Database status page extremely slow with over a billion documents in the db."}, {"time":"2013-08-16T11:40:33.864229-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I am not spawning requests any more. I have made changes based on Wayne's suggestion. \r\n\r\nAt this point, I am marking this bug as fixed, since we have taken Chris's and Wayn'es advice and implemented them. And Haitao has made some improvements around forest-counts as well."}, {"time":"2013-08-16T11:40:33.864229-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-08-16T11:40:33.864229-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-08-16T12:15:46.136109-07:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true, "comment":"Need to change the implementation of forest-counts to actually do things concurrently.\r\nIt needs the same code as forest-status to do remote forests first."}, {"time":"2013-08-16T12:15:46.136109-07:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"assignTo":{"from":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-08-16T12:16:27.563571-07:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{"assignTo":{"from":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "to":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-08-16T13:35:38.766433-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"See my commit for bug 22982."}, {"time":"2013-08-16T14:16:43.080009-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Wayne, I could be wrong. 22982 seems to be for forest-status. Does it hold for forest-counts as well?"}, {"time":"2013-08-16T14:17:38.673511-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"When I marked it for test, I assumed that forest-counts did do things concurrently (if we passed it  a list of forest ids."}, {"time":"2013-08-16T14:19:07.882594-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"There is some C++ work to improve on the parallization of forest-counts()."}, {"time":"2013-08-16T15:14:17.215602-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"149402", "paths":["xdmp/trunk/src/StatusBuiltins.cpp"], "affectedBugs":[]}, "comment":"bug:20229 Database status page extremely slow with over a billion documents in the db"}, {"time":"2013-08-16T15:17:26.864239-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I'll backport both my change and Wayne's change to 6.0 using Bug 20649."}, {"time":"2013-08-16T15:18:51.91934-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-08-16T15:18:51.91934-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-08-16T15:21:15.588771-07:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"on second thought,  will use Bug 20649 for the change made here (in forest-counts) but will clone 22982 separately."}, {"time":"2013-09-16T15:27:35.511987-07:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"verified on build 7.0-20130909"}], "updatedAt":"2013-09-16T15:27:35.511987-07:00", "fixedAt":"2013-08-16T15:18:51.91934-07:00", "fixedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "shippedAt":"2013-09-16T15:27:35.511987-07:00", "shippedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "renderDescriptionAs":"normal"}