{"id":20873, "kind":"Bug", "createdAt":"2013-02-21T02:37:12.541253-08:00", "status":"Closed", "title":"REGR:wrong estimate returned by cts:search on cts:reverse-query", "category":"xdmp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"REGR:wrong estimate returned by cts:search on cts:reverse-query\r\n\r\nTest Failing: bug5606.xml\r\nML Version: 20130220\r\nLink to diff on nightly: https://regression-status.marklogic.com/new-app/space2/diff-archive/b7_0/2013-02-20/linux-64-rh6/diffs/bug5606.xml\r\n\r\nSteps to reproduce:\r\n1. Create DB with 2 forests(say B5606F1,B5606F2) and associate DB with triggers db.\r\n2. Load test data:\r\nxquery version \"1.0-ml\";\r\n        xdmp:document-insert(\"doc1.xml\", <test>1</test>, (), (), 0, xdmp:forest(\"B5606F1\")),\r\n        xdmp:document-insert(\"doc2.xml\", <test>2</test>, (), (), 0, xdmp:forest(\"B5606F1\")),\r\n        xdmp:document-insert(\"doc3.xml\", <test>3</test>, (), (), 0, xdmp:forest(\"B5606F2\")),\r\n        xdmp:document-insert(\"doc4.xml\", <test>4</test>, (), (), 0, xdmp:forest(\"B5606F2\")),\r\n        xdmp:document-insert(\"q1.xml\", <query>{cts:word-query(\"hello world 1\")}</query>, (), (), 0, xdmp:forest(\"B5606F1\")),\r\n        xdmp:document-insert(\"q2.xml\", <query>{cts:word-query(\"hello world 2\")}</query>, (), (), 0, xdmp:forest(\"B5606F2\"))\r\n\r\n3. Check reindex-refrag info for forests: should be 0\r\n4. Disable indexer\r\n5. Enable fast reverse searches\r\n6. Check reindex-refrag info for forests : should be 2 fragments since 2 out of 6 docs have serialized queries\r\n7. Enable indexer and wait till the reindexer is done\r\n8. Run Following query:\r\n        xquery version \"1.0-ml\";let $est := xdmp:estimate( cts:search(/query, cts:reverse-query(<test>hello world 1</test>)))\r\n        let $count := fn:count( cts:search(/query, cts:reverse-query(<test>hello world 1</test>))) return <res count=\"{$count}\" est=\"{$est}\"/>\r\n\r\nActual result: <res count=\"1\" est=\"2\"/>\r\nExpected result: <res count=\"1\" est=\"1\"/>\r\n\r\n\r\nNote: This test started failing since 2013-01-19", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea1", "fixedin":"7.0-ea1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, {"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, {"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, {"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "iagrawal"], "changeHistory":[{"time":"2013-02-21T02:37:12.541253-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-27T05:29:18.307005-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The test simply passed after I turned off rebalancer:\r\n\r\nIndex: scripts/tests/bug5606.xml\r\n===================================================================\r\n--- scripts/tests/bug5606.xml\t(revision 133873)\r\n+++ scripts/tests/bug5606.xml\t(working copy)\r\n@@ -202,6 +202,23 @@\r\n         ]]>\r\n     </h:query>\r\n  </h:test>\r\n+<h:test h:output-result=\"false\"  h:username=\"admin\" h:password=\"admin\">\r\n+  <h:name>setup-rebalancer</h:name>\r\n+  <h:comment-expected-result>set rebalancer to off</h:comment-expected-result>\r\n+  <h:query>\r\n+         <![CDATA[xquery version \"1.0-ml\";\r\n+        declare namespace admin=\"http://marklogic.com/xdmp/admin\";\r\n+        import module \"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n+        let $config := admin:get-configuration()\r\n+        let $dbid   := admin:database-get-id($config, \"B5606DB\")\r\n+\r\n+        let $c := admin:database-set-rebalancer-enable($config,$dbid,fn:false())\r\n+        return\r\n+         admin:save-configuration($c)\r\n+\r\n+        ]]>\r\n+  </h:query>\r\n+ </h:test>\r\n  <h:test h:output-result=\"false\">\r\n   <h:name>Enable index options</h:name>\r\n    <h:comment-expected-result>enable fast reverse searches</h:comment-expected-result>\r\n"}, {"time":"2013-02-27T05:29:18.307005-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}}}, "files":[], "show":true, "comment":"Please Haitao if he has made any rebalancer checkins on 01/19 and if it is ok to turn off rebalancer in this test.\r\n\r\nThe test passes for me fater turning the rebalancer off."}, {"time":"2013-02-27T05:29:18.307005-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-28T00:13:26.405398-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"As per Haitao \"In general, you want to avoid customized assignments (like in-forest eval) if you have the rebalancer enabled.\"\r\nHence turned off rebalancer in test bug5606.xml and it passed on ML version 20130227.Closing the bug"}, {"time":"2013-02-28T00:13:26.405398-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-02-28T00:13:26.405398-08:00", "fixedAt":"2013-02-27T05:29:18.307005-08:00", "fixedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "closedAt":"2013-02-28T00:13:26.405398-08:00", "closedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "renderDescriptionAs":"normal"}