{"id":20023, "kind":"Bug", "createdAt":"2012-11-07T11:56:59.200739-08:00", "status":"Closed", "title":"Point in time recovery fails if we do a restore to latest timestamp and if we dont do any transactions after taking a backup with journal archiving.", "category":"Backup/Restore", "severity":"Major", "priority":{"level":"2", "title":"Not required for product release"}, "submittedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"\r\nFollow the following steps:\r\n\r\n1. Load some documents into Documents database.\r\n2. Take a backup with journal archiving.\r\n3. Set the merge timestamp to current time.\r\n4. Now do a point in time recovery to latest timestamp.\r\n\r\nActual :\r\n\r\nRestore show completed but you loose the documents loaded in step1. I see the following details in the errorlog.\r\n\r\n2012-11-07 11:46:30.410 Info: Starting restore of forest Documents from /tmp/20121107-1145357599600, jobid=6972951917268819437\r\n2012-11-07 11:46:32.397 Debug: OnDiskStand /var/opt/MarkLogic/RestoredForests/Documents/00000000, disk=17MB, memory=8MB\r\n2012-11-07 11:46:32.398 Debug: Recovering redo from {fsn=-1, off=0, sk=0} on forest Documents\r\n2012-11-07 11:46:32.398 Debug: Found journal /tmp/20121107-1145357599600/Forests/Documents/Journals/Journal-20121107194538-10-18446744073709551615-13523175090772110 with fsns 10..-1\r\n2012-11-07 11:46:32.398 Debug: Recovered redo of 0 records at {fsn=10, off=0, sk=0} on forest Documents, lmfsn=18446744073709551615\r\n2012-11-07 11:46:32.479 Debug: Recovering undo at endTimestamp 0 on forest Documents\r\n2012-11-07 11:46:32.479 Debug: Recovered undo at endTimestamp 0 on forest Documents\r\n2012-11-07 11:46:32.572 Debug: ~OnDiskStand /var/opt/MarkLogic/RestoredForests/Documents/00000000\r\n2012-11-07 11:46:32.573 Debug: ~Forest 2647609695754145034 Documents /var/opt/MarkLogic/RestoredForests/Documents\r\n2012-11-07 11:46:32.575 Info: Finished copying to forest Documents from /tmp/20121107-1145357599600, jobid=6972951917268819437\r\n2012-11-07 11:46:32.745 Debug: Detecting indexes for database templateDB\r\n2012-11-07 11:46:32.745 Info: Finishing restore of forest Documents from /tmp/20121107-1145357599600/Forests/Documents assertMaster=true, jobid=6972951917268819437\r\n------\r\n2012-11-07 11:46:32.840 Debug: Closing journal archive /tmp/20121107-1145357599600/Forests/Documents/Journals/Journal-20121107194538-10-10-13523175090772110 with fsns 10..10\r\n2012-11-07 11:46:32.840 Debug: ~OnDiskStand /var/opt/MarkLogic/Forests/Documents/00000000\r\n2012-11-07 11:46:32.842 Info: Unmounted forest Documents\r\n2012-11-07 11:46:32.966 Info: Mounted forest Documents locally on /var/opt/MarkLogic/Forests/Documents (sda8 ext4 rw)\r\n2012-11-07 11:46:32.967 Debug: OnDiskStand /var/opt/MarkLogic/Forests/Documents/00000000, disk=17MB, memory=8MB\r\n2012-11-07 11:46:32.967 Debug: Recovering redo from {fsn=-1, off=0, sk=0} on forest Documents\r\n2012-11-07 11:46:32.968 Debug: Found journal /var/opt/MarkLogic/Forests/Documents/Journals/Journal1-19700101000000-10-18446744073709551615-0 with fsns 10..-1\r\n2012-11-07 11:46:32.968 Debug: Recovered redo of 0 records at {fsn=10, off=0, sk=0} on forest Documents, lmfsn=18446744073709551615\r\n2012-11-07 11:46:32.968 Debug: Found FSN 10 in journal /var/opt/MarkLogic/Forests/Documents/Journals/Journal1-19700101000000-10-18446744073709551615-0 with fsns 10..-1\r\n2012-11-07 11:46:32.968 Debug: Opening journal /var/opt/MarkLogic/Forests/Documents/Journals/Journal1-19700101000000-10-18446744073709551615-0 10..-1 at {fsn=10, off=0, sk=0}\r\n2012-11-07 11:46:32.968 Debug: Recovering undo on forest Documents\r\n2012-11-07 11:46:32.968 Debug: Recovered undo at endTimestamp 13523175090772110 minQueryTimestamp 0 on forest Documents\r\n2012-11-07 11:46:33.049 Info: Finished restore of forest Documents from /tmp/20121107-1145357599600/Forests/Documents, jobid=6972951917268819437\r\n2012-11-07 11:46:33.100 Info: Finished 1-forest database restore from /tmp/20121107-1145357599600, jobid=6972951917268819437, safeRestoreTimestamp=0\r\n", "samplequery":"", "sampledata":"", "version":"6.0-nightly", "tofixin":"6.0-5", "fixedin":"6.0-5", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, {"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, {"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[22890], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["Backup/Restore", "skottam"], "changeHistory":[{"time":"2012-11-07T11:56:59.200739-08:00", "updatedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "change":{"assignTo":{"from":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-07T11:59:49.617095-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-07T19:59:01.188994-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"this bug is caused by fix in bug 19296. "}, {"time":"2012-11-08T17:40:46.059262-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"120042", "paths":["xdmp/branches/b6_0/src/Recovery.cpp"], "affectedBugs":[]}, "comment":"bug:20023 point in time recovery fix"}, {"time":"2012-11-08T17:41:30.204214-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "to":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-08T17:41:30.204214-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{"assignTo":{"from":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "to":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-09T13:48:28.114078-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"120157", "paths":["xdmp/trunk/src/Recovery.cpp"], "affectedBugs":[]}, "comment":"bug:20023 point in time recovery fix"}, {"time":"2012-11-12T17:43:35.28647-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"sql-db-backup-restore.xml failed with 6.0.1-1 build on my machine so it is not a regression."}, {"time":"2012-11-13T13:32:30.427662-08:00", "updatedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "to":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}}}, "files":[], "show":true, "comment":"This can be a regression as the failures for the steps are almost same as before except you need to do backup and restore before you continue to the steps.\r\ni.e. \r\n \r\n1. Load some documents into Documents database.  \r\n2. Take a backup with no journal archiving.\r\n3. Do restore of Documents database.\r\n4. Now take a backup with journal archiving.\r\n5. set the merge timestamp to current timestamp.\r\n6. Do a point in time recovery to latest time and you see restore shows completed with safeRestoreTimestamp=0 i,e incorrect recovery."}, {"time":"2012-11-13T13:32:30.427662-08:00", "updatedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "change":{"assignTo":{"from":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "to":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-13T14:39:18.147611-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I can reproduce it in both 6.0-2 and 6.0-1.1."}, {"time":"2012-11-13T15:59:15.2615-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Not a regression and not a typical customer user case. So moving this to 6.0-3"}, {"time":"2012-11-13T15:59:15.2615-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"tofixin":{"from":"6.0-2", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-02-27T13:05:18.833737-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"6.0-3", "to":"6.0-4"}}, "files":[], "show":true}, {"time":"2013-05-21T09:55:59.026476-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Per Raghu's comment, I think we could move this out of 6.0-4 as well."}, {"time":"2013-05-28T13:00:12.76596-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"6.0-4", "to":"6.0-5"}}, "files":[], "show":true}, {"time":"2014-02-19T16:59:36.427247-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"161746", "paths":["xdmp/branches/b6_0/src/Forest.cpp"], "affectedBugs":[]}, "comment":"bug:20023 restore after backup and do not do any transaction"}, {"time":"2014-02-19T17:00:11.753445-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "to":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}}}, "files":[], "show":true, "comment":"fixed"}, {"time":"2014-02-19T17:00:11.753445-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{"assignTo":{"from":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "to":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}}}, "files":[], "show":true}, {"time":"2014-02-25T11:33:04.515805-08:00", "updatedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified in the build 6.0-20140224 and looks good to me."}], "updatedAt":"2014-02-25T11:33:04.515805-08:00", "fixedAt":"2014-02-19T17:00:11.753445-08:00", "fixedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "shippedAt":"2014-02-25T11:33:04.515805-08:00", "shippedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "renderDescriptionAs":"normal"}