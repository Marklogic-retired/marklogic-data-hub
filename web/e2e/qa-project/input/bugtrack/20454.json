{"id":20454, "kind":"Bug", "createdAt":"2013-01-14T05:55:20.494774-08:00", "status":"Closed", "title":"Search API namespace handling on path range queries", "category":"Search API", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"oschwering", "name":"Olav  Schwering", "email":"oschwering@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Using Search API and cts:path-range-query where the xpath contains nameapces returns a namespace binding error (XDMP-UNBPRFX: (err:XPST0081) Prefix my has no namespace binding)\r\n\r\nThe following example code returns the mentioned error:\r\n\r\nimport module namespace search = \"http://marklogic.com/appservices/search\"\r\n    at \"/MarkLogic/appservices/search/search.xqy\";\r\n\r\nsearch:estimate(\r\n<cts:path-range-query operator=\"=\" xmlns:cts=\"http://marklogic.com/cts\">\r\n  <cts:path xmlns:my=\"http://my_namespace\" >/my:root/my:elt[@att='val']</cts:path>\r\n  <cts:value xsi:type=\"xs:string\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">hello</cts:value>\r\n  <cts:option>collation=http://marklogic.com/collation/</cts:option>\r\n</cts:path-range-query>\r\n)\r\n\r\nParsing the query into a cts:query it deserializes fine:\r\n\r\ncts:query(\r\n<cts:path-range-query operator=\"=\" xmlns:cts=\"http://marklogic.com/cts\">\r\n  <cts:path xmlns:my=\"http://my_namespace\" >/my:root/my:elt[@att='val']</cts:path>\r\n  <cts:value xsi:type=\"xs:string\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">hello</cts:value>\r\n  <cts:option>collation=http://marklogic.com/collation/</cts:option>\r\n</cts:path-range-query>\r\n)\r\n\r\nAdding the namespace into the database doesn't prevent from throwing the error.\r\n\r\nFrom analyzing the search api the higher-order.xqy is failing. \r\n", "samplequery":"", "sampledata":"", "version":"6.0-2.1", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"oschwering", "name":"Olav  Schwering", "email":"oschwering@marklogic.com"}, {"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, {"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, {"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}], "attachments":[{"name":"MY database settings", "uri":"root/support/bugtracking/attachments/20454/package.xml"}, {"name":"CQ output on that database", "uri":"root/support/bugtracking/attachments/20454/Screen Shot 2013-01-17 at 22.45.27.png"}], "relationships":[{"type":"", "to":""}], "clones":[20639], "cloneOf":"", "support":{"headline":"Namespaces in XPath expressions for indexes do not recognize prefixes.", "supportDescription":"If your path index specification uses prefixes, the corresponding namespace URIs are not passed to the server.  Hence your path index will not be found.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"Low", "title":"Minimal business impact or reasonable workaround is available"}, "workaround":"Define the namespace in the appserver"}, "tags":["Search API", "oschwering"], "changeHistory":[{"time":"2013-01-17T09:54:27.861146-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-17T09:54:27.861146-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-17T09:54:27.861146-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-01-17T10:31:48.134436-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi Olav, just to make sure, it looks like you may have missed the path-range-index namespace configuration.\r\n\r\nWhile unfortunate that you have to manage namespaces in two places, the path range indexes do not share the same scope for namespaces as appservers.\r\n\r\nYou must use the Admin GUI to configure path namespaces.  In database view, path-range-indexes and path-namespaces are two configuration items next to each other along the left hand side.  Have you configured namespaces in that location?\r\n\r\nCharles\r\n"}, {"time":"2013-01-17T13:46:48.933723-08:00", "updatedBy":{"username":"oschwering", "name":"Olav  Schwering", "email":"oschwering@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hello Charles"}, {"time":"2013-01-17T13:54:51.396074-08:00", "updatedBy":{"username":"oschwering", "name":"Olav  Schwering", "email":"oschwering@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Second try ;-)\r\n\r\nHi again,\r\n\r\nI attached my database settings and an output from CQ. I think I have everything done right? You can also review the details on the reported support ticket, link see below.\r\n\r\nThanks\r\n\r\n\r\n              OLAV"}, {"time":"2013-01-17T14:14:09.37798-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi Olav, with a little experimentation i've found that the prefix has to be defined BOTH in the path namespaces (which you've done) and also in the XQuery module (or appserver or group).\r\n\r\nThis seems suspicious to me.  I've sent out a general message to engineering asking what's up.\r\n\r\nCharles"}, {"time":"2013-01-17T14:29:08.672031-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Well, Olav here's the word from Gajanan, and it makes sense to me:\r\n\r\n\"The path-namespaces definition in the database is used only for index definition.\r\n\r\nQueries/applications are not resolved using the path namespace definitions in the server. Only those namespaces are used for queries that are in its context of execution. A query must explicitly declare all the namespaces it needs. The query  may use different namespace prefixes than the path-namespace definitions.\"\r\n\r\nSo you do have to declare that namespace again.  The prefix might be different from the one you used to define the index, but the namespace uri must match in order to find the index.\r\n\r\nIf you're satisfied with this, then feel free to close the bug."}, {"time":"2013-01-27T11:24:39.444262-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"No it's not a server bug.  I keep and fix.\r\n\r\nThis works, with the appropriate path index defined.\r\n\r\n\r\nimport module namespace search = \"http://marklogic.com/appservices/search\"\r\n\r\n    at \"/MarkLogic/appservices/search/search.xqy\";\r\n\r\n declare namespace my = \"http://my_namespace\";\r\ncts:search(/, cts:query(\r\n\r\n<cts:path-range-query operator=\"=\" xmlns:cts=\"http://marklogic.com/cts\">\r\n\r\n  <cts:path xmlns:my=\"http://my_namespace\" >/my:root/my:elt[@att='val']</cts:path>\r\n\r\n  <cts:value xsi:type=\"xs:string\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">hello</cts:value>\r\n\r\n  <cts:option>collation=http://marklogic.com/collation/</cts:option>\r\n\r\n</cts:path-range-query>))\r\n"}, {"time":"2013-02-05T02:14:49.738275-08:00", "updatedBy":{"username":"oschwering", "name":"Olav  Schwering", "email":"oschwering@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"It looks like I identified the problem in Search-API. After editing the lines in search-impl.xqy line 2707 following:\r\n\r\n\r\n        concat(\r\n            \"cts:search(\", \r\n            impl:build-searchable-expr($opts), \", \", \r\n            if ($opts//opt:path-index) \r\n            then concat(\"cts:query(\", xdmp:quote($query) ,\") \")\r\n            else impl:cts-query($query),\r\n            $optstr, \r\n            ......\r\n\r\nto this change:\r\n\r\n\r\n        concat(\r\n            \"cts:search(\", \r\n            impl:build-searchable-expr($opts), \", \", \r\n            if ($query) \r\n            then concat(\"cts:query(\", xdmp:quote($query) ,\") \")\r\n            else (),\r\n            $optstr, \r\n\r\nThe search:estimate works well without defining the namespace on App-Server or Group level. Defining the namespace in XQuery is also not required as cts:query takes care about the transformation. \r\n\r\nWould suggest someone from the app services team should review this possible solution for fixing the issue.\r\n\r\n"}, {"time":"2013-02-20T09:05:31.350636-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"132625", "paths":["xdmp/branches/b6_0/src/Apps/test/appservices/search-unittest/parse-unittest.xqy", "xdmp/branches/b6_0/src/Modules/MarkLogic/appservices/search/search-impl.xqy"], "affectedBugs":[]}, "comment":"bug:20454 path namespaces in cts queries"}, {"time":"2013-02-20T09:06:16.149262-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}}}, "files":[], "show":true, "comment":"Went ahead and go this into b60 just now.   I've got a unit test to help with qa as needed."}, {"time":"2013-02-20T09:06:16.149262-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-12T11:11:23.782399-07:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Aries, I can see that you added the test for the clone already. So this is coming your way"}, {"time":"2013-03-12T11:11:23.782399-07:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "to":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-01T11:09:52.286082-07:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Add automation test searchAPI-bug20639 to 6.0 regression"}, {"time":"2013-04-01T11:09:52.286082-07:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-22T16:30:18.392874-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-04-22T16:30:18.392874-07:00", "fixedAt":"2013-02-20T09:06:16.149262-08:00", "fixedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "shippedAt":"2013-04-01T11:09:52.286082-07:00", "shippedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "closedAt":"2013-04-22T16:30:18.392874-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}