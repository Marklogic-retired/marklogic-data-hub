{"id":20014, "kind":"Bug", "createdAt":"2012-11-07T03:27:15.864979-08:00", "status":"Closed", "title":"Seeing \"The shared library cannot be loaded\" in udf tests during 6.0-2 upgrade on MAC.", "category":"Upgrade", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Seeing \"The shared library cannot be loaded\" in udf tests during 6.0-2 upgrade on MAC and Win64 cluster.\r\n\r\n1. Upgrade scenario: 5.0-4 -> 6.0-2 sanity upgrade on MAC\r\n\r\nMachine Name:osx-intel64-43-build\r\nBuild used for upgrade: 11/05\r\nPath to qa-stdout.txt: /space/isha/upgrade_sanity_50_60_1105/upgrade_test_sanity\r\nPath to diffs directory: /space/isha/upgrade_sanity_50_60_1105/logs.HEAD.1211060058/diffs\r\nPath to results directory: /space/isha/upgrade_sanity_50_60_1105/logs.HEAD.1211060058/results\r\nPath to ErrorLog: /space/isha/upgrade_sanity_50_60_1105/Logs/ErrorLog.txt\r\n\r\nSteps to perform Upgrade:\r\na. Install 5.0-4 and run sec,fo suite\r\n   command: make tests tname=sec,fo clean=yes pkg=/project/engineering/builds/5.0-4/MarkLogic-5.0-4-x86_64.dmg\r\nb. Upgrade to 6.0-2 nightly manually.\r\nc. Run 00udf suite.\r\n\r\nFew of the failing tests is given below:\r\n1. Test Name: udf-aggregates-1.xml \r\nXquery:\r\n\r\n        xquery version \"1.0-ml\";\r\n        declare namespace qa=\"http://marklogic.com/qa\" ;\r\n        import module namespace util=\"http://marklogic.com/util\" at \"/util.xqy\";\r\n        <sum>{cts:sum(cts:element-values(xs:QName(\"qa:foo-bard\"), 0, (\"type=double\")))}</sum>,\r\n        <count>{cts:count(cts:element-values(xs:QName(\"qa:foo-bard\"), 0, (\"type=double\")))}</count>,\r\n        <avg>{cts:avg(cts:element-values(xs:QName(\"qa:foo-bard\"), 0, (\"type=double\")))}</avg>,\r\n        <sum>{cts:aggregate(\"sampleplugin/sampleplugin\", \"sum\", cts:element-reference(xs:QName(\"qa:foo-bard\"), (\"type=double\")))}</sum>,\r\n        <count>{cts:aggregate(\"sampleplugin/sampleplugin\", \"count\", cts:element-reference(xs:QName(\"qa:foo-bard\"), (\"type=double\")))}</count>,\r\n        <avg>{cts:aggregate(\"sampleplugin/sampleplugin\", \"avg\", cts:element-reference(xs:QName(\"qa:foo-bard\"), (\"type=double\")))}</avg>\r\n\r\nActual result: The shared library cannot be loaded\r\nExpected result:<sum>15</sum><count>5</count><avg>3</avg><sum>15</sum><count>5</count><avg>3</avg>\r\n\r\n2. Test Name: udf-aggregates-10.xml\r\nXquery:\r\n        xquery version \"1.0-ml\";\r\n        declare namespace qa=\"http://marklogic.com/qa\" ;\r\n        import module namespace util=\"http://marklogic.com/util\" at \"/util.xqy\";\r\n        cts:aggregate(\"sampleplugin/sampleplugin\", \"max_date\", cts:element-reference(xs:QName(\"qa:foo-bard\"), (\"type=date\"))),\r\n             \",\",\r\n        cts:aggregate(\"sampleplugin/sampleplugin\", \"max_time\", cts:element-reference(xs:QName(\"qa:foo-bart\"), (\"type=time\")))\r\n\t\t\r\nActual result: The shared library cannot be loaded\r\nExpected result: 2012-07-30,10:39:25.1\t\r\n\r\n\r\n\r\n2. Upgrade scenario: 4.1-11.1 -> 5.0-4 -> 6.0-2 sanity upgrade on win64 cluster\r\n\r\nMachine name:w2k3-i64-42-t1\r\nBuild used for upgrade: 11/05\r\nPath to logs: /cygdrive/c/isha/upgrade41_50_60_05_sanity\r\nPath to qa-stdout.txt: /cygdrive/c/isha/upgrade41_50_60_05_sanity/upgrade_test3_new\r\nPath to diffs directory: /cygdrive/c/isha/upgrade41_50_60_05_sanity/logs.HEAD.1211050240/diffs\r\nPath to results directory: /cygdrive/c/isha/upgrade41_50_60_05_sanity/logs.HEAD.1211050240/results\r\nPath to ErrorLog: /cygdrive/c/isha/upgrade41_50_60_05_sanity/Logs/ErrorLog.txt\r\n\r\nSteps to perform Upgrade:\r\na. Install 4.1-11.1 on all nodes manually and join clusters manually.\r\nb. Upgrade to 5.0-4 and run sec,fo.\r\n   Command: make tests tname=sec,fo clean=no pkg=/cygdrive/c/tmp/MarkLogic-5.0-4-amd64.msi cluster=w2k3-i64-42-t2,w2k3-i64-42-t3 domainname=marklogic.com   \r\nc. Upgrade to 6.0-2 nightly.\r\n   Command :make tests tname=sdsd clean=no pkg=/cygdrive/c/builds/packages/b6_0/pkgs.20121105/*.msi cluster=w2k3-i64-42-t2,w2k3-i64-42-t3 domainname=marklogic.com\r\nd. Put license from admin UI manually. \r\ne. Run 00udf suite.\r\n   Command: make tests tname=00udf clean=no cluster=w2k3-i64-42-t2,w2k3-i64-42-t3 domainname=marklogic.com", "samplequery":"", "sampledata":"", "version":"6.0-1", "tofixin":"6.0-4", "fixedin":"N/A", "platform":"OS X", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, {"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}], "attachments":[{"name":"ErrorLog_MAC.txt", "uri":"root/support/bugtracking/attachments/20014/ErrorLog_MAC.txt"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"Native plugin loading fails after some upgrade scenarios on Mac OS X", "supportDescription":"For some multi-version upgrade scenarios on Mac OS X, native plugin loading can return the error message \"The shared library cannot be loaded\".", "publishStatus":"Prepare", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":"Uninstall MarkLogic, and reinstall a fresh copy."}, "tags":["Upgrade", "iagrawal"], "changeHistory":[{"time":"2012-11-07T03:27:15.864979-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-07T11:02:01.235422-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-07T22:47:23.199462-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"All 00udf tests are passing in linux64 cluster and solaris64 cluster and even in couple of win64 cluster paths. Here are few upgrade scenarios where these tests passed:\r\n1. linux64 cluster 6.0-1.1 -> 6.0-2 complete regression upgrade on 11/07 build.\r\n2. Solaris 64 cluster 5.0-4 -> 6.0-2 sanity upgrade on 11/07 build.\r\n3. linux64 cluster 5.0-4-> 6.0-2 complete regression upgrade on 11/05 build.\r\n4. Win64 cluster 6.0-1.1 -> 6.0-2 Complete regression upgrade 0n 11/06 build.\r\n5. Win64 cluster 5.0-4 -> 6.0-2 sanity upgrade on 11/07 build."}, {"time":"2012-11-08T15:13:03.710008-08:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I took a quick look at this and it is going to be a very time consuming task to investigate.  It appears to only occur on *some* cluster tests.\r\nThe error on mac is that that * dependent* shared library cannot be loaded.  This means that the master shared library loaded fine.\r\nIt may be a timing problem on clusters where dependant native plugin libs are not updated fast enough.  It could be a permissions problem,\r\nit may be that we need to rebuild the QA Samples against the latest version of the software.\r\nTo add fuel, since this is a multi version upgrade that fails (simple upgrades do not) it will be quite difficult to reproduce without full QA environment and possible working directly with QA on how to do the upgrade tests on clusters (I have never done these).\r\n\r\nTo debug this I am going to need access to a cluster of Windows or mac machines, preferably the exact QA machines that are causing these problems.\r\nThis means that QA needs to stop using these machines for the duration.  A single machine wont be sufficient, and typical lab machines will also probably not be sufficient as I have been unable to ever get the full QA suite to execute on either macs or windows ... its a complex setup procedure.\r\nThen I will likely need to work directly with a QA engineer while running the upgrade tests so that they can be paused at the appropriate points and the various systems investigated.\r\n\r\nSuggestions welcome on how to coordinate the required people and machines and time to do these tests.\r\n\r\nWorkarounds may well be possible.  For example simply re-deploying the UDF might well fix things up ...but we wont know until we can get a system frozen in the broken state and try things.   Likely many iterations.\r\n\r\n\r\n"}, {"time":"2012-11-08T15:17:22.949909-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Can we determine whether bouncing the cluster resolves the issue? I think I'm okay pushing to 6.0-3 since  to the best of my knowledge we don't actually have UDFs in production anywhere."}, {"time":"2012-11-08T17:47:17.805852-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"since it is working fine on windows 5.0 to 6.0 upgrade scenario and mac is only development platform, ok to move to 6.0-3. Moving this to 6.0-3."}, {"time":"2012-11-08T17:47:17.805852-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"tofixin":{"from":"6.0-2", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-01-27T21:42:52.662421-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"John's comment:\r\nNot a customer bug, only happens in an obscure case, unlikely to happen in the field.  \r\n\r\nMay want to push this bug to next release."}, {"time":"2013-01-28T13:33:50.300916-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"John, in the single node case, what actually is not working here?  Is there a directory that does not get created?  Is there a workaround?  If the triage team understands this correctly, you just need to install MarkLogic 5 on a mac, then upgrade it and try to use UDFs on 6, and you run into this problem.  Please put a note in the bug and advise. "}, {"time":"2013-01-29T01:52:50.919353-08:00", "updatedBy":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"David Lee looked into this more than me. This only happens in a multi-upgrade scenario - 4.1-11.1 -> 5.0-4 -> 6.0-2. My suspicion is that there might be an environment variable not set correctly.\r\n\r\nIn any case, a viable work around is to uninstall MarkLogic, and then reinstall the 6.0-X version."}, {"time":"2013-02-28T11:53:52.69471-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"6.0-3", "to":"6.0-4"}}, "files":[], "show":true}, {"time":"2013-03-01T13:38:17.49462-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Please fill in support info so this can go into a known bug list."}, {"time":"2013-04-09T00:37:26.860598-07:00", "updatedBy":{"username":"sanand", "name":"Sumit Anand", "email":"Sumit.Anand@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This issue also seen on upgrade scenario from 5.0-5 to 6.0-3 on MAC platform. \r\n\r\nPath to qa-stdout: /project/engineering/qa/upgradeLogs/6.0-3_Upgrade/5.0-5-6.0-3/mac-sanity-505-603/2.sanity_run-on-6.0-3\r\n\r\nPath to Log : /project/engineering/qa/upgradeLogs/6.0-3_Upgrade/5.0-5-6.0-3/mac-sanity-505-603/Logs/ErrorLog.txt \r\n\r\nPath to resule : /project/engineering/qa/upgradeLogs/6.0-3_Upgrade/5.0-5-6.0-3/mac-sanity-505-603/logs.b6_0.1304030528/results/"}, {"time":"2013-05-20T08:36:03.22305-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Suggest to push this bug to 8.0-1.  John thinks that it is an issue with Mac launch script. (not DB upgrade issue)"}, {"time":"2013-06-24T14:22:38.138607-07:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Let's not bother to fix this."}, {"time":"2013-06-24T14:22:38.138607-07:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-06-24T14:22:38.138607-07:00", "closedAt":"2013-06-24T14:22:38.138607-07:00", "closedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "renderDescriptionAs":"normal"}