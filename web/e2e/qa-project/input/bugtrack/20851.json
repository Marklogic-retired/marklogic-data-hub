{"id":20851, "kind":"Bug", "createdAt":"2013-02-19T11:38:50.438509-08:00", "status":"Closed", "title":"XDMP-MISSINGFILE during replication", "category":"xdmp", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"JPMC encountered this last night while testing out a 5.0-5 nightly build. The same fragment is failing to replicate over and over.\r\n\r\n$ grep XDMP-MISSINGFILE /var/opt/MarkLogic/Logs/ErrorLog_1.txt\r\n2013-02-18 17:19:11.542 Debug: ForestSynchronizeThread::run: DCPP_Forest35 XDMP-MISSINGFILE: Missing file /data/MarkLogic11/Forests/DCPP_Forest35/Large/315/c55ada9ba870453c\r\n2013-02-18 17:20:28.991 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:20:56.665 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:21:21.656 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:21:48.487 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:22:13.598 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:22:39.067 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:23:04.461 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:23:27.455 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:23:52.810 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:24:18.958 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:24:45.280 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:25:12.684 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:25:38.666 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n2013-02-18 17:26:02.461 Debug: ForestSynchronizeThread::run: DCPP_Forest30 XDMP-MISSINGFILE: Missing file /data/MarkLogic06/Forests/DCPP_Forest30/Large/3f2/fc9a2662f1b9a7c1\r\n", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea2", "fixedin":"7.0-ea2", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20837, "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "wfeick"], "changeHistory":[{"time":"2013-02-19T11:38:50.438509-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-19T16:39:29.105482-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"132500", "paths":["xdmp/branches/b5_0/src/Forest.cpp", "xdmp/branches/b5_0/src/BinaryManager.h", "xdmp/branches/b5_0/src/BinaryManager.cpp"], "affectedBugs":[]}, "comment":"bug:20837 a speculative fix; more trace events"}, {"time":"2013-02-20T10:56:42.339459-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"132642", "paths":["xdmp/branches/b5_0/src/Forest.cpp"], "affectedBugs":[]}, "comment":"Bug:20837 respond to XDMP-MISSINGFILE during large binary bulk replication by replicating the binary again."}, {"time":"2013-02-20T12:11:00.558506-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-1"}}, "files":[], "show":true}, {"time":"2013-02-21T11:12:21.791867-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"132907", "paths":["xdmp/trunk/src/BinaryManager.h", "xdmp/trunk/src/Forest.cpp", "xdmp/trunk/src/BinaryManager.cpp"], "affectedBugs":[]}, "comment":"bug:20851 XDMP-MISSINGFILE during replication"}, {"time":"2013-02-21T11:14:47.232614-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-21T11:14:47.232614-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-21T11:14:47.232614-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"tofixin":{"from":"7.0-1", "to":"7.0-ea2"}}, "files":[], "show":true}, {"time":"2013-05-03T14:40:02.547561-07:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-05-07T11:25:29.533236-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Steps to Verify:\r\n \r\n1. Create Database in two different clusters and enable database replication.\r\n2. Insert Large binaries in Master and let it replicate to replica database.\r\n3. Bring host down in replica that has Forest with replicated binary.\r\n4. Remove forest Label from forest's data directory.\r\n5. Delete large binary from Forests's data directory (on replica)\r\n6. Modify the large binary on Master (add a collection or something).\r\n7. Bring replica host back up.\r\n \r\nWhat should happen:\r\n - It should be reported in ErrorLog that Largebinary is missing with XDMP-MISSINGFILE\r\n - Then replica forest should sync up with master and get the missing file (bulk replicate).\r\n - Check contents of file on master and replica (md5sum) "}, {"time":"2013-05-07T11:46:20.221029-07:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified with MarkLogic-7.0-20130506\r\n\r\n==\r\n2013-05-07 11:41:35.273 Info: Forest Test-F1 replicating 1 keys to foreign forest Test-F1 in cluster rh5-intel64-22.marklogic.com-cluster\r\n2013-05-07 11:41:35.351 Info: Forest Test-F1 needs to replicate 1 fragments to foreign forest Test-F1 in cluster rh5-intel64-22.marklogic.com-cluster\r\n2013-05-07 11:41:35.376 Warning: Forest Test-F1 missing large binary file: XDMP-MISSINGFILE: Missing file /var/opt/MarkLogic/Forests/Test-F1/Large/0ec/3b2a71f0f9965a12\r\n2013-05-07 11:41:36.808 Info: Deleted 1 MB in 1 sec at 455 MB/sec /var/opt/MarkLogic/Forests/Test-F1/00000002\r\n2013-05-07 11:41:36.813 Info: Deleted 15 MB in 1 sec at 3041 MB/sec /var/opt/MarkLogic/Forests/Test-F1/00000000\r\n2013-05-07 11:42:08.233 Info: Saving /var/opt/MarkLogic/Forests/App-Services/00000004\r\n2013-05-07 11:42:08.296 Debug: OnDiskStand /var/opt/MarkLogic/Forests/App-Services/00000004, disk=15MB, memory=16MB\r\n2013-05-07 11:42:08.297 Info: Saved 15 MB in 1 sec at 233 MB/sec to /var/opt/MarkLogic/Forests/App-Services/00000004\r\n2013-05-07 11:42:08.297 Debug: ~InMemoryStand /var/opt/MarkLogic/Forests/App-Services/00000004\r\n2013-05-07 11:42:08.302 Info: Merging 3 MB from /var/opt/MarkLogic/Forests/App-Services/00000004 and /var/opt/MarkLogic/Forests/App-Services/00000003 to /var/opt/MarkLogic/Forests/App-Services/00000005\r\n2013-05-07 11:42:08.368 Debug: OnDiskStand /var/opt/MarkLogic/Forests/App-Services/00000005, disk=0MB, memory=1MB\r\n2013-05-07 11:42:08.368 Info: Merged 1 MB in 1 sec at 15 MB/sec to /var/opt/MarkLogic/Forests/App-Services/00000005\r\n2013-05-07 11:42:08.371 Debug: ~OnDiskStand /var/opt/MarkLogic/Forests/App-Services/00000004\r\n2013-05-07 11:42:08.372 Debug: ~OnDiskStand /var/opt/MarkLogic/Forests/App-Services/00000003\r\n2013-05-07 11:42:10.862 Info: Deleted 15 MB in 1 sec at 2326 MB/sec /var/opt/MarkLogic/Forests/App-Services/00000004\r\n2013-05-07 11:42:10.863 Info: Deleted 1 MB in 1 sec at 885 MB/sec /var/opt/MarkLogic/Forests/App-Services/00000003\r\n2013-05-07 11:42:42.288 Debug: InMemoryStand /var/opt/MarkLogic/Forests/App-Services/00000006, disk=15MB, memory=655MB, list=512MB, tree=128MB, rangeIndex=16MB, reverseIndex=16MB, tripleIndex=16MB\r\n2013-05-07 11:43:01.863 Info: Forest Test-F1 bulk replicated 1 fragments (0 skipped, 0 not found) to foreign forest Test-F1 in cluster rh5-intel64-22.marklogic.com-cluster (0/sec)\r\n2013-05-07 11:43:02.295 Info: Forest Test-F1 finished bulk replicating to foreign forest Test-F1 in cluster rh5-intel64-22.marklogic.com-cluster\r\n2013-05-07 11:43:02.379 Info: Forest Test-F1 finished synchronizing to foreign replica forest Test-F1 in cluster rh5-intel64-22.marklogic.com-cluster\r\n==\r\n\r\nVerified md5 on both Master and Replica after replication:\r\n\r\nOn Master:\r\nxdmp:md5(xdmp:subbinary(fn:doc(\"/binary-support/suddenly.mpeg\")/binary(),1,100),\"hex\") ==> a60f968dc6406144e211aa00a208ee79\r\n\r\nOn Replica:\r\nxdmp:md5(xdmp:subbinary(fn:doc(\"/binary-support/suddenly.mpeg\")/binary(),1,100),\"hex\") ==> a60f968dc6406144e211aa00a208ee79"}], "updatedAt":"2013-05-07T11:46:20.221029-07:00", "fixedAt":"2013-02-21T11:14:47.232614-08:00", "fixedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "shippedAt":"2013-05-07T11:46:20.221029-07:00", "shippedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "renderDescriptionAs":"normal"}