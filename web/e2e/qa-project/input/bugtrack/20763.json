{"id":20763, "kind":"Bug", "createdAt":"2013-02-12T10:48:02.647507-08:00", "status":"Will not fix", "title":"REGR: 5.0 search unit-test failure (cts:similar-query)", "category":"xdmp", "severity":"Minor", "priority":{"level":"2", "title":"Not required for product release"}, "submittedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"5.0 search unit-test failure started on 02/12 build\r\n\r\n  <h:result-text><results notice=\"empty if all tests ran successfully\"><report group=\"search\"><setup/><tests><FAIL id=\"similar-1\"><diff uri=\"/testdocs/stored/doc-2013-02-12T00:49:35.802483-08:00-/opt/MarkLogic/Apps//test/appservices/search-unittest/data/geodata/1000quakes.xml\"><expected/><actual><uri>/testdocs/stored/doc-2013-02-12T00:49:35.802483-08:00-/opt/MarkLogic/Apps//test/appservices/search-unittest/data/geodata/1000quakes.xml</uri></actual><search:result confidence=\"0\" fitness=\"0\" index=\"7\" path=\"fn:doc(\"/testdocs/stored/doc-2013-02-12T00:49:35.802483-08:00-/opt/MarkLogic/Apps//test/appservices/search-unittest/data/geodata/1000quakes.xml\")\" score=\"0\" uri=\"/testdocs/stored/doc-2013-02-12T00:49:35.802483-08:00-/opt/MarkLogic/Apps//test/appservices/search-unittest/data/geodata/1000quakes.xml\" xmlns:search=\"http://marklogic.com/appservices/search\">\r\n\t    <search:similar>/testdocs/stored/doc-2013-02-12T00:49:35.802483-08:00-/opt/MarkLogic/Apps//test/appservices/search-unittest/data/geodata/1000quakes.xml</search:similar>\r\n\t    <search:snippet>\r\n\t      <search:match path=\"fn:doc(\"/testdocs/stored/doc-2013-02-12T00:49:35.802483-08:00-/opt/MarkLogic/Apps//test/appservices/search-unittest/data/geodata/1000quakes.xml\")/quakes\">0 0 1 15813 PDE 1991 3 3 233321.41 70.65</search:match>\r\n\t    </search:snippet>\r\n\t  </search:result></diff></FAIL></tests><teardown/></report></results></h:result-text>\r\n  <h:expected-result><results notice=\"empty if all tests ran successfully\"/></h:expected-result>", "samplequery":"", "sampledata":"", "version":"5.0-nightly", "tofixin":"5.0-7", "fixedin":"N/A", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, {"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "ayuwono"], "changeHistory":[{"time":"2013-02-12T10:48:02.647507-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-13T09:01:01.048565-08:00", "updatedBy":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi, Raghu -- as I indicated in my note, it looks like cts:similar-query() is now returning the model node in the similar set, which if confirmed would be a bug in cts:similar-query().\r\n"}, {"time":"2013-02-13T09:01:01.048565-08:00", "updatedBy":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-13T14:14:59.587795-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"Erik, please elaborate.\r\nI may be wrong, but I don't think think it's a bug for cts:similar-query to match a document in the database \r\nwhen that document is passed as the argument to the query."}, {"time":"2013-02-13T14:20:07.462341-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Eric sent me this test case and i have asked him the same question.\r\n\r\nWhen I execute the following, the model document (\"/tmp/testdoc.xml\") is the first result document for the similar query.\r\n\r\n\r\nErik Hennum\r\n\r\nxquery version \"1.0-ml\";\r\n\r\nxdmp:document-insert(\"/tmp/testdoc.xml\",\r\n<quakes><quake>\r\n <area>0</area>\r\n <perimeter>0</perimeter>\r\n <quakesx020>1</quakesx020>\r\n <quakesx0201>15813</quakesx0201>\r\n <catalog_sr>PDE</catalog_sr>\r\n <year>1991</year>\r\n <month>3</month>\r\n <day>3</day>\r\n <origin_tim>233321.41</origin_tim>\r\n <lat>70.65</lat>\r\n <lon>-14.95</lon>\r\n <depth>10</depth>\r\n <magnitude>4.3</magnitude>\r\n <mag_scale>mb</mag_scale>\r\n <mag_source/>\r\n</quake>\r\n</quakes>)\r\n;\r\nxquery version \"1.0-ml\";\r\n\r\ncts:search(fn:collection(),cts:similar-query(fn:doc(\"/tmp/testdoc.xml\")))\r\n"}, {"time":"2013-02-13T14:50:55.954485-08:00", "updatedBy":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Maybe I'm misinterpreting the evidence.  I'm seeing that:\r\n\r\n*  The Search API interface to cts:similar-query() doesn't filter out the model document.\r\n*  The unit test (which has been stable and passing for a while) expects an empty result list.\r\n\r\nThe test machine is currently running the regressions.  When the regression tests finish, I'll investigate farther.\r\n"}, {"time":"2013-02-13T14:50:55.954485-08:00", "updatedBy":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "to":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-13T14:52:27.124563-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I have reproduced the same behavior on 5.0-4 build too. One other thing i noticed that it only returns the document as match when inserted doc is still in-memory and when it is flushed to on-disk stand it doesn't match. Again this behavior is also consistent with both 5.0-nightly and 5.0-4."}, {"time":"2013-02-13T14:52:27.124563-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-13T14:56:32.459717-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-13T15:15:55.047433-08:00", "updatedBy":{"username":"dgorbet", "name":"David Gorbet", "email":"David.Gorbet@marklogic.com"}, "change":{"tofixin":{"from":"5.0-5", "to":"5.0-6"}}, "files":[], "show":true}, {"time":"2013-02-13T15:41:57.259302-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"This is not an interesting test.\r\nStatistics for similar query are computed differently for in-memory and on-disk stands.\r\nAlso, similar query is not intended to work on databases with small number of documents.\r\nIt is designed to work well on databases with large numbers of documents.\r\nIf one document represents a large fraction of the corpus, logically it is very hard to judge similarity and dissimilarity.\r\n"}, {"time":"2013-02-13T16:04:32.851227-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Mary,\r\n\r\nBased on Christopher's comment not sure if we can fix anything here but please take a look."}, {"time":"2013-02-13T16:04:32.851227-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2013-02-13T20:57:30.472434-08:00", "updatedBy":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Point well taken that the failing Search API similar test would be better if it expected different documents rather than the empty test.\r\n\r\nOn the larger point about model document appearing in the similar set, FWIW, my naive expectations are likely conditioned by the Google similar link, which on a cursory inspection seems to filter out the model document, not that their choice for web scale is right choice for enterprise scale.\r\n"}, {"time":"2015-03-05T06:04:19.053975-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"status":{"from":"Verify", "to":"Will not fix"}, "assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"EOL"}, {"time":"2015-03-05T06:04:19.053975-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2015-03-05T06:04:19.053975-08:00", "renderDescriptionAs":"normal"}