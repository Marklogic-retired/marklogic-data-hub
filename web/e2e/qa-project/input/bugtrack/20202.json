{"id":20202, "kind":"Bug", "createdAt":"2012-11-21T07:25:19.98869-08:00", "status":"Will not fix", "title":"XML Schema types randomly getting confused on schema update", "category":"xdmp", "severity":"Minor", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"This bug is being filed in part based on a discussion we've been having internally (as the support team):\r\nhttps://help.marklogic.com/staff/Tickets/Ticket/View/11930\r\n\r\nWe have a customer use case which seems to be difficult to reproduce and which little progress seems to have been made so far in attempts to reproduce the issue.  \r\n\r\nThe customer reports the following behaviour:\r\n1. A schema change is made while the database is \"live\"\r\n2. Queries made against documents sporadically report incorrect datatypes.  An example of which includes this error:\r\n\r\n<error:format-string>XDMP-LEXVAL: xs:boolean(\"Nathan Alison\") -- Invalid lexical value \"Nathan Alison\"</error:format-string>\r\n\r\nAccording to their schema, this value should have been an xs:normalizedString and they inform us that at no time was this cast to an xs:boolean.\r\n\r\nThey go on to say:\r\n\"This seems to have been triggered by a schema update which included new simpleType definitions.\r\n\r\nSeems to me like types are not being flushed/rebuilt correctly after schemas are re-loaded. I've only been able to fix this today by re-indexing the content database; re-indexing or clearing and re-loading the Schemas database did not work, a full re-index of the content database did. This is obviously not practical in production!\"\r\n\r\nThis bug is being filed to track progress of this issue - although without a reproducible test case, we do not expect the issue to gain much traction.  I will work to make sure any similar future issues of this nature are documented as part of this bug also.", "samplequery":"", "sampledata":"", "version":"6.0-2", "tofixin":"N/A", "fixedin":"N/A", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, {"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20132, "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"Medium", "title":"Requires significant or unnatural effort to work around issue or to prevent significant business impact"}, "workaround":""}, "tags":["xdmp", "ableasdale"], "changeHistory":[{"time":"2012-11-21T14:33:47.220142-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-21T14:33:47.220142-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-21T14:33:47.220142-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-5"}}, "files":[], "show":true}, {"time":"2012-11-21T16:04:26.588836-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-05T12:03:52.008939-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2012-12-05T12:15:01.582973-08:00", "updatedBy":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Could this be indirectly caused by documents with cached schema types in the expanded tree cache?"}, {"time":"2013-01-28T03:08:54.447389-08:00", "updatedBy":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"On 25/01/13 15:28, Mary Holstege wrote:\r\n\r\nIt is possible that this has to do with the the fact that\r\ndata models in the expanded tree cache may already have\r\nbeen type annotated and then the schema gets changed.\r\nBut I don't quite get how this theory gets you to a\r\nLEXVAL error to a type that was never germane to the\r\nelement in question.\r\n\r\nBut then again, we don't have the schemas (either version)\r\nor the XQuery modules being run that failed, so it is hard\r\nto know.\r\n\r\nI also think it is low priority as the case is closed, and it\r\nonly happens if you dick around with your schemas while\r\nrunning a live system, and the schema system really\r\nwasn't engineered for that.\r\n\r\nOTOH:\r\n\r\nI think the right action on this bug is to create a schema\r\nstress/torture test and see what it shakes loose. There\r\nhave been a couple of these \"once I saw something really\r\nbad in schema processing\" bugs that we haven't got\r\nanywhere with.  I'd do this in the context of 7 and backport\r\nany necessary fixes."}, {"time":"2013-02-28T11:50:28.800085-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"6.0-3", "to":"6.0-4"}}, "files":[], "show":true}, {"time":"2013-05-06T08:29:07.947627-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"No plan to do it in ML7 as we are short handed now.  will consider its scope later and make assignment."}, {"time":"2013-05-06T08:29:07.947627-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-05-06T08:29:07.947627-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"6.0-4", "to":"8.0-1"}}, "files":[], "show":true}, {"time":"2013-08-29T10:44:55.387839-07:00", "updatedBy":{"username":"dgorbet", "name":"David Gorbet", "email":"David.Gorbet@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Can you comment on the relative priority of a Schema stress test for ML8? Is this something we should resource?"}, {"time":"2013-08-29T10:44:55.387839-07:00", "updatedBy":{"username":"dgorbet", "name":"David Gorbet", "email":"David.Gorbet@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dgorbet", "name":"David Gorbet", "email":"David.Gorbet@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2013-08-29T10:50:53.033736-07:00", "updatedBy":{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"If it helps, I did manage to reproduce the issue on a single host - but not always reliably.  It could serve as a starting point though.\r\n \r\nsee comments in: https://help.marklogic.com/staff/Tickets/Ticket/View/11930"}, {"time":"2013-08-29T10:58:08.407813-07:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"I think it is pretty low priority: schema usage in general is low, and changing schemas a lot in production is really not something we'd expect to see. "}, {"time":"2014-10-11T09:31:33.339872-07:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"status":{"from":"Verify", "to":"Fix"}, "assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true, "comment":"Will have another run at this. Low priority: people experiencing this have a workaround."}, {"time":"2014-10-31T15:53:01.015968-07:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"tofixin":{"from":"8.0-1", "to":"N/A"}}, "files":[], "show":true}, {"time":"2015-06-25T15:35:55.169999-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"Fix", "to":"Will not fix"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"low priority and fallen off the radar. \r\nreopen and clone forward if we think we still need a fix"}], "updatedAt":"2015-06-25T15:35:55.169999-07:00", "renderDescriptionAs":"normal"}