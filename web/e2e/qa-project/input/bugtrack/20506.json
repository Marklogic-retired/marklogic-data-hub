{"id":20506, "kind":"Bug", "createdAt":"2013-01-17T14:36:35.132692-08:00", "status":"Closed", "title":"xdmp:tidy exhaustive memory and cpu consumption --> crash of server", "category":"xdmp", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"oschwering", "name":"Olav  Schwering", "email":"oschwering@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Converting the attached 44KB file with xdmp:tidy will consume 100% CPU and eats up all available memory after some time with the result that the server crashes.\r\n\r\nThis is the used XQuery code:\r\n\r\nlet $doc := xdmp:document-get(\r\n  \"/path/to/20120113.txt\",\r\n<options xmlns=\"xdmp:document-get\">\r\n     <format>xml</format>\r\n    </options>\r\n    )\r\nreturn xdmp:tidy($doc//articles/article/message/text())\r\n\r\nTested on on 5.0 and 6.0 versions. \r\n\r\n\r\n", "samplequery":"", "sampledata":"", "version":"5.0-4.2", "tofixin":"5.0-5", "fixedin":"5.0-5", "platform":"all", "memory":"", "processors":"", "note":"Fails also on 6.0.", "subscribers":[{"username":"oschwering", "name":"Olav  Schwering", "email":"oschwering@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}], "attachments":[{"name":"conversion file", "uri":"root/support/bugtracking/attachments/20506/20120113.txt"}, {"name":"server error log", "uri":"root/support/bugtracking/attachments/20506/ErrorLog.txt"}, {"name":"linux /var/log/messages", "uri":"root/support/bugtracking/attachments/20506/messages.txt"}], "relationships":[{"type":"", "to":""}], "clones":[20544, 20545], "cloneOf":"", "support":{"headline":"xdmp:tidy of source needing list and nested table inference can loop, exhaust memory, and crash the server.", "supportDescription":"When xdmp:tidy is run on a source document with an element pattern such as the following, where a <ul> element must be deduced from <li> and a nested table must be deduced within the same outer table element context, this can cause an infinite loop in system software, exhaust memory, and crash the server.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"High", "title":"Significant business impact with no reasonable workaround"}, "workaround":""}, "tags":["xdmp", "oschwering"], "changeHistory":[{"time":"2013-01-17T15:24:24.966985-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}}}, "files":[], "show":true, "comment":"Scott, can you see if you can reproduce this and evaluate the cause?"}, {"time":"2013-01-17T15:24:24.966985-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-17T15:24:24.966985-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-5"}}, "files":[], "show":true}, {"time":"2013-01-21T16:45:02.775469-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi Scott,\r\nSupport team thinks that this bug has high customer impact.  They want it to be fixed in 5.0-5.  Please give it a high priority.  Thanks."}, {"time":"2013-01-21T17:17:15.698366-08:00", "updatedBy":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"128637", "paths":["xdmp/branches/b5_0/src/tidy/src/parser.c"], "affectedBugs":[]}, "comment":"bug:20506 - in ParseList (which may be entered when processing an inferred list), set lexer->inTable to 'no' and reset it on exit--a more airtight test than the 18154 attempt to infer whether the context was 'implicit' at row element parsing time."}, {"time":"2013-01-21T17:19:48.637651-08:00", "updatedBy":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"Fixed in our copy of the open source 'tidy' parser."}, {"time":"2013-01-21T17:19:48.637651-08:00", "updatedBy":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "change":{"assignTo":{"from":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-22T08:22:07.109713-08:00", "updatedBy":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "to":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}}}, "files":[], "show":true, "comment":"Fix attempt caused a difference in the test output for 3531.\r\n"}, {"time":"2013-01-22T08:22:07.109713-08:00", "updatedBy":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "change":{"assignTo":{"from":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "to":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-22T13:21:33.23472-08:00", "updatedBy":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"128786", "paths":["xdmp/branches/b5_0/src/tidy/src/parser.c"], "affectedBugs":[]}, "comment":"bug:20506 - preserve ML-specific logic that can remove a list element inside a table rather than inferring a nested table."}, {"time":"2013-01-23T08:27:39.019474-08:00", "updatedBy":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"Fixed the regression in bug3531.xml."}, {"time":"2013-01-23T08:27:39.019474-08:00", "updatedBy":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "change":{"assignTo":{"from":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-28T10:13:59.042492-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-28T13:16:06.729082-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Duplicated the slowness and heavy CPU utilization in 5.0-4.2 and verified the fix on build 5.0-20130124. Also made sure bug3531.xml passed in nightly regression since 24th Jan."}, {"time":"2013-02-25T17:15:29.72481-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-02-25T17:15:29.72481-08:00", "fixedAt":"2013-01-23T08:27:39.019474-08:00", "fixedBy":{"username":"smiller", "name":"Scott Miller", "email":"Scott.Miller@marklogic.com"}, "shippedAt":"2013-01-28T13:16:06.729082-08:00", "shippedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "closedAt":"2013-02-25T17:15:29.72481-08:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}