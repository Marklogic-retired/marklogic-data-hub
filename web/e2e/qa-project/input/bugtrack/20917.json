{"id":20917, "kind":"Bug", "createdAt":"2013-02-25T03:29:43.152483-08:00", "status":"Closed", "title":"REGR:incorrect count is returned by cts:and-query on cts:words", "category":"search", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"REGR:incorrect count is returned by cts:and-query on cts:words\r\n\r\nTest failing: forestSpecificSearchqmode.xml\r\nML version: 7.0-20130224\r\nLink to diff: https://regression-status.marklogic.com/new-app/space2/diff-archive/b7_0-ea1/2013-02-24/linux-64-rh5-cluster/diffs/forestSpecificSearchqmode.xml\r\n\r\nSteps to reproduce:\r\n\r\n1. Create DB say fssDB\r\n2. Add frag root\r\nxquery version \"1.0-ml\";\r\n        import module namespace admin = \"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n        let $config := admin:get-configuration()\r\n        let $dbid := xdmp:database(\"fssDB\")\r\n        let $fragspec := admin:database-fragment-root(\"\", \"MedlineCitation\")\r\n        let $c := admin:database-add-fragment-root($config, $dbid, $fragspec)\r\n        return\r\n                admin:save-configuration($c)\r\n3. Add WORD LEXICON\r\n4. Enable uri-lexicon\r\n5. Set collection-lexicon true\r\n6. Add element-word-lexicon:\r\nxquery version \"1.0-ml\";\r\n        import module namespace admin = \"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n        let $config := admin:get-configuration()\r\n        let $dbid := xdmp:database(\"fssDB\")\r\n        let $lexspec := admin:database-element-word-lexicon(\"\", \"SPEAKER\", \"http://marklogic.com/collation/\" )\r\n        let $c := admin:database-add-element-word-lexicon($config, $dbid, $lexspec)\r\n        return\r\n                admin:save-configuration($c)\r\n7. Add element-attribute-word-lexicon\r\nxquery version \"1.0-ml\";\r\n        import module namespace admin = \"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n        let $config := admin:get-configuration()\r\n        let $dbid := xdmp:database(\"fssDB\")\r\n        let $lexspec := admin:database-element-attribute-word-lexicon(\"\", \"fname\", \"\", \"initial\", \"http://marklogic.com/collation/\" )\r\n        let $c := admin:database-add-element-attribute-word-lexicon($config, $dbid, $lexspec)\r\n        return\r\n                admin:save-configuration($c)\r\n8. Add range element index\r\nxquery version \"1.0-ml\";\r\n        import module namespace admin = \"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n        let $config := admin:get-configuration()\r\n        let $dbid := xdmp:database(\"fssDB\")\r\n        let $rangespec := admin:database-range-element-index(\"string\", \"\", \"fname\", \"http://marklogic.com/collation/\", fn:false() )\r\n        let $c := admin:database-add-range-element-index($config, $dbid, $rangespec)\r\n        return\r\n                admin:save-configuration($c)\r\n\r\n9. Add range element attr index\r\nxquery version \"1.0-ml\";\r\n        import module namespace admin = \"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n        let $config := admin:get-configuration()\r\n        let $dbid := xdmp:database(\"fssDB\")\r\n        let $rangespec := admin:database-range-element-attribute-index(\"string\", \"\", \"fname\", \"\", \"initial\", \"http://marklogic.com/collation/\", fn:false() )\r\n        let $c := admin:database-add-range-element-attribute-index($config, $dbid, $rangespec)\r\n        return\r\n                admin:save-configuration($c)\r\n10. Create 4 forest say forestA,forestB,forestC,fsemptyforest and associate them with the db\r\n11. Set default-time-limit of QAxdbcServer to 1200\r\n12. Load Data:\r\ndefault element namespace=\"http://marklogic.com/xdmp/directory\"\r\nfor $a in data(xdmp:filesystem-directory(\"QA_HOME/testdata/1.2Scripts/Shakespeare\")//pathname)\r\nlet $name :=substring-after($a, \"QA_HOME/testdata/1.2Scripts/Shakespeare/\")\r\nreturn\r\n        if (contains($name,\".xml\"))\r\n                 then xdmp:document-load($a,\r\n                 <options xmlns=\"xdmp:document-load\">\r\n                         <uri>{$name[last()]}</uri>\r\n                         <forests>\r\n                                <forest>{xdmp:forest(\"forestA\")}</forest>\r\n                         </forests>\r\n                 </options>)\r\n        else ();\r\n\r\nxdmp:document-insert(\"doc1.xml\",\r\n<doc1>\r\n        <fname initial=\"rl\">Rachel Link</fname>\r\n        <fname initial=\"rp\">Raghu Polasani</fname>\r\n        <fname initial=\"jc\">Justin Cooper</fname>\r\n        <fname initial=\"rh\">Ron Hitchins</fname>\r\n        <fname initial=\"ra\">Ron Avnur</fname>\r\n</doc1>,xdmp:default-permissions(),\"http://marklogic.com/forestAdoc1\",0, xdmp:forest(\"forestA\")),\r\n\r\nxdmp:document-insert(\"doc2.xml\",\r\n<doc2>\r\n        <fname initial=\"rj\">Rick James</fname>\r\n        <fname initial=\"mt\">Michael Thomas</fname>\r\n        <fname initial=\"gw\">George Washington</fname>\r\n        <fname initial=\"jd\">Jimmy Dean</fname>\r\n        <fname initial=\"jw\">John Wayne</fname>\r\n        <fname initial=\"rh\">Ron Howard</fname>\r\n</doc2>,xdmp:default-permissions(),\"http://marklogic.com/forestBdoc2\",0, xdmp:forest(\"forestB\")),\r\n\r\nxdmp:document-insert(\"doc3.xml\",\r\n<doc3>\r\n        <SPEECH>\r\n                <SPEAKER>HENRY</SPEAKER>\r\n                <LINE>I played hamlet in highschool</LINE>\r\n                <LINE>The audience showered me with flowers</LINE>\r\n                <LINE>Have you done Hamlet before?</LINE>\r\n        </SPEECH>\r\n        <SPEECH>\r\n                <SPEAKER>ABE</SPEAKER>\r\n                <LINE>No Hamlet for me...Just Romeo and Juliet</LINE>\r\n        </SPEECH>\r\n</doc3>,xdmp:default-permissions(),\"http://forestBdoc3\",0, xdmp:forest(\"forestB\")),\r\n\r\nxdmp:document-load(\"QA_HOME/testdata/2.2/medline03n0331.xml\",\r\n<options xmlns=\"xdmp:document-load\">\r\n        <uri>medline.xml</uri>\r\n        <forests>\r\n                <forest>{xdmp:forest(\"forestC\")}</forest>\r\n        </forests>\r\n</options>)\r\n13. Run following query:\r\ncount(cts:words(\"hamlet\",(),cts:and-query(()),1.0,xdmp:forest(\"forestA\")))\r\n\r\nActual count: 6706\r\nExpected count: 16796", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea1", "fixedin":"N/A", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, {"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, {"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["search", "iagrawal"], "changeHistory":[{"time":"2013-02-25T03:29:43.152483-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-25T11:54:29.601674-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2013-02-25T11:55:19.090573-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"And another possible manifestation."}, {"time":"2013-02-25T11:55:19.090573-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-25T11:55:19.208928-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"And another possible manifestation."}, {"time":"2013-02-25T11:56:45.866503-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"It may be related to bug 20916."}, {"time":"2013-02-25T12:00:59.489119-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The query is not wildcarded. Suspect not related to my recent change."}, {"time":"2013-02-25T15:12:12.554377-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Regression started on 20130222."}, {"time":"2013-02-25T15:38:50.16136-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This regression seems to be related. \r\n\r\n\r\nforestSpecificSearchumode.xml:\r\nLink to diff: https://regression-status.marklogic.com/new-app/space2/diff-archive/b7_0-ea1/2013-02-24/linux-64-rh5-cluster/diffs/forestSpecificSearchumode.xml\r\n \r\nXquery:\r\nlet $a := (if (2 eq 1) then xdmp:document-insert(\"fool.xml\",<foo/>) else ()) return count(cts:word-match(\"ham*\",(),cts:and-query(()),1.0,xdmp:forest(\"forestC\")))\r\n \r\nActual result:153\r\nExpected Result: 152\r\n"}, {"time":"2013-02-25T15:59:21.36933-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This does not seem to be a search related problem, rebalancing is turned on and forest query returns incorrect result. Please change the test case and disable rebalancing. same applies to 20916."}, {"time":"2013-02-25T16:00:51.600238-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Is the rebalancer disabled in this test?  If no so, a document inserted with placeKeys (or in-forest evals) will likely be moved by the rebalancer.  That can lead to incorrect count (also with placeKeys)."}, {"time":"2013-02-25T16:03:50.587104-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{"assignTo":{"from":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-26T22:44:20.390027-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"please disable rebalancer in the test and see if the test passes. If test still fails after disabling rebalancer, please assign the bug back to Haitao."}, {"time":"2013-02-26T22:44:20.390027-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-27T23:54:10.146959-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Turned off rebalancer in test forestSpecificSearchqmode.xml and it passed on ML Version 20130217, hence closing the bug\r\n"}], "updatedAt":"2013-02-27T23:54:10.146959-08:00", "closedAt":"2013-02-27T23:54:10.146959-08:00", "closedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "renderDescriptionAs":"normal"}