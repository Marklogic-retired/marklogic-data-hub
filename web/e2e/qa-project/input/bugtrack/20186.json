{"id":20186, "kind":"Bug", "createdAt":"2012-12-03T15:18:32.158327-08:00", "status":"Closed", "title":"windows SVC-FILREN xdmp:write-cluster-config-file Permission denied", "category":"xdmp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Create a dev build of MarkLogic on b6_0 branch\r\nMake sure the Data directory does not exist.\r\nRun with standard dev startup\r\n   MarkLogic -d Data -i . -t\r\n\r\nAccept EULA and restart marklogic as needed\r\n\r\nWhen shown the comment that ML needs to install the system databases, hit OK.  Wait about 1 minute\r\nYou get this error:\r\n\r\nYou've encountered an error in the server. Please copy the text below, and email support (support@marklogic.com):\r\n500: Internal Server Error\r\nSVC-FILREN: xdmp:write-cluster-config-file(\"server.xml\", <server xsi:schemaLocation=\"http://marklogic.com/xdmp/group group.xsd\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://marklogic.com/xdmp/group\"><host-id>16327661571594465569</host-id><licensee/><license-key/>...</server>) -- File rename error: rename 'c:\\Work\\MarkLogic\\workspace\\xdmp-b6_0\\src\\Data\\server.xml to c:\\Work\\MarkLogic\\workspace\\xdmp-b6_0\\src\\Data\\server_1.xml': Permission denied\r\nIn /initialize-go.xqy on line 100\r\n$confirm = \"40\"\r\n$cancel = \"\"\r\n$server = <server xsi:schemaLocation=\"http://marklogic.com/xdmp/group group.xsd\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://marklogic.com/xdmp/group\"><host-id>16327661571594465569</host-id><licensee/><license-key/>...</server>\r\n$groups = <groups xsi:schemaLocation=\"http://marklogic.com/xdmp/group group.xsd\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://marklogic.com/xdmp/group\"><group><group-name>Default</group-name><group-id>106802386317182...</groups>\r\n$hosts = <hosts xsi:schemaLocation=\"http://marklogic.com/xdmp/hosts hosts.xsd\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://marklogic.com/xdmp/hosts\"><host><host-id>16327661571594465569</host-id><host-name>hp8460-1...</hosts>\r\n$databases = <databases xsi:schemaLocation=\"http://marklogic.com/xdmp/database database.xsd\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://marklogic.com/xdmp/database\"><database><database-name>Documents</database-name><database-id>6...</databases>\r\n$assignments = <assignments xsi:schemaLocation=\"http://marklogic.com/xdmp/assignments assignments.xsd\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://marklogic.com/xdmp/assignments\"><assignment><forest-name>Documents</forest-name><host>1632766157...</assignments>\r\n$clusters = <clusters xsi:schemaLocation=\"http://marklogic.com/xdmp/clusters clusters.xsd\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://marklogic.com/xdmp/clusters\"><cluster-id>12199717655624647738</cluster-id><cluster-name>hp846...</clusters>\r\n\r\n\r\n--------------------------\r\n\r\nKill MarkLogic (Control - C)\r\n\r\nTry to remove the data directory\r\n\r\nc:\\Work\\MarkLogic\\workspace\\xdmp-b6_0\\src>rm -rf Data\r\nrm: cannot remove `Data/clusters.xml': Permission denied\r\nrm: cannot remove `Data/server.xml': Permission denied\r\n\r\n\r\nYou cannot delete clusters.xml or server.xml with normal user permission.\r\n\r\n\r\n", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-1", "fixedin":"7.0-1", "platform":"windows(64-bit)", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20185, "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "dlee"], "changeHistory":[{"time":"2012-12-03T15:18:32.158327-08:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "to":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-03T15:51:23.817675-08:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I have reproduced this on trunk.  It does seem to require the .options file to not bypass licensing"}, {"time":"2012-12-05T10:29:43.749131-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2012-12-12T15:36:49.553492-08:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"One further clue.  I cannot reproduce this on my desktop but could on my laptop while it was connected to the corp intranet.  The problem seems to be with the ACL assigned to the Data directory.  It enables read/write but not delete.  This propogates to child objects which then cannot be deleted.\r\n\r\nI found some suspect code that might be the issue in File.cpp\r\n\r\nvoid StandardFileImpl::\r\nchmod(const string& path, int mode)\r\n{\r\n#ifndef _WIN32\r\n  if (::chmod(path.c_str(),mode))\r\n    File::error(\"SVC-FILCHMD\",\"chmod\",path);\r\n#else\r\n  if (mode==0600) {\r\n    PSID psidOwner = NULL;\r\n\r\n    BOOL ret = GetNamedSecurityInfo(\r\n                 const_cast<char *>(path.c_str()),\r\n                 SE_FILE_OBJECT,\r\n                 OWNER_SECURITY_INFORMATION,\r\n                 &psidOwner, NULL, NULL, NULL, NULL);\r\n\r\n    if (ret == ERROR_SUCCESS) {\r\n      EXPLICIT_ACCESS ea;\r\n\r\n      ZeroMemory(&ea, sizeof(EXPLICIT_ACCESS));\r\n      ea.grfAccessPermissions = (GENERIC_READ|GENERIC_WRITE);\r\n      ea.grfAccessMode = SET_ACCESS;\r\n      ea.grfInheritance= NO_INHERITANCE;\r\n      BuildTrusteeWithSid(&ea.Trustee, psidOwner);\r\n      PACL pNewDACL = NULL;\r\n      if (SetEntriesInAcl(1, &ea, NULL, &pNewDACL) == ERROR_SUCCESS) {\r\n        SECURITY_DESCRIPTOR sd2;\r\n        InitializeSecurityDescriptor(&sd2, SECURITY_DESCRIPTOR_REVISION);\r\n        SetSecurityDescriptorDacl(&sd2, TRUE, pNewDACL, FALSE);\r\n\r\n        SetFileSecurity(const_cast<char *>(path.c_str()),\r\n\r\n.........\r\n\r\n\r\nI need to investigate if this has unwanted side effects on NTFS systems for certian user configurations.\r\n\r\n\r\n"}, {"time":"2013-02-19T16:54:50.554205-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea1", "to":"7.0-ea2"}}, "files":[], "show":true}, {"time":"2013-04-17T12:38:25.742042-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Defering to 7.0 EA3 no customer complaints"}, {"time":"2013-04-17T12:38:25.742042-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea2", "to":"7.0-ea3"}}, "files":[], "show":true}, {"time":"2013-06-12T10:40:30.21248-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea3", "to":"7.0-1"}}, "files":[], "show":true}, {"time":"2013-07-12T08:29:29.304392-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"I can no longer reproduce this, suspect a corrupt environment on my laptop.\r\n"}, {"time":"2013-07-12T08:29:29.304392-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-07-15T00:51:52.103588-07:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"probably user env issue and no code changed. Hence closing the bug."}], "updatedAt":"2013-07-15T00:51:52.103588-07:00", "fixedAt":"2013-07-12T08:29:29.304392-07:00", "fixedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "closedAt":"2013-07-15T00:51:52.103588-07:00", "closedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "renderDescriptionAs":"normal"}