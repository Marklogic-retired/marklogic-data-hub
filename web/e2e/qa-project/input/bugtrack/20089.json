{"id":20089, "kind":"Bug", "createdAt":"2012-11-14T14:15:39.964394-08:00", "status":"Closed", "title":"Encountering XDMP-NOTXN while running cpox ingestion with Content Pump.", "category":"mlcp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Test case bug19729 is failing with the following errors during load using MLCP with hdfs forest. This is occurring on build MarkLogic-6.0-20121114.x86_64. This test case was checked in on 10/26 and first occurrence of this error was on 10/31.\r\n\r\nrunning following shell command: /space/builder/builds/linux64/b6_0/qa/mlcp/runmlcp.sh /space/builder/builds/linux64/b6_0/qa import -input_file_path /project/engineering/qa/data/cpox-loader/wiki-zip/enwiki-zip -host rh6-intel64-51-test-2.marklogic.com -port 5275 -username admin -password admin -fastload true -mode local -document_type xml -input_compressed -thread_count 16 -input_file_pattern WikiToZip-0000001\\.*\r\nstderr/out from shell cmd: 2012-11-12\r\nstderr/out from shell cmd: drwxrwxrwx 5 builder builder 4096 2012-11-11 08:31:38.431522556 -0800 marklogic-contentpump\r\nstderr/out from shell cmd: directory exists\r\nstderr/out from shell cmd: however it was not created today\r\nstderr/out from shell cmd: Archive:  marklogic-contentpump.zip\r\nstderr/out from shell cmd:    creating: marklogic-contentpump-1.0/\r\nstderr/out from shell cmd:    creating: marklogic-contentpump-1.0/lib/\r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/lib/marklogic-contentpump-1.0.jar  \r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/lib/commons-cli-1.2.jar  \r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/lib/commons-codec-1.3.jar  \r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/lib/commons-logging-1.1.1.jar  \r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/lib/hadoop-core-0.20.2.jar  \r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/lib/log4j-1.2.16.jar  \r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/lib/marklogic-mapreduce-1.1.jar  \r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/lib/marklogic-xcc-6.0.jar  \r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/lib/solr-commons-csv-3.5.0.jar  \r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/lib/xpp3-1.1.3.3.jar  \r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/lib/xstream-1.4.2.jar  \r\nstderr/out from shell cmd:    creating: marklogic-contentpump-1.0/bin/\r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/bin/mlcp.bat  \r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/bin/mlcp.sh  \r\nstderr/out from shell cmd:    creating: marklogic-contentpump-1.0/conf/\r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/conf/log4j.properties  \r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/LEGALNOTICES.txt  \r\nstderr/out from shell cmd:   inflating: marklogic-contentpump-1.0/LICENSE.txt  \r\nstderr/out from shell cmd: data/xml/bigdata directory exists.\r\nstderr/out from shell cmd: 12/11/12 08:33:55 INFO contentpump.LocalJobRunner: Content type: XML\r\nstderr/out from shell cmd: 12/11/12 08:33:55 INFO jvm.JvmMetrics: Initializing JVM Metrics with processName=JobTracker, sessionId=\r\nstderr/out from shell cmd: 12/11/12 08:33:56 INFO input.FileInputFormat: Total input paths to process : 16\r\nstderr/out from shell cmd: 12/11/12 08:33:56 INFO mapreduce.ContentOutputFormat: Running in fast load mode\r\nstderr/out from shell cmd: 12/11/12 08:33:57 INFO contentpump.LocalJobRunner:  completed 0%\r\nstderr/out from shell cmd: 12/11/12 08:49:42 WARN mapreduce.ContentWriter: XDMP-NOTXN: No transaction with identifier 16504971778569555152\r\nstderr/out from shell cmd: 12/11/12 08:50:19 WARN mapreduce.ContentWriter: XDMP-NOTXN: No transaction with identifier 6672864548543188440\r\nstderr/out from shell cmd: 12/11/12 08:50:36 WARN mapreduce.ContentWriter: XDMP-NOTXN: No transaction with identifier 18136690029834301254\r\nstderr/out from shell cmd: 12/11/12 08:50:40 WARN mapreduce.ContentWriter: XDMP-NOTXN: No transaction with identifier 6370660514757750202\r\nstderr/out from shell cmd: 12/11/12 08:50:52 WARN mapreduce.ContentWriter: XDMP-NOTXN: No transaction with identifier 1653939243373861829\r\nstderr/out from shell cmd: 12/11/12 08:50:57 WARN mapreduce.ContentWriter: SVC-EXTIME: Time limit exceeded\r\nstderr/out from shell cmd: 12/11/12 08:50:57 WARN mapreduce.ContentWriter: SVC-EXTIME: Time limit exceeded\r\nstderr/out from shell cmd: 12/11/12 08:50:59 WARN mapreduce.ContentWriter: XDMP-NOTXN: No transaction with identifier 1358330528154123639", "samplequery":"", "sampledata":"", "version":"6.0-nightly", "tofixin":"6.0-3", "fixedin":"N/A", "platform":"linux(64-bit)", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, {"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, {"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}], "attachments":[{"name":"Attaching errorlog that contains latest manual run from today.", "uri":"root/support/bugtracking/attachments/20089/ErrorLog.txt"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["mlcp", "jsolis"], "changeHistory":[{"time":"2012-11-14T14:15:39.964394-08:00", "updatedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "change":{"assignTo":{"from":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "to":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-14T14:29:07.561652-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"We are getting this with forest on local file system and mlcp 1.0 (6.0-1):\r\n\r\nHere's a segment of the log on rh6-intel64-hdfs-1:\r\n2012-11-14 13:59:24.398 Notice: 6001-cpox-: XDMP-NOTXN: No transaction with identifier 14565963198707629357\r\n2012-11-14 13:59:24.398 Notice: 6001-cpox-:  [1.0-ml]\r\n2012-11-14 13:59:32.425 Info: Saved 198 MB in 18 sec at 11 MB/sec to /space/fxue/mldata/Forests/cpox-1-1-7/0000001f\r\n2012-11-14 13:59:36.106 Notice: 6001-cpox-: XDMP-NOTXN: No transaction with identifier 7616247287962790655\r\n2012-11-14 13:59:36.106 Notice: 6001-cpox-:  [1.0-ml]\r\n2012-11-14 13:59:36.826 Info: Saved 197 MB in 18 sec at 11 MB/sec to /space/fxue/mldata/Forests/cpox-1-1-2/0000001f\r\n2012-11-14 13:59:37.245 Info: Merging 389 MB from /space/fxue/mldata/Forests/cpox-1-1-2/0000001d and /space/fxue/mldata/Forests/cpox-1-1-2/0000001f to /space/fxue/mldata/Forests/cpox-1-1-2/00000021, timestamp=13529303725437820\r\n2012-11-14 13:59:40.378 Info: Merged 342 MB in 156 sec at 2 MB/sec to /space/fxue/mldata/Forests/cpox-1-1-7/00000020\r\n2012-11-14 13:59:42.830 Info: Deleted 196 MB in 1 sec at 1068 MB/sec /space/fxue/mldata/Forests/cpox-1-1-7/0000001c\r\n2012-11-14 13:59:42.942 Info: Deleted 196 MB in 1 sec at 1748 MB/sec /space/fxue/mldata/Forests/cpox-1-1-7/0000001e\r\n2012-11-14 13:59:59.841 Notice: 6001-cpox-: XDMP-NOTXN: No transaction with identifier 14521469963368630132\r\n2012-11-14 13:59:59.841 Notice: 6001-cpox-:  [1.0-ml]\r\n2012-11-14 14:00:21.382 Info: Saving /space/fxue/mldata/Forests/cpox-1-1-8/00000021\r\n2012-11-14 14:00:33.927 Info: Saving /space/fxue/mldata/Forests/cpox-1-1-3/0000001c\r\n "}, {"time":"2012-11-14T14:42:32.210351-08:00", "updatedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Same error is encountered using local forest."}, {"time":"2012-11-14T15:28:28.953136-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"bug19729.xml was added on 10/26 and started failing on 10/31 for the above reason."}, {"time":"2012-11-14T15:38:47.451473-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This is reproducible even with 6.0-1.1 server.  So doesn't look like a regression."}, {"time":"2012-11-14T17:05:15.602665-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Here's the log with 6.0-1.1 server and 1.0 mlcp:\r\n\r\n2012-11-14 17:00:53,032 ERROR com.marklogic.mapreduce.ContentWriter: com.marklogic.xcc.exceptions.XQueryException: XDMP-NOTXN: No transaction with identifier 8656871069113559949\r\n [Session: user=admin, cb=#12573213834778490605 [ContentSource: user=admin, cb={none} [provider: address=rh6-intel64-hdfs-1.marklogic.com/172.18.18.74:6001, pool=0/64]]]\r\n [Client: XCC/6.0-1, Server: XDBC/6.0-1.1]\r\n2012-11-14 17:01:16,550 ERROR com.marklogic.mapreduce.ContentWriter: com.marklogic.xcc.exceptions.XQueryException: Transaction with identifier 16762422318492155205 already completed\r\n [Session: user=admin, cb=#8114078177538066654 [ContentSource: user=admin, cb={none} [provider: address=rh6-intel64-hdfs-4.marklogic.com/172.18.18.97:6001, pool=0/64]]]\r\n [Client: XCC/6.0-1, Server: XDBC/6.0-1.1]\r\n2012-11-14 17:01:19,020 ERROR com.marklogic.mapreduce.ContentWriter: com.marklogic.xcc.exceptions.XQueryException: SVC-EXTIME: Time limit exceeded\r\n [Session: user=admin, cb=#6470953243311892607 [ContentSource: user=admin, cb={none} [provider: address=rh6-intel64-hdfs-3.marklogic.com/172.18.18.76:6001, pool=0/64]]]\r\n [Client: XCC/6.0-1, Server: XDBC/6.0-1.1]\r\n2012-11-14 17:01:36,357 ERROR com.marklogic.mapreduce.ContentWriter: com.marklogic.xcc.exceptions.XQueryException: XDMP-NOTXN: No transaction with identifier 3833662681923733809\r\n [Session: user=admin, cb=#1754704645296848587 [ContentSource: user=admin, cb={none} [provider: address=rh6-intel64-hdfs-2.marklogic.com/172.18.18.75:6001, pool=0/64]]]\r\n [Client: XCC/6.0-1, Server: XDBC/6.0-1.1]\r\n2012-11-14 17:01:42,253 ERROR com.marklogic.mapreduce.ContentWriter: com.marklogic.xcc.exceptions.XQueryException: XDMP-NOTXN: No transaction with identifier 16762422318492155205\r\n [Session: user=admin, cb=#8114078177538066654 [ContentSource: user=admin, cb={none} [provider: address=rh6-intel64-hdfs-4.marklogic.com/172.18.18.97:6001, pool=0/64]]]\r\n [Client: XCC/6.0-1, Server: XDBC/6.0-1.1]\r\n"}, {"time":"2012-11-14T17:19:04.940243-08:00", "updatedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Recreated with tracing turned on. \r\nSee /home/jsolis/bug20089/ErrorLog-bug20089.txt.\r\n\r\n"}, {"time":"2012-11-14T18:06:45.908485-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Error reproduced with any combination of 6.0-1/6.0-2 mlcp and ml server with fast load. Also reproduced in 6.0-1 mlcp 6.0-2 ml server local mode.\r\n\r\nI tried ingesting only one wiki zip (the largest zip enwiki/WikiToZip-00000000.zip) distributedly with both 6.0-1 and got the “no txn with identifier” error.\r\nObservations:\r\n1.\tHadoop does not show any error, only show up in server log.\r\n2.\tAt start, about 3000 shows up in the “deleted fragment” section\r\n\r\nI loaded the same zip with normal mode, no error in server log and loaded 65,534 docs, while fast load loaded only 40,934. Thus might be fastload/memory specific"}, {"time":"2012-11-14T18:08:46.077196-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Command:\r\nmlcp.sh import -mode distributed -host rh6-intel64-hdfs-1 -port 6003 -username admin -password admin -document_type xml -hadoop_home /space2/hadoop-0.20.2 -input_compressed true -input_file_path enwiki-one -batch_size 100 -transaction_size 10 (-output_directory out)>& mlcp.log\r\n\r\nfastload job: http://rh6-intel64-hdfs-1:50030/jobdetails.jsp?jobid=job_201211141307_0003&refresh=0\r\nnormal job: http://rh6-intel64-hdfs-1:50030/jobdetails.jsp?jobid=job_201211141307_0004&refresh=0\r\n\r\nMarklogic version: 6.0-1.1"}, {"time":"2012-11-14T18:35:20.540885-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"examples of error in ErrorLog.txt\r\n\r\n2012-11-14 17:25:07.020 Notice: 6002-cpox-: XDMP-NOTXN: No transaction with identifier 11605049371416107388\r\n2012-11-14 17:25:07.020 Notice: 6002-cpox-:  [1.0-ml]\r\n2012-11-14 17:25:14.234 Notice: 6002-cpox-: XDMP-NOTXN: No transaction with identifier 8296553338808757535\r\n2012-11-14 17:25:14.234 Notice: 6002-cpox-:  [1.0-ml]\r\n2012-11-14 17:25:21.890 Notice: 6002-cpox-: XDMP-NOTXN: No transaction with identifier 10465870613973970924\r\n2012-11-14 17:25:21.890 Notice: 6002-cpox-:  [1.0-ml]\r\n"}, {"time":"2012-11-14T20:06:50.752223-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"changing keep alive timeout to 0 and 150, did not make a difference.\r\n\r\nPer discussion with ali,\r\nbiggest file in the zip: 448KB\r\nso worst case memory consumption: \r\nfilesize*batchsize*numofforest*txnsize=448K*100*32*10=14G for one transaction to commit on the server side, which seems problematic for a 32G machine.\r\nwould be 0.4375G only for normal mode.\r\n\r\nTo verify it is a memory problem, I did\r\n1) normal mode, batch 3200, txn 10  => SVC-EXTIME: Time limit exceeded, 0 doc loaded\r\n    (22,401 in deleted fragment, should be txn rolled back)\r\n2) fast mode, batch 100, txn 1 => no error 65,534 loaded\r\n\r\nwhat we already have:\r\n3) normal mode, batch 100, txn 10 => no error 65,534 loaded\r\n4) fast mode, batch 100, txn 10 =>  XDMP-NOTXN: No transaction with identifier. 40,934 loaded"}, {"time":"2012-11-14T21:42:00.399092-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"My understanding of the worst case memory consumption for \r\n ContentWriter in hadoop connector is filesize*batchsize*numofforest=448K*100*32=1.4G.\r\n\r\n#2 may imply that the bug be relevant to multi-statement transaction. Not necessarily a memory issue."}, {"time":"2012-11-15T10:25:51.964895-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The trace events show that the transactions throwing NOTXN have been rolled back.  The theory is that the transaction exceeded the request time out.  But we don't consistently get SVC-EXTIME logged.  Anyway, testing with increased request timeout now."}, {"time":"2012-11-15T11:27:30.895886-08:00", "updatedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Re-ran test case and still encountered NOTXN errors with increased request timeout = 60 sec.\r\n\r\nLatest ErrorLog and standard output in:\r\n/home/jsolis/bug20089/std.out\r\n/home/jsolis/bug20089/ErrorLog.txt"}, {"time":"2012-11-15T11:33:39.522825-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I'm able to hit this with request timeout set to 10 sec and MarkLogic running in a debugger.  Here's the stack that rolls back the txn:\r\n\r\n8 xdmp::TransactionSection::end() /space/projects/head/xdmp/src/TransactionBuiltins.cpp:831 0x0000000002c04bf2\t\r\n7 xdmp::CompleteTxnTask::run() /space/projects/head/xdmp/src/TransactionBuiltins.cpp:636 0x0000000002c03857\t\r\n6 svc::PooledThread::run() /space/projects/head/xdmp/src/services/ThreadPool.cpp:146 0x0000000002fb9e70\t\r\n5 svc::Thread::top() /space/projects/head/xdmp/src/services/Thread.cpp:274 0x0000000002fb8142\t\r\n4 svc::runThread() /space/projects/head/xdmp/src/services/Thread.cpp:306 0x0000000002fb8647\t\r\n3 start_thread()  0x0000003429006a3a\t\r\n2 clone()  0x0000003428cde62d\t\r\n"}, {"time":"2012-11-15T12:30:54.554262-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Based on the investigation I've done so far, I don't think it's a code bug.  In the latest error log Julio provided, there are also multiple SVC-EXTIME logged.  That's consistent with what I'm seeing.  \r\n\r\nJulio, I know how to make your test pass by either reducing the number of foests, and/or increasing the request time out, and/or reducing batch size and transaction size, and/or avoid using fastload.  The problem is if we do that, I'm not sure if we can still reproduce 19729, which occurred with a high throughput of ingestion.   Let's think about it and talk offline."}, {"time":"2012-11-15T12:30:54.554262-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{"assignTo":{"from":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "to":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-15T16:18:01.690623-08:00", "updatedBy":{"username":"dgorbet", "name":"David Gorbet", "email":"David.Gorbet@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Moving to 6.0-3 to consider (for e.g.) better error message, or something that can be more helpful. Please add bug text. thx."}, {"time":"2012-11-15T16:18:01.690623-08:00", "updatedBy":{"username":"dgorbet", "name":"David Gorbet", "email":"David.Gorbet@marklogic.com"}, "change":{"tofixin":{"from":"6.0-2", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2012-11-15T16:49:30.077246-08:00", "updatedBy":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"To clarify, the time limit exceeded in the test is \"default time limit\", not request timeout."}, {"time":"2012-12-10T14:58:56.737376-08:00", "updatedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Evaluating this test case. Consider moving this test to stress/performance since it is long running. For bug 19729, will need to redesign test case to make it functional but yet will still test 19729. Will provide another update when I complete tasks."}, {"time":"2013-02-15T13:40:53.289948-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Julio, triage team thinks that this is now an issue where the test needs to be fixed.  So in your plate to fix the test."}, {"time":"2013-03-08T11:20:13.876272-08:00", "updatedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Closing this bug since the test case bug19729.xml is able to run without error against Cloudera HDFS.  The previous errors occurred against Hadoop 23.3 HDFS because the machine jchen2 was slower hardware. The errors were timing related and expected, not a bug.\r\n\r\nMoving test case bug19729.xml to stress test since it's long running. I've created a task 21103 to create a more functional test to test bug 19729."}], "updatedAt":"2013-03-08T11:20:13.876272-08:00", "closedAt":"2013-03-08T11:20:13.876272-08:00", "closedBy":{"username":"jsolis", "name":"Julio Solis", "email":"Julio.Solis@marklogic.com"}, "renderDescriptionAs":"normal"}