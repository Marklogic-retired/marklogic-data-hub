{"id":20522, "kind":"Bug", "createdAt":"2013-01-18T15:53:01.471058-08:00", "status":"Closed", "title":"REGR: geospatial query returns some documents where the expected result should be returning 0 documents", "category":"Search API", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Build: 5.0-20130118\r\n\r\nSteps:\r\n======\r\n1) Insert this document:\r\n\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<doc>\r\n<id>A</id>\r\n<text>foo test1 test2 test3 test4 john test6 test7 test8 test9 jane</text>\r\n<person>\r\n<description>\r\n<name>john</name>\r\n<color>red</color>\r\n<bday>2010-07-24</bday>\r\n<height1>17</height1>\r\n</description>\r\n<geo>\r\n<g-elem-point>12,5</g-elem-point>\r\n<g-elem-child-parent>\r\n  <g-elem-child-point>12,5</g-elem-child-point>\r\n</g-elem-child-parent>\r\n<g-elem-pair>\r\n  <lat>12</lat>\r\n  <long>5</long>\r\n</g-elem-pair>\r\n<g-attr-pair lat=\"12\" long=\"5\"/>\r\n</geo>\r\n</person>\r\n<person>\r\n<description>\r\n<name>jane</name>\r\n<color>black</color>\r\n<bday>2011-08-13</bday>\r\n<height2>35</height2>\r\n</description>\r\n<geo>\r\n<g-elem-point>20,-15</g-elem-point>\r\n<g-elem-child-parent>\r\n  <g-elem-child-point>20,-15</g-elem-child-point>\r\n</g-elem-child-parent>\r\n<g-elem-pair>\r\n  <lat>20</lat>\r\n  <long>-15</long>\r\n</g-elem-pair>\r\n<g-attr-pair lat=\"20\" long=\"-15\"/>\r\n</geo>\r\n</person>\r\n</doc>\r\n\r\n2) Run search with this query:\r\nxquery version \"1.0-ml\";\r\n\r\nimport module namespace search = \"http://marklogic.com/appservices/search\"\r\n    at \"/MarkLogic/appservices/search/search.xqy\";\r\n\r\nlet $options :=\r\n<options xmlns=\"http://marklogic.com/appservices/search\">\r\n  <constraint name=\"geo-elem\">\r\n    <geo-elem>\r\n      <element ns=\"\" name=\"g-elem-point\"/>\r\n    </geo-elem>\r\n  </constraint>\r\n  <constraint name=\"eq-name\">\r\n    <element-query ns=\"\" name=\"name\"/>\r\n  </constraint>\r\n</options>\r\n\r\nreturn\r\nsearch:search('geo-elem:\"@70 12,5\" OR (geo-elem:\"@70 18,-15\") eq-name:jane', $options)\r\n\r\nActual Result\r\n===========\r\nThe query returns the document loaded above. This is a regression issue and causing diffs on QA. Before 01/15 build, there is no document returned from the query\r\n\r\nWhen we see the timeline on svn, there is no change on geospatial area around that date", "samplequery":"", "sampledata":"", "version":"5.0-nightly", "tofixin":"5.0-5", "fixedin":"5.0-5", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, {"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["Search API", "ayuwono"], "changeHistory":[{"time":"2013-01-18T15:53:01.471058-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-18T16:34:04.447739-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This is happening on all branches: 5.0, 6.0, and 7.0"}, {"time":"2013-01-18T22:18:44.42231-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi Aries, what was the rationale for returning no document?\r\n\r\nIt looks to me as though one would expect that document to be returned.\r\n\r\nDid it start failing on all branches on 1/15? \r\n\r\nI see that I checked in a performance bug on 1/14.  I'll test to see whether reverting that changes this behavior.  In the meantime, it would be good to know if I inadvertently fixed something.\r\n\r\n\r\n\r\n"}, {"time":"2013-01-21T09:11:27.360831-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi Charles,\r\n\r\nYes it's failing on all branches started on 1/15.\r\n\r\nI also think that it should return the documents, but I just need a confirmation and maybe some explanation from the developers. I'm not sure why before 1/15 the same query is not returning any documents"}, {"time":"2013-01-21T09:12:14.199385-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"And yes, I think it would be great if you can try to revert the code and see if the diffs are gone because of this"}, {"time":"2013-01-21T09:22:49.484793-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"OK When you're in today let's decide which branch you want to verify, and I'll revert that patch.  In the meantime I'll get opinions about this query."}, {"time":"2013-01-21T09:23:59.272175-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true, "comment":"I've verified this regression and know where it came from.  However, I don't understand why this isn't a fix to a bug (why this query should return 0). I'll solicit opinions on this now."}, {"time":"2013-01-21T10:13:38.472366-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Reverting the patch I suspected had no effect on this query.  Appservices concurs that it looks like getting a result is the correct answer."}, {"time":"2013-01-21T19:12:03.805316-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi all,\r\n\r\nSorry the query and the options provided were wrong. The correct query to reproduce the problem is below\r\n\r\nNote that this query has an extra right bracket after \"jane\". If you run this query before 01/15 build, it will return 0 docs. If you run it on 01/15 build or after, it will return 4 docs.\r\n\r\nThere are some steps needed to setup the range index etc. The easiest way is to go to this test on QA repository: searchAPI20-geo-elem-constraints.xml and comment out all of the cleanup steps, and run it against QA harness: make ut tname=searchAPI20-geo-elem-constraints.xml. After that, just run this query below against geo-elem-constraints database  \r\n\r\nxquery version \"1.0-ml\";\r\n \r\nimport module namespace search = \"http://marklogic.com/appservices/search\"\r\n    at \"/MarkLogic/appservices/search/search.xqy\";\r\n \r\nlet $options :=\r\n<options xmlns=\"http://marklogic.com/appservices/search\">\r\n  <constraint name=\"geo-elem\">\r\n    <geo-elem>\r\n      <element ns=\"\" name=\"g-elem-point\"/>\r\n    </geo-elem>\r\n  </constraint>\r\n  <constraint name=\"geo-elem-child\">\r\n    <geo-elem>\r\n      <parent ns=\"\" name=\"g-elem-child-parent\"/>\r\n      <element ns=\"\" name=\"g-elem-child-point\"/>\r\n    </geo-elem>\r\n  </constraint>\r\n  <constraint name=\"geo-elem-pair\">\r\n    <geo-elem-pair>\r\n      <parent ns=\"\" name=\"g-elem-pair\"/>\r\n      <lat ns=\"\" name=\"lat\"/>\r\n      <lon ns=\"\" name=\"long\"/>\r\n    </geo-elem-pair>\r\n  </constraint>\r\n  <constraint name=\"geo-attr-pair\">\r\n    <geo-attr-pair>\r\n      <parent ns=\"\" name=\"g-attr-pair\"/>\r\n      <lat ns=\"\" name=\"lat\"/>\r\n      <lon ns=\"\" name=\"long\"/>\r\n    </geo-attr-pair>\r\n  </constraint>\r\n  <return-metrics>false</return-metrics>\r\n  <constraint name=\"eq-name\">\r\n    <element-query ns=\"\" name=\"name\"/>\r\n  </constraint>\r\n  <constraint name=\"eq-desc\">\r\n    <element-query ns=\"\" name=\"description\"/>\r\n  </constraint>\r\n  <constraint name=\"eq-person\">\r\n    <element-query ns=\"\" name=\"person\"/>\r\n  </constraint>\r\n  <constraint name=\"color\">\r\n    <value>\r\n      <element ns=\"\" name=\"color\"/>\r\n    </value>\r\n  </constraint>\r\n  <constraint name=\"height\">\r\n    <range type=\"xs:int\">\r\n      <element ns=\"\" name=\"height1\"/>\r\n    </range>\r\n  </constraint>\r\n  <constraint name=\"bucket_height\">\r\n    <range type=\"xs:int\">\r\n      <element ns=\"\" name=\"height1\"/>\r\n      <bucket name=\"tall\" ge=\"21\">tall (21+)</bucket>\r\n      <bucket name=\"short\" lt=\"21\">short (0-21)</bucket>\r\n    </range>\r\n  </constraint>\r\n  <constraint name=\"word_const\">\r\n    <word>\r\n      <element ns=\"\" name=\"text\"/>\r\n    </word>\r\n  </constraint>\r\n  <constraint name=\"field_const\">\r\n    <word>\r\n      <field name=\"description\"/>\r\n    </word>\r\n  </constraint>\r\n  <constraint name=\"coll\">\r\n    <collection prefix=\"http://coll/\"/> \r\n  </constraint>\r\n  <constraint name=\"prop\">\r\n    <properties/>\r\n  </constraint>\r\n  <page-length>25</page-length>\r\n  <debug>true</debug>\r\n</options>    \r\n    \r\nreturn\r\nsearch:search('geo-elem:\"@70 12,5\" OR (geo-elem:\"@70 18,-15\") eq-name:jane)', $options)"}, {"time":"2013-01-21T22:56:34.385193-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Okay, I just isolate the issue, please use these steps to setup and run the query:\r\n\r\n1) On your database, add a Geospatial Element Index:\r\nname = g-elem-point\r\npoint format = point\r\nrange value positions = false\r\n\r\n2) Run this document:\r\n<doc>\r\n<id>A</id>\r\n<text>foo test1 test2 test3 test4 john test6 test7 test8 test9 jane</text>\r\n<person>\r\n<description>\r\n<name>john</name>\r\n<color>red</color>\r\n<bday>2010-07-24</bday>\r\n<height1>17</height1>\r\n</description>\r\n<geo>\r\n<g-elem-point>12,5</g-elem-point>\r\n<g-elem-child-parent>\r\n  <g-elem-child-point>12,5</g-elem-child-point>\r\n</g-elem-child-parent>\r\n<g-elem-pair>\r\n  <lat>12</lat>\r\n  <long>5</long>\r\n</g-elem-pair>\r\n<g-attr-pair lat=\"12\" long=\"5\"/>\r\n</geo>\r\n</person>\r\n<person>\r\n<description>\r\n<name>jane</name>\r\n<color>black</color>\r\n<bday>2011-08-13</bday>\r\n<height2>35</height2>\r\n</description>\r\n<geo>\r\n<g-elem-point>20,-15</g-elem-point>\r\n<g-elem-child-parent>\r\n  <g-elem-child-point>20,-15</g-elem-child-point>\r\n</g-elem-child-parent>\r\n<g-elem-pair>\r\n  <lat>20</lat>\r\n  <long>-15</long>\r\n</g-elem-pair>\r\n<g-attr-pair lat=\"20\" long=\"-15\"/>\r\n</geo>\r\n</person>\r\n</doc> \r\n\r\n3) Run this query:\r\nxquery version \"1.0-ml\";\r\n \r\nimport module namespace search = \"http://marklogic.com/appservices/search\"\r\n    at \"/MarkLogic/appservices/search/search.xqy\";\r\n \r\nlet $options :=\r\n<options xmlns=\"http://marklogic.com/appservices/search\">\r\n  <constraint name=\"geo-elem\">\r\n    <geo-elem>\r\n      <element ns=\"\" name=\"g-elem-point\"/>\r\n    </geo-elem>\r\n  </constraint>\r\n  <constraint name=\"eq-name\">\r\n    <element-query ns=\"\" name=\"name\"/>\r\n  </constraint>\r\n</options> \r\n\r\nreturn\r\nsearch:search('geo-elem:\"@70 12,5\" OR (geo-elem:\"@70 18,-15\") eq-name:jane'), $options) \r\n\r\nThe search response returns 1 on build 01/15 or newer\r\n\r\n<search:response total=\"1\" start=\"1\" page-length=\"10\" xmlns=\"\" xmlns:search=\"http://marklogic.com/appservices/search\">\r\n\r\nWith the same query, the search response returns 0 on build older than 01/15\r\n\r\n<search:response total=\"0\" start=\"1\" page-length=\"10\" xmlns=\"\" xmlns:search=\"http://marklogic.com/appservices/search\">"}, {"time":"2013-01-22T09:20:40.145492-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Thanks Aries, I'll check this out.  "}, {"time":"2013-01-22T10:25:13.880726-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi Aries, two things.\r\n\r\n1.  still can't reproduce the 0 case.\r\n I built a server on branch 7.0 from Jan 13 I still cannot reproduce the bug -- I still get 1 result.\r\nI also tried on an older 5.0 - from 12/13/2012.  This too returns a document.\r\n\r\n2.  It still looks like this should return a document.\r\n\r\n"}, {"time":"2013-01-23T10:41:08.524819-08:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "to":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}}}, "files":[], "show":true, "comment":"We have decide the change is behavior is acceptable and we should update the key.\r\n\r\nBackground:\r\n1. We found out that this regression happened starting 0115 build  and it was introduced by the chcekin http://svn.marklogic.com/trac.engsvn/changeset/127728\r\n2. Mary Verified that the query returning results is a better behavior.\r\n"}, {"time":"2013-01-23T10:41:08.524819-08:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "to":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-23T10:42:49.068118-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Confirmed the behavior with Mary and found the cause. Confirmed that the search behavior is better with the change"}, {"time":"2013-01-23T10:42:49.068118-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-25T17:03:43.017515-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-02-25T17:03:43.017515-08:00", "fixedAt":"2013-01-23T10:41:08.524819-08:00", "fixedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "shippedAt":"2013-01-23T10:42:49.068118-08:00", "shippedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "closedAt":"2013-02-25T17:03:43.017515-08:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}