{"id":20729, "kind":"Bug", "createdAt":"2013-01-27T14:01:47.017789-08:00", "status":"Closed", "title":"Replica forest stays in \"Finish Closing\" for 3 minutes before going back to \"Open Replica\" state, when moved from flash-backup to all", "category":"Replication", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Replica forest stays in \"Finish Closing\" for 3 minutes before going back to \"Open Replica\" state, when moved from flash-backup to all\r\n\r\nWhen moving the forest from flash-bakup back to all, the replica forest (database replication) is taking 3 minutes to transition out of \"finish closing\" state. This is only happening while queries are running which are querying the database and the queries running against the same database.\r\n\r\nHere are the steps:\r\n\r\n1.\tCreate two clusters (single node)\r\n2.\tCreate database, forest, attach them in each cluster\r\n3.\tCouple clusters and enable database replication between the two databases.\r\n4.\tLoad 1000 dummy documents in Master database.\r\n5.\tKeep taking replica forests into flash-backup and open mode.\r\n6.    Point QA XDBC server to FlashBackupdb database\r\n7.    Run this query in a loop (from QA harness):\r\n==\r\nxquery version \"1.0-ml\";\r\nfor $x in 1 to 10000\r\nreturn\r\n(\r\nxdmp:eval(\"fn:count(fn:doc())\", (),\r\n<options xmlns=\"xdmp:eval\">\r\n                                    <database>{xdmp:database(\"FlashBackupdb\")}</database>\r\n                                  </options>), xdmp:sleep(1000)\r\n)\r\n==\r\n\r\n\r\nErrorlogs with following traces will be attached:\r\nForest Replicate\r\nDatabase Replicate\r\nForest State\r\nForest Label \r\n\r\n\r\nLog Snippets:\r\n\r\nWhen the forest is moved into flash-backup mode (while queries are running)\r\n\r\n2013-01-27 13:26:54.020 Debug: Retrying xdmp:eval 4527409178279862549 Query 1 because XDMP-FORESTNOT: Forest FlashBackupfor not available: start closing\r\n2013-01-27 13:26:54.107 Debug: Retrying xdmp:eval 4527409178279862549 Query 2 because XDMP-FORESTNOT: Forest FlashBackupfor not available: start closing\r\n2013-01-27 13:26:54.219 Info: [Event:id=Forest State] Forest FlashBackupfor state changed from start closing to finish closing at 13593220142193620\r\n---\r\n2013-01-27 13:27:07.649 Debug: Retrying xdmp:eval 4527409178279862549 Query 10 because XDMP-FORESTNOT: Forest FlashBackupfor not available: finish closing\r\n2013-01-27 13:27:09.755 Debug: Retrying xdmp:eval 4527409178279862549 Query 11 because XDMP-FORESTNOT: Forest FlashBackupfor not available: finish closing\r\n\r\n\r\nWhen moved out of flash-backup state to \"all\"\r\n\r\n2013-01-27 13:27:23.118 Debug: Retrying xdmp:eval 4527409178279862549 Query 17 because XDMP-FORESTNOT: Forest FlashBackupfor not available: finish closing\r\n2013-01-27 13:27:30.004 Debug: Retrying xdmp:eval 4527409178279862549 Query 20 because XDMP-FORESTNOT: Forest FlashBackupfor not available: finish closing\r\n2013-01-27 13:27:31.598 Debug: Retrying xdmp:eval 4527409178279862549 Query 21 because XDMP-FORESTNOT: Forest FlashBackupfor not available: finish closing\r\n---\r\n2013-01-27 13:30:04.097 Notice: QAxdbcServer: XDMP-FORESTNOT: fn:unordered(xdmp:eval(\"fn:count(fn:doc())\", (), <options xmlns=\"xdmp:eval\"><database>{ xdmp:database(\"FlashBackupdb\") }</database></options>)) -- Forest FlashBackupfor not available: finish closing\r\n2013-01-27 13:30:04.097 Notice: QAxdbcServer: at 7:8,\r\n2013-01-27 13:30:04.097 Notice: QAxdbcServer: in xdmp:eval(\"fn:count(fn:doc())\", (), <options xmlns=\"xdmp:eval\"><database>9675351485968910231</database></options>) [1.0-ml]\r\n2013-01-27 13:30:04.097 Notice: QAxdbcServer: at 7:8 [1.0-ml]\r\n2013-01-27 13:30:04.097 Notice: QAxdbcServer:   $x = 1603\r\n2013-01-27 13:30:04.171 Debug: Closing journal /var/opt/MarkLogic/Forests/FlashBackupfor/Journals/Journal1 with fsns 0..2009\r\n2013-01-27 13:30:04.173 Debug: ~OnDiskStand /var/opt/MarkLogic/Forests/FlashBackupfor/00000000\r\n2013-01-27 13:30:04.174 Info: [Event:id=Forest State] Forest FlashBackupfor state changed from finish closing to mounted at 13593222041742270\r\n2013-01-27 13:30:04.174 Info: [Event:id=Forest State] Forest FlashBackupfor state changed from mounted to unmounted at 13593222041742880\r\n----\r\n2013-01-27 13:30:05.983 Info: [Event:id=Forest State] Forest FlashBackupfor state changed from mounted to recovering at 13593222059831700\r\n2013-01-27 13:30:05.983 Debug: Recovering redo from {fsn=2009, off=2705336, sk=5295137279037302927} on forest FlashBackupfor\r\n2013-01-27 13:30:05.983 Debug: Found journal /var/opt/MarkLogic/Forests/FlashBackupfor/Journals/Journal1 with fsns 0..2009\r\n2013-01-27 13:30:05.983 Debug: Recovered redo of 0 records at {fsn=2009, off=2705336, sk=5295137279037302927} on forest FlashBackupfor, lmfsn=18446744073709551615, lsk=12405387711523731558\r\n2013-01-27 13:30:05.983 Debug: Found FSN 2009 in journal /var/opt/MarkLogic/Forests/FlashBackupfor/Journals/Journal1 with fsns 0..2009\r\n2013-01-27 13:30:05.984 Debug: Opening journal /var/opt/MarkLogic/Forests/FlashBackupfor/Journals/Journal1 0..2009 at {fsn=2009, off=2705336, sk=5295137279037302927}\r\n2013-01-27 13:30:05.984 Info: [Event:id=Forest Replicate] Forest FlashBackupfor replication config: FlashBackupfor\r\n2013-01-27 13:30:05.984 Info: [Event:id=Forest State] Forest FlashBackupfor state changed from recovering to open replica at 13593222059846120\r\n---\r\n\r\n", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-1", "fixedin":"7.0-1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, {"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}], "attachments":[{"name":"ErrorLog from Master", "uri":"root/support/bugtracking/attachments/20601/ErroLog_Master__27Jan2013.txt"}, {"name":"ErrorLog from Replica", "uri":"root/support/bugtracking/attachments/20601/ErroLog_Replica_27Jan2013.txt"}, {"name":"Pstacks when moved to flash backup", "uri":"root/support/bugtracking/attachments/20601/pstacks_when_moved_to_flash_backup.tar.gz"}, {"name":"Pstacks when it hangs", "uri":"root/support/bugtracking/attachments/20601/pstacks_when_moved_out_of_flash_backup.tar.gz"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20601, "support":{"headline":"forest stays in \"Finish Closing\" for 3 minutes when moved to or from flash backup mode", "supportDescription":"When a forest is transitioned to or from flash backup mode, it may stall in finish closing state for 3 minutes.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"Medium", "title":"Requires significant or unnatural effort to work around issue or to prevent significant business impact"}, "workaround":""}, "tags":["Replication", "svempati"], "changeHistory":[{"time":"2013-01-27T14:01:47.017789-08:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-28T19:39:46.680999-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I just looked at how you replicated the issue, and I expect it would hang with the xdbc server pointed at the database. That's pretty much \"as designed\".\r\n\r\nAre you able to replicate the issue if the xdbc server is pointed at some other database?"}, {"time":"2013-01-28T19:39:46.680999-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-29T16:27:58.311256-08:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"No I could not duplicate it without pointing the appserver at the database that is being queried. \r\n\r\n==\r\nI read this from the email chain that came from the support case:\r\n\r\nFrom the pstack, forests are waiting on 'finish closing' state because there is a transaction doing an eval of another transaction and inner eval is doing retries due to the forest being in 'finish closing' state, but the outer transaction is still holding on to a reference of the forest and therefore preventing if from finishing the close. It seems to be happening with an XDBC server and HTTP App server\r\n==\r\n\r\nThis made me think that the customer is doing a similar thing. Not sure if this is the case.\r\n\r\nHowever, since the issue reported in this bug is expected behavior, I will close this now.\r\n"}, {"time":"2013-01-29T16:28:15.248279-08:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Closing the bug per earlier comment"}, {"time":"2013-02-06T22:25:52.17153-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"130864", "paths":["xdmp/branches/b5_0/src/XDBCServer.cpp", "xdmp/branches/b5_0/src/AppServer.cpp"], "affectedBugs":[]}, "comment":"bug:20601 avoid holding query paths when running program"}, {"time":"2013-02-06T22:27:21.225206-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Stack traces from JPMorgan plus code inspection revealed a couple issues that I've fixed and they've verified as helping.\r\n\r\nI'm going to move the bug back to verify and assign to Raghu to decide whether there's anything to do."}, {"time":"2013-02-06T22:27:21.225206-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-06T22:27:21.225206-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-06T22:52:41.131779-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"130866", "paths":["xdmp/trunk/src/XDBCServer.cpp"], "affectedBugs":[]}, "comment":"bug:20729 release query path handle to avoid forest restart hang"}, {"time":"2013-02-06T22:53:24.149692-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-06T22:53:24.149692-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-02-17T09:43:11.902811-08:00", "updatedBy":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"132172", "paths":["xdmp/trunk/src/Eval.cpp", "xdmp/trunk/src/XSLTParser.cpp", "xdmp/trunk/src/XQueryInterpreter.cpp", "xdmp/trunk/src/XDBCServer.cpp", "xdmp/trunk/src/ServerConfig.cpp", "xdmp/trunk/src/TaskServer.cpp", "xdmp/trunk/src/XQuery.h", "xdmp/trunk/src/AppServer.cpp", "xdmp/trunk/src/SPARQLParser.cpp", "xdmp/trunk/src/UpdateBuiltins.cpp"], "affectedBugs":[]}, "comment":"bug:20729 handle XDMP-FORESTNOT and XDMP-FORESTMNT retries in outermost loop"}, {"time":"2013-02-18T00:11:14.618655-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"132244", "paths":["xdmp/trunk/src/XQueryInterpreter.cpp", "xdmp/trunk/src/Eval.cpp"], "affectedBugs":[]}, "comment":"bug:20729 also handle XDMP-UPDATESNOTALLOWED"}, {"time":"2013-03-02T11:22:05.124605-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-08T09:56:27.213545-08:00", "updatedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Did this test to verify:\r\n1. Master and Replica clusters are 1E-2D\r\n2. No local disk failover enabled in either cluster.\r\n3. 2 forests per D-node attached to MedlineDB on each cluster and moving in and out of flash backup is scheduled once per hour on Master and Replica cluster taking these forests in and out of Flash backup : MedlineDB, Modules, Triggers\r\n\r\n\r\nThe test completed successfully on 7.0-ea1_20130307"}], "updatedAt":"2013-03-08T09:56:27.213545-08:00", "closedAt":"2013-01-29T16:28:15.248279-08:00", "closedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "fixedAt":"2013-02-06T22:53:24.149692-08:00", "fixedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "shippedAt":"2013-03-08T09:56:27.213545-08:00", "shippedBy":{"username":"svempati", "name":"Sundeep Vempati", "email":"sundeep.vempati@marklogic.com"}, "renderDescriptionAs":"normal"}