{"id":20430, "kind":"Bug", "createdAt":"2012-11-06T10:42:08.220562-08:00", "status":"Closed", "title":"Some reverse queries require a considerable amount of memory for certain documents.", "category":"xdmp", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"sravotto", "name":"Silvano  Ravotto", "email":"sravotto@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Working with Dow Jones we found a combination of document/query that would require a lot of memory (we did see up to 200GB in virtual space) to resolve the reverse query. It also takes over 2 minutes to execute. \r\n\r\nI will attach the document, query as well as the database configuration used. The problem can be reproduced by running the following expression (it assumes that the document (doc.xml) is in the filesystem, under /tmp/) and that the reverse query has been loaded into the database. \r\n\r\n\r\ndeclare namespace xdmp=\"http://marklogic.com/xdmp\";\r\nimport module namespace alert = \"http://marklogic.com/xdmp/alert\" at \"/MarkLogic/alert.xqy\";\r\n \r\nlet $doc := xdmp:document-get(\"/tmp/doc.xml\")\r\n \r\nreturn cts:uris((), (), cts:and-query( (cts:reverse-query($doc)) )) \r\n", "samplequery":"", "sampledata":"", "version":"6.0-nightly", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"sravotto", "name":"Silvano  Ravotto", "email":"sravotto@marklogic.com"}, {"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, {"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}], "attachments":[{"name":"Document, Query, database config", "uri":"root/support/bugtracking/attachments/20007/sample.zip"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20007, "support":{"headline":"Memory and performance issues with some reverse queries", "supportDescription":"If the query contains element-query and the document contains tens of thousands of the element specified in the element-query, position-aware reverse queries take a long time to finish and require a considerable amount of memory.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["xdmp", "sravotto"], "changeHistory":[{"time":"2012-11-06T10:42:08.220562-08:00", "updatedBy":{"username":"sravotto", "name":"Silvano  Ravotto", "email":"sravotto@marklogic.com"}, "change":{"assignTo":{"from":{"username":"sravotto", "name":"Silvano  Ravotto", "email":"sravotto@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-06T20:42:43.89761-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Jane, you have some reverse index experience. Do you have cycles to look into this? It'll probably need to be cloned to 6.0."}, {"time":"2012-11-06T20:42:43.89761-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-06T20:42:43.89761-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-5"}}, "files":[], "show":true}, {"time":"2012-11-08T11:29:42.614855-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-08T11:30:25.997581-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"jchen", "name":"Jane Chen", "email":"jane.chen@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-08T11:34:09.104751-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"How urgent is this bug? I could some time play with it if this bug is not urgent. It may take me some time to understand the code though."}, {"time":"2012-11-08T14:06:52.645-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Let me take over the bug and play with it."}, {"time":"2012-11-08T14:06:52.645-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-07T15:02:39.697193-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"We've duplicated the issue on ML6."}, {"time":"2012-12-07T15:16:56.013685-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"It looks like a position explosion inside the element-query"}, {"time":"2012-12-21T15:00:46.541318-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Ondisk reverse index sizes look fine.\r\n-rw-rw-r-- 1 ali ali      2400 Dec 19 17:32 ReverseIndexExprOffsets\r\n-rw-rw-r-- 1 ali ali     11896 Dec 19 17:32 ReverseIndexExprs\r\n-rw-rw-r-- 1 ali ali      1200 Dec 19 17:32 ReverseIndexFactExprs\r\n-rw-rw-r-- 1 ali ali        16 Dec 19 17:32 ReverseIndexRootExprs\r\n\r\nduring reverse query index evaluation, the number of positions for a element can be as large as 148028. "}, {"time":"2012-12-26T19:26:10.021571-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"backtrace shows server is busy doing Positions::intersect (ReverseIndex.cpp:2469)\r\n\r\nInside the intersect method, it is doing a cross product of a's ORs and b's ORs. \r\nThe size of the cross product seems abnormal. e.g., the number of a's ORs can be 418 and the number of b's ORs can be 3645062."}, {"time":"2012-12-27T12:31:17.623064-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"not sure it is related to the bug: the document is in French, while the language setting in both the db configuration and the cts query option is English. "}, {"time":"2012-12-27T13:23:58.241542-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"It is indeed related to the language setting. After setting the language when doing xdmp:document-get, reverse query finish in seconds without blowing memory. It doesn't look like a bug to me, as it is desirable to have the correct language information.\r\n \r\ndeclare namespace xdmp=\"http://marklogic.com/xdmp\";\r\nimport module namespace alert = \"http://marklogic.com/xdmp/alert\" at \"/MarkLogic/alert.xqy\";\r\n  \r\nlet $doc := xdmp:document-get(\"/tmp/doc.xml\"\r\n, <options xmlns=\"xdmp:document-get\"><default-language>fr</default-language></options>\r\n)\r\n  \r\nreturn cts:uris((), (), cts:and-query( (cts:reverse-query($doc)) )) \r\n\r\nActually, the language info is embedded in the document itself in element \"language\" and \"la\".\r\nIf the language is unknown beforehand, It should be viable to get the content from the \"language\" or \"la\" element, and then set the language option in xdmp:document-get and run xdmp:document-get again.\r\n"}, {"time":"2012-12-27T13:39:22.868609-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Silvano,\r\nPlease let us know whether this solves the problem the customer has been running into. Thanks."}, {"time":"2012-12-27T14:26:59.134917-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Regardless of language setting, we still don't want it to go off into a painfully slow comparison of positions. Mary has done things in the forward query world to avoid this, but I don't remember the details off hand."}, {"time":"2013-01-02T16:01:16.967554-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Mary has some comments regarding to this bug:\r\n\"I don't understand what the language has to do with it. English and French tokenization will give you the same order of magnitude number of tokens in any case. I suppose what it could really be is stemming, where there is some set of tokens that stem to the same thing in English, but not in French, and, in this document, that set is large.\r\n\r\nDocuments don't have a language, text runs have a language, and no, there is no way to know whether the asserted language is \"correct\" short of pointing a human familiar with the language(s) in question at it and asking their opinion.\r\n\r\nBut I don't think it being the \"wrong\" language is really your problem.\r\nYour problem is how you handle a document that apparently has a lot of instances of something that plays a certain role in some kind of query.\r\n\r\nNow, as far as limiting the number of positions you need to look at to handle complex position-aware queries, what I have done in the forwards-search case is\r\n(1) avoid asking for positions if you don't need them or can't use\r\n     them (part of the tangle of logic in SearchBuiltins.cpp)\r\n(2) rewrite nested near queries to replace the cross-product of\r\n     positions with the cross-product of queries, e.g\r\n     (A NEAR (B AND C)) => (A NEAR B) AND (A NEAR C)\r\n     (promoteAndQueries in Query.cpp)\r\n(3) push position filtering down to the leaves, i.e. if there is\r\n     an element-query scoping some positional calculation, push\r\n     the element positions all the way down the expression tree\r\n     so they get filtered at the leaves, not at the end\r\n     (use of pEPos in PostingIterator.cpp)\r\n(4) we just give up and return a false positive if the number\r\n     of positions we're being asked to consider due to cross\r\n     product calculations exceeds some suitably huge number\r\n     (see TooManyPositions in PostingIterator.cpp)\r\n\r\nI don't know if any of these is particularly amenable to the reverse query side of things except #4.\r\n\r\nThat's on the search side.\r\n\r\nOn the indexing side we also have a positions cut off limit (positions-list-max-size).\"\r\n"}, {"time":"2013-01-02T16:15:11.958969-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"As there is no way to guarantee to fetch the text of a document using its corresponding language, it this happens, reverse query needs to be able to give up and return a false positive instead of blowing memory (similar to #4 shown above)."}, {"time":"2013-01-04T11:13:56.245945-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Aries comments:\r\nIt is indeed related to the language setting. After setting the language when doing xdmp:document-get, reverse query finish in seconds without blowing memory.\r\n\r\nBased on this, change to P4."}, {"time":"2013-01-04T15:34:51.542966-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Silvano's comments:\r\nI am not sure I agree with the change of severity. This seems fairly critical since you may exhaust system resource if you don't specify the correct language. You could bring down a production database doing a perfectly reasonable thing.  \r\n\r\nAries,\r\nIs there a reliable way to constrain the memory usage or give an error?\r\n\r\nChange to P3."}, {"time":"2013-01-04T15:54:33.115756-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I believe yes. Reverse query should be able to give up and return a false positive instead of blowing memory (similar to #4 suggested by Mary), leaving the filtering phase of the search to guarantee the correctness. I need to double check with Wayne to decide the max number of positions and see if there is some side effects."}, {"time":"2013-01-10T18:04:31.477003-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}}}, "files":[], "show":true, "comment":"Enforcing a limit for positions should be a reasonable thing to do"}, {"time":"2013-01-10T18:06:27.886155-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-01-15T16:47:28.921651-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Revision: 127886\r\nModified Files:\r\n\r\n    xdmp/branches/b6_0/src/ReverseIndex.cpp\r\n    xdmp/branches/b6_0/src/ReverseIndexImpl.h\r\n"}, {"time":"2013-01-15T17:03:36.511276-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"Please uses the doc, query and database config attached in the bug to test it and make sure no regression caused by this fix.\r\n\r\nIf would be nice if Silvano can provide more sample documents."}, {"time":"2013-01-15T17:03:36.511276-08:00", "updatedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-11T23:03:53.961251-07:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"reproduced the problem on 6.0-2 and verified the fix on 6.0-20130411 build."}, {"time":"2013-04-11T23:03:54.674456-07:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-22T16:24:57.486921-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-04-22T16:24:57.486921-07:00", "fixedAt":"2013-01-15T17:03:36.511276-08:00", "fixedBy":{"username":"ali", "name":"Aries Li", "email":"ali@marklogic.com"}, "shippedAt":"2013-04-11T23:03:53.961251-07:00", "shippedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "closedAt":"2013-04-22T16:24:57.486921-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}