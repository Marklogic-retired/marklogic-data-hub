{"id":20551, "kind":"Bug", "createdAt":"2013-01-22T10:37:31.579095-08:00", "status":"Closed", "title":"Custom JSON transformation doesn't preserve element order", "category":"", "severity":"Minor", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"cwhitney", "name":"Colleen  Whitney", "email":"colleen.whitney@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Per offline discussion with David, the JSON conversion implementation is expected to preserve order when converting XML to JSON, in order to make round-tripping possible.\r\n\r\nIn cases where elements have some children that should be serialized as an array and others that shouldn't, array elements are being collected and serialized first, breaking ordering.  \r\n\r\nAttaching XML input file and JSON output file.\r\n\r\nimport module namespace json = \"http://marklogic.com/xdmp/json\" at \"/MarkLogic/json/json.xqy\";\r\n \r\ndeclare function local:build-config(\r\n    $element-namespace\r\n) as map:map\r\n{\r\n    let $config := json:config(\"custom\")\r\n    return\r\n        (map:put($config, \"array-element-names\",(\"list-item\",\"related-view\",\"relation-group\",\"relation\")),\r\n         map:put($config, \"element-namespace\", $element-namespace),\r\n         map:put($config,\"text-value\",\"value\"),\r\n         $config)\r\n};\r\n \r\njson:transform-to-json( doc(\"/forests.xml\") , local:build-config(\"http://marklogic.com/manage/forests\") )\r\n\r\nNote that in the XML input, list-count is the first child of list-items.  In the JSON, it is the last child. ", "samplequery":"", "sampledata":"", "version":"6.0-1", "tofixin":"7.0-ea2", "fixedin":"7.0-ea2", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"cwhitney", "name":"Colleen  Whitney", "email":"colleen.whitney@marklogic.com"}, {"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}], "attachments":[{"name":"XML input", "uri":"root/support/bugtracking/attachments/20551/forests.xml"}, {"name":"JSON output", "uri":"root/support/bugtracking/attachments/20551/forests.json"}], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["", "cwhitney"], "changeHistory":[{"time":"2013-01-22T10:37:31.579095-08:00", "updatedBy":{"username":"cwhitney", "name":"Colleen  Whitney", "email":"colleen.whitney@marklogic.com"}, "change":{"assignTo":{"from":{"username":"cwhitney", "name":"Colleen  Whitney", "email":"colleen.whitney@marklogic.com"}, "to":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-21T04:03:24.235263-08:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This is not really a bug and no 6.0 features require it.\r\nIn JSON ordering of members is not significant.\r\nHowever it is *useful* to preserve members, so moving this to the 7.0 line.\r\nThis will not be able to be 'fixed' entirely as there are many cases where the order is ambigous such as \r\n    <array>\r\n        <a/>\r\n        <b/>\r\n        <a/>\r\n        <b/>\r\n    </array>\r\n\r\nBut I will attempt to improve the huristics of the algorithm to be a bit closer to what is hoped for."}, {"time":"2013-02-21T04:03:24.235263-08:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{"tofixin":{"from":"6.0-4", "to":"7.0-ea2"}}, "files":[], "show":true}, {"time":"2013-03-30T11:24:12.054891-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"138195", "paths":["xdmp/trunk/src/Modules/MarkLogic/json/custom.xqy"], "affectedBugs":[]}, "comment":"bug:20551 Preserve the element order in custom JSON transformation even when arrays are present\n"}, {"time":"2013-03-30T11:24:34.229361-07:00", "updatedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "to":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-04-17T12:36:52.45377-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-05-03T13:26:08.356363-07:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-05-07T14:10:27.199013-07:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"141014", "paths":["qa/trunk/scripts/tests/bug20551.xml", "qa/trunk/testdata/bug20551.xml", "qa/trunk/scripts/list/bugs70.txt", "qa/trunk/scripts/keys/bug20551.xml"], "affectedBugs":[]}, "comment":"bug:20551"}, {"time":"2013-05-07T14:11:12.149193-07:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-05-07T14:11:12.149193-07:00", "updatedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "change":{"assignTo":{"from":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-05-07T14:11:12.149193-07:00", "fixedAt":"2013-03-30T11:24:34.229361-07:00", "fixedBy":{"username":"dlee", "name":"David  Lee", "email":"David.Lee@marklogic.com"}, "shippedAt":"2013-05-07T14:11:12.149193-07:00", "shippedBy":{"username":"lling", "name":"Ling Ling", "email":"ling.ling@marklogic.com"}, "renderDescriptionAs":"normal"}