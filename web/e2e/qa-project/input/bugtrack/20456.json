{"id":20456, "kind":"Bug", "createdAt":"2012-04-03T11:32:36.225936-07:00", "status":"Closed", "title":"When returning Facets only, don't do the search", "category":"Search API", "severity":"Performance", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"phare", "name":"Paxton Hare", "email":"phare@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"I originally filed this as RFE 2212: http://rfetrack.marklogic.com/detail/2212\r\n\r\nIn the comments, Colleen suggested filing a bug. Here it is.\r\n\r\nCurrently in App Services, when <return-results>false</return-results> is an option the cts:search is still being run. There are many times when I need only the facets and don't want to spend time running the cts:search.\r\n\r\nI have code that will allow me to get only the facets, but I'd prefer to see this in Appservices so that it gets properly maintained and whatnot.\r\n\r\ndeclare function facets-only($query, $options)\r\n{\r\n  let $init-options := impl:merge-options($impl:default-options, $options)\r\n  let $parsed-query := \r\n    if ($init-options) then\r\n      impl:do-tokenize-parse($query, $init-options, fn:false())\r\n    else\r\n      fn:error((),\"SEARCH-INVALARGS\",(\"requires either $ctsquery or $qtext and $options\"))\r\n  \r\n  (: create and merge final options with any state contained in the parsed query :)\r\n  let $options := impl:apply-state($init-options,$parsed-query)\r\n\r\n  let $combined-query :=\r\n    let $extra-cts := $options/opt:additional-query/*\r\n    return\r\n      if ($parsed-query and $extra-cts) then\r\n        element cts:and-query { ($parsed-query, $extra-cts) }\r\n      else\r\n        $parsed-query\r\n  return\r\n    impl:do-resolve-facets($options, $combined-query, 100)\r\n};\r\n", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-1", "fixedin":"7.0-1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"phare", "name":"Paxton Hare", "email":"phare@marklogic.com"}, {"username":"achoudha", "name":"Ajay Choudhary", "email":"ajay.choudhary@marklogic.com"}, {"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, {"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, {"username":"cwhitney", "name":"Colleen  Whitney", "email":"colleen.whitney@marklogic.com"}, {"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, {"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":16730, "support":{"headline":"", "supportDescription":"", "publishStatus":"Never Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["Search API", "phare"], "changeHistory":[{"time":"2012-04-04T18:10:04.02077-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi Mary,\r\nWhat do you think?"}, {"time":"2012-04-04T18:10:04.02077-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2012-04-04T18:10:04.02077-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2012-04-04T20:01:51.676403-07:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"cwhitney", "name":"Colleen  Whitney", "email":"colleen.whitney@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-06T14:58:37.306081-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Colleen,\r\n\r\nSHould we move this 7.0 and consider a fix there? IF we fix this, would there be any backward compatibility issue?\r\n\r\nThanks,\r\n\r\nGanesh"}, {"time":"2012-12-06T16:48:21.407649-08:00", "updatedBy":{"username":"phare", "name":"Paxton Hare", "email":"phare@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"If it's of any use here is the updated function that is compatible with the latest 6.0 code:\r\n\r\ndeclare function m:facets-only($query, $options) as element(search:facet)*\r\n{\r\n  let $init-options := impl:merge-options($impl:default-options, $options)\r\n  let $parsed-query :=\r\n    if ($init-options) then\r\n      impl:do-tokenize-parse($query, $init-options, fn:false())\r\n    else\r\n      fn:error((),\"SEARCH-INVALARGS\",(\"requires either $ctsquery or $qtext and $options\"))\r\n  (: create and merge final options with any state contained in the parsed query :)\r\n  let $options := impl:apply-state($init-options,$parsed-query,())\r\n  let $combined-query :=\r\n    let $extra-cts := $options/search:additional-query/*\r\n    return\r\n      if ($parsed-query and $extra-cts) then\r\n        element cts:and-query { ($parsed-query, $extra-cts) }\r\n      else\r\n        $parsed-query\r\n  return\r\n    impl:do-resolve-facets($options, $combined-query, 100)\r\n};\r\n\r\nStill works great for me."}, {"time":"2012-12-27T00:22:21.347812-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Charles,\r\n\r\nCan you take a look at this. Code freeze for 5.0-5 is 01/23/13. Make sure Colleen reviews your changes. "}, {"time":"2012-12-27T00:22:21.347812-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-10T18:52:55.93291-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Colleen,\r\n\r\nDo you agree with Paxton's fix. If so, can I make the change and check it in? Thanks."}, {"time":"2013-01-10T21:28:31.047571-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi Ganesh, I think Paxton's code is the guide toward the patch, but he's not really provided the test coverage and context for use.  I don't think it will take much work to incorporate his solution, but it's not trivial.  We'll certainly want a unit test or two for it.\r\n\r\nI can commit to addressing it tomorrow; I've considered it the lower-risk bug thus far on my plate."}, {"time":"2013-01-11T17:50:36.680816-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Thanks Charles for the input. I will let you fix it then. I was trying to see if I can help. Thanks."}, {"time":"2013-01-14T10:06:39.905713-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I think i have a fix ready for this.  Verifying no change in tests and checking on all branches.\r\n"}, {"time":"2013-01-14T10:58:14.538601-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"127728", "paths":["xdmp/trunk/src/Modules/MarkLogic/appservices/search/search-impl.xqy"], "affectedBugs":[]}, "comment":"bug:20456 when not requesting results don't run search"}, {"time":"2013-01-14T10:58:39.540764-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}}}, "files":[], "show":true, "comment":"Same story here as with the clones.  Cheers!"}, {"time":"2013-01-14T10:58:39.540764-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-14T10:58:39.540764-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-02-19T21:49:13.389819-08:00", "updatedBy":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msarma", "name":"Meghalim Sarma", "email":"msarma@marklogic.com"}, "to":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-28T15:45:07.959482-08:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"The mark mail forests are yet to be reindexed and merged before we could use these for 7.0\r\n\r\nWill be verified post EA1"}, {"time":"2013-05-22T13:26:02.559939-07:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Move it to 7.0-ea3 because it's stress test"}, {"time":"2013-05-22T13:26:02.559939-07:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea2", "to":"7.0-ea3"}}, "files":[], "show":true}, {"time":"2013-09-18T13:55:16.00887-07:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi Ajay,\r\n\r\nYou will need to test this after the MarkMail performance test is done as you need to use the machine\r\n\r\nTo verify:\r\n1) Run query with return-results = true\r\n\r\n xquery version \"1.0-ml\";\r\n \r\nimport module namespace search = \"http://marklogic.com/appservices/search\"\r\n     at \"/MarkLogic/appservices/search/search.xqy\";\r\n      \r\nlet $options :=\r\n<options xmlns=\"http://marklogic.com/appservices/search\">\r\n<constraint name=\"date\">\r\n  <range type=\"xs:dateTime\" facet=\"true\">\r\n    <element ns=\"\" name=\"message\"/>\r\n    <attribute ns=\"\" name=\"date\"/>\r\n \r\n    <computed-bucket lt=\"-P1Y\" anchor=\"start-of-year\" name=\"older\">Older</computed-bucket>\r\n    <computed-bucket lt=\"P1Y\" ge=\"P0Y\" anchor=\"start-of-year\" name=\"year\">This Year</computed-bucket>\r\n    <computed-bucket lt=\"P1M\" ge=\"P0M\" anchor=\"start-of-month\" name=\"month\">This Month</computed-bucket>\r\n    <computed-bucket lt=\"P1D\" ge=\"P0D\" anchor=\"start-of-day\" name=\"today\">Today</computed-bucket>\r\n    <computed-bucket ge=\"P0D\" anchor=\"now\" name=\"future\">Future</computed-bucket>\r\n     \r\n  </range>\r\n</constraint>\r\n  <return-results>true</return-results>\r\n</options>\r\n \r\nreturn search:search(\"date:older\", $options) \r\n\r\n2) Run query with return-results = false\r\n\r\nxquery version \"1.0-ml\";\r\n \r\nimport module namespace search = \"http://marklogic.com/appservices/search\"\r\n     at \"/MarkLogic/appservices/search/search.xqy\";\r\n      \r\nlet $options :=\r\n<options xmlns=\"http://marklogic.com/appservices/search\">\r\n<constraint name=\"date\">\r\n  <range type=\"xs:dateTime\" facet=\"true\">\r\n    <element ns=\"\" name=\"message\"/>\r\n    <attribute ns=\"\" name=\"date\"/>\r\n \r\n    <computed-bucket lt=\"-P1Y\" anchor=\"start-of-year\" name=\"older\">Older</computed-bucket>\r\n    <computed-bucket lt=\"P1Y\" ge=\"P0Y\" anchor=\"start-of-year\" name=\"year\">This Year</computed-bucket>\r\n    <computed-bucket lt=\"P1M\" ge=\"P0M\" anchor=\"start-of-month\" name=\"month\">This Month</computed-bucket>\r\n    <computed-bucket lt=\"P1D\" ge=\"P0D\" anchor=\"start-of-day\" name=\"today\">Today</computed-bucket>\r\n    <computed-bucket ge=\"P0D\" anchor=\"now\" name=\"future\">Future</computed-bucket>\r\n     \r\n  </range>\r\n</constraint>\r\n  <return-results>false</return-results>\r\n</options>\r\n \r\nreturn search:search(\"date:older\", $options) \r\n\r\n3) When running each query, take a note on <search:total-time> value. The total-time taken with return-results = false must be faster than the total-time taken with return-results = true"}, {"time":"2013-09-18T13:55:16.00887-07:00", "updatedBy":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ayuwono", "name":"Aries Yuwono", "email":"ayuwono@marklogic.com"}, "to":{"username":"achoudha", "name":"Ajay Choudhary", "email":"ajay.choudhary@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-10-15T00:44:06.114649-07:00", "updatedBy":{"username":"achoudha", "name":"Ajay Choudhary", "email":"ajay.choudhary@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"achoudha", "name":"Ajay Choudhary", "email":"ajay.choudhary@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"The queries (1) and (2), while ran on MarkMail setup, got the below results.\r\n\r\nQuery (1)  with return-results=true  :    <search:total-time>PT3.741735S</search:total-time>\r\nQuery (2)  with return-results=false:    <search:total-time>PT3.18753S</search:total-time>\r\n\r\nThe search results time with return-results=false is significantly faster than the search results time with return-results=true."}, {"time":"2013-10-15T00:44:06.114649-07:00", "updatedBy":{"username":"achoudha", "name":"Ajay Choudhary", "email":"ajay.choudhary@marklogic.com"}, "change":{"assignTo":{"from":{"username":"achoudha", "name":"Ajay Choudhary", "email":"ajay.choudhary@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-10-15T00:44:06.114649-07:00", "fixedAt":"2013-01-14T10:58:39.540764-08:00", "fixedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "shippedAt":"2013-10-15T00:44:06.114649-07:00", "shippedBy":{"username":"achoudha", "name":"Ajay Choudhary", "email":"ajay.choudhary@marklogic.com"}, "renderDescriptionAs":"normal"}