{"id":20770, "kind":"Bug", "createdAt":"2012-12-11T07:32:17.11829-08:00", "status":"Closed", "title":"cts:highlight does not work when a not-query is inside a near-query", "category":"search", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Below is a test case that shows this behavior:\r\n\r\nlet $article := <article>Google Nexus S Android </article>\r\n \r\nlet $working-query := cts:near-query(\r\n(cts:and-not-query(cts:word-query(\"Android\"), cts:word-query(\"iphone\"))),1)\r\n \r\nlet $not-working-query := cts:near-query(\r\n(cts:word-query(\"Android\"), cts:not-query( cts:word-query(\"iphone\"))),1)\r\n \r\nlet $Works := cts:contains($article, $working-query)\r\nlet $DoesntWork := cts:contains($article, $not-working-query)\r\nreturn ($Works,$DoesntWork)\r\n=>\r\ntrue\r\ntrue\r\n \r\nBoth the queries match. Now replace cts:contains with cts:highlight.\r\n \r\nlet $Works := cts:highlight($article, $working-query, <span class=\"highlight\">{$cts:text}</span>)\r\nlet $DoesntWork := cts:highlight($article, $not-working-query, <span class=\"highlight\">{$cts:text}</span>)\r\nreturn ($Works,$DoesntWork)\r\n=>\r\n<article>Google Nexus S <span class=\"highlight\">Android</span> </article>\r\n<article>Google Nexus S Android </article>", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-1", "fixedin":"7.0-1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, {"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20249, "support":{"headline":"cts:highlight misses matches when query has cts:not-query nested inside cts:near-query.", "supportDescription":"cts:highlight misses matches when query has cts:not-query nested inside cts:near-query.", "workaround":"Redesign query to use cts:and-not-query instead of cts:not-query.", "publishStatus":"Publish", "tickets":["12222", " 12414"], "customerImpact":{"level":"Low", "title":"Minimal business impact or reasonable workaround is available"}}, "tags":["search", "rjovanovich"], "changeHistory":[{"time":"2012-12-11T07:32:17.11829-08:00", "updatedBy":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rjovanovich", "name":"Richard Jovanovich", "email":"richard.jovanovich@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-12-12T06:48:16.162932-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-01-27T23:29:31.283771-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This bug was originally reported on b5_0. We moved this out of 5.0.5 as a work-around of using cts:and-not-query exists.\r\n\r\nThis is not any critical bug for release 6.0.3 and we can fix it after we fix the original in b5_0."}, {"time":"2013-01-28T10:38:15.25295-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"We may move it to 6.0-4."}, {"time":"2013-01-28T13:15:15.874086-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"6.0-3", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-02-12T20:51:36.999198-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"131500", "paths":["xdmp/trunk/src/SearchBuiltins.cpp"], "affectedBugs":[]}, "comment":"Fix for bug:20249.\n"}, {"time":"2013-02-12T20:55:34.161764-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true, "comment":"\r\nlet $article := <article>Google Nexus S Android </article>\r\n  \r\nlet $working-query := cts:near-query(\r\n(cts:and-not-query(cts:word-query(\"Android\"), cts:word-query(\"iphone\"))),1)\r\nlet $working-query2 := cts:near-query(\r\n(cts:not-in-query(cts:word-query(\"Android\"),cts:word-query(\"iphone\"))),1) \r\nlet $not-working-query := cts:near-query(\r\n(cts:not-query(cts:word-query(\"iphone\")), cts:word-query(\"Android\")),1)\r\n\r\nlet $Works2 := cts:highlight($article, $working-query2, <span class=\"highlight\">{$cts:text}</span>)\r\nlet $Works := cts:highlight($article, $working-query, <span class=\"highlight\">{$cts:text}</span>)\r\nlet $DoesntWork := cts:highlight($article, $not-working-query, <span class=\"highlight\">{$cts:text}</span>)\r\nreturn ($Works,$DoesntWork,$Works2)\r\n=>\r\n<article>Google Nexus S <span class=\"highlight\">Android</span> </article>\r\n<article>Google Nexus S <span class=\"highlight\">Android</span> </article>\r\n<article>Google Nexus S <span class=\"highlight\">Android</span> </article>"}, {"time":"2013-02-12T20:55:34.161764-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-12T20:55:34.161764-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-03-02T11:21:40.66456-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-07T00:57:37.054984-08:00", "updatedBy":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on 7.0-ea1_20130304. \r\n\r\nTest bug20248.xml has been added for the same."}, {"time":"2013-03-07T00:57:37.054984-08:00", "updatedBy":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, "change":{"assignTo":{"from":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-03-07T00:57:37.054984-08:00", "fixedAt":"2013-02-12T20:55:34.161764-08:00", "fixedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "shippedAt":"2013-03-07T00:57:37.054984-08:00", "shippedBy":{"username":"ksaxena", "name":"Kapil Saxena", "email":"kapil.saxena@marklogic.com"}, "renderDescriptionAs":"normal"}