{"id":20970, "kind":"Bug", "createdAt":"2013-02-28T01:51:53.373041-08:00", "status":"Closed", "title":"REGR:cts:word-match on wild card search is yielding incorrect results with cts:document-fragment-query", "category":"search", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"REGR:cts:word-match on wild card search is yielding incorrect results with cts:document-fragment-query\r\n\r\nTest failing: cts-document-fragment-query.xml\r\nML Version: 20130227\r\nLink to diff: https://regression-status.marklogic.com/new-app/space2/diff-archive/b7_0-ea1/2013-02-27/linux-64-rh5-cluster/diffs/cts-document-fragment-query.xml\r\n\r\nSteps to reproduce:\r\n\r\n1. Create DB say ctsdocfragDB and forest.\r\n2. Add fragment root.\r\nxquery version \"1.0-ml\";\r\n        import module namespace admin=\"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n\r\n        let $config := admin:get-configuration()\r\n        let $names := (\"a\", \"doc\", \"SPEECH\")\r\n        let $dbid := admin:database-get-id($config, \"ctsdocfragDB\")\r\n        let $elements := (\r\n                for $i in $names\r\n                return admin:database-fragment-root(\"\", $i)\r\n        )\r\n        let $c := admin:database-add-fragment-root($config, $dbid, $elements)\r\n        return admin:save-configuration($c)\r\n3. Add element range index\r\nQuery1:\r\nxquery version \"1.0-ml\";\r\n        import module namespace admin=\"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n\r\n        let $config := admin:get-configuration()\r\n        let $dbid := admin:database-get-id($config, \"ctsdocfragDB\")\r\n        let $ele  :=  admin:database-range-element-index(\"int\",\"\",\"priority\",\"http://marklogic.com/collation/\", false())\r\n        let $c := admin:database-add-range-element-index($config,$dbid,$ele)\r\n\r\n        return\r\n         admin:save-configuration($c)\r\nQuery2:\r\nxquery version \"1.0-ml\";\r\n        import module namespace admin=\"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n\r\n        let $config := admin:get-configuration()\r\n        let $dbid := admin:database-get-id($config, \"ctsdocfragDB\")\r\n                let $ele  :=  admin:database-range-element-index(\"dateTime\",\"http://marklogic.com/qa\",\"datetime-1\",\"http://marklogic.com/collation/\", false())\r\n        let $c := admin:database-add-range-element-index($config,$dbid,$ele)\r\n        return\r\n         admin:save-configuration($c)\r\n4. Insert document\r\n\r\nquery1:\r\nxdmp:document-insert(\"hello1.xml\", <a>Good to see you<priority>0</priority></a>,(),\r\n   <collections>\r\n     <collection>hello</collection>\r\n   </collections> )\r\n\r\nquery2:\r\nxdmp:document-insert(\"hello2.xml\", <a>How are you?<priority>6</priority></a>);\r\nxdmp:document-insert(\"hello3.xml\", <a>Helloworld<priority>1</priority></a>)\r\n\r\n5. Add range index\r\n        xquery version \"1.0-ml\";\r\n        import module namespace admin=\"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n        let $config := admin:get-configuration()\r\n        let $dbid := admin:database-get-id($config, \"ctsdocfragDB\")\r\n        let $ele  :=  admin:database-range-element-index(\"string\",\"\",\"a\",\"http://marklogic.com/collation/\", false())\r\n        let $c := admin:database-add-range-element-index($config,$dbid,$ele)\r\n        let $ele  :=  admin:database-range-element-index(\"string\",\"\",\"doc\",\"http://marklogic.com/collation/\", false())\r\n        let $c := admin:database-add-range-element-index($c,$dbid,$ele)\r\n        let $ele  :=  admin:database-range-element-index(\"string\",\"\",\"author\",\"http://marklogic.com/collation/\", false())\r\n        let $c := admin:database-add-range-element-index($c,$dbid,$ele)\r\n        return admin:save-configuration($c)\r\n6. Add string attribute range index\r\nquery1:\r\n\t xquery version \"1.0-ml\";\r\n\t  import module namespace admin = \"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n\t  let $config := admin:get-configuration()\r\n\t  let $dbid := xdmp:database(\"ctsdocfragDB\")\r\n\t  let $rangespec := admin:database-range-element-attribute-index(\"string\",\r\n\t\t   \"\", \"doc\", \"\", \"doc-type\",\"http://marklogic.com/collation/\", fn:false() )\r\n\t  let $eleattrbid1 := admin:database-add-range-element-attribute-index($config, $dbid, $rangespec)\r\n\t  return admin:save-configuration($eleattrbid1);\r\n\t  xdmp:log(\"eleatrr\")\r\n \r\nquery2:\r\n\t  xquery version \"1.0-ml\";\r\n\t  import module namespace admin = \"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n\t  let $config := admin:get-configuration()\r\n\t  let $dbid := xdmp:database(\"ctsdocfragDB\")\r\n\t  let $rangespec := admin:database-range-element-attribute-index(\"string\",\r\n\t\t   \"\", \"doc\", \"\", \"year\",\"http://marklogic.com/collation/\", fn:false() )\r\n\t  let $eleattrbid2 := admin:database-add-range-element-attribute-index($config, $dbid, $rangespec)\r\n\t  return admin:save-configuration($eleattrbid2);\r\n\t  xdmp:log(\"attrrange\")\r\n7. Enable collection lexicon,uri lexicon on DB.\r\n8. Enable word lexicon\r\n\t xquery version \"1.0-ml\";\r\n\t  import module namespace admin = \"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n\t  let $config := admin:get-configuration()\r\n\t  let $dbid := xdmp:database(\"ctsdocfragDB\")\r\n\t  let $lexspec := admin:database-word-lexicon(\"http://marklogic.com/collation/\")\r\n\t  let $wordlex := admin:database-add-word-lexicon($config, $dbid, $lexspec)\r\n\t  return admin:save-configuration($wordlex);\r\n\t  xdmp:sleep(3000)\r\n9. Add element word lexicons\r\n\t  xquery version \"1.0-ml\";\r\n\t  declare namespace admin=\"http://marklogic.com/xdmp/admin\";\r\n\t  import module \"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n\t  let $config := admin:get-configuration()\r\n\t  let $dbid := xdmp:database(\"ctsdocfragDB\")\r\n\t  let $eleword := admin:database-element-word-lexicon(\"\",\"a\", \"http://marklogic.com/collation/\")\r\n\t  let $elewordid := admin:database-add-element-word-lexicon($config, $dbid, $eleword)\r\n\t  return admin:save-configuration($elewordid)\r\n10. Add field\r\n\txquery version \"1.0-ml\";\r\n\t import module namespace admin = \"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n\t let $config := admin:get-configuration()\r\n\t let $dbid := xdmp:database(\"ctsdocfragDB\")\r\n\t let $fieldspec := admin:database-field(\"a\", fn:true() )\r\n\t let $c := admin:database-add-field($config, $dbid, $fieldspec)\r\n\t return admin:save-configuration($c)               \r\n11. Add field word lexicon\r\n\txquery version \"1.0-ml\";\r\n\timport module namespace admin = \"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n\tlet $config := admin:get-configuration()\r\n\tlet $dbid := xdmp:database(\"ctsdocfragDB\")\r\n\tlet $lexspec := admin:database-word-lexicon(\"http://marklogic.com/collation/\")\r\n\tlet $c := admin:database-add-field-word-lexicon($config, $dbid, \"a\", $lexspec)\r\n\treturn admin:save-configuration($c)\r\n\r\n12. Add element attribute word lexicon\r\n        xquery version \"1.0-ml\";\r\n        declare namespace adm=\"http://marklogic.com/xdmp/admin\";\r\n        import module \"http://marklogic.com/xdmp/admin\" at \"/MarkLogic/admin.xqy\";\r\n        let $config := adm:get-configuration()\r\n        let $dbid := adm:database-get-id($config, \"ctsdocfragDB\")\r\n        let $word-lexicon := adm:database-element-attribute-word-lexicon(\"\",\"doc\",\"\",\"doc-type\",\"http://marklogic.com/collation/\")\r\n        let $c := adm:database-add-element-attribute-word-lexicon($config,$dbid,$word-lexicon)\r\n        return adm:save-configuration($c);\r\n        xdmp:log(\"eleattrlex\")\r\n13. Add document hello2.xml to collection property-query\r\n     xdmp:document-add-collections(\"hello2.xml\", \"property-query\")\r\n14. See if reindexer kicks in and wait till reindexer finishes.\r\n15. Perform Merge and wait till merge is done.\r\n16. check for deleted fragments-2\r\n\tlet $a := sum(xdmp:forest-counts(xdmp:forest(\"ctsdocfragF1\"),\"*\")//*:deleted-fragment-count)\r\n\t\t\tlet $b := sum(xdmp:forest-counts(xdmp:forest(\"ctsdocfragF2\"),\"*\")//*:deleted-fragment-count)\r\n\t\t\t return if (sum(($a,$b)) eq 0) then ()\r\n\t\t\t\t\telse xdmp:merge();\r\n\t\t\t xdmp:sleep(10000)\r\n\r\n17. Run following queries:\r\ncts:word-match(\"H*\",(), cts:document-fragment-query(cts:document-query(\"hello2.xml\")));\r\ncts:word-match(\"*\",(), cts:document-fragment-query(cts:collection-query(\"hello\")));\r\n\r\nActual result: How01GoodHelloworldseetoyou\r\nExpected Result: How0Goodseetoyou\r\n\r\nNOTE: This test started failing since 20130221", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-ea1", "fixedin":"7.0-ea1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, {"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, {"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, {"username":"sverma", "name":"Shiva Verma", "email":"shiva.verma@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["search", "iagrawal"], "changeHistory":[{"time":"2013-02-28T01:51:53.373041-08:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-01T15:47:58.001199-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2013-03-02T11:45:34.2928-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"More fun with lexicon matching"}, {"time":"2013-03-02T11:45:34.2928-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{"assignTo":{"from":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "to":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-04T10:38:40.119998-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This is already fixed on trunk. need to port relevant change to ea1 branch."}, {"time":"2013-03-04T10:49:23.254425-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"observation: although this does not appear on trunk, the problem with ea1 does not seem to be related to matching as it is a \"*\" match query, and it is matching on things outside of collection - \"hello\""}, {"time":"2013-03-04T10:59:27.800236-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Could not reproduce it deterministic on ea1, most of the time it is returning the right result, on certain occasions it is returning wrong result that includes all three docs."}, {"time":"2013-03-04T11:29:24.655276-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"That suggests that either the in-memory or the on-disk processing is incorrect."}, {"time":"2013-03-04T14:06:56.038138-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Thanks! So the problem happens on IteratorVec's such as FewStringsIteratorVec.\r\nthe ++operator and done() function are messed up when one of the iterator is empty upon construction."}, {"time":"2013-03-04T19:22:09.049286-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"134888", "paths":["xdmp/trunk/src/OnDiskRangeIndexes.cpp"], "affectedBugs":[]}, "comment":"Bug:20970 fixed on trunk-^C130305 deal with corner case: one of the lexicon iterator is empty"}, {"time":"2013-03-04T19:24:09.633034-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"134889", "paths":["xdmp/branches/b7_0-ea1/src/OnDiskRangeIndexes.cpp"], "affectedBugs":[]}, "comment":"Bug:20970 fixed on 7ea1-20130305 deal with corner case: one of the lexicon iterator is empty"}, {"time":"2013-03-04T19:34:59.870357-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "to":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on local box. "}, {"time":"2013-03-04T19:34:59.870357-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{"assignTo":{"from":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "to":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-05T11:32:31.458293-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "to":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-05T11:32:31.458293-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{"assignTo":{"from":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "to":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-05T12:08:20.357956-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"cts:properties-query.xml also seems to be failing due to this issue. Hence when this bug is fixed, both cts:document-fragment-query.xml and cts:properties-query.xml should pass."}, {"time":"2013-03-05T19:11:38.612888-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Thanks Maha. \r\nit is failing on UCA collation and is returning the wrong lexicon, should be collection instead of word.\r\nSo should have nothing to do with interval breakdown.\r\nAlso checked out a copy on 20130210, failing too."}, {"time":"2013-03-08T11:42:34.504383-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"135702", "paths":["xdmp/trunk/src/OnDiskRangeIndexes.cpp"], "affectedBugs":[]}, "comment":"Bug:20970 add missing initializer"}, {"time":"2013-03-08T13:16:26.749858-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"135717", "paths":["xdmp/branches/b7_0-ea1/src/OnDiskRangeIndexes.cpp"], "affectedBugs":[]}, "comment":"Bug:20970 on 7.0-ea1 code reviewed"}, {"time":"2013-03-08T13:17:02.305646-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "to":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}}}, "files":[], "show":true, "comment":"Fixed on both trunk and ea1"}, {"time":"2013-03-08T16:27:21.295845-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{"assignTo":{"from":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-08T16:38:53.819433-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Isha, moving this to your queue since your originally filed the bug."}, {"time":"2013-03-08T16:38:53.819433-08:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-11T03:23:51.409301-07:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on ML 7.0-ea1-20130310. The test cts-document-fragment-query.xml and cts-properties-query.xml are passing.Hence, shipping the bug"}, {"time":"2013-03-11T03:23:51.409301-07:00", "updatedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "change":{"assignTo":{"from":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-03-11T03:23:51.409301-07:00", "fixedAt":"2013-03-08T13:17:02.305646-08:00", "fixedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "shippedAt":"2013-03-11T03:23:51.409301-07:00", "shippedBy":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, "renderDescriptionAs":"normal"}