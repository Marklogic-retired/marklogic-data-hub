{"id":20843, "kind":"Bug", "createdAt":"2013-02-20T06:51:56.176751-08:00", "status":"Closed", "title":"Calls to /request-stack.xqy remain and continue to run even if the original query (for the stack) gets cancelled.", "category":"Debug API", "severity":"Major", "priority":{"level":"1", "title":"Required for product release"}, "submittedBy":{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"I'm filing this on behalf of Paul Barker at JPMorgan - the original case is here:\r\nhttps://help.marklogic.com/staff/Tickets/Ticket/View/12511\r\n\r\nThis seems to affect 5.0 and 6.0 so is also likely to yield the same results in the 7.0 branch\r\n\r\nIf you have generated a call stack for a query running on a given application server, then cancel the original query, the request to /request-stack.xqy remains on the host's http server on port 8001.\r\n\r\nHere is a breakdown of the steps to reproduce:\r\n1. Set up a long running query - in query console, run: xdmp:sleep(250000)\r\n2. Go to the App Services http server (Configure -> Groups -> Default -> App Servers -> App Services -> show more) and confirm your query is listed there\r\n3. Hit the [stack] link to start generating the call stack\r\n4. Wait a few seconds, then [cancel] the query\r\n5. Go to the Admin http server (Configure -> Groups -> Default -> App Servers -> Admin -> show more)\r\n6. Observe that a call to /request-stack.xqy is listed as a running query even though the original query is cancelled\r\n\r\nPlease note that this issue was reported from nightly builds because the [stack] links do not work at all in 5.0-4.x or 6.0-2.x (see bug 20189 and associated clones)", "samplequery":"1. Set up a long(ish) running query using (for example: xdmp:sleep)\r\n2. Create a stack trace for the query in the application server's status page\r\n3. Cancel the query\r\n4. Your original request to /request-stack.xqy will still be seen as a pending query in the app server on 8001", "sampledata":"", "version":"5.0-nightly", "tofixin":"5.0-6", "fixedin":"5.0-6", "platform":"all", "memory":"", "processors":"", "note":"Also reproduced in 5.0 nightly build", "subscribers":[{"username":"ableasdale", "name":"Alex Bleasdale", "email":"alex.bleasdale@marklogic.com"}, {"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, {"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, {"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, {"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, {"username":"jjames", "name":"John James", "email":"John.James@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":20842, "support":{"headline":"Calls to /request-stack.xqy remain and continue to run even if the original query (for the stack) gets cancelled.", "supportDescription":"If you have generated a call stack for a query running on a given application server, then cancel the original query, the request to /request-stack.xqy remains on the host's http server on port 8001", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"Low", "title":"Minimal business impact or reasonable workaround is available"}, "workaround":"Restart the daemon process to clear the backlog."}, "tags":["Debug API", "ableasdale"], "changeHistory":[{"time":"2013-02-20T11:03:22.66816-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-20T11:03:22.66816-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-20T11:03:22.66816-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"5.0-6"}}, "files":[], "show":true}, {"time":"2013-02-20T15:24:52.869907-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"jsnelson", "name":"John Snelson", "email":"jsnelson@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-07-12T12:10:22.001072-07:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}}}, "files":[], "show":true}, {"time":"2014-02-23T21:46:40.657639-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Assigning as P1 since this is support reported"}, {"time":"2014-02-24T15:57:02.42189-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"some investigation:\r\nthe way stack works is that it uses the dbg:attach() function to attach and stop a request, then calls dbg:stack() to get stack, then dbg:detach() to quit and resume.\r\nIn this case, only dbg:attach() is called but it seems to be stuck there.\r\nSo debugger was never detached from the request, thus the request is still stopped and not able to be cancelled."}, {"time":"2014-02-25T11:32:22.057436-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"162274", "paths":["xdmp/branches/b5_0/src/Debug.cpp"], "affectedBugs":[]}, "comment":"bug:20843 if a request cancel is detected in debugger, do putVal(nullValeSequence) to debugFutureVal to avoid hang"}, {"time":"2014-02-25T11:32:55.042732-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "to":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}}}, "files":[], "show":true, "comment":"Fixed on 5.0-20140226"}, {"time":"2014-02-25T11:32:55.042732-08:00", "updatedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "change":{"assignTo":{"from":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "to":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}}}, "files":[], "show":true}, {"time":"2014-03-10T09:44:15.14794-07:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}}}, "files":[], "show":true}, {"time":"2014-03-11T14:50:03.888065-07:00", "updatedBy":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "change":{"assignTo":{"from":{"username":"lratcliff", "name":"Larry Ratcliff", "email":"lratcliff@marklogic.com"}, "to":{"username":"jjames", "name":"John James", "email":"John.James@marklogic.com"}}}, "files":[], "show":true}, {"time":"2014-03-12T11:56:25.776535-07:00", "updatedBy":{"username":"jjames", "name":"John James", "email":"John.James@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"jjames", "name":"John James", "email":"John.James@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Confirmed fixed manually in build 5.0-20140312"}, {"time":"2014-04-09T15:51:59.986536-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"ga"}], "updatedAt":"2014-04-09T15:51:59.986536-07:00", "fixedAt":"2014-02-25T11:32:55.042732-08:00", "fixedBy":{"username":"fxue", "name":"Fei Xue", "email":"Fei.Xue@marklogic.com"}, "shippedAt":"2014-03-12T11:56:25.776535-07:00", "shippedBy":{"username":"jjames", "name":"John James", "email":"John.James@marklogic.com"}, "closedAt":"2014-04-09T15:51:59.986536-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal", "renderSampleQueryAs":"normal"}