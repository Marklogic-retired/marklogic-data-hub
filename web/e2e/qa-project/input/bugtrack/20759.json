{"id":20759, "kind":"Bug", "createdAt":"2013-02-12T02:50:49.884149-08:00", "status":"Closed", "title":"cts:count-aggregate() with item-frequency option giving incorrect result", "category":"search", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"bgupta", "name":"Balkrishna Gupta", "email":"balkrishna.gupta@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"We have a case where cts:count-aggregate() with item-frequency return incorrect counts. I am attaching the database package xml and sample documents to reproduce the issue. The strange behavior is that if I have created another test database with simplified document then the counts are inconsistent while executing query against different databases. I am attaching a simplified document (test.xml) also extracted from the original document provided by customer. Below is the XQuery code to get the count and counts with the actual documents provided by customer:\r\n\r\ndeclare namespace va = \"ns://va.gov/2012/ip401\";\r\ncount(/va:vpr/va:results/va:consults/va:consult/va:requested),\r\ncts:count-aggregate(\r\ncts:path-reference('/va:vpr/va:results/va:consults/va:consult/va:requested')),\r\ncts:count-aggregate(\r\ncts:path-reference('/va:vpr/va:results/va:consults/va:consult/va:requested'),'item-frequency')\r\n=>\r\n<results warning=\"more than one root item\">76 60 152</results>\r\n\r\nThe setup is available on cluster-009.marklogic.com. I have three databases (vista_analytics-content, 12485, test) on this lab machine with the path range index defined. The counts for each database are below (please note that we have just one document in test and 12485 database):\r\n\r\nvista_analytics-content:\r\n<results warning=\"more than one root item\">76 60 152</results>\r\n12485:\r\n<results warning=\"more than one root item\">1 1 1</results>\r\ntest:\r\n<results warning=\"more than one root item\">1 1 3</results>", "samplequery":"", "sampledata":"", "version":"6.0-2.1", "tofixin":"6.0-3", "fixedin":"6.0-3", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"bgupta", "name":"Balkrishna Gupta", "email":"balkrishna.gupta@marklogic.com"}, {"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, {"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, {"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, {"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}], "attachments":[{"name":"Package xml and Sample documents", "uri":"root/support/bugtracking/attachments/20759/12485.zip"}], "relationships":[{"type":"", "to":""}], "clones":[21057, 21079], "cloneOf":"", "support":{"headline":"Aggregate cts:count on cts:values of path range index with item-frequency option gives incorrect result", "supportDescription":"Aggregate cts:count on cts:values of path range index with item-frequency option gives incorrect result. The frequency calculation includes all of the path range indexes defined in a config file irrespective of database boundaries in the config.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"High", "title":"Significant business impact with no reasonable workaround"}, "workaround":""}, "tags":["search", "bgupta"], "changeHistory":[{"time":"2013-02-12T10:51:20.916699-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-12T10:51:20.916699-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-12T10:51:20.916699-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-02-12T11:16:27.027508-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-02-19T19:31:04.107663-08:00", "updatedBy":{"username":"bgupta", "name":"Balkrishna Gupta", "email":"balkrishna.gupta@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Steps to Reproduce the issue:\r\n\r\n1. Create a new database with importing attached package vista-content.xml\r\n2. Load the documents in data folder in the attached zip\r\n3. Execute below XQuery code:\r\ndeclare namespace va = \"ns://va.gov/2012/ip401\";\r\ncount(/va:vpr/va:results/va:consults/va:consult/va:requested),\r\ncts:count-aggregate(\r\ncts:path-reference('/va:vpr/va:results/va:consults/va:consult/va:requested')),\r\ncts:count-aggregate(\r\ncts:path-reference('/va:vpr/va:results/va:consults/va:consult/va:requested'),'item-frequency')\r\n=>\r\n<results warning=\"more than one root item\">76 60 152</results> \r\n\r\nExpected result:\r\nThe path element appears only 76 times in the documents but count returned with item-frequency option is 152 which is incorrect and it should be 76.\r\n\r\nI have a simplified document also in the attached zip. Please follow below steps to reproduce with a simplified sample document\r\n1. Create two new database\r\n2. Define path namespace as per below details:\r\n        prefix:  va \r\n        namespace uri:  ns://va.gov/2012/ip401\r\n2. Create a path range index as per below details:\r\n<range-path-index>\r\n<scalar-type>float</scalar-type>\r\n<collation/>\r\n<path-expression>/va:vpr/va:results/va:consults/va:consult/va:requested</path-expression>\r\n<range-value-positions>false</range-value-positions>\r\n<invalid-values>reject</invalid-values>\r\n</range-path-index>\r\n3. Load test.xml (present in attached zip) in the databases\r\n4. Execute below XQuery code against the newly created database:\r\ndeclare namespace va = \"ns://va.gov/2012/ip401\";\r\ncount(/va:vpr/va:results/va:consults/va:consult/va:requested),\r\ncts:count-aggregate(\r\ncts:path-reference('/va:vpr/va:results/va:consults/va:consult/va:requested')),\r\ncts:count-aggregate(\r\ncts:path-reference('/va:vpr/va:results/va:consults/va:consult/va:requested'),'item-frequency')\r\n\r\nExpected result:\r\nThe result count should be '1 1 1' after execution on each database but the counts are incorrect."}, {"time":"2013-03-05T14:43:17.192292-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I reproduced the problem with \"test.xml\" (thanks to Balkrishna's work on creating a very isolated test case).  The issue doesn't appear to be related to aggregate functions. I reproduced it with the following query:\r\n\r\ndeclare namespace va = \"ns://va.gov/2012/ip401\";\r\ncts:count(cts:values(cts:path-reference('/va:vpr/va:results/va:consults/va:consult/va:requested'), (), (\"item-frequency\")))\r\n\r\nNote that I created 3 databases and configured/populated each of them following the steps Balkrishna documented. The query above returns 1 on the first database, 2 on the second datbase and 3 on the third database. \r\n\r\n"}, {"time":"2013-03-05T14:44:10.657187-08:00", "updatedBy":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"hwu", "name":"Haitao Wu", "email":"haitao.wu@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-06T08:52:32.350557-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}}}, "files":[], "show":true, "comment":"The fix here is the same for the bug that you filed: 20934.\r\n\r\nPlease verify all the unit-tests in here and also monitor the test failure bug17944.xml reported in bug 20934."}, {"time":"2013-03-06T08:52:32.350557-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"iagrawal", "name":"Isha Agrawal", "email":"iagrawal@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-06T09:02:21.649656-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Fix"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true, "comment":"Incorrect assignment."}, {"time":"2013-03-06T09:02:21.649656-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-06T09:02:21.649656-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"tofixin":{"from":"7.0-ea1", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-03-07T08:03:05.046242-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"135469", "paths":["xdmp/branches/b6_0/src/DatabaseConfig.cpp"], "affectedBugs":[]}, "comment":"Fix for bug:20759.\n"}, {"time":"2013-03-07T08:58:23.740353-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-07T08:58:23.740353-08:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{"assignTo":{"from":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-18T16:59:48.753693-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-21T12:34:37.200437-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true, "comment":"The simple test that Balkrishna has provided seems to return the correct result of 111 in 7.0, but returns 112 in 6.0. Gajanan, could you please take a look?"}, {"time":"2013-03-21T12:34:37.200437-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-23T22:07:37.784764-07:00", "updatedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This works fine on 6.0 nightly. I may have to work with Maha to find out how she is testing this."}, {"time":"2013-03-25T12:05:27.970524-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"For easy reference, the name of the test is path-index-bug21079.xml."}, {"time":"2013-03-26T13:07:33.536481-07:00", "updatedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on build 6.0-20130326. My bad, I was running the test on an older build. "}, {"time":"2013-04-22T16:19:39.522975-07:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2013-04-22T16:19:39.522975-07:00", "fixedAt":"2013-03-07T08:58:23.740353-08:00", "fixedBy":{"username":"gchinchwadkar", "name":"Gajanan Chinchwadkar", "email":"Gajanan.Chinchwadkar@marklogic.com"}, "shippedAt":"2013-03-26T13:07:33.536481-07:00", "shippedBy":{"username":"msrinivasan", "name":"Mahalakshmi Srinivasan", "email":"mahalakshmi.srinivasan@marklogic.com"}, "closedAt":"2013-04-22T16:19:39.522975-07:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}