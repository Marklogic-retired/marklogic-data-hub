{"id":2073, "kind":"Bug", "createdAt":"2005-08-11T13:07:04.721986-07:00", "status":"Closed", "title":"thesaurus creates queries with duplicate terms", "category":"", "severity":"", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"michael", "name":"Michael Blakeley", "email":"michael.blakeley@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"* load thesaurus:\n<thesaurus xmlns=\"http://marklogic.com/xdmp/thesaurus\">\n  <metadata/>\n  <entry>\n    <term>gi</term>\n    <part-of-speech>adjective</part-of-speech>\n    <qualifiers>\n      <qualifier>anatomy</qualifier>\n    </qualifiers>\n    <synonym>\n      <term>gastrointestinal</term>\n    </synonym>\n  </entry>\n</thesaurus>\n\n* test thesaurus:\n\nimport module namespace thsr=\"http://marklogic.com/xdmp/thesaurus\"\n at \"/MarkLogic/thesaurus.xqy\"\n\nlet $q := cts:or-query((\n  \"gi\", \"gi\"\n))\nreturn thsr:expand(\n  $q, thsr:query-lookup(\"bullseye-thesaurus.xml\", $q), (), (), ()\n)\n\n* Unexpected result:\n  cts:or-query((cts:or-query((cts:word-query(\"gi\", (), 1), cts:word-query(\"gastrointestinal\", (), 1), cts:word-query(\"gastrointestinal\", (), 1))), cts:or-query((cts:word-query(\"gi\", (), 1), cts:word-query(\"gastrointestinal\", (), 1), cts:word-query(\"gastrointestinal\", (), 1)))))\n\n* Expected result:\n  cts:or-query((cts:or-query((cts:word-query(\"gi\", (), 1), cts:word-query(\"gastrointestinal\", (), 1))), cts:or-query((cts:word-query(\"gi\", (), 1), cts:word-query(\"gastrointestinal\", (), 1)))))", "samplequery":"", "sampledata":"", "version":"3.0-2", "tofixin":"3.0-3", "fixedin":"3.0-3", "platform":"linux", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"michael", "name":"Michael Blakeley", "email":"michael.blakeley@marklogic.com"}], "attachments":[], "clones":[], "cloneOf":"", "support":{"headline":"Thesaurus query expansion adding extra terms", "supportDescription":"When the query passed to thsr:expand() includes multiple instances of the same search term, the thsr:lookup() function will return duplicate results per term instance, which then get included in the expanded query. ", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["", "michael"], "changeHistory":[{"time":"2005-08-11T13:40:03.684082-07:00", "updatedBy":{"username":"michael", "name":"Michael Blakeley", "email":"michael.blakeley@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I should have noted that I ran into this behavior today at Ovid - it has the effect of skewing the relevancy-rankings in favor of whatever thesaurus-expanded terms happen to come later in the query. This is bad for our effort to convince them that relevance extensions (gap #1) aren't needed.\n\nI think this is happening because my queries really do end up with duplicate terms in various places - for example, cts:or-query(( cts:near-query((\"a\", \"b\")), cts:near-query((\"b\", \"c\")) )). A distinct-values() in just the right place in thesaurus.xqy would probably do the trick - I think someplace in expand-to-or-query.\n\nI may also be able to work around this problem in my code, but it'll slow down my query builder a bit."}, {"time":"2005-08-11T17:49:11.068303-07:00", "updatedBy":{"username":"ian", "name":"Ian Small", "email":"ian@cerisent.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"ian", "name":"Ian Small", "email":"ian@cerisent.com"}, "to":{"username":"nick", "name":"Nick Lanham", "email":"nick@cerisent.com"}}}, "files":[], "show":true, "comment":"can you please discuss this with michael?\ni'm not sure exactly what we're doing vs. what he wants, and what magic set of rules we need to follow to figure it out."}, {"time":"2005-08-29T17:50:22.895477-07:00", "updatedBy":{"username":"nick", "name":"Nick Lanham", "email":"nick@cerisent.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"nick", "name":"Nick Lanham", "email":"nick@cerisent.com"}, "to":{"username":"michael", "name":"Michael Blakeley", "email":"michael.blakeley@marklogic.com"}}}, "files":[], "show":true, "comment":"Fixed after 0829\n\nbasically what was happening is, in the lookup for the query we were recursing on each \"gi\" query and each call was returning the same entry, leading to duplicate entries being passed to expand and the strange behaviour.\n\nwe now do duplicate elimination on lookups so this won't happen.\n\nnote that if you pass duplicate entries to expand you will get duplicates in the expansion still."}, {"time":"2005-09-01T08:14:33.670605-07:00", "updatedBy":{"username":"michael", "name":"Michael Blakeley", "email":"michael.blakeley@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"michael", "name":"Michael Blakeley", "email":"michael.blakeley@marklogic.com"}, "to":{"username":"cjl", "name":"Christopher Lindblad", "email":"cjl@cerisent.com"}}}, "files":[], "show":true, "comment":"Works in 3.0-20050829"}, {"time":"2005-09-01T08:16:35.747324-07:00", "updatedBy":{"username":"michael", "name":"Michael Blakeley", "email":"michael.blakeley@marklogic.com"}, "change":{"assignTo":{"from":{"username":"michael", "name":"Michael Blakeley", "email":"michael.blakeley@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}], "updatedAt":"2005-09-01T08:16:35.747324-07:00", "fixedAt":"2005-08-29T17:50:22.895477-07:00", "fixedBy":{"username":"nick", "name":"Nick Lanham", "email":"nick@cerisent.com"}, "shippedAt":"2005-09-01T08:14:33.670605-07:00", "shippedBy":{"username":"michael", "name":"Michael Blakeley", "email":"michael.blakeley@marklogic.com"}, "renderDescriptionAs":"normal"}