{"id":20026, "kind":"Bug", "createdAt":"2012-11-07T16:18:57.957234-08:00", "status":"Closed", "title":"CPF Pipeline: 'XInclude Processing' fails with XDMP-CONFLICTINGUPDATES error on cpf:state", "category":"conversion", "severity":"Major", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"From Support ticket https://help.marklogic.com/staff/Tickets/Ticket/View/12073\r\n\r\nHere is a segment of the cpf error.\r\n\r\n<cpf:error xmlns:cpf=\"http://marklogic.com/cpf\">\r\n    <error:error xsi:schemaLocation=\"http://marklogic.com/xdmp/error error.xsd\" xmlns:error=\"http://marklogic.com/xdmp/error\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\r\n      <error:code>XDMP-CONFLICTINGUPDATES</error:code>\r\n      <error:name/>\r\n      <error:xquery-version>1.0-ml</error:xquery-version>\r\n      <error:message>Conflicting updates</error:message>\r\n      <error:format-string>XDMP-CONFLICTINGUPDATES: xdmp:invoke(\"/MarkLogic/xinclude/actions/propagate-parts-action.xqy\", (xs:QName(\"trgr:uri\"), \"/docs/editable/0011d46f-0ff8-0e12-7ff7-3fe0837f39f6.xml\", xs:QName(\"trgr:trigger\"), ...), &lt;options xmlns=\"xdmp:eval\"&gt;&lt;isolation&gt;different-transaction&lt;/isolation&gt;&lt;prevent-deadlocks&gt;t...&lt;/options&gt;) -- Conflicting updates xdmp:document-set-property(\"/docs/editable/0011d46f-0ff8-0e12-7ff7-3fe0837f39f6.xml\", /cpf:state) and xdmp:document-set-property(\"/docs/editable/0011d46f-0ff8-0e12-7ff7-3fe0837f39f6.xml\", /cpf:state)</error:format-string>\r\n      <error:retryable>false</error:retryable>\r\n      <error:expr>xdmp:invoke(\"/MarkLogic/xinclude/actions/propagate-parts-action.xqy\", (xs:QName(\"trgr:uri\"), \"/docs/editable/0011d46f-0ff8-0e12-7ff7-3fe0837f39f6.xml\", xs:QName(\"trgr:trigger\"), ...), &lt;options xmlns=\"xdmp:eval\"&gt;&lt;isolation&gt;different-transaction&lt;/isolation&gt;&lt;prevent-deadlocks&gt;t...&lt;/options&gt;)</error:expr>\r\n      <error:data>\r\n\t<error:datum>xdmp:document-set-property(\"/docs/editable/0011d46f-0ff8-0e12-7ff7-3fe0837f39f6.xml\", /cpf:state)</error:datum>\r\n\t<error:datum>xdmp:document-set-property(\"/docs/editable/0011d46f-0ff8-0e12-7ff7-3fe0837f39f6.xml\", /cpf:state)</error:datum>\r\n      </error:data>\r\n      <error:stack>\r\n\t<error:frame>\r\n\t  <error:uri>/MarkLogic/cpf/triggers/internal-cpf.xqy</error:uri>\r\n\t  <error:line>179</error:line>\r\n\t  <error:column>8</error:column>\r\n\t  <error:operation>execute-action(\"on-state-enter\", \"http://marklogic.com/states/xinclude/updated-part\", \"/docs/editable/0011d46f-0ff8-0e12-7ff7-3fe0837f39f6.xml\", (xs:QName(\"trgr:uri\"), \"/docs/editable/0011d46f-0ff8-0e12-7ff7-3fe0837f39f6.xml\", xs:QName(\"trgr:trigger\"), ...), &lt;options xmlns=\"xdmp:eval\"&gt;&lt;isolation&gt;different-transaction&lt;/isolation&gt;&lt;prevent-deadlocks&gt;t...&lt;/options&gt;, (fn:doc(\"http://marklogic.com/cpf/pipelines/7977256676073362602.xml\")/p:pipeline, fn:doc(\"http://marklogic.com/cpf/pipelines/6363974101186217948.xml\")/p:pipeline), fn:doc(\"http://marklogic.com/cpf/pipelines/6363974101186217948.xml\")/p:pipeline/p:state-transition[5]/p:default-action, fn:doc(\"http://marklogic.com/cpf/pipelines/6363974101186217948.xml\")/p:pipeline/p:state-transition[5])</error:operation>\r\n\t  <error:variables>\r\n...\r\n\r\n", "samplequery":"", "sampledata":"", "version":"6.0-1", "tofixin":"N/A", "fixedin":"N/A", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, {"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}], "attachments":[{"name":"Customer's pipeline", "uri":"root/support/bugtracking/attachments/20026/innovate_upload_xinclude_pipeline.xml"}, {"name":"Properties for document that experienced cpf error", "uri":"root/support/bugtracking/attachments/20026/properties.xml"}], "relationships":[{"type":"", "to":""}], "clones":[20027], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"Medium", "title":"Requires significant or unnatural effort to work around issue or to prevent significant business impact"}, "workaround":""}, "tags":["conversion", "rpelton"], "changeHistory":[{"time":"2012-11-07T16:27:45.580117-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Looking at the code in /MarkLogic/xinclude/actions/propagate-parts-action.xqy, it looks like both cpf:document-set-state() & cpf:success() are called.\r\n\r\ncpf:success() will call cpf:document-set-state() under many conditions.\r\n\r\ncpf:document-set-state() will call xdmp:document-set-property() for cpf:state."}, {"time":"2012-11-07T16:48:08.895773-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"status":{"from":"", "to":"Verify"}, "assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true, "comment":"Rick, can we push this to 6.0-3, or do you need someone to look at it before that?"}, {"time":"2012-11-07T16:48:08.895773-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"assignTo":{"from":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "to":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-11-07T18:39:37.965299-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Mary,\r\nPlease look at this.  As it does not have a high customer impact, it should be fine to push it to 6.0-3."}, {"time":"2012-11-07T18:39:37.965299-08:00", "updatedBy":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rhu", "name":"Ron Hu", "email":"ron.hu@marklogic.com"}, "to":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}}}, "files":[], "show":true}, {"time":"2012-11-08T06:05:06.345377-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I have a query out to the customer regarding their impact. I will follow up today if I don't get a response this morning.  \r\n\r\nWorkaround may be to create a custom cpf pipeline  that moves this module (with fix) into their own app space - so we will most likely be able to push this to 6.0-3.\r\n"}, {"time":"2012-11-08T08:19:39.777049-08:00", "updatedBy":{"username":"mary", "name":"Mary Holstege", "email":"mary@cerisent.com"}, "change":{}, "files":[], "show":true, "comment":"Do we know what there data looks like that this is running over?  The set-state is happening on the targeted part being xincluded; the success is happening on the source master document. So it looks like the master points at itself. So there is an application level conflict over what the next processing step should be: reprocess the part as a part, or continue processing it as a master."}, {"time":"2012-11-08T08:35:50.626873-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Thanks Mary - I will ping the customer for that document"}, {"time":"2012-11-08T11:00:04.71132-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Pushing out to 6.0-3\r\n\r\nHaven't heard back from the customer.  "}, {"time":"2012-11-08T11:00:04.71132-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"tofixin":{"from":"6.0-2", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-01-21T14:04:38.74139-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Analysis indicated that customer's custom cpf pipeline introduced xinclude recursion.  Customer was tasked with resolving.  Support ticket is closed and will only revisit if customer comes back with additional issues."}, {"time":"2013-01-21T14:04:38.74139-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-21T14:04:38.74139-08:00", "updatedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "change":{"tofixin":{"from":"6.0-3", "to":"N/A"}}, "files":[], "show":true}], "updatedAt":"2013-01-21T14:04:38.74139-08:00", "closedAt":"2013-01-21T14:04:38.74139-08:00", "closedBy":{"username":"rpelton", "name":"Rick Pelton", "email":"rick.pelton@marklogic.com"}, "renderDescriptionAs":"normal"}