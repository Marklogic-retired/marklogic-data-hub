{"id":20501, "kind":"Bug", "createdAt":"2012-10-02T10:42:40.173372-07:00", "status":"Closed", "title":"Replay of rollback journal frames during point in time recovery could be incorrect.", "category":"xdmp", "severity":"Catastrophic", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"This came up as a result of a customer case (11883).\r\n\r\nThe rollback replay code doesn't verify that it can successfully roll back (i.e. it may have already discarded fragments from the point in time being rolled back to). This could happen in a few cases.\r\n\r\n1. When doing database replication, the master database might have a merge timestamp set, but the replica database might not.\r\n\r\n2. When doing either database replication or local-disk failover with no merge timestamp set and the master happens to have sufficient state to do a successful rollback but the replica  does not.\r\n\r\n3. During point in time recovery when journal frames are being replayed from an archive and encounter a rollback that was possible when the database was live (e.g. a merge timestamp was set at some point in the past) but is not possible during restore+replay (e.g. no merge timestamp is set). This could be particularly difficult if the user was dynamically changing the merge timestamp and performed multiple rollbacks at different points in time.\r\n\r\nFor 1 and 2, an easy fix would be to simply detect the situation and force a bulk resynchronization from the master.\r\n\r\nFor 3, the fix would be more difficult. Ideally, we'd have a list of all rollbacks in the journal archive so that we can dynamically ensure no fragments are discarded that will be needed after a rollback. Theoretically, we could also use this to speed up replay of journal archives by skipping over replay of transactions that will be discarded later by a rollback. The performance win is enough of an edge case that I don't think it's worth doing on its own, but it may be the simplest way to fix this bug.\r\n\r\nI'm marking this as catastrophic because it results in loss of data, but this is another case where a priority field would be useful if we decide it's enough of an edge case that we're not worried about fixing it quickly.\r\n\r\nI'm going to mark it to be fixed in 6.0-2 so that it gets considered during triage. We may want to split this into two separate bugs, one for the replication case and the other for the point in time recovery case since the fix for 1 and 2 is easier than the fix for 3.", "samplequery":"", "sampledata":"", "version":"7.0-nightly", "tofixin":"7.0-1", "fixedin":"7.0-1", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, {"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, {"username":"dchander", "name":"Dinesh Chander", "email":"dinesh.chander@globallogic.com"}, {"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":19852, "support":{"headline":"Incorrect merge timestamp during point in time recovery results in incorrect forest rollback", "supportDescription":"Forest rollback is performed with a merge timestamp when the database is active.\r\nIf the merge timestamp is not set properly during point in time recovery, the result of the forest rollback replayed is not correct.", "publishStatus":"Publish", "tickets":[], "customerImpact":{"level":"High", "title":"Significant business impact with no reasonable workaround"}, "workaround":""}, "tags":["xdmp", "wfeick"], "changeHistory":[{"time":"2012-10-02T10:42:40.173372-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"assignTo":{"from":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "to":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}}}, "files":[], "show":true}, {"time":"2012-10-02T10:43:41.681726-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"6.0-3", "to":"6.0-2"}}, "files":[], "show":true}, {"time":"2012-10-21T20:07:02.263984-07:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-01-14T14:48:11.166856-08:00", "updatedBy":{"username":"wfeick", "name":"Wayne Feick", "email":"wfeick@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Bug 19505 took care of 1 and 2, this bug is for 3 only."}, {"time":"2013-01-17T13:56:43.15199-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{"assignTo":{"from":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "to":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-17T13:56:43.15199-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"7.0-ea1"}}, "files":[], "show":true}, {"time":"2013-01-17T14:33:59.129704-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{}, "files":[], "show":true, "svn":{"repository":"/project/engsvn", "revision":"128122", "paths":["xdmp/trunk/src/Forest.cpp"], "affectedBugs":[]}, "comment":"bug:20501 check rollback timestamp in restore"}, {"time":"2013-01-17T14:34:23.107431-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{"status":{"from":"", "to":"Test"}, "assignTo":{"from":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-17T14:34:23.107431-08:00", "updatedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "change":{"assignTo":{"from":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "to":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-02T10:58:56.751162-08:00", "updatedBy":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "change":{"assignTo":{"from":{"username":"rpolasani", "name":"Raghu Polasani", "email":"raghu.polasani@marklogic.com"}, "to":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-03-07T12:37:05.776763-08:00", "updatedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"This bug verification has dependency on the bug 21077"}, {"time":"2013-03-12T14:45:40.807115-07:00", "updatedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "change":{"status":{"from":"", "to":"Ship"}, "assignTo":{"from":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"Verified on the build 7.0-20130312, looks good to me"}], "updatedAt":"2013-03-12T14:45:40.807115-07:00", "fixedAt":"2013-01-17T14:34:23.107431-08:00", "fixedBy":{"username":"atsoi", "name":"Arthur Tsoi", "email":"arthur.tsoi@marklogic.com"}, "shippedAt":"2013-03-12T14:45:40.807115-07:00", "shippedBy":{"username":"skottam", "name":"Sravan Kottam", "email":"Sravan.Kottam@marklogic.com"}, "renderDescriptionAs":"normal"}