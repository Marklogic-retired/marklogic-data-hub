{"id":20441, "kind":"Bug", "createdAt":"2013-01-11T13:41:07.174921-08:00", "status":"Closed", "title":"Custom constraints in Structured Search does not seem to work", "category":"MarkLogic REST API", "severity":"Critical", "priority":{"level":"5", "title":""}, "submittedBy":{"username":"sravotto", "name":"Silvano  Ravotto", "email":"sravotto@marklogic.com"}, "assignTo":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}, "description":"Create a simple custom constraint and install it on the server under the \"myoptions\" name.\r\n\r\n<options xmlns=\"http://marklogic.com/appservices/search\">\r\n   <constraint name=\"simple\">\r\n    <custom facet=\"false\">\r\n      <parse apply=\"simple\" at=\"/mystuff/constraints.xqy\" ns=\"my stuff\"/>\r\n    </custom>\r\n  </constraint>\r\n</options> \r\n\r\n===========\r\n\r\nmodule namespace c = \"mystuff\";\r\n\r\ndeclare function c:simple(\r\n    $qtext as xs:string,\r\n    $right as schema-element(cts:query) ) as schema-element(cts:query)\r\n{\r\n   document {cts:and-query(())}/*\r\n};\r\n\r\n\r\n===========\r\n\r\nCreate a test query:\r\n\r\n<search:query xmlns:search=\"http://marklogic.com/appservices/search\">\r\n    <search:custom-constraint-query>\r\n      <search:constraint-name>simple</search:constraint-name>\r\n      <search:text>notneeded</search:text>\r\n    </search:custom-constraint-query>\r\n</search:query>\r\n\r\nand post it:\r\n\r\ncurl -v --digest --user admin:admin -H \"Content-Type: application/xml\" -X POST -d @search.xml \"http://host:port/v1/search?options=myoptions\"\r\n\r\nRESULT:\r\n\r\n<rapi:error xmlns:rapi=\"http://marklogic.com/rest-api\"><rapi:status-code>500</rapi:status-code><rapi:status>INTERNAL ERROR</rapi:status><rapi:message-code>XDMP-NONMIXEDCOMPLEXCONT</rapi:message-code><rapi:message>XDMP-NONMIXEDCOMPLEXCONT: fn:data(&lt;search:custom-constraint-query xmlns:search=\"http://marklogic.com/appservices/search\"&gt;&lt;search:constraint-name&gt;simple&lt;/search:constraint-name&gt;&lt;search:t...&lt;/search:custom-constraint-query&gt;) -- Node has complex type with non-mixed complex content.  See the MarkLogic server error log for further detail.</rapi:message></rapi:error>\r\n\r\nIt seems that ast:custom-query in ast.xqy is calling the parser function with the wrong arguments.\r\n", "samplequery":"", "sampledata":"", "version":"6.0-2.1", "tofixin":"6.0-3", "fixedin":"N/A", "platform":"all", "memory":"", "processors":"", "note":"", "subscribers":[{"username":"sravotto", "name":"Silvano  Ravotto", "email":"sravotto@marklogic.com"}, {"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, {"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}], "attachments":[], "relationships":[{"type":"", "to":""}], "clones":[], "cloneOf":"", "support":{"headline":"", "supportDescription":"", "publishStatus":"Not Ready", "tickets":[], "customerImpact":{"level":"N/A", "title":""}, "workaround":""}, "tags":["MarkLogic REST API", "sravotto"], "changeHistory":[{"time":"2013-01-11T13:41:07.174921-08:00", "updatedBy":{"username":"sravotto", "name":"Silvano  Ravotto", "email":"sravotto@marklogic.com"}, "change":{"assignTo":{"from":{"username":"sravotto", "name":"Silvano  Ravotto", "email":"sravotto@marklogic.com"}, "to":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-11T14:25:26.268534-08:00", "updatedBy":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "change":{"assignTo":{"from":{"username":"mdubinko", "name":"Micah  Dubinko", "email":"mdubinko@marklogic.com"}, "to":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}}}, "files":[], "show":true}, {"time":"2013-01-11T14:41:56.722918-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Peculiar.  I'll reproduce and see what I can do.\r\n"}, {"time":"2013-01-11T14:53:43.006835-08:00", "updatedBy":{"username":"dsokolsky", "name":"Danny Sokolsky", "email":"dsokolsky@marklogic.com"}, "change":{"tofixin":{"from":"", "to":"6.0-3"}}, "files":[], "show":true}, {"time":"2013-01-25T11:58:00.300478-08:00", "updatedBy":{"username":"gvaidees", "name":"Ganesh Vaideeswaran", "email":"Ganesh.Vaideeswaran@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"cc'ing Erik as well"}, {"time":"2013-02-14T14:19:34.801586-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"I've been able to verify that there's an issue here. Thanks for excellent reproduction info Silvano.  The immediate fix for this very trivial, but I'll want to add test cases for it."}, {"time":"2013-02-14T15:19:53.134075-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"OK, I think this is a design flaw and possibly a documentation bug. \r\n\r\nThe issue is that there are two different function signatures expected for custom constraint is designed for structured query or for string query.  I'm going to chat with Colleen about this before seeing what to do about it.\r\n"}, {"time":"2013-02-14T15:29:09.546527-08:00", "updatedBy":{"username":"ehennum", "name":"Erik Hennum", "email":"erik.hennum@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Hi, Charles and Silvano:\r\n\r\nI made the same mistake initially.\r\n\r\nThis difference is by design.  Please search for custom constraint in the Plex functional specification and also see this thread:\r\n\r\nhttp://markmail.org/message/ymlcmjgpzdyoit5y\r\n\r\nI think Kim already has the item to clarify the documentation on this point.\r\n"}, {"time":"2013-02-14T15:32:20.877864-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Talking with Colleen, we now consider this a documentation bug -- a custom constraint can only support string query or structured query, but not both.\r\n\r\nThe spec is clear on this point.\r\n\r\nhttps://wiki.marklogic.com/display/ENGINEERING/Search+API+Changes+for+Plex#SearchAPIChangesforPlex-Structuredsearch.1\r\n"}, {"time":"2013-02-19T11:43:54.87339-08:00", "updatedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "change":{"status":{"from":"", "to":"Closed"}, "assignTo":{"from":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "to":{"username":"nobody", "name":"nobody nobody", "email":"nobody@marklogic.com"}}}, "files":[], "show":true, "comment":"We've determined that, although this is some odd behavior, it's working as designed and documented.  You cannot use the same function for string search and structured search where customization is concerned."}, {"time":"2013-03-11T21:44:30.294054-07:00", "updatedBy":{"username":"cwhitney", "name":"Colleen  Whitney", "email":"colleen.whitney@marklogic.com"}, "change":{}, "files":[], "show":true, "comment":"Just a clarification.  You can define a custom constraint that has processors for *both* string and structured search as well as facets.  The handlers for string and structured search are not the same, but can be referenced by the same constraint.  This is a documentation issue."}], "updatedAt":"2013-03-11T21:44:30.294054-07:00", "closedAt":"2013-02-19T11:43:54.87339-08:00", "closedBy":{"username":"cgreer", "name":"Charles Greer", "email":"charles.greer@marklogic.com"}, "renderDescriptionAs":"normal"}