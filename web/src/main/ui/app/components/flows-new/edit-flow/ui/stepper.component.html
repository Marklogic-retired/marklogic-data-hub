<div class="steps-container">
  <header>
    <div class="flow-container">
        <h3 id="flow-name" class="text">{{flow.name}}</h3>
        <button id="new-step-btn"
                mat-raised-button color="primary" 
                (click)="this.newStepClicked()">New Step</button>
    </div>
    <div class="spacer"></div>
    <div class="flow-container">
        <button *ngIf="!flow.isRunning; else elseStop"
                id="run-flow-btn"
                class="item" 
                mat-raised-button 
                color="primary" 
                (click)="this.runClicked()">Run</button>
        <ng-template #elseStop>
          <button 
            id="stop-flow-btn"
            class="item" 
            mat-raised-button 
            color="primary" 
            (click)="this.stopClicked()">Stop</button>
        </ng-template>
        <mat-progress-bar  
          *ngIf="flow.isRunning; else finished" 
          id="job-progress-bar"
          class="item" 
          mode="determinate" 
          [value]="flow.latestJob.runningPercent"></mat-progress-bar>
        <ng-template #finished>
          <a href="#">{{flow.status}}</a>
          <div></div>
        </ng-template>
        <div id="job-started-timestamp" [ngClass]="flow.isRunning ? 'show-running' : 'hide-running'" class="text item">Started: {{flow.latestJob.startTime}}</div>
        <a id="view-jobs-btn" href="#" class="text item">View Jobs</a>
        <div class="icon-container">
          <mat-icon id="flow-menu" class="flow-menu-icon item" [matMenuTriggerFor]="flowMenu">more_vert</mat-icon>
          <mat-icon id="flow-expand-collapse-btn" class="flow-menu-icon item" (click)="this.toggleBody()">arrow_drop_down</mat-icon>
        </div>
    </div>
  </header>

    <div *ngIf="stepsArray.length > 0 && showBody" class="steps-body">
        <section class="step-navigation-bar" cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="dropped($event)" >
          <div class="stepper-container" *ngFor="let step of steps; let i = index;">
            <div
            class="step {{ 'step-' + i }}"
            [ngClass]="{'active': selectedIndex === i}"
            (click)="stepClicked(i)"
            cdkDrag
            >
              <div class="bar {{stepsArray[i].type}}"></div>
              <div class="step-reorder-handle move-icon" cdkDragHandle>
                <svg width="18px" fill="white" viewBox="0 0 24 24">
                  <path d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z"></path>
                  <path d="M0 0h24v24H0z" fill="none"></path>
                </svg>
              </div>
              <div class="header">
                <div class="step-type step-title {{stepsArray[i].type}}">{{stepsArray[i].type}}</div>
                <div class="step-icons header-icons">
                  <mat-icon *ngIf="stepsArray[i].isValid && !stepsArray[i].isRunning" class="step-valid check-icon">check_circle</mat-icon>
                  <mat-icon *ngIf="!stepsArray[i].isValid && !stepsArray[i].isRunning"  class="step-invalid grey-icon">lens</mat-icon>
                  <mat-icon *ngIf="!stepsArray[i].isRunning && !flow.isRunning" (click)="deleteStepClicked(stepsArray[i])" class="step-delete delete-icon">delete</mat-icon>
                  <div *ngIf="stepsArray[i].isRunning" class="spinner-container">
                    <mat-spinner class="step-spinner" diameter="20"></mat-spinner>
                  </div>
                </div>            
              </div>
              <span class="step-name">{{step.label}}</span>
              <!-- TODO Update Information for each step -->
              <div class="summary" *ngIf="stepsArray[i].type === 'ingestion'">
                <div>Source: {{stepsArray[i].targetEntity}}</div>
                <div>Input Type: {{stepsArray[i].targetEntity}}</div>
              </div>
              <div class="summary" *ngIf="stepsArray[i].type === 'mapping'">
                <div>Source Collection: {{stepsArray[i].sourceCollection}}</div>
                <div>Target Entity: {{stepsArray[i].targetEntity}}</div>
              </div>
              <div class="summary" *ngIf="stepsArray[i].type === 'mastering'">
                  <div>Match Options: {{stepsArray[i].config.matchOptions.propertyDefs.property.length}}</div>
                  <div>Merge Options: {{stepsArray[i].targetEntity}}</div>
              </div>
              <div class="summary" *ngIf="stepsArray[i].type === 'custom'">
                <div>Target Entity: {{stepsArray[i].targetEntity}}</div>
                <div>Module: {{stepsArray[i].targetEntity}}</div>
              </div>
              
            </div>
            <div *ngIf="i !== (steps.length-1); else spacer" class="line">&rarr;</div>
            <ng-template #spacer><span class="spacer" ></span></ng-template>
          </div>
        </section>
    </div>
    <div *ngIf="stepsArray.length === 0" class="no-steps steps-body">
      <p>Click the <span>New Step</span> button to create a step for your flow</p>
    </div>
  </div>

  <ng-container *ngIf="stepsArray.length > 0" [ngTemplateOutlet]="selected.content"></ng-container>

  <mat-menu id="flow-menu-dialog" #flowMenu="matMenu">
      <div id="flow-menu-edit-btn" mat-menu-item (click)="this.editSettingsClicked()">Edit Settings</div>
      <div id="flow-menu-delete-btn" mat-menu-item (click)="this.deleteFlowClicked()">Delete</div>
  </mat-menu>